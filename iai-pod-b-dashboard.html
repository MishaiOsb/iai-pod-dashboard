<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IAI Pod B Dashboard — Mishai | ImplementAI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
/* ========================================================
   CSS CUSTOM PROPERTIES & THEME
   ======================================================== */
:root {
    /* Shared tokens (don't change between themes) */
    --accent-purple: #6B30FF;
    --accent-purple-light: #8B50FF;
    --accent-purple-glow: rgba(107,48,255,0.3);
    --accent-orange: #FF6629;
    --accent-gold: #FFD700;
    --rag-green: #00c875;
    --rag-green-bg: rgba(0,200,117,0.12);
    --rag-amber: #fdab3d;
    --rag-amber-bg: rgba(253,171,61,0.12);
    --rag-red: #df2f4a;
    --rag-red-bg: rgba(223,47,74,0.12);
    --plan-pilot: #fdab3d;
    --plan-scale: #df2f4a;
    --plan-activate: #579bfc;
    --plan-orchestrate: #007eb5;
    --plan-custom: #00c875;
    --plan-partnership: #9d50dd;
    --plan-freedemo: #037f4c;
    --billing-yes: #00c875;
    --billing-no: #df2f4a;
    --billing-na: #579bfc;
    --radius-sm: 6px;
    --radius-md: 8px;
    --radius-lg: 12px;
    --radius-xl: 16px;
    --transition-fast: 0.15s ease;
    --transition-default: 0.25s ease;
    --transition-smooth: 0.35s cubic-bezier(0.4,0,0.2,1);
    /* Chart colours used by JS */
    --chart-grid: #222;
    --chart-tick: #666;
    --chart-tick-label: #ccc;
    --chart-border: #1a1a1a;
}

/* ---- DARK THEME (default) ---- */
[data-theme="dark"] {
    --bg-primary: #0a0a0a;
    --bg-secondary: #111111;
    --bg-card: #1a1a1a;
    --bg-elevated: #252525;
    --bg-hover: #2a2a2a;
    --bg-input: #1e1e1e;
    --border-subtle: #2a2a2a;
    --border-default: #333333;
    --border-focus: #6B30FF;
    --text-primary: #e0e0e0;
    --text-secondary: #999999;
    --text-muted: #666666;
    --text-white: #ffffff;
    --shadow-card: 0 2px 8px rgba(0,0,0,0.3);
    --shadow-elevated: 0 8px 24px rgba(0,0,0,0.5);
    --shadow-glow: 0 0 20px rgba(107,48,255,0.15);
    --navbar-bg: rgba(17,17,17,0.92);
    --chart-grid: #222;
    --chart-tick: #666;
    --chart-tick-label: #ccc;
    --chart-border: #1a1a1a;
}

/* ---- LIGHT THEME ---- */
[data-theme="light"] {
    --bg-primary: #f4f5f7;
    --bg-secondary: #ffffff;
    --bg-card: #ffffff;
    --bg-elevated: #eef0f4;
    --bg-hover: #e4e6ea;
    --bg-input: #ffffff;
    --border-subtle: #dfe1e6;
    --border-default: #c1c7d0;
    --border-focus: #6B30FF;
    --text-primary: #172b4d;
    --text-secondary: #5e6c84;
    --text-muted: #97a0af;
    --text-white: #172b4d;
    --shadow-card: 0 1px 4px rgba(9,30,66,0.13);
    --shadow-elevated: 0 8px 16px rgba(9,30,66,0.16);
    --shadow-glow: 0 0 20px rgba(107,48,255,0.08);
    --navbar-bg: rgba(255,255,255,0.92);
    --chart-grid: #e4e6ea;
    --chart-tick: #97a0af;
    --chart-tick-label: #5e6c84;
    --chart-border: #ffffff;
}

/* ========================================================
   RESET & BASE
   ======================================================== */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html { scroll-behavior: smooth; }
body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.5;
    overflow-x: hidden;
    min-height: 100vh;
}
a { color: var(--accent-purple-light); text-decoration: none; }
a:hover { text-decoration: underline; }
button { font-family: inherit; cursor: pointer; border: none; outline: none; }
input, textarea, select { font-family: inherit; outline: none; }
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg-secondary); }
::-webkit-scrollbar-thumb { background: var(--border-default); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

/* ========================================================
   SETUP MODAL
   ======================================================== */
.setup-overlay {
    position: fixed; inset: 0; z-index: 9999;
    background: rgba(0,0,0,0.85);
    display: flex; align-items: flex-start; justify-content: center;
    backdrop-filter: blur(8px);
    opacity: 1; transition: opacity 0.3s ease;
    overflow-y: auto; padding: 40px 0;
}
.setup-overlay.hidden { opacity:0; pointer-events:none; }
.setup-modal {
    background: var(--bg-card);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-xl);
    padding: 48px 40px;
    max-width: 480px; width: 90%;
    box-shadow: var(--shadow-elevated), var(--shadow-glow);
    text-align: center;
    flex-shrink: 0;
}
.setup-modal .logo {
    font-size: 28px; font-weight: 800;
    background: linear-gradient(135deg, #6B30FF, #FF6629);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    margin-bottom: 8px;
}
.setup-modal .subtitle { color: var(--text-secondary); margin-bottom: 32px; font-size: 14px; }
.setup-modal h2 { color: var(--text-white); margin-bottom: 4px; font-size: 20px; }
.setup-input-group {
    position: relative; margin-bottom: 16px; text-align: left;
}
.setup-input-group label {
    display: block; font-size: 12px; font-weight: 600;
    color: var(--text-secondary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;
}
.setup-input-group input {
    width: 100%; padding: 12px 44px 12px 14px;
    background: var(--bg-input); border: 1px solid var(--border-default);
    border-radius: var(--radius-md); color: var(--text-primary);
    font-size: 14px; transition: border-color var(--transition-fast);
}
.setup-input-group input:focus { border-color: var(--accent-purple); }
.toggle-vis {
    position: absolute; right: 10px; top: 32px;
    background: none; color: var(--text-muted); font-size: 18px; padding: 4px;
}
.setup-error {
    color: var(--rag-red); font-size: 13px; margin-bottom: 12px;
    min-height: 20px;
}
.setup-success {
    color: var(--rag-green); font-size: 13px; margin-bottom: 12px;
    min-height: 20px;
}
.btn-primary {
    width: 100%; padding: 12px;
    background: linear-gradient(135deg, #6B30FF, #5020CC);
    color: white; border-radius: var(--radius-md);
    font-weight: 600; font-size: 14px;
    transition: all var(--transition-fast);
    border: none;
}
.btn-primary:hover { background: linear-gradient(135deg, #7B40FF, #6030DD); transform: translateY(-1px); }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
.setup-hint {
    margin-top: 16px; font-size: 12px; color: var(--text-muted); line-height: 1.6;
}
.pod-select-btn {
    padding: 14px 18px; background: var(--bg-elevated); border: 2px solid var(--border-default);
    border-radius: var(--radius-lg); color: var(--text-primary); font-size: 15px; font-weight: 600;
    cursor: pointer; transition: all var(--transition-fast); text-align: left;
    display: flex; align-items: center; gap: 12px;
}
.pod-select-btn:hover {
    border-color: var(--accent-purple); background: var(--bg-hover); transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(107,48,255,0.15);
}
.pod-select-btn .pod-icon {
    width: 38px; height: 38px; border-radius: 50%; background: var(--accent-purple);
    display: flex; align-items: center; justify-content: center;
    color: white; font-weight: 700; font-size: 15px; flex-shrink: 0;
}

/* ========================================================
   SETUP EXTRAS — Close Button, Mode Toggle, Offline Badge
   ======================================================== */
.setup-modal { position: relative; }
.setup-close-btn {
    position: absolute; top: 14px; right: 14px;
    background: var(--bg-elevated); border: 1px solid var(--border-default);
    color: var(--text-muted); font-size: 18px; width: 32px; height: 32px;
    border-radius: 50%; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all var(--transition-fast); z-index: 1;
}
.setup-close-btn:hover { color: var(--text-primary); border-color: var(--text-muted); background: var(--bg-hover); }
.mode-toggle-group { display: flex; flex-direction: column; gap: 8px; margin: 12px 0; }
.mode-toggle-btn {
    padding: 12px 14px; background: var(--bg-elevated); border: 2px solid var(--border-default);
    border-radius: var(--radius-md); color: var(--text-secondary); font-size: 13px;
    cursor: pointer; transition: all var(--transition-fast); text-align: left;
}
.mode-toggle-btn:hover { border-color: var(--accent-purple); background: var(--bg-hover); }
.mode-toggle-btn.active { border-color: var(--accent-purple); background: rgba(107,48,255,0.1); color: var(--text-primary); }
.btn-secondary {
    width: 100%; padding: 10px; margin-top: 8px;
    background: var(--bg-elevated); color: var(--text-secondary);
    border: 1px solid var(--border-default); border-radius: var(--radius-md);
    font-size: 13px; font-weight: 600; cursor: pointer;
    transition: all var(--transition-fast);
}
.btn-secondary:hover { background: var(--bg-hover); color: var(--text-primary); border-color: var(--text-muted); }
.nav-connection-status {
    display: inline-flex; align-items: center; gap: 6px;
    font-size: 10px; font-weight: 600; padding: 3px 10px;
    border-radius: 10px; text-transform: uppercase; letter-spacing: 0.5px;
    transition: all var(--transition-fast);
    cursor: default;
}
.nav-connection-status .conn-dot {
    width: 7px; height: 7px; border-radius: 50%;
    flex-shrink: 0; transition: background 0.3s ease;
}
.nav-connection-status[data-status="online"] {
    background: rgba(0,200,117,0.12); color: #00c875;
}
.nav-connection-status[data-status="online"] .conn-dot { background: #00c875; box-shadow: 0 0 4px rgba(0,200,117,0.6); }
.nav-connection-status[data-status="issues"] {
    background: rgba(255,203,0,0.15); color: var(--rag-amber);
}
.nav-connection-status[data-status="issues"] .conn-dot { background: var(--rag-amber); box-shadow: 0 0 4px rgba(255,203,0,0.6); }
.nav-connection-status[data-status="disconnected"] {
    background: rgba(226,68,92,0.15); color: var(--rag-red);
}
.nav-connection-status[data-status="disconnected"] .conn-dot { background: var(--rag-red); box-shadow: 0 0 4px rgba(226,68,92,0.6); }
.nav-connection-status[data-status="offline"] {
    background: rgba(255,203,0,0.15); color: var(--rag-amber);
}
.nav-connection-status[data-status="offline"] .conn-dot { background: var(--rag-amber); }

/* ========================================================
   LOADING OVERLAY
   ======================================================== */
.loading-overlay {
    position: fixed; inset: 0; z-index: 8000;
    background: var(--bg-primary);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    transition: opacity 0.4s ease;
}
.loading-overlay.hidden { opacity:0; pointer-events:none; }
.spinner {
    width: 48px; height: 48px;
    border: 3px solid var(--border-default);
    border-top-color: var(--accent-purple);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text { margin-top: 16px; color: var(--text-secondary); font-size: 14px; }

/* ========================================================
   NAVBAR
   ======================================================== */
.navbar {
    position: sticky; top: 0; z-index: 500;
    background: var(--navbar-bg);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border-subtle);
    padding: 12px 24px;
    display: flex; align-items: center; gap: 16px; flex-wrap: wrap;
    transition: left var(--transition-smooth), width var(--transition-smooth);
}
.dashboard {
    transition: margin-left var(--transition-smooth);
}
.nav-brand {
    display: flex; align-items: center; gap: 10px;
    font-weight: 700; font-size: 16px; color: var(--text-white);
    white-space: nowrap;
}
.nav-brand .brand-home-link {
    display: flex; align-items: center; gap: 10px;
    cursor: pointer; text-decoration: none; color: inherit;
    transition: opacity 0.2s;
}
.nav-brand .brand-home-link:hover { opacity: 0.85; }
.nav-brand .brand-icon {
    width: 34px; height: 34px; border-radius: 8px;
    background: linear-gradient(135deg, #6B30FF, #FF6629);
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 800; color: white; letter-spacing: 0.5px;
}
.nav-brand .pod-tag {
    background: #5559df; color: white;
    padding: 2px 8px; border-radius: 4px;
    font-size: 11px; font-weight: 600;
}
.nav-brand .brand-user {
    font-size: 12px; font-weight: 500;
    color: var(--text-secondary);
    padding-left: 6px;
    border-left: 1px solid rgba(255,255,255,0.15);
}
.nav-filters {
    display: flex; align-items: center; gap: 8px; flex: 1; flex-wrap: wrap;
}
.filter-pill {
    padding: 5px 12px; border-radius: 20px;
    font-size: 12px; font-weight: 500;
    background: var(--bg-elevated); color: var(--text-secondary);
    border: 1px solid var(--border-subtle);
    transition: all var(--transition-fast);
    cursor: pointer; white-space: nowrap;
}
.filter-pill:hover { border-color: var(--accent-purple); color: var(--text-primary); }
.filter-pill.active {
    background: var(--accent-purple); color: white;
    border-color: var(--accent-purple);
}
.filter-pill.rag-green.active { background: var(--rag-green); border-color: var(--rag-green); }
.filter-pill.rag-amber.active { background: var(--rag-amber); border-color: var(--rag-amber); color: #111; }
.filter-pill.rag-red.active { background: var(--rag-red); border-color: var(--rag-red); }
.filter-pill .pill-count {
    display: inline-flex; align-items: center; justify-content: center;
    min-width: 18px; height: 18px; border-radius: 9px;
    background: rgba(255,255,255,0.2); font-size: 10px; font-weight: 700;
    margin-left: 4px; padding: 0 4px;
}
.filter-select {
    padding: 5px 10px; border-radius: var(--radius-sm);
    background: var(--bg-elevated); color: var(--text-secondary);
    border: 1px solid var(--border-subtle); font-size: 12px;
    cursor: pointer;
}
.filter-select:focus { border-color: var(--accent-purple); color: var(--text-primary); }
.sort-select {
    padding: 5px 10px; border-radius: var(--radius-sm);
    background: var(--bg-elevated); color: var(--text-secondary);
    border: 1px solid var(--border-subtle); font-size: 12px;
    cursor: pointer;
}
.sort-select:focus { border-color: var(--accent-purple); color: var(--text-primary); }
.nav-actions {
    display: flex; align-items: center; gap: 10px;
    margin-left: auto;
}
.search-box {
    padding: 6px 12px; border-radius: 20px;
    background: var(--bg-elevated); color: var(--text-primary);
    border: 1px solid var(--border-subtle); font-size: 12px;
    width: 180px; transition: all var(--transition-fast);
}
.search-box:focus { border-color: var(--accent-purple); width: 220px; }
.search-box::placeholder { color: var(--text-muted); }
.btn-icon {
    width: 32px; height: 32px; border-radius: var(--radius-sm);
    background: var(--bg-elevated); color: var(--text-secondary);
    border: 1px solid var(--border-subtle);
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; transition: all var(--transition-fast);
    position: relative;
}
.btn-icon:hover { border-color: var(--accent-purple); color: var(--text-primary); }
.btn-icon.spinning svg, .btn-icon.spinning::after {
    animation: spin 0.8s linear infinite;
}
.alert-badge {
    position: absolute; top: -4px; right: -4px;
    min-width: 16px; height: 16px; border-radius: 8px;
    background: var(--rag-red); color: white;
    font-size: 9px; font-weight: 700;
    display: flex; align-items: center; justify-content: center;
    padding: 0 3px;
}
.alert-badge.hidden { display: none; }
.last-refresh {
    font-size: 11px; color: var(--text-muted); white-space: nowrap;
    display: flex; flex-direction: column; align-items: flex-end; line-height: 1.3;
}
.refresh-countdown {
    font-size: 10px; color: var(--text-muted); opacity: 0.6;
}

/* ========================================================
   MAIN CONTENT
   ======================================================== */
.main-content {
    max-width: 1600px; margin: 0 auto; padding: 20px 24px 60px;
}

/* ========================================================
   SMART ALERTS BANNER
   ======================================================== */
.alerts-section {
    margin-bottom: 20px;
    animation: fadeIn 0.3s ease;
}
.alerts-section.hidden { display: none; }
.alerts-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 10px;
}
.alerts-header h3 {
    font-size: 13px; font-weight: 600; color: var(--rag-amber);
    display: flex; align-items: center; gap: 6px;
}
.alerts-header .alerts-actions { display: flex; gap: 6px; align-items: center; }
.alerts-header .alerts-toggle, .alerts-header .alerts-clear {
    font-size: 11px; color: var(--text-muted); cursor: pointer;
    background: none; padding: 4px 10px; border-radius: 4px;
    transition: all var(--transition-fast);
}
.alerts-header .alerts-toggle:hover, .alerts-header .alerts-clear:hover { color: var(--text-primary); background: var(--bg-elevated); }
.alerts-header .alerts-clear { color: var(--rag-red); }
.alerts-header .alerts-clear:hover { background: var(--rag-red-bg); color: var(--rag-red); }
.alerts-show-more {
    width: 100%; padding: 8px 16px; margin-top: 4px;
    font-size: 11px; font-weight: 600; color: var(--accent-purple-light);
    background: var(--bg-card); border: 1px dashed var(--border-subtle);
    border-radius: var(--radius-md); cursor: pointer;
    transition: all var(--transition-fast); text-align: center;
}
.alerts-show-more:hover { background: var(--bg-elevated); border-color: var(--accent-purple); color: var(--text-primary); }
.alerts-grid {
    display: flex; gap: 10px; flex-wrap: wrap;
}
.alert-card {
    flex: 1; min-width: 220px; max-width: 350px;
    padding: 12px 16px;
    background: var(--bg-card);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    font-size: 12px;
    display: flex; align-items: flex-start; gap: 10px;
    cursor: pointer;
    transition: all var(--transition-fast);
    position: relative;
}
.alert-card:hover {
    border-color: var(--border-default);
    transform: translateY(-1px);
    box-shadow: var(--shadow-card);
}
.alert-card.critical { border-left: 3px solid var(--rag-red); }
.alert-card.warning { border-left: 3px solid var(--rag-amber); }
.alert-card.info { border-left: 3px solid #579bfc; }
.alert-icon {
    font-size: 18px; flex-shrink: 0; margin-top: 1px;
}
.alert-content { flex: 1; }
.alert-title {
    font-weight: 600; color: var(--text-primary); margin-bottom: 2px;
    padding-right: 18px;
}
.alert-desc {
    color: var(--text-muted); line-height: 1.4;
}
.alert-timestamp {
    font-size: 10px; color: var(--text-muted); margin-top: 4px;
    display: flex; align-items: center; gap: 4px; opacity: 0.7;
}
.alert-timestamp .ts-dot {
    width: 4px; height: 4px; border-radius: 50%; flex-shrink: 0;
}
.alert-timestamp .ts-dot.fresh { background: var(--rag-green); }
.alert-timestamp .ts-dot.recent { background: var(--rag-amber); }
.alert-timestamp .ts-dot.aged { background: var(--rag-red); }
.alert-dismiss {
    position: absolute; top: 8px; right: 8px;
    width: 22px; height: 22px;
    display: flex; align-items: center; justify-content: center;
    background: var(--bg-elevated); border: 1px solid var(--border-subtle);
    border-radius: 50%; color: var(--text-muted);
    font-size: 13px; line-height: 1; cursor: pointer;
    opacity: 0; transition: all var(--transition-fast);
    z-index: 2;
}
.alert-card:hover .alert-dismiss { opacity: 1; }
.alert-dismiss:hover {
    background: var(--rag-red); color: #fff;
    border-color: var(--rag-red); transform: scale(1.1);
}

/* ========================================================
   KPI CARDS ROW
   ======================================================== */
.kpi-row {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 12px; margin-bottom: 24px;
}
.kpi-card {
    background: var(--bg-card);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: 16px 18px;
    position: relative; overflow: hidden;
    transition: all var(--transition-default);
    cursor: pointer;
}
.kpi-card:hover {
    border-color: var(--border-default);
    transform: translateY(-2px);
    box-shadow: var(--shadow-card);
}
.kpi-card.active-filter {
    border-color: var(--accent-purple);
    box-shadow: var(--shadow-glow);
}
.kpi-card .kpi-accent {
    position: absolute; left: 0; top: 0; bottom: 0;
    width: 3px; border-radius: 3px 0 0 3px;
}
.kpi-card .kpi-icon {
    font-size: 18px; margin-bottom: 6px; display: block;
}
.kpi-card .kpi-value {
    font-size: 28px; font-weight: 700; color: var(--text-white);
    line-height: 1.1; margin-bottom: 2px;
}
.kpi-card .kpi-label {
    font-size: 11px; font-weight: 500; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.5px;
}
.kpi-card .kpi-sub {
    font-size: 10px; color: var(--text-muted); margin-top: 4px;
    opacity: 0.7;
}

/* ========================================================
   CHARTS SECTION
   ======================================================== */
.charts-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px; margin-bottom: 24px;
}
.chart-card {
    background: var(--bg-card);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: 20px;
}
.chart-card h3 {
    font-size: 13px; font-weight: 600; color: var(--text-secondary);
    text-transform: uppercase; letter-spacing: 0.5px;
    margin-bottom: 16px;
}
.chart-wrapper {
    position: relative; height: 220px;
}
.chart-wrapper canvas { max-height: 100%; }

/* ========================================================
   CLIENT CARDS GRID
   ======================================================== */
.section-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 16px;
}
.section-header h2 {
    font-size: 18px; font-weight: 600; color: var(--text-white);
}
.section-header .header-right {
    display: flex; align-items: center; gap: 10px;
}
.section-header .count-badge {
    background: var(--bg-elevated); color: var(--text-secondary);
    padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;
}
.clients-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: 16px; margin-bottom: 24px;
}
.client-card {
    background: var(--bg-card);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    overflow: hidden;
    transition: all var(--transition-default);
    cursor: default;
    position: relative;
}
.client-card:hover {
    border-color: var(--border-default);
    box-shadow: var(--shadow-card);
}
.client-card.stale-warning {
    border-color: rgba(253,171,61,0.4);
}
.client-card.stale-critical {
    border-color: rgba(223,47,74,0.4);
}
.client-card-header {
    padding: 16px 18px 12px;
    display: flex; align-items: flex-start; justify-content: space-between;
    gap: 12px;
}
.client-name-group {
    flex: 1; min-width: 0;
}
.client-name {
    font-size: 16px; font-weight: 600; color: var(--text-white);
    cursor: pointer; transition: color var(--transition-fast);
}
.client-name:hover { color: var(--accent-purple-light); }
.client-domain {
    font-size: 12px; color: var(--text-muted);
    display: block; margin-top: 2px;
}
.client-domain a { color: var(--text-muted); font-size: 11px; }
.client-domain a:hover { color: var(--accent-purple-light); }
.health-score {
    display: flex; align-items: center; gap: 6px;
    margin-top: 4px;
}
.health-bar {
    width: 60px; height: 4px; border-radius: 2px;
    background: var(--bg-elevated); overflow: hidden;
}
.health-bar-fill {
    height: 100%; border-radius: 2px;
    transition: width 0.5s ease, background 0.5s ease;
}
.health-label {
    font-size: 10px; font-weight: 600;
}
.card-header-right {
    display: flex; flex-direction: column; align-items: flex-end; gap: 4px;
}

/* Badges */
.badge {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 3px 10px; border-radius: 4px;
    font-size: 11px; font-weight: 600;
    cursor: pointer; position: relative;
    transition: all var(--transition-fast);
    border: 1px solid transparent;
    white-space: nowrap;
}
.badge:hover { filter: brightness(1.15); transform: scale(1.02); }
.badge-green { background: var(--rag-green-bg); color: var(--rag-green); border-color: rgba(0,200,117,0.25); }
.badge-amber { background: var(--rag-amber-bg); color: var(--rag-amber); border-color: rgba(253,171,61,0.25); }
.badge-red { background: var(--rag-red-bg); color: var(--rag-red); border-color: rgba(223,47,74,0.25); }
.badge-blue { background: rgba(87,155,252,0.12); color: #579bfc; border-color: rgba(87,155,252,0.25); }
.badge-purple { background: rgba(107,48,255,0.12); color: var(--accent-purple-light); border-color: rgba(107,48,255,0.25); }
.badge-gray { background: rgba(150,150,150,0.12); color: #999; border-color: rgba(150,150,150,0.25); }
.badge-teal { background: rgba(0,126,181,0.12); color: #007eb5; border-color: rgba(0,126,181,0.25); }

/* Status badges row */
.client-badges {
    padding: 0 18px 12px;
    display: flex; flex-wrap: wrap; gap: 6px;
}

/* Inline edit dropdown */
.inline-dropdown {
    position: absolute; top: 100%; left: 0; z-index: 600;
    background: var(--bg-elevated);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-elevated);
    min-width: 140px; padding: 4px;
    animation: fadeIn 0.15s ease;
}
@keyframes fadeIn { from { opacity:0; transform:translateY(-4px); } to { opacity:1; transform:translateY(0); } }
.inline-dropdown .dd-option {
    padding: 6px 10px; border-radius: 4px;
    font-size: 12px; color: var(--text-primary);
    cursor: pointer; display: flex; align-items: center; gap: 6px;
    transition: background var(--transition-fast);
}
.inline-dropdown .dd-option:hover { background: var(--bg-hover); }
.inline-dropdown .dd-option .dd-dot {
    width: 8px; height: 8px; border-radius: 50%;
    flex-shrink: 0;
}

/* Sliders */
.client-sliders {
    padding: 0 18px 14px;
}
.slider-group {
    display: flex; align-items: center; gap: 8px;
    margin-bottom: 6px;
}
.slider-label {
    font-size: 10px; font-weight: 600; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.3px;
    width: 70px; flex-shrink: 0;
}
.slider-track {
    flex: 1; height: 6px; border-radius: 3px;
    -webkit-appearance: none; appearance: none;
    background: var(--bg-elevated); outline: none;
    cursor: pointer;
}
.slider-track.confidence::-webkit-slider-thumb {
    -webkit-appearance: none; width: 14px; height: 14px;
    border-radius: 50%; border: 2px solid var(--bg-card);
    cursor: pointer;
}
.slider-track.progress::-webkit-slider-thumb {
    -webkit-appearance: none; width: 14px; height: 14px;
    border-radius: 50%; background: var(--accent-purple);
    border: 2px solid var(--bg-card); cursor: pointer;
}
.slider-track.confidence::-moz-range-thumb {
    width: 14px; height: 14px; border-radius: 50%;
    border: 2px solid var(--bg-card); cursor: pointer;
}
.slider-track.progress::-moz-range-thumb {
    width: 14px; height: 14px; border-radius: 50%;
    background: var(--accent-purple); border: 2px solid var(--bg-card); cursor: pointer;
}
.slider-value {
    font-size: 11px; font-weight: 600; color: var(--text-secondary);
    width: 32px; text-align: right;
}

/* Summary preview */
.client-summary {
    padding: 0 18px 14px;
    font-size: 12px; color: var(--text-muted);
    line-height: 1.5;
    display: -webkit-box; -webkit-line-clamp: 3;
    -webkit-box-orient: vertical; overflow: hidden;
}

/* Footer */
.client-footer {
    padding: 10px 18px;
    background: var(--bg-secondary);
    border-top: 1px solid var(--border-subtle);
    display: flex; align-items: center; justify-content: space-between;
    font-size: 11px; color: var(--text-muted);
}
.client-footer .meta-item {
    display: flex; align-items: center; gap: 4px;
}
.client-footer .meta-item.warning { color: var(--rag-amber); }
.client-footer .meta-item.danger { color: var(--rag-red); }
.btn-detail {
    padding: 4px 10px; border-radius: 4px;
    background: var(--accent-purple); color: white;
    font-size: 11px; font-weight: 600;
    transition: all var(--transition-fast);
}
.btn-detail:hover { background: var(--accent-purple-light); }

/* ========================================================
   DETAIL PANEL (SLIDE-OUT)
   ======================================================== */
.detail-backdrop {
    position: fixed; inset: 0; z-index: 700;
    background: rgba(0,0,0,0.5);
    opacity: 0; pointer-events: none;
    transition: opacity var(--transition-smooth);
}
.detail-backdrop.open { opacity: 1; pointer-events: auto; }
.detail-panel {
    position: fixed; right: 0; top: 0; bottom: 0; z-index: 800;
    width: 520px; max-width: 95vw;
    background: var(--bg-card);
    border-left: 1px solid var(--border-default);
    box-shadow: var(--shadow-elevated);
    transform: translateX(100%);
    transition: transform var(--transition-smooth);
    overflow-y: auto;
    display: flex; flex-direction: column;
}
.detail-panel.open { transform: translateX(0); }
.detail-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border-subtle);
    display: flex; align-items: flex-start; justify-content: space-between;
    position: sticky; top: 0; background: var(--bg-card); z-index: 10;
}
.detail-header h2 { font-size: 18px; font-weight: 700; color: var(--text-white); }
.detail-header .detail-subtitle { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
.btn-close-detail {
    width: 32px; height: 32px; border-radius: var(--radius-sm);
    background: var(--bg-elevated); color: var(--text-secondary);
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; transition: all var(--transition-fast);
}
.btn-close-detail:hover { background: var(--rag-red); color: white; }
.detail-body { padding: 20px 24px; flex: 1; }
.detail-section {
    margin-bottom: 24px;
}
.detail-section h3 {
    font-size: 11px; font-weight: 700; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.8px;
    margin-bottom: 12px; padding-bottom: 6px;
    border-bottom: 1px solid var(--border-subtle);
}
.detail-field {
    margin-bottom: 12px;
}
.detail-field label {
    display: block; font-size: 11px; font-weight: 600;
    color: var(--text-muted); margin-bottom: 4px;
}
.detail-field input, .detail-field textarea, .detail-field select {
    width: 100%; padding: 8px 12px;
    background: var(--bg-input); border: 1px solid var(--border-subtle);
    border-radius: var(--radius-sm); color: var(--text-primary);
    font-size: 13px; transition: border-color var(--transition-fast);
}
.detail-field input:focus, .detail-field textarea:focus, .detail-field select:focus {
    border-color: var(--accent-purple);
}
.detail-field textarea { resize: vertical; min-height: 100px; line-height: 1.5; }
.detail-field .read-only {
    padding: 8px 12px; background: var(--bg-secondary);
    border: 1px solid var(--border-subtle); border-radius: var(--radius-sm);
    font-size: 13px; color: var(--text-secondary);
}
.detail-field-row {
    display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
}
.agents-list {
    display: flex; flex-direction: column; gap: 6px;
}
.agent-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 12px; background: var(--bg-secondary);
    border-radius: var(--radius-sm); border: 1px solid var(--border-subtle);
}
.agent-item .agent-name { font-size: 13px; font-weight: 500; color: var(--text-primary); }
.agent-item .agent-stage {
    font-size: 10px; font-weight: 600; padding: 2px 8px;
    border-radius: 4px;
}
.detail-footer {
    padding: 16px 24px;
    border-top: 1px solid var(--border-subtle);
    display: flex; gap: 10px;
    position: sticky; bottom: 0; background: var(--bg-card);
}
.btn-save {
    flex: 1; padding: 10px;
    background: linear-gradient(135deg, #6B30FF, #5020CC);
    color: white; border-radius: var(--radius-md);
    font-weight: 600; font-size: 13px;
    transition: all var(--transition-fast);
}
.btn-save:hover { background: linear-gradient(135deg, #7B40FF, #6030DD); }
.btn-save:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-secondary {
    padding: 10px 16px;
    background: var(--bg-elevated); color: var(--text-secondary);
    border: 1px solid var(--border-default); border-radius: var(--radius-md);
    font-weight: 500; font-size: 13px;
    transition: all var(--transition-fast);
}
.btn-secondary:hover { border-color: var(--accent-purple); color: var(--text-primary); }

/* ========================================================
   TOAST NOTIFICATIONS
   ======================================================== */
.toast-container {
    position: fixed; top: 20px; right: 20px; z-index: 9000;
    display: flex; flex-direction: column; gap: 8px;
}
.toast {
    padding: 12px 18px; border-radius: var(--radius-md);
    font-size: 13px; font-weight: 500;
    box-shadow: var(--shadow-elevated);
    animation: toastIn 0.3s ease;
    display: flex; align-items: center; gap: 8px;
    max-width: 360px;
}
.toast.success { background: #0a2e1a; color: var(--rag-green); border: 1px solid rgba(0,200,117,0.3); }
.toast.error { background: #2e0a14; color: var(--rag-red); border: 1px solid rgba(223,47,74,0.3); }
.toast.info { background: #0a1a2e; color: #579bfc; border: 1px solid rgba(87,155,252,0.3); }
.toast.warning { background: #2e1a0a; color: var(--rag-amber); border: 1px solid rgba(253,171,61,0.3); }
@keyframes toastIn { from { opacity:0; transform:translateX(40px); } to { opacity:1; transform:translateX(0); } }

/* ========================================================
   EMPTY & ERROR STATES
   ======================================================== */
.empty-state {
    text-align: center; padding: 60px 20px;
    color: var(--text-muted);
}
.empty-state .empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.3; }
.empty-state h3 { color: var(--text-secondary); margin-bottom: 4px; }

/* ========================================================
   KEYBOARD SHORTCUT HINT
   ======================================================== */
.shortcuts-panel {
    position: fixed; bottom: 20px; left: 20px; z-index: 400;
    background: var(--bg-card); border: 1px solid var(--border-default);
    border-radius: var(--radius-lg); padding: 16px 20px;
    box-shadow: var(--shadow-elevated);
    font-size: 12px; color: var(--text-secondary);
    max-width: 280px;
    transition: all var(--transition-smooth);
    transform: translateY(120%); opacity: 0;
}
.shortcuts-panel.visible { transform: translateY(0); opacity: 1; }
.shortcuts-panel h4 {
    font-size: 11px; font-weight: 700; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;
}
.shortcut-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 3px 0;
}
.shortcut-key {
    background: var(--bg-elevated); padding: 2px 6px;
    border-radius: 3px; font-size: 11px; font-weight: 600;
    border: 1px solid var(--border-subtle); color: var(--text-primary);
}

/* ========================================================
   EMAIL ACTIVITY SECTION
   ======================================================== */
.email-section {
    margin-bottom: 24px;
}
.email-section-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 12px;
}
.email-section-header h2 {
    font-size: 18px; font-weight: 600; color: var(--text-white);
    display: flex; align-items: center; gap: 8px;
}
.email-section-header .email-meta {
    font-size: 11px; color: var(--text-muted);
}
.email-sync-status { display: flex; align-items: center; gap: 10px; }
.email-sync-text { font-size: 12px; color: var(--text-muted); white-space: nowrap; }
.email-sync-text.live { color: var(--rag-green); }
.email-sync-text.error { color: var(--rag-amber); }
.email-sync-btn {
    background: rgba(107,48,255,0.15); color: var(--accent-purple-light);
    border: 1px solid rgba(107,48,255,0.3); border-radius: var(--radius-sm);
    padding: 5px 14px; font-size: 12px; cursor: pointer; transition: all 0.2s;
    white-space: nowrap; font-weight: 500;
}
.email-sync-btn:hover { background: rgba(107,48,255,0.25); border-color: rgba(107,48,255,0.5); }
.email-sync-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.email-cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: 14px;
}
.email-card {
    background: var(--bg-card);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    padding: 18px 20px;
    cursor: pointer;
    transition: all var(--transition-fast);
    position: relative;
}
.email-card:hover {
    border-color: var(--border-default);
    transform: translateY(-1px);
    box-shadow: var(--shadow-card);
}
.email-card.needs-response {
    border-left: 3px solid var(--rag-amber);
}
.email-card.within-grace {
    border-left: 3px solid #579bfc;
}
.email-card.awaiting {
    border-left: 3px solid #579bfc;
}
.email-card.stale-email {
    border-left: 3px solid var(--rag-red);
}
.email-card-header {
    display: flex; align-items: flex-start; justify-content: space-between;
    margin-bottom: 8px;
}
.email-client-name {
    font-size: 14px; font-weight: 600; color: var(--text-white);
}
.email-status-tag {
    font-size: 10px; font-weight: 600; padding: 3px 10px;
    border-radius: 4px; white-space: nowrap;
}
.email-status-tag.needs-response {
    background: var(--rag-amber-bg); color: var(--rag-amber);
}
.email-status-tag.within-grace {
    background: rgba(87,155,252,0.12); color: #579bfc;
}
.email-status-tag.awaiting {
    background: rgba(87,155,252,0.12); color: #579bfc;
}
.email-status-tag.stale-email {
    background: var(--rag-red-bg); color: var(--rag-red);
}
.email-status-tag.up-to-date {
    background: var(--rag-green-bg); color: var(--rag-green);
}
.email-status-tag.discontinued {
    background: rgba(102,102,102,0.15); color: var(--text-muted);
}
.email-card.discontinued {
    opacity: 0.6; border-left-color: var(--text-muted);
}
.email-subject {
    font-size: 13px; color: var(--text-secondary);
    margin-bottom: 8px;
    line-height: 1.5;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
    overflow: hidden;
}
.email-meta-row {
    display: flex; align-items: center; gap: 14px;
    font-size: 12px; color: var(--text-muted);
    padding-top: 8px; border-top: 1px solid var(--border-subtle);
}
.email-meta-row .email-from {
    font-weight: 500;
}
.email-open-link {
    font-size: 11px; color: var(--accent-purple-light);
    opacity: 0; transition: opacity var(--transition-fast);
    margin-left: auto; text-decoration: none; white-space: nowrap;
}
.email-card:hover .email-open-link { opacity: 1; }
/* Email card hide/restore controls */
.email-hide-btn {
    position: absolute; top: 12px; right: 12px;
    font-size: 11px; color: var(--text-muted);
    opacity: 0; transition: opacity var(--transition-fast);
    cursor: pointer; background: none; border: none; padding: 2px 6px;
    border-radius: var(--radius-sm); z-index: 2;
}
.email-hide-btn:hover { color: var(--rag-red); background: var(--rag-red-bg); }
.email-card:hover .email-hide-btn { opacity: 1; }
.email-card.email-card-hidden {
    opacity: 0.45; border-style: dashed; filter: grayscale(0.3);
}
.email-card.email-card-hidden:hover { opacity: 0.7; }
.email-restore-btn {
    position: absolute; top: 12px; right: 12px;
    font-size: 10px; font-weight: 600; color: var(--accent-purple-light);
    background: rgba(107,48,255,0.1); border: 1px solid rgba(107,48,255,0.2);
    padding: 3px 10px; border-radius: var(--radius-sm);
    cursor: pointer; transition: all var(--transition-fast); z-index: 2;
}
.email-restore-btn:hover { background: rgba(107,48,255,0.2); border-color: var(--accent-purple); color: var(--text-white); }
.email-hidden-toggle {
    width: 100%; padding: 8px 16px; margin-top: 10px;
    font-size: 11px; font-weight: 600; color: var(--accent-purple-light);
    background: var(--bg-card); border: 1px dashed var(--border-subtle);
    border-radius: var(--radius-md); cursor: pointer;
    transition: all var(--transition-fast); text-align: center;
    grid-column: 1 / -1;
}
.email-hidden-toggle:hover { background: var(--bg-elevated); border-color: var(--accent-purple); color: var(--text-primary); }

/* Watermark */
.watermark-credit {
    position: fixed; bottom: 6px; right: 12px; font-size: 9px;
    color: var(--text-muted); opacity: 0.15; pointer-events: none; z-index: 0;
    font-family: var(--font-sans); letter-spacing: 0.5px;
}

/* Email in detail panel */
.detail-emails-list {
    display: flex; flex-direction: column; gap: 8px;
}
.detail-email-item {
    padding: 10px 12px; background: var(--bg-secondary);
    border-radius: var(--radius-sm); border: 1px solid var(--border-subtle);
    cursor: pointer; transition: all var(--transition-fast);
}
.detail-email-item:hover {
    border-color: var(--border-default);
    background: var(--bg-elevated);
}
.detail-email-subject {
    font-size: 12px; font-weight: 500; color: var(--text-primary);
    margin-bottom: 3px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.detail-email-meta {
    font-size: 11px; color: var(--text-muted);
    display: flex; gap: 8px;
}

/* ========================================================
   THEME TOGGLE
   ======================================================== */
.theme-toggle {
    display: flex; align-items: center;
    background: var(--bg-elevated); border: 1px solid var(--border-subtle);
    border-radius: 20px; padding: 2px; gap: 0;
    height: 30px;
}
.theme-toggle button {
    width: 28px; height: 26px; border-radius: 14px;
    background: transparent; border: none; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px; color: var(--text-muted);
    transition: all var(--transition-fast);
    padding: 0;
}
.theme-toggle button:hover { color: var(--text-primary); }
.theme-toggle button.active {
    background: var(--accent-purple); color: white;
    box-shadow: 0 1px 3px rgba(107,48,255,0.3);
}

/* Light-mode overrides for specific elements */
[data-theme="light"] .setup-overlay { background: rgba(0,0,0,0.5); }
[data-theme="light"] .loading-overlay { background: var(--bg-primary); }
[data-theme="light"] .detail-panel { box-shadow: var(--shadow-elevated); }
[data-theme="light"] .toast.success { background: #e6f9f0; color: #006644; border-color: rgba(0,200,117,0.3); }
[data-theme="light"] .toast.error { background: #fff0f0; color: #bf2600; border-color: rgba(223,47,74,0.3); }
[data-theme="light"] .toast.info { background: #e9ecff; color: #6B30FF; border-color: rgba(107,48,255,0.3); }
[data-theme="light"] .toast.warning { background: #fff8e6; color: #ff8b00; border-color: rgba(253,171,61,0.3); }
[data-theme="light"] .filter-pill .pill-count { background: rgba(0,0,0,0.1); }

/* ========================================================
   TARGETS & GOALS TRACKER
   ======================================================== */
.targets-section {
    margin-bottom: 32px;
}
.targets-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 16px;
}
.targets-header h2 { font-size: 18px; font-weight: 700; color: var(--text-white); }
.btn-add-target {
    padding: 6px 14px; border-radius: 20px;
    background: var(--accent-purple); color: white;
    font-size: 12px; font-weight: 600;
    transition: all var(--transition-fast);
}
.btn-add-target:hover { background: var(--accent-purple-light); transform: translateY(-1px); }
.targets-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
}
.target-card {
    background: var(--bg-card); border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg); padding: 20px;
    transition: all var(--transition-fast); cursor: pointer;
}
.target-card:hover { border-color: var(--accent-purple); box-shadow: var(--shadow-glow); }
.target-card .target-expand-indicator {
    font-size: 12px; color: var(--text-muted); transition: transform 0.3s ease;
    margin-left: 8px; display: inline-block;
}
.target-card.expanded .target-expand-indicator { transform: rotate(180deg); }
.target-detail-panel {
    max-height: 0; overflow: hidden; transition: max-height 0.4s ease, opacity 0.3s ease, margin-top 0.3s ease;
    opacity: 0; margin-top: 0;
}
.target-card.expanded .target-detail-panel {
    max-height: 2000px; opacity: 1; margin-top: 14px; overflow-y: auto;
}
.target-detail-panel-inner {
    border-top: 1px solid var(--border-subtle); padding-top: 14px;
}
.target-detail-description {
    font-size: 13px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 12px;
}
.target-detail-description strong { color: var(--text-primary); font-weight: 600; }
.target-client-list { display: flex; flex-direction: column; gap: 6px; }
.target-client-item {
    display: flex; align-items: center; flex-wrap: wrap; gap: 6px 10px;
    padding: 10px 12px; background: var(--bg-elevated); border-radius: var(--radius-md);
    font-size: 12px; color: var(--text-primary);
}
.target-client-item > span:first-child { font-weight: 500; min-width: 80px; }
.target-client-item-actions { display: flex; gap: 4px; margin-left: auto; flex-shrink: 0; }
.target-client-item .tcl-status {
    font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 10px;
}
.target-client-item .tcl-status.met { background: rgba(0,200,117,0.15); color: var(--rag-green); }
.target-client-item .tcl-status.unmet { background: rgba(232,73,73,0.15); color: var(--rag-red); }
.target-exclude-btn, .target-include-btn {
    background: none; border: 1px solid var(--border-subtle); border-radius: var(--radius-sm);
    cursor: pointer; font-size: 13px; width: 26px; height: 26px;
    display: inline-flex; align-items: center; justify-content: center;
    transition: all var(--transition-fast); flex-shrink: 0; margin-left: 8px;
}
.target-exclude-btn { color: var(--text-muted); }
.target-exclude-btn:hover { color: var(--rag-red); border-color: var(--rag-red); background: rgba(232,73,73,0.1); }
.target-include-btn { color: var(--text-muted); }
.target-include-btn:hover { color: var(--rag-green); border-color: var(--rag-green); background: rgba(0,200,117,0.1); }
.target-override-btn {
    background: none; border: 1px solid var(--border-subtle); border-radius: var(--radius-sm);
    cursor: pointer; font-size: 13px; width: 26px; height: 26px;
    display: inline-flex; align-items: center; justify-content: center;
    transition: all var(--transition-fast); flex-shrink: 0; margin-left: 4px;
    color: var(--text-muted);
}
.target-override-btn:hover { color: var(--rag-green); border-color: var(--rag-green); background: rgba(0,200,117,0.1); }
.target-override-btn.revert { color: var(--rag-amber); }
.target-override-btn.revert:hover { color: var(--rag-amber); border-color: var(--rag-amber); background: rgba(255,203,0,0.1); }
.target-client-item .tcl-status.manual { background: rgba(255,203,0,0.15); color: var(--rag-amber); }
.target-client-item.manually-overridden { border-left: 2px solid var(--rag-amber); }
.target-client-item.excluded {
    opacity: 0.5; text-decoration: line-through;
}
.target-excluded-section {
    margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--border-subtle);
}
.target-excluded-section .excluded-label {
    font-size: 11px; color: var(--text-muted); text-transform: uppercase;
    letter-spacing: 0.5px; margin-bottom: 6px; font-weight: 600;
}
.target-detail-stats {
    display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap;
}
.target-detail-stat {
    display: flex; flex-direction: column; align-items: center; padding: 10px 16px;
    background: var(--bg-elevated); border-radius: var(--radius-md); min-width: 80px;
}
.target-detail-stat .tds-value { font-size: 20px; font-weight: 700; color: var(--text-white); }
.target-detail-stat .tds-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }
.target-deadline-info {
    display: flex; align-items: center; gap: 8px; padding: 8px 12px;
    background: rgba(255,102,41,0.08); border: 1px solid rgba(255,102,41,0.2);
    border-radius: var(--radius-md); margin-bottom: 12px; font-size: 12px; color: var(--accent-orange);
}
.target-detail-hint {
    font-size: 11px; color: var(--text-muted); font-style: italic; margin-top: 10px;
}
.target-card-header {
    display: flex; align-items: flex-start; justify-content: space-between;
    margin-bottom: 12px;
}
.target-title { font-size: 14px; font-weight: 600; color: var(--text-white); flex: 1; }
.target-type-badge {
    font-size: 10px; padding: 2px 8px; border-radius: 10px;
    font-weight: 600; white-space: nowrap; margin-left: 8px;
}
.target-type-badge.auto { background: rgba(107,48,255,0.15); color: var(--accent-purple-light); }
.target-type-badge.manual { background: rgba(255,102,41,0.15); color: var(--accent-orange); }
.target-progress-row {
    display: flex; align-items: center; gap: 10px; margin-bottom: 8px;
}
.target-progress-bar {
    flex: 1; height: 8px; background: var(--bg-elevated);
    border-radius: 4px; overflow: hidden;
}
.target-progress-fill {
    height: 100%; border-radius: 4px;
    transition: width 0.5s ease;
}
.target-fraction {
    font-size: 14px; font-weight: 700; min-width: 50px; text-align: right;
    color: var(--text-primary);
}
.target-meta {
    display: flex; align-items: center; justify-content: space-between;
    font-size: 11px; color: var(--text-muted); margin-top: 6px;
}
.target-actions { display: flex; gap: 6px; }
.target-actions button {
    background: var(--bg-elevated); color: var(--text-secondary);
    border: 1px solid var(--border-subtle); border-radius: var(--radius-sm);
    padding: 3px 8px; font-size: 11px; cursor: pointer;
    transition: all var(--transition-fast);
}
.target-actions button:hover { border-color: var(--accent-purple); color: var(--text-primary); }
.target-actions button.delete:hover { border-color: var(--rag-red); color: var(--rag-red); }
.target-deadline { color: var(--accent-orange); font-weight: 500; }
.target-complete { color: var(--rag-green); }

/* Target Modal */
.target-modal-overlay {
    position: fixed; inset: 0; z-index: 9000;
    background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none; transition: opacity 0.2s ease;
}
.target-modal-overlay.open { opacity: 1; pointer-events: auto; }
.target-modal {
    background: var(--bg-card); border: 1px solid var(--border-default);
    border-radius: var(--radius-xl); padding: 32px;
    max-width: 420px; width: 90%;
    box-shadow: var(--shadow-elevated);
}
.target-modal h3 { color: var(--text-white); margin-bottom: 20px; font-size: 18px; }
.target-modal .field { margin-bottom: 14px; }
.target-modal .field label {
    display: block; font-size: 12px; font-weight: 600;
    color: var(--text-secondary); margin-bottom: 6px;
    text-transform: uppercase; letter-spacing: 0.5px;
}
.target-modal .field input {
    width: 100%; padding: 10px 12px;
    background: var(--bg-input); border: 1px solid var(--border-default);
    border-radius: var(--radius-md); color: var(--text-primary); font-size: 14px;
}
.target-modal .field input:focus { border-color: var(--accent-purple); }
.target-modal-actions {
    display: flex; gap: 10px; margin-top: 20px;
}
.target-modal-actions .btn-primary { flex: 1; }
.target-modal-actions .btn-cancel {
    flex: 1; padding: 10px; border-radius: var(--radius-md);
    background: var(--bg-elevated); color: var(--text-secondary);
    border: 1px solid var(--border-default); font-weight: 500; font-size: 14px;
}
.target-modal-actions .btn-cancel:hover { color: var(--text-primary); border-color: var(--text-muted); }

/* ========================================================
   CLIENT NOTES
   ======================================================== */
.notes-badge {
    font-size: 11px; color: var(--accent-purple-light); cursor: pointer;
    display: inline-flex; align-items: center; gap: 3px;
    opacity: 0.8; transition: opacity var(--transition-fast);
}
.notes-badge:hover { opacity: 1; text-decoration: underline; }
.detail-notes-section { margin-top: 4px; }
.note-input-row {
    display: flex; gap: 8px; margin-bottom: 12px;
}
.note-input-row input {
    flex: 1; padding: 8px 12px;
    background: var(--bg-input); border: 1px solid var(--border-default);
    border-radius: var(--radius-md); color: var(--text-primary); font-size: 13px;
}
.note-input-row input:focus { border-color: var(--accent-purple); }
.note-input-row button {
    padding: 8px 14px; border-radius: var(--radius-md);
    background: var(--accent-purple); color: white;
    font-size: 12px; font-weight: 600;
    white-space: nowrap;
}
.note-input-row button:hover { background: var(--accent-purple-light); }
.notes-list { display: flex; flex-direction: column; gap: 8px; }
.note-item {
    background: var(--bg-secondary); border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md); padding: 10px 12px;
    display: flex; align-items: flex-start; gap: 10px;
}
.note-item .note-content { flex: 1; }
.note-item .note-text { font-size: 13px; color: var(--text-primary); line-height: 1.5; }
.note-item .note-time { font-size: 10px; color: var(--text-muted); margin-top: 3px; }
.note-item .note-delete {
    background: none; color: var(--text-muted); font-size: 14px;
    padding: 2px; cursor: pointer; flex-shrink: 0;
    transition: color var(--transition-fast);
}
.note-item .note-delete:hover { color: var(--rag-red); }

/* ========================================================
   EDITABLE SECTIONS
   ======================================================== */
.client-summary[data-editable] {
    cursor: pointer; position: relative;
    border: 1px solid transparent; border-radius: var(--radius-sm);
    padding: 6px 8px; margin: -6px -8px;
    transition: all var(--transition-fast);
}
.client-summary[data-editable]:hover {
    border-color: var(--border-default);
    background: var(--bg-elevated);
}
.client-summary[data-editable]::after {
    content: '\270E'; position: absolute; top: 4px; right: 6px;
    font-size: 12px; color: var(--text-muted);
    opacity: 0.6; transition: opacity var(--transition-fast);
}
.client-summary[data-editable]:hover::after { opacity: 1; color: var(--accent-purple); }
.client-summary.editing {
    border-color: var(--accent-purple) !important;
    background: transparent !important;
    cursor: default;
}
.client-summary.editing::after { display: none; }
.client-summary.editing textarea {
    width: 100%; min-height: 80px; padding: 8px;
    background: var(--bg-input); border: 1px solid var(--border-default);
    border-radius: var(--radius-sm); color: var(--text-primary);
    font-size: 12px; line-height: 1.5; resize: vertical;
    font-family: inherit;
}
.client-summary.editing textarea:focus { border-color: var(--accent-purple); }
.edit-save-hint {
    font-size: 10px; color: var(--text-muted); margin-top: 4px;
    text-align: right;
}
.email-note {
    margin-top: 6px; padding-top: 6px;
    border-top: 1px solid var(--border-subtle);
}
.email-note-text {
    font-size: 11px; color: var(--accent-purple-light);
    cursor: pointer; font-style: italic;
    padding: 2px 4px; border-radius: 3px;
    transition: all var(--transition-fast);
}
.email-note-text:hover { background: var(--bg-elevated); }
.email-note-text.placeholder { color: var(--text-muted); opacity: 0.6; }
.email-note-input {
    width: 100%; padding: 4px 6px;
    background: var(--bg-input); border: 1px solid var(--accent-purple);
    border-radius: 3px; color: var(--text-primary);
    font-size: 11px; font-family: inherit;
}

/* ========================================================
   SIDEBAR / BURGER MENU
   ======================================================== */
.burger-btn {
    width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
    background: transparent; border: 1px solid var(--border-default); border-radius: var(--radius-md);
    color: var(--text-primary); font-size: 22px; cursor: pointer; transition: all var(--transition-fast);
    flex-shrink: 0;
}
.burger-btn:hover { background: var(--bg-elevated); border-color: var(--accent-purple); color: var(--accent-purple); }
.sidebar-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999;
    opacity: 0; pointer-events: none; transition: opacity var(--transition-smooth);
}
.sidebar-overlay.visible { opacity: 1; pointer-events: auto; }
.sidebar {
    position: fixed; top: 0; left: 0; width: 260px; height: 100vh;
    background: var(--card-bg); border-right: 1px solid var(--border-default);
    z-index: 1000; transform: translateX(-260px); transition: transform var(--transition-smooth);
    display: flex; flex-direction: column; overflow-y: auto;
}
.sidebar.open { transform: translateX(0); }
.sidebar-header {
    padding: 20px 20px 16px; font-size: 16px; font-weight: 700; color: var(--text-primary);
    border-bottom: 1px solid var(--border-default); display: flex; align-items: center; gap: 10px;
}
.sidebar-header::before {
    content: 'IAI'; display: inline-flex; align-items: center; justify-content: center;
    width: 32px; height: 32px; background: linear-gradient(135deg, #6B30FF, #FF6629); color: #fff;
    border-radius: var(--radius-sm); font-size: 11px; font-weight: 800; flex-shrink: 0; letter-spacing: 0.3px;
}
.sidebar-nav-item {
    display: flex; align-items: center; gap: 12px; padding: 14px 20px;
    color: var(--text-secondary); font-size: 14px; font-weight: 500;
    cursor: pointer; transition: all var(--transition-fast);
    border-left: 3px solid transparent; text-decoration: none;
}
.sidebar-nav-item:hover { background: var(--bg-elevated); color: var(--text-primary); }
.sidebar-nav-item.active {
    background: rgba(107,48,255,0.08); color: var(--accent-purple);
    border-left-color: var(--accent-purple); font-weight: 600;
}
.sidebar-nav-item .nav-icon { font-size: 18px; width: 24px; text-align: center; }
.sidebar-close {
    position: absolute; top: 16px; right: 12px; background: none; border: none;
    color: var(--text-muted); font-size: 20px; cursor: pointer; padding: 4px 8px;
}
.sidebar-close:hover { color: var(--text-primary); }

/* ========================================================
   PAGE CONTAINERS (SPA)
   ======================================================== */
.page-container { display: none; }
.page-container.page-active { display: block; }

/* ========================================================
   OVERVIEW PAGE
   ======================================================== */
.overview-clients-header {
    display: flex; align-items: center; justify-content: space-between;
    margin: 24px 0 12px; padding: 0 4px;
}
.overview-clients-header h3 { font-size: 16px; font-weight: 600; color: var(--text-primary); }
.overview-quick-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px;
}
.overview-client-card {
    background: var(--card-bg); border: 1px solid var(--border-default);
    border-radius: var(--radius-lg); padding: 16px; cursor: pointer;
    transition: all var(--transition-fast); display: flex; flex-direction: column; gap: 8px;
}
.overview-client-card:hover { border-color: var(--accent-purple); transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.15); }
.overview-client-name { font-size: 14px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 8px; }
.overview-client-meta { display: flex; gap: 8px; flex-wrap: wrap; }
.overview-client-meta .tag { font-size: 11px; padding: 2px 8px; border-radius: 20px; font-weight: 500; }
.overview-rag-chart-wrap { margin-top: 20px; }
.overview-rag-chart-wrap h3 { font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px; }
.overview-chart-container { max-width: 350px; margin: 0 auto; }

/* ========================================================
   ACTIVITY LOG / RECENT UPDATES
   ======================================================== */
.activity-log-section { margin-top: 24px; }
.activity-log-section h3 { font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px; }
.activity-log-controls {
    display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; align-items: center;
}
.activity-log-filter-btn {
    padding: 3px 10px; font-size: 10px; font-weight: 600; border-radius: 10px;
    background: var(--bg-elevated); border: 1px solid var(--border-subtle);
    color: var(--text-muted); cursor: pointer; transition: all var(--transition-fast);
}
.activity-log-filter-btn.active {
    background: rgba(107,48,255,0.15); color: var(--accent-purple-light);
    border-color: rgba(107,48,255,0.3);
}
.activity-log-filter-btn:hover:not(.active) { color: var(--text-secondary); border-color: var(--border-default); }
.activity-log-count {
    font-size: 10px; color: var(--text-muted); margin-left: auto;
}
.activity-log-list { display: flex; flex-direction: column; gap: 0; max-height: 600px; overflow-y: auto; }
.activity-log-list::-webkit-scrollbar { width: 4px; }
.activity-log-list::-webkit-scrollbar-thumb { background: var(--border-default); border-radius: 2px; }
.activity-log-item {
    display: flex; align-items: flex-start; gap: 12px; padding: 12px 14px;
    border-bottom: 1px solid var(--border-subtle); position: relative;
    transition: background 0.15s;
}
.activity-log-item:hover { background: rgba(255,255,255,0.02); }
.activity-log-item:last-child { border-bottom: none; }
.activity-log-dot {
    width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; margin-top: 4px;
}
.activity-log-dot.email-in { background: var(--rag-green); }
.activity-log-dot.email-out { background: var(--accent-purple); }
.activity-log-dot.data-change { background: var(--rag-amber); }
.activity-log-dot.alert { background: var(--rag-red); }
.activity-log-dot.calendar { background: #579bfc; }
.activity-log-dot.system { background: var(--text-muted); }
.activity-log-dot.target { background: var(--accent-gold); }
.activity-log-dot.note { background: #9d50dd; }
.activity-log-dot.status-change { background: var(--accent-orange); }
.activity-log-dot.override { background: #ff5ac4; }
.activity-log-body { flex: 1; min-width: 0; }
.activity-log-title { font-size: 12px; font-weight: 600; color: var(--text-white); }
.activity-log-desc { font-size: 11px; color: var(--text-muted); margin-top: 2px; word-break: break-word; }
.activity-log-source {
    font-size: 9px; color: var(--text-muted); margin-top: 3px; text-transform: uppercase;
    letter-spacing: 0.5px; opacity: 0.7;
}
.activity-log-time {
    font-size: 10px; color: var(--text-muted); white-space: nowrap; margin-top: 3px;
    flex-shrink: 0;
}
.activity-log-empty { font-size: 12px; color: var(--text-muted); font-style: italic; padding: 16px 0; text-align: center; }
.activity-log-show-more {
    text-align: center; padding: 10px; cursor: pointer; font-size: 11px; color: var(--accent-purple-light);
    border-top: 1px solid var(--border-subtle);
}
.activity-log-show-more:hover { background: rgba(107,48,255,0.05); }

/* Email Action Items in Planner */
.email-action-item {
    display: flex; align-items: center; gap: 10px; padding: 10px 12px;
    border-radius: var(--radius-md); margin-bottom: 4px;
    background: rgba(107,48,255,0.03); border: 1px solid rgba(107,48,255,0.1);
    transition: all 0.15s;
}
.email-action-item:hover { background: rgba(107,48,255,0.06); border-color: rgba(107,48,255,0.2); }
.email-action-item.is-done { opacity: 0.5; }
.email-action-item.is-done .email-action-text { text-decoration: line-through; }
.email-action-checkbox {
    width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--border-default);
    display: flex; align-items: center; justify-content: center; cursor: pointer;
    flex-shrink: 0; font-size: 11px; transition: all 0.15s; color: transparent;
}
.email-action-checkbox:hover { border-color: var(--accent-purple); }
.email-action-checkbox.checked {
    background: var(--rag-green); border-color: var(--rag-green); color: #fff;
}
.email-action-icon { font-size: 14px; flex-shrink: 0; }
.email-action-body { flex: 1; min-width: 0; }
.email-action-text { font-size: 12px; font-weight: 500; color: var(--text-white); }
.email-action-detail { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
.email-action-status-btn {
    font-size: 9px; font-weight: 600; padding: 3px 8px; border-radius: 8px;
    cursor: pointer; border: none; transition: all 0.15s; text-transform: uppercase;
    letter-spacing: 0.3px;
}
.email-action-status-btn.needs-action { background: rgba(232,73,73,0.15); color: var(--rag-red); }
.email-action-status-btn.awaiting { background: rgba(87,155,252,0.12); color: #579bfc; }
.email-action-status-btn.done { background: rgba(0,200,117,0.15); color: var(--rag-green); }
.email-action-status-btn.grace { background: rgba(255,203,0,0.15); color: var(--rag-amber); }
.email-action-status-btn:hover { filter: brightness(1.2); transform: scale(1.05); }
/* Override dropdown */
.email-action-override {
    position: relative; display: inline-block;
}
.email-action-override-menu {
    position: absolute; top: 100%; right: 0; z-index: 100; min-width: 160px;
    background: var(--bg-elevated); border: 1px solid var(--border-default);
    border-radius: var(--radius-md); box-shadow: var(--shadow-elevated); padding: 4px 0;
    display: none;
}
.email-action-override-menu.open { display: block; }
.email-action-override-option {
    padding: 7px 14px; font-size: 11px; color: var(--text-secondary); cursor: pointer;
    display: flex; align-items: center; gap: 8px;
}
.email-action-override-option:hover { background: rgba(107,48,255,0.08); color: var(--text-white); }
.email-action-override-option .ov-dot {
    width: 8px; height: 8px; border-radius: 50%;
}
.email-action-override-option .ov-dot.done { background: var(--rag-green); }
.email-action-override-option .ov-dot.awaiting { background: #579bfc; }
.email-action-override-option .ov-dot.needs-action { background: var(--rag-red); }
.email-action-override-option .ov-dot.auto { background: var(--text-muted); }

/* ========================================================
   CHANGE DETECTION INDICATORS
   ======================================================== */
/* Pulsing badge on cards */
.change-badge {
    position: absolute; top: -6px; right: -6px; z-index: 3;
    width: 24px; height: 24px; border-radius: 50%;
    background: var(--accent-purple); color: #fff;
    font-size: 14px; font-weight: 800; line-height: 24px; text-align: center;
    box-shadow: 0 2px 8px rgba(107,48,255,0.45);
    cursor: pointer;
    animation: changePulse 2s ease-in-out infinite;
}
.change-badge:hover {
    transform: scale(1.15);
    box-shadow: 0 3px 14px rgba(107,48,255,0.6);
}
@keyframes changePulse {
    0%, 100% { box-shadow: 0 2px 8px rgba(107,48,255,0.45); }
    50% { box-shadow: 0 2px 16px rgba(107,48,255,0.75), 0 0 0 4px rgba(107,48,255,0.15); }
}
/* Card border glow when changed */
.overview-client-card.has-changes { border-color: var(--accent-purple); position: relative; }
.client-card-large.has-changes { border-color: var(--accent-purple); }
/* Inline change badge for comparison table */
.change-badge-inline {
    position: relative; top: auto; right: auto;
    display: inline-flex; align-items: center; justify-content: center;
    width: 18px; height: 18px; font-size: 11px; line-height: 18px;
    margin-left: 6px; vertical-align: middle;
}
.compare-row-changed {
    background: rgba(107,48,255,0.06);
    border-left: 3px solid var(--accent-purple);
}
.compare-row-changed td:first-child { padding-left: 9px; }

/* Change Popover */
.change-popover {
    position: fixed; z-index: 1200;
    background: var(--bg-card); border: 1px solid var(--accent-purple);
    border-radius: var(--radius-lg); padding: 0; width: 340px;
    box-shadow: 0 12px 40px rgba(0,0,0,0.5), 0 0 0 1px rgba(107,48,255,0.2);
    animation: popoverIn 0.15s ease-out;
}
@keyframes popoverIn {
    from { opacity: 0; transform: translateY(-6px) scale(0.96); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}
.change-popover-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 16px; border-bottom: 1px solid var(--border-subtle);
}
.change-popover-header h4 {
    font-size: 13px; font-weight: 700; color: var(--text-white); margin: 0;
    display: flex; align-items: center; gap: 6px;
}
.change-popover-close {
    width: 24px; height: 24px; border-radius: var(--radius-sm);
    background: transparent; border: none; color: var(--text-muted);
    cursor: pointer; font-size: 14px; display: flex; align-items: center;
    justify-content: center; transition: all var(--transition-fast);
}
.change-popover-close:hover { background: var(--bg-elevated); color: var(--text-primary); }
.change-popover-body {
    padding: 12px 16px; max-height: 260px; overflow-y: auto;
    scrollbar-width: thin;
}
.change-item {
    display: flex; align-items: flex-start; gap: 10px;
    padding: 8px 0; border-bottom: 1px solid var(--border-subtle);
}
.change-item:last-child { border-bottom: none; }
.change-item-icon {
    width: 28px; height: 28px; border-radius: var(--radius-sm);
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; flex-shrink: 0; margin-top: 1px;
}
.change-item-icon.improved { background: rgba(0,200,117,0.12); }
.change-item-icon.declined { background: rgba(223,47,74,0.12); }
.change-item-icon.neutral { background: rgba(255,255,255,0.06); }
.change-item-detail { flex: 1; }
.change-item-field {
    font-size: 11px; font-weight: 600; color: var(--text-secondary);
    text-transform: uppercase; letter-spacing: 0.3px;
}
.change-item-values {
    font-size: 12px; color: var(--text-primary); margin-top: 2px;
    display: flex; align-items: center; gap: 6px;
}
.change-val-old {
    color: var(--text-muted); text-decoration: line-through; opacity: 0.7;
}
.change-val-arrow { color: var(--text-muted); font-size: 10px; }
.change-val-new { font-weight: 600; }
.change-val-new.improved { color: var(--rag-green); }
.change-val-new.declined { color: var(--rag-red); }
.change-val-new.neutral { color: var(--accent-purple-light); }
.change-popover-footer {
    padding: 10px 16px; border-top: 1px solid var(--border-subtle);
    display: flex; gap: 8px; justify-content: space-between;
}
.change-popover-btn {
    padding: 7px 14px; border-radius: var(--radius-md); border: none;
    font-size: 11px; font-weight: 600; cursor: pointer;
    transition: all var(--transition-fast);
}
.change-popover-btn.view {
    background: var(--accent-purple); color: #fff; flex: 1;
}
.change-popover-btn.view:hover { background: var(--accent-purple-light); }
.change-popover-btn.dismiss {
    background: var(--bg-elevated); color: var(--text-secondary);
    border: 1px solid var(--border-default);
}
.change-popover-btn.dismiss:hover { background: var(--bg-main); color: var(--text-primary); }

/* ========================================================
   BIGGER CLIENT CARDS
   ======================================================== */
.client-card-large {
    background: var(--card-bg); border: 1px solid var(--border-default);
    border-radius: var(--radius-lg); padding: 24px; position: relative;
    transition: all var(--transition-fast); cursor: pointer;
}
.client-card-large:hover { border-color: var(--accent-purple); transform: translateY(-2px); box-shadow: 0 6px 24px rgba(0,0,0,0.18); }
.client-card-large .client-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
.client-card-large .client-name { font-size: 18px; font-weight: 700; color: var(--text-primary); }
.client-card-large .rag-badge { width: 14px; height: 14px; border-radius: 50%; flex-shrink: 0; }
.client-card-large .client-meta-row {
    display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 14px;
}
.client-card-large .meta-tag {
    font-size: 12px; padding: 4px 10px; border-radius: 20px;
    font-weight: 500; background: var(--bg-elevated); color: var(--text-secondary);
    border: 1px solid var(--border-default);
}
.client-card-large .meta-tag.billing-yes { background: rgba(0,200,117,0.1); color: var(--billing-yes); border-color: rgba(0,200,117,0.3); }
.client-card-large .meta-tag.billing-no { background: rgba(223,47,74,0.1); color: var(--billing-no); border-color: rgba(223,47,74,0.3); }
.client-card-large .meta-tag.update-yes { background: rgba(0,200,117,0.1); color: var(--rag-green); border-color: rgba(0,200,117,0.3); }
.client-card-large .meta-tag.update-no { background: rgba(253,171,61,0.1); color: var(--rag-amber); border-color: rgba(253,171,61,0.3); }
.client-card-large .client-summary-text {
    font-size: 13px; line-height: 1.6; color: var(--text-secondary); margin-bottom: 14px;
    position: relative; min-height: 40px;
    display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
}
.client-card-large .client-stats-row {
    display: flex; gap: 16px; flex-wrap: wrap; padding-top: 12px;
    border-top: 1px solid var(--border-default);
}
.client-card-large .stat-item { display: flex; flex-direction: column; gap: 2px; }
.client-card-large .stat-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
.client-card-large .stat-value { font-size: 14px; font-weight: 600; color: var(--text-primary); }
.client-card-large .card-footer { display: flex; align-items: center; gap: 10px; margin-top: 12px; }
.clients-page-header {
    display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap;
    gap: 12px; margin-bottom: 16px;
}
.clients-page-header h2 { font-size: 20px; font-weight: 700; color: var(--text-primary); }
.clients-page-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
.btn-compare {
    padding: 8px 16px; background: var(--accent-purple); color: #fff;
    border: none; border-radius: var(--radius-md); font-size: 13px;
    font-weight: 600; cursor: pointer; transition: all var(--transition-fast);
}
.btn-compare:hover { background: var(--accent-purple-light); }
.clients-filters-row {
    display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 16px;
}
.clients-large-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;
}

/* ========================================================
   COMPARISON TABLE
   ======================================================== */
.compare-page-header {
    display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;
}
.compare-page-header h2 { font-size: 20px; font-weight: 700; color: var(--text-primary); }
.compare-table-wrap { overflow-x: auto; border-radius: var(--radius-lg); border: 1px solid var(--border-default); }
.compare-table {
    width: 100%; border-collapse: collapse; font-size: 13px;
}
.compare-table th {
    position: sticky; top: 0; background: var(--bg-elevated); color: var(--text-secondary);
    font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;
    padding: 12px 16px; text-align: left; border-bottom: 2px solid var(--border-default); z-index: 2;
    white-space: nowrap; cursor: pointer; user-select: none; transition: color var(--transition-fast);
}
.compare-table th:hover { color: var(--accent-purple-light); }
.compare-table th .sort-indicator {
    display: inline-block; margin-left: 4px; font-size: 10px; opacity: 0.3;
    transition: opacity 0.2s ease;
}
.compare-table th.sort-active { color: var(--accent-purple-light); }
.compare-table th.sort-active .sort-indicator { opacity: 1; }
.compare-table td {
    padding: 12px 16px; border-bottom: 1px solid var(--border-default);
    color: var(--text-primary); vertical-align: middle;
}
.compare-table tr:hover td { background: var(--bg-elevated); }
.compare-table .client-name-link {
    color: var(--accent-purple); font-weight: 600; cursor: pointer; text-decoration: none;
}
.compare-table .client-name-link:hover { text-decoration: underline; }
.compare-table .rag-cell { display: flex; align-items: center; gap: 8px; }
.compare-table .rag-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

/* ========================================================
   CLIENT DETAIL PAGE (FULL PAGE)
   ======================================================== */
.client-detail-back {
    display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px;
    background: var(--bg-elevated); border: 1px solid var(--border-default);
    border-radius: var(--radius-md); color: var(--text-secondary); font-size: 13px;
    font-weight: 500; cursor: pointer; transition: all var(--transition-fast); margin-bottom: 20px;
}
.client-detail-back:hover { color: var(--accent-purple); border-color: var(--accent-purple); }
.client-detail-header {
    display: flex; align-items: center; gap: 16px; flex-wrap: wrap; margin-bottom: 24px;
}
.client-detail-header .detail-name { font-size: 28px; font-weight: 800; color: var(--text-primary); }
.client-detail-header .detail-badges { display: flex; gap: 8px; flex-wrap: wrap; }
.client-detail-header .detail-badge {
    padding: 5px 14px; border-radius: 20px; font-size: 12px; font-weight: 600;
}
.client-detail-summary {
    background: var(--card-bg); border: 1px solid var(--border-default);
    border-radius: var(--radius-lg); padding: 20px; margin-bottom: 20px; position: relative;
}
.client-detail-summary h3 { font-size: 14px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px; }
.client-detail-summary .summary-text {
    font-size: 14px; line-height: 1.7; color: var(--text-primary); position: relative; cursor: pointer;
}
.client-detail-summary .summary-text:hover { background: rgba(107,48,255,0.04); border-radius: var(--radius-sm); }
.client-detail-summary .edit-icon {
    position: absolute; top: 16px; right: 16px; font-size: 16px;
    color: var(--text-muted); opacity: 0.6; cursor: pointer; transition: opacity var(--transition-fast);
}
.client-detail-summary .edit-icon:hover { opacity: 1; color: var(--accent-purple); }
.client-detail-metrics {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 14px; margin-bottom: 24px;
}
.detail-metric-card {
    background: var(--card-bg); border: 1px solid var(--border-default);
    border-radius: var(--radius-lg); padding: 16px; text-align: center;
}
.detail-metric-card .metric-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.detail-metric-card .metric-value { font-size: 22px; font-weight: 700; color: var(--text-primary); }
.detail-metric-card .metric-sub { font-size: 11px; color: var(--text-secondary); margin-top: 4px; }
.client-detail-charts {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 16px; margin-bottom: 24px;
}
.detail-chart-card {
    background: var(--card-bg); border: 1px solid var(--border-default);
    border-radius: var(--radius-lg); padding: 20px;
}
.detail-chart-card h4 { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px; }
.detail-chart-card .chart-container { position: relative; height: 200px; }
.client-detail-notes {
    background: var(--card-bg); border: 1px solid var(--border-default);
    border-radius: var(--radius-lg); padding: 20px; margin-bottom: 24px;
}
.client-detail-notes h3 { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px; }
.client-detail-emails {
    background: var(--card-bg); border: 1px solid var(--border-default);
    border-radius: var(--radius-lg); padding: 20px; margin-bottom: 24px;
}
.client-detail-emails h3 { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px; }
.client-detail-emails .email-cards {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px;
}

/* ========================================================
   PLANNER / TO-DO & WEEK VIEW
   ======================================================== */
.planner-layout {
    display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;
}
.planner-column { min-width: 0; }
.planner-section-title {
    font-size: 16px; font-weight: 700; color: var(--text-white); margin-bottom: 14px;
    display: flex; align-items: center; gap: 8px;
}
.planner-section-title .section-count {
    font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 10px;
    background: rgba(107,48,255,0.15); color: var(--accent-purple-light);
}

/* To-Do Cards */
/* Task Prompt Modal */
.task-prompt-overlay {
    position: fixed; inset: 0; z-index: 9100;
    background: rgba(0,0,0,0.75); backdrop-filter: blur(6px);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none; transition: opacity 0.25s ease;
}
.task-prompt-overlay.open { opacity: 1; pointer-events: auto; }
.task-prompt-modal {
    background: var(--bg-card); border: 1px solid var(--border-default);
    border-radius: var(--radius-xl); padding: 28px 32px;
    max-width: 620px; width: 92%; max-height: 85vh; overflow-y: auto;
    box-shadow: var(--shadow-elevated);
}
.task-prompt-modal h3 { color: var(--text-white); font-size: 18px; margin-bottom: 6px; }
.task-prompt-modal .prompt-subtitle { font-size: 12px; color: var(--text-muted); margin-bottom: 18px; line-height: 1.5; }
.task-prompt-textarea {
    width: 100%; min-height: 140px; max-height: 260px; padding: 14px;
    background: var(--bg-input); border: 1px solid var(--border-default);
    border-radius: var(--radius-md); color: var(--text-primary); font-size: 13px;
    font-family: inherit; line-height: 1.6; resize: vertical;
}
.task-prompt-textarea::placeholder { color: var(--text-muted); }
.task-prompt-textarea:focus { border-color: var(--accent-purple); outline: none; }
.task-prompt-options {
    display: flex; gap: 12px; margin: 14px 0; flex-wrap: wrap; align-items: center;
}
.task-prompt-options label {
    font-size: 12px; font-weight: 600; color: var(--text-secondary);
    text-transform: uppercase; letter-spacing: 0.5px;
}
.task-prompt-options select, .task-prompt-options input[type="date"] {
    padding: 8px 10px; background: var(--bg-input); border: 1px solid var(--border-default);
    border-radius: var(--radius-md); color: var(--text-primary); font-size: 12px;
}
.task-prompt-preview {
    margin-top: 14px; padding: 14px; background: var(--bg-elevated);
    border-radius: var(--radius-md); border: 1px solid var(--border-subtle);
    max-height: 200px; overflow-y: auto; display: none;
}
.task-prompt-preview.visible { display: block; }
.task-prompt-preview-title {
    font-size: 11px; font-weight: 700; color: var(--text-secondary);
    text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;
}
.task-preview-item {
    display: flex; align-items: center; gap: 8px; padding: 5px 0;
    font-size: 12px; color: var(--text-primary); border-bottom: 1px solid var(--border-subtle);
}
.task-preview-item:last-child { border-bottom: none; }
.task-preview-item .tpi-priority {
    font-size: 9px; font-weight: 700; padding: 1px 6px; border-radius: 8px;
    text-transform: uppercase;
}
.task-preview-item .tpi-priority.high { background: rgba(232,73,73,0.15); color: var(--rag-red); }
.task-preview-item .tpi-priority.medium { background: rgba(253,171,61,0.15); color: var(--rag-amber); }
.task-preview-item .tpi-priority.low { background: rgba(0,200,117,0.15); color: var(--rag-green); }
.task-preview-item .tpi-date { font-size: 10px; color: var(--text-muted); margin-left: auto; }
.task-prompt-actions {
    display: flex; gap: 10px; margin-top: 18px; justify-content: flex-end;
}
.task-prompt-actions button {
    padding: 10px 22px; border-radius: var(--radius-md); font-size: 13px;
    font-weight: 600; cursor: pointer; transition: all var(--transition-fast); border: none;
}
.task-prompt-actions .btn-cancel {
    background: var(--bg-elevated); color: var(--text-secondary); border: 1px solid var(--border-default);
}
.task-prompt-actions .btn-cancel:hover { border-color: var(--text-muted); color: var(--text-primary); }
.task-prompt-actions .btn-add-tasks {
    background: var(--accent-purple); color: #fff;
}
.task-prompt-actions .btn-add-tasks:hover { background: var(--accent-purple-light); }
.btn-open-prompt {
    display: flex; align-items: center; gap: 8px; padding: 10px 20px;
    background: var(--accent-purple); color: #fff; border: none;
    border-radius: var(--radius-md); font-size: 13px; font-weight: 600;
    cursor: pointer; transition: all var(--transition-fast);
}
.btn-open-prompt:hover { background: var(--accent-purple-light); transform: translateY(-1px); }
.todo-list { display: flex; flex-direction: column; gap: 6px; }
.todo-item {
    display: flex; align-items: center; gap: 10px; padding: 10px 14px;
    background: var(--bg-card); border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md); transition: all var(--transition-fast);
    cursor: pointer;
}
.todo-item:hover { border-color: var(--accent-purple); }
.todo-item.completed { opacity: 0.5; }
.todo-item.completed .todo-text { text-decoration: line-through; }
.todo-checkbox {
    width: 20px; height: 20px; border: 2px solid var(--border-default); border-radius: 50%;
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    cursor: pointer; transition: all var(--transition-fast); font-size: 11px;
}
.todo-item.completed .todo-checkbox {
    background: var(--rag-green); border-color: var(--rag-green); color: #fff;
}
.todo-item.priority-high { border-left: 3px solid var(--rag-red); }
.todo-item.priority-medium { border-left: 3px solid var(--rag-amber); }
.todo-item.priority-low { border-left: 3px solid var(--rag-green); }
.todo-text { flex: 1; font-size: 13px; color: var(--text-primary); }
.todo-meta {
    display: flex; align-items: center; gap: 6px; font-size: 10px; color: var(--text-muted);
}
.todo-priority-badge {
    font-size: 9px; font-weight: 700; padding: 1px 6px; border-radius: 8px;
    text-transform: uppercase; letter-spacing: 0.5px;
}
.todo-priority-badge.high { background: rgba(232,73,73,0.15); color: var(--rag-red); }
.todo-priority-badge.medium { background: rgba(253,171,61,0.15); color: var(--rag-amber); }
.todo-priority-badge.low { background: rgba(0,200,117,0.15); color: var(--rag-green); }
.todo-delete {
    opacity: 0; font-size: 14px; color: var(--text-muted); cursor: pointer;
    transition: all var(--transition-fast); padding: 2px 4px;
}
.todo-item:hover .todo-delete { opacity: 1; }
.todo-delete:hover { color: var(--rag-red); }
.todo-empty {
    text-align: center; padding: 20px; color: var(--text-muted); font-size: 13px; font-style: italic;
}
.todo-filters {
    display: flex; gap: 6px; margin-bottom: 12px;
}
.todo-filter-btn {
    padding: 4px 12px; font-size: 11px; font-weight: 600; border-radius: 12px;
    background: var(--bg-elevated); border: 1px solid var(--border-subtle);
    color: var(--text-muted); cursor: pointer; transition: all var(--transition-fast);
}
.todo-filter-btn.active {
    background: rgba(107,48,255,0.15); color: var(--accent-purple-light);
    border-color: rgba(107,48,255,0.3);
}

/* Week Projection */
.week-day-card {
    background: var(--bg-card); border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg); padding: 14px 18px; margin-bottom: 10px;
    transition: all var(--transition-fast);
}
.week-day-card:hover { border-color: var(--accent-purple); }
.week-day-card.today { border-left: 3px solid var(--accent-purple); background: rgba(107,48,255,0.03); }
.week-day-header {
    display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;
}
.week-day-name { font-size: 14px; font-weight: 700; color: var(--text-white); }
.week-day-date { font-size: 11px; color: var(--text-muted); }
.week-day-badge {
    font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 10px;
    background: rgba(107,48,255,0.15); color: var(--accent-purple-light);
}
.week-event-item {
    display: flex; align-items: flex-start; gap: 8px; padding: 6px 0;
    font-size: 12px; border-bottom: 1px solid var(--border-subtle);
}
.week-event-item:last-child { border-bottom: none; }
.week-event-time {
    min-width: 50px; color: var(--accent-purple-light); font-weight: 600;
    font-size: 11px; padding-top: 1px;
}
.week-event-title { color: var(--text-primary); flex: 1; }
.week-event-type {
    font-size: 9px; font-weight: 600; padding: 1px 6px; border-radius: 8px;
    text-transform: uppercase; letter-spacing: 0.5px;
}
.week-event-type.meeting { background: rgba(87,155,252,0.15); color: #579bfc; }
.week-event-type.todo { background: rgba(107,48,255,0.15); color: var(--accent-purple-light); }
.week-event-type.deadline { background: rgba(232,73,73,0.15); color: var(--rag-red); }
.week-event-type.email-urgent { background: rgba(232,73,73,0.15); color: var(--rag-red); }
.week-event-type.email-grace { background: rgba(255,203,0,0.15); color: var(--rag-amber); }
.week-event-type.email-followup { background: rgba(0,200,117,0.15); color: var(--rag-green); }
.week-event-type.email-stale { background: rgba(232,73,73,0.1); color: #c77; }
.week-no-events { font-size: 12px; color: var(--text-muted); font-style: italic; padding: 4px 0; }

/* Email follow-ups section in planner */
.email-followup-section {
    background: var(--card-bg); border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg); padding: 16px; margin-bottom: 20px;
}
.email-followup-item {
    display: flex; align-items: center; gap: 10px; padding: 10px 12px;
    border-radius: var(--radius-md); margin-bottom: 6px;
    background: rgba(255,255,255,0.02); border: 1px solid var(--border-subtle);
    transition: background 0.15s;
}
.email-followup-item:hover { background: rgba(255,255,255,0.05); }
.email-followup-item:last-child { margin-bottom: 0; }
.email-followup-icon {
    width: 32px; height: 32px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; flex-shrink: 0;
}
.email-followup-icon.urgent { background: rgba(232,73,73,0.15); }
.email-followup-icon.grace { background: rgba(255,203,0,0.15); }
.email-followup-icon.stale { background: rgba(232,73,73,0.08); }
.email-followup-icon.awaiting { background: rgba(87,155,252,0.12); }
.email-followup-body { flex: 1; min-width: 0; }
.email-followup-client { font-size: 13px; font-weight: 600; color: var(--text-white); }
.email-followup-detail { font-size: 11px; color: var(--text-muted); margin-top: 2px; display: flex; gap: 8px; flex-wrap: wrap; }
.email-followup-tag {
    font-size: 9px; font-weight: 600; padding: 2px 8px; border-radius: 8px;
    text-transform: uppercase; letter-spacing: 0.5px;
}
.email-followup-tag.urgent { background: rgba(232,73,73,0.15); color: var(--rag-red); }
.email-followup-tag.grace { background: rgba(255,203,0,0.15); color: var(--rag-amber); }
.email-followup-tag.stale { background: rgba(232,73,73,0.1); color: #c77; }
.email-followup-tag.awaiting { background: rgba(87,155,252,0.12); color: #579bfc; }
.email-followup-action {
    font-size: 11px; color: var(--accent-purple-light); cursor: pointer;
    text-decoration: none; white-space: nowrap;
}
.email-followup-action:hover { text-decoration: underline; }

/* Calendar Section */
.calendar-section {
    background: var(--bg-card); border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg); padding: 20px; margin-bottom: 20px;
}
.calendar-event-card {
    display: flex; align-items: flex-start; gap: 12px; padding: 12px;
    background: var(--bg-elevated); border-radius: var(--radius-md);
    margin-bottom: 8px; transition: all var(--transition-fast);
}
.calendar-event-card:not(.cal-completed):not(.cal-cancelled):hover { border-left: 3px solid var(--accent-purple); padding-left: 9px; }
.cal-time-block {
    min-width: 55px; text-align: center; padding: 6px 8px;
    background: rgba(107,48,255,0.1); border-radius: var(--radius-sm);
}
.cal-time-block .cal-time { font-size: 13px; font-weight: 700; color: var(--accent-purple-light); }
.cal-time-block .cal-duration { font-size: 9px; color: var(--text-muted); margin-top: 2px; }
.cal-event-info { flex: 1; }
.cal-event-subject { font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: 3px; }
.cal-event-meta { font-size: 11px; color: var(--text-muted); display: flex; flex-wrap: wrap; gap: 8px; }
.cal-event-link {
    font-size: 11px; color: var(--accent-purple); text-decoration: none; font-weight: 600;
    transition: color var(--transition-fast);
}
.cal-event-link:hover { color: var(--accent-purple-light); text-decoration: underline; }

/* Calendar event states */
.calendar-event-card.cal-completed {
    border-left: 3px solid var(--rag-green); padding-left: 9px;
    background: rgba(0,200,117,0.06);
}
.calendar-event-card.cal-completed .cal-event-subject {
    text-decoration: line-through; color: var(--text-muted);
}
.calendar-event-card.cal-completed .cal-time-block {
    background: rgba(0,200,117,0.12);
}
.calendar-event-card.cal-completed .cal-time-block .cal-time {
    color: var(--rag-green);
}
.calendar-event-card.cal-completed .cal-status-badge {
    background: rgba(0,200,117,0.15); color: var(--rag-green);
}
.calendar-event-card.cal-cancelled {
    border-left: 3px solid var(--rag-red); padding-left: 9px;
    opacity: 0.45;
    background: rgba(232,73,73,0.05);
}
.calendar-event-card.cal-cancelled .cal-event-subject {
    text-decoration: line-through; color: var(--text-muted);
}
.calendar-event-card.cal-cancelled .cal-time-block {
    background: rgba(232,73,73,0.12);
}
.calendar-event-card.cal-cancelled .cal-time-block .cal-time {
    color: var(--rag-red);
}
.calendar-event-card.cal-cancelled .cal-status-badge {
    background: rgba(232,73,73,0.15); color: var(--rag-red);
}
.cal-status-badge {
    font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 8px;
    text-transform: uppercase; letter-spacing: 0.3px; white-space: nowrap;
}
.cal-actions {
    display: flex; gap: 4px; flex-shrink: 0; align-items: flex-start; margin-left: 4px;
}
.cal-action-btn {
    width: 26px; height: 26px; border-radius: 6px; border: 1px solid var(--border-subtle);
    background: var(--bg-elevated); color: var(--text-muted); font-size: 13px;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: all var(--transition-fast); flex-shrink: 0;
}
.cal-action-btn:hover { border-color: var(--accent-purple); color: var(--accent-purple); }
.cal-action-btn.complete:hover { border-color: var(--rag-green); color: var(--rag-green); background: rgba(0,200,117,0.08); }
.cal-action-btn.cancel-btn:hover { border-color: var(--rag-red); color: var(--rag-red); background: rgba(232,73,73,0.08); }
.cal-action-btn.undo:hover { border-color: var(--rag-amber); color: var(--rag-amber); background: rgba(253,171,61,0.08); }

/* Week projection event states */
.week-event-item.we-completed .week-event-title {
    text-decoration: line-through; color: var(--text-muted);
}
.week-event-item.we-completed .week-event-type.meeting {
    background: rgba(0,200,117,0.15); color: var(--rag-green);
}
.week-event-item.we-cancelled .week-event-title {
    text-decoration: line-through; color: var(--text-muted); opacity: 0.5;
}
.week-event-item.we-cancelled .week-event-type.meeting {
    background: rgba(232,73,73,0.15); color: var(--rag-red);
}

/* ========================================================
   KNOWLEDGE BASE
   ======================================================== */
.kb-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 20px; flex-wrap: wrap; gap: 12px;
}
.kb-header h2 { font-size: 20px; font-weight: 700; color: var(--text-white); }
.kb-header-count { font-size: 13px; color: var(--text-muted); font-weight: 400; margin-left: 8px; }
.kb-btn-add {
    display: flex; align-items: center; gap: 6px; padding: 9px 18px;
    background: var(--accent-purple); color: #fff; border: none;
    border-radius: var(--radius-md); font-size: 13px; font-weight: 600;
    cursor: pointer; transition: all var(--transition-fast);
}
.kb-btn-add:hover { background: var(--accent-purple-light); transform: translateY(-1px); }
.kb-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 16px;
}
.kb-card {
    background: var(--bg-card); border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg); padding: 20px;
    display: flex; flex-direction: column; gap: 10px;
    transition: all var(--transition-fast); cursor: pointer; position: relative;
}
.kb-card:hover { border-color: var(--accent-purple); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
.kb-card-icon { font-size: 28px; }
.kb-card-title { font-size: 15px; font-weight: 700; color: var(--text-white); }
.kb-card-desc { font-size: 12px; color: var(--text-muted); line-height: 1.5; }
.kb-card-meta {
    display: flex; align-items: center; gap: 8px; margin-top: auto; padding-top: 10px;
    border-top: 1px solid var(--border-subtle);
}
.kb-card-cat {
    font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 8px;
    text-transform: uppercase; letter-spacing: 0.5px;
    background: rgba(107,48,255,0.12); color: var(--accent-purple-light);
}
.kb-card-cat.guide { background: rgba(0,200,117,0.12); color: var(--rag-green); }
.kb-card-cat.reference { background: rgba(87,155,252,0.12); color: #579bfc; }
.kb-card-cat.template { background: rgba(253,171,61,0.12); color: var(--rag-amber); }
.kb-card-cat.other { background: rgba(200,200,200,0.12); color: var(--text-muted); }
.kb-card-date { font-size: 10px; color: var(--text-muted); margin-left: auto; }
.kb-card-remove {
    position: absolute; top: 10px; right: 10px; width: 24px; height: 24px;
    border-radius: 50%; border: none; background: transparent; color: var(--text-muted);
    font-size: 14px; cursor: pointer; opacity: 0; transition: all var(--transition-fast);
    display: flex; align-items: center; justify-content: center;
}
.kb-card:hover .kb-card-remove { opacity: 0.6; }
.kb-card-remove:hover { opacity: 1 !important; background: rgba(232,73,73,0.15); color: var(--rag-red); }
.kb-empty {
    text-align: center; padding: 60px 20px; color: var(--text-muted);
}
.kb-empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
.kb-empty-text { font-size: 15px; margin-bottom: 16px; }

/* KB Viewer */
.kb-viewer-wrap {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: var(--bg-main); z-index: 1000; display: flex; flex-direction: column;
}
.kb-viewer-toolbar {
    display: flex; align-items: center; gap: 12px; padding: 10px 20px;
    background: var(--bg-card); border-bottom: 1px solid var(--border-default);
    flex-shrink: 0;
}
.kb-viewer-back {
    padding: 7px 14px; background: var(--bg-elevated); border: 1px solid var(--border-default);
    border-radius: var(--radius-md); color: var(--text-primary); font-size: 13px;
    font-weight: 600; cursor: pointer; transition: all var(--transition-fast);
}
.kb-viewer-back:hover { background: var(--accent-purple); color: #fff; border-color: var(--accent-purple); }
.kb-viewer-title {
    flex: 1; font-size: 15px; font-weight: 700; color: var(--text-white);
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.kb-viewer-external {
    font-size: 12px; color: var(--accent-purple); text-decoration: none;
    font-weight: 600; white-space: nowrap;
}
.kb-viewer-external:hover { color: var(--accent-purple-light); text-decoration: underline; }
.kb-viewer-frame {
    flex: 1; width: 100%; border: none; background: #0a0a0a;
}

/* KB Add Document Modal */
.kb-modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px); z-index: 1100;
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none; transition: opacity 0.2s;
}
.kb-modal-overlay.open { opacity: 1; pointer-events: auto; }
.kb-modal {
    background: var(--bg-card); border: 1px solid var(--border-default);
    border-radius: var(--radius-lg); padding: 28px; width: 90%;
    max-width: 500px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);
}
.kb-modal-title {
    font-size: 18px; font-weight: 700; color: var(--text-white); margin-bottom: 20px;
}
.kb-modal-field { margin-bottom: 14px; }
.kb-modal-field label {
    display: block; font-size: 12px; font-weight: 600;
    color: var(--text-secondary); margin-bottom: 5px;
}
.kb-modal-field input,
.kb-modal-field select {
    width: 100%; padding: 10px 12px;
    background: var(--bg-elevated); border: 1px solid var(--border-default);
    border-radius: var(--radius-md); color: var(--text-primary);
    font-size: 13px; transition: border-color var(--transition-fast);
}
.kb-modal-field input:focus,
.kb-modal-field select:focus {
    outline: none; border-color: var(--accent-purple);
}
.kb-modal-hint {
    display: block; font-size: 10px; color: var(--text-muted); margin-top: 4px;
}
.kb-modal-actions {
    display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;
}
.kb-modal-btn {
    padding: 9px 20px; border-radius: var(--radius-md); border: none;
    font-size: 13px; font-weight: 600; cursor: pointer; transition: all var(--transition-fast);
}
.kb-modal-btn.cancel {
    background: var(--bg-elevated); color: var(--text-secondary);
    border: 1px solid var(--border-default);
}
.kb-modal-btn.cancel:hover { background: var(--bg-main); }
.kb-modal-btn.add { background: var(--accent-purple); color: #fff; }
.kb-modal-btn.add:hover { background: var(--accent-purple-light); }

/* ========================================================
   SHARE SNAPSHOT MODAL
   ======================================================== */
.share-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.65);
    backdrop-filter: blur(4px); z-index: 1100;
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none; transition: opacity 0.25s;
}
.share-overlay.open { opacity: 1; pointer-events: auto; }
.share-modal {
    background: var(--bg-card); border: 1px solid var(--border-default);
    border-radius: var(--radius-lg); width: 94%; max-width: 780px;
    max-height: 88vh; display: flex; flex-direction: column;
    box-shadow: 0 24px 80px rgba(0,0,0,0.5);
}
.share-modal-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 20px 24px 16px; border-bottom: 1px solid var(--border-subtle);
}
.share-modal-header h3 {
    font-size: 17px; font-weight: 700; color: var(--text-white); margin: 0;
}
.share-modal-close {
    width: 32px; height: 32px; border-radius: var(--radius-sm);
    background: var(--bg-elevated); border: 1px solid var(--border-subtle);
    color: var(--text-secondary); cursor: pointer; font-size: 16px;
    display: flex; align-items: center; justify-content: center;
    transition: all var(--transition-fast);
}
.share-modal-close:hover { background: var(--bg-main); color: var(--text-primary); }
.share-modal-actions {
    display: flex; gap: 8px; padding: 14px 24px;
    border-bottom: 1px solid var(--border-subtle);
    background: var(--bg-elevated);
}
.share-action-btn {
    padding: 8px 16px; border-radius: var(--radius-md); border: 1px solid var(--border-default);
    background: var(--bg-card); color: var(--text-secondary); font-size: 12px;
    font-weight: 600; cursor: pointer; transition: all var(--transition-fast);
    display: flex; align-items: center; gap: 6px;
}
.share-action-btn:hover { border-color: var(--accent-purple); color: var(--accent-purple-light); }
.share-action-btn.primary {
    background: var(--accent-purple); color: #fff; border-color: var(--accent-purple);
}
.share-action-btn.primary:hover { background: var(--accent-purple-light); }
.share-modal-body {
    flex: 1; overflow-y: auto; padding: 20px 24px;
    scrollbar-width: thin;
}
.share-modal-body::-webkit-scrollbar { width: 6px; }
.share-modal-body::-webkit-scrollbar-thumb { background: var(--border-subtle); border-radius: 3px; }

/* Snapshot Content Styles */
.snap-header {
    text-align: center; padding-bottom: 16px; margin-bottom: 16px;
    border-bottom: 1px solid var(--border-subtle);
}
.snap-title { font-size: 16px; font-weight: 700; color: var(--text-white); margin: 0; }
.snap-subtitle {
    font-size: 12px; color: var(--text-muted); margin-top: 4px;
}
.snap-kpi-row {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
    margin-bottom: 18px;
}
.snap-kpi {
    background: var(--bg-elevated); border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md); padding: 12px; text-align: center;
}
.snap-kpi-value { font-size: 22px; font-weight: 800; color: var(--text-white); }
.snap-kpi-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }

.snap-section-title {
    font-size: 13px; font-weight: 700; color: var(--text-white);
    margin: 18px 0 10px; padding-bottom: 6px;
    border-bottom: 1px solid var(--border-subtle);
}

/* Client Snapshot Cards */
.snap-clients-grid {
    display: flex; flex-direction: column; gap: 10px;
}
.snap-client-card {
    background: var(--bg-elevated); border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md); padding: 14px 16px;
    border-left: 3px solid var(--border-default);
}
.snap-client-card.rag-green { border-left-color: var(--rag-green); }
.snap-client-card.rag-amber { border-left-color: var(--rag-amber); }
.snap-client-card.rag-red { border-left-color: var(--rag-red); }
.snap-client-header {
    display: flex; align-items: center; gap: 10px; margin-bottom: 8px;
}
.snap-rag-dot {
    width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
}
.snap-client-name {
    font-size: 14px; font-weight: 700; color: var(--text-white); flex: 1;
}
.snap-health-badge {
    font-size: 12px; font-weight: 700; padding: 2px 8px;
    border-radius: 10px; background: rgba(255,255,255,0.06);
}
.snap-client-metrics {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 6px 14px;
    margin-bottom: 8px;
}
.snap-metric {
    display: flex; justify-content: space-between; font-size: 11px;
    padding: 3px 0; border-bottom: 1px dashed var(--border-subtle);
}
.snap-metric-label { color: var(--text-muted); }
.snap-metric-value { color: var(--text-primary); font-weight: 600; }
.snap-client-summary {
    font-size: 11px; color: var(--text-secondary); line-height: 1.5;
    margin-top: 6px; padding: 8px 10px;
    background: var(--bg-main); border-radius: var(--radius-sm);
    border-left: 2px solid var(--border-subtle);
}
.snap-agents-row {
    display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px;
}
.snap-agent-tag {
    font-size: 10px; padding: 2px 8px; border-radius: 10px;
    background: rgba(107,48,255,0.12); color: var(--accent-purple-light);
    border: 1px solid rgba(107,48,255,0.2);
}

/* Copy success animation */
.share-action-btn.copied {
    background: var(--rag-green); border-color: var(--rag-green);
    color: #fff; pointer-events: none;
}
.snap-footer {
    text-align: center; font-size: 10px; color: var(--text-muted);
    margin-top: 16px; padding-top: 12px;
    border-top: 1px solid var(--border-subtle);
}

/* ========================================================
   EDITABLE FIELDS & INLINE EDITING
   ======================================================== */
.editable-field { cursor: pointer; position: relative; transition: background 0.2s; border-radius: 4px; padding: 2px 6px; display: inline-flex; align-items: center; gap: 4px; }
.editable-field:hover { background: rgba(107,48,255,0.08); }
.editable-field .ef-pencil { font-size: 10px; opacity: 0; transition: opacity 0.2s; }
.editable-field:hover .ef-pencil { opacity: 0.7; }

.inline-edit-overlay { position: fixed; z-index: 1200; background: var(--bg-card); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid var(--border-default); border-radius: var(--radius-sm); padding: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.05); min-width: 180px; }
.inline-edit-overlay .dd-option { padding: 8px 12px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-primary); }
.inline-edit-overlay .dd-option:hover { background: rgba(107,48,255,0.1); }
.inline-edit-overlay .dd-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.inline-edit-input { width: 100%; padding: 6px 10px; border: 1px solid var(--border-default); border-radius: var(--radius-sm); background: var(--bg-secondary); color: var(--text-primary); font-size: 13px; box-sizing: border-box; }
.inline-edit-input:focus { outline: none; border-color: var(--accent-purple); }
.inline-edit-actions { display: flex; gap: 6px; margin-top: 6px; justify-content: flex-end; }
.inline-edit-actions button { padding: 4px 10px; border-radius: 4px; border: 1px solid var(--border-default); background: var(--bg-secondary); color: var(--text-primary); font-size: 11px; cursor: pointer; }
.inline-edit-actions button.save { background: var(--accent-purple); color: #fff; border-color: var(--accent-purple); }

/* Local edit indicator */
.local-edit-badge { font-size: 10px; color: var(--accent-purple); background: rgba(107,48,255,0.1); padding: 2px 8px; border-radius: 10px; display: inline-block; }
.local-edit-indicator { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(107,48,255,0.06); border: 1px dashed rgba(107,48,255,0.3); border-radius: var(--radius-sm); margin-bottom: 12px; font-size: 12px; color: var(--accent-purple-light); }
.local-edit-indicator button { background: var(--accent-purple); color: #fff; border: none; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; margin-left: auto; }
.local-edit-indicator button:hover { opacity: 0.85; }
.local-edit-indicator .sync-btn { background: var(--rag-green); }

/* Change detection inline indicators */
.change-inline { font-size: 10px; font-weight: 700; margin-left: 4px; vertical-align: middle; }
.change-inline.improved { color: var(--rag-green); }
.change-inline.declined { color: var(--rag-red); }
.change-inline.neutral { color: var(--accent-purple-light); }
.change-summary-strip { font-size: 11px; color: var(--text-muted); padding: 8px 0 0; border-top: 1px solid var(--border-default); margin-top: 8px; line-height: 1.6; }
.change-summary-strip .cs-item { display: inline; margin-right: 8px; white-space: nowrap; }
.change-summary-strip .cs-arrow { margin: 0 2px; }

/* Recent changes card (client detail) */
.recent-changes-card { background: rgba(253,171,61,0.06); border: 1px solid rgba(253,171,61,0.2); border-radius: var(--radius-lg); padding: 16px; margin-bottom: 20px; }
.recent-changes-card h4 { font-size: 14px; font-weight: 600; color: var(--rag-amber); margin-bottom: 10px; }
.recent-changes-card .rc-item { display: flex; align-items: center; gap: 8px; padding: 4px 0; font-size: 13px; }
.recent-changes-card .rc-field { font-weight: 600; color: var(--text-primary); min-width: 100px; }
.recent-changes-card .rc-old { color: var(--text-muted); text-decoration: line-through; }
.recent-changes-card .rc-arrow { color: var(--text-muted); }
.recent-changes-card .rc-new { font-weight: 600; }
.recent-changes-card .rc-new.improved { color: var(--rag-green); }
.recent-changes-card .rc-new.declined { color: var(--rag-red); }
.recent-changes-card .rc-new.neutral { color: var(--accent-purple-light); }

/* KPI insight popover */
.kpi-insight-popover { position: fixed; z-index: 1100; background: var(--bg-card); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: 0; width: 440px; max-height: 520px; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.05); }
.kpi-insight-header { padding: 14px 16px; border-bottom: 1px solid var(--border-default); display: flex; justify-content: space-between; align-items: center; }
.kpi-insight-header h4 { font-size: 14px; font-weight: 600; color: var(--text-primary); margin: 0; }
.kpi-insight-body { padding: 14px 16px; }
.kpi-insight-close { background: none; border: none; color: var(--text-muted); font-size: 20px; cursor: pointer; line-height: 1; padding: 0; }
.kpi-insight-close:hover { color: var(--text-primary); }
.kpi-insight-row { display: flex; justify-content: space-between; align-items: flex-start; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.04); }
.kpi-insight-row:last-child { border-bottom: none; }
.kpi-insight-client { font-size: 13px; font-weight: 500; color: var(--text-primary); cursor: pointer; }
.kpi-insight-client:hover { color: var(--accent-purple-light); }
.kpi-insight-rag-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
.kpi-insight-factors { display: grid; grid-template-columns: 1fr 1fr; gap: 2px 12px; font-size: 11px; color: var(--text-muted); margin-top: 4px; }
.kpi-insight-delta { font-weight: 700; font-size: 13px; }
.kpi-insight-delta.up { color: var(--rag-green); }
.kpi-insight-delta.down { color: var(--rag-red); }
.kpi-insight-section-title { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin: 14px 0 8px; padding-top: 10px; border-top: 1px solid var(--border-default); }
.kpi-insight-change { display: flex; align-items: center; gap: 6px; padding: 4px 0; font-size: 12px; }
.kpi-insight-change .ci-icon { font-size: 14px; }

/* Health breakdown specific */
.health-breakdown-item { background: var(--bg-secondary); border-radius: var(--radius-sm); padding: 10px 12px; margin-bottom: 8px; }
.health-breakdown-item .hb-header { display: flex; justify-content: space-between; align-items: center; }
.health-breakdown-item .hb-name { font-size: 13px; font-weight: 600; color: var(--text-primary); }
.health-breakdown-item .hb-score { font-size: 16px; font-weight: 700; }
.health-breakdown-item .hb-factors { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
.health-breakdown-item .hb-factor { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.05); color: var(--text-muted); }
.health-breakdown-item .hb-factor.positive { color: var(--rag-green); background: rgba(0,200,117,0.08); }
.health-breakdown-item .hb-factor.negative { color: var(--rag-red); background: rgba(223,47,74,0.08); }

/* KPI tile interactive enhancements */
.kpi-card { cursor: pointer; transition: transform 0.15s ease, box-shadow 0.15s ease; }
.kpi-card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.2); }

/* ========================================================
   RESPONSIVE
   ======================================================== */
/* Ultrawide (2560px+) — triple column charts, spread everything out */
@media (min-width: 2560px) {
    .main-content { max-width: 2400px; padding: 28px 48px 60px; }
    .kpi-row { grid-template-columns: repeat(6, 1fr); gap: 16px; }
    .charts-section { grid-template-columns: repeat(3, 1fr); gap: 20px; }
    .email-cards { grid-template-columns: repeat(auto-fill, minmax(420px, 1fr)); gap: 18px; }
    .clients-large-grid { grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 22px; }
    .targets-grid { grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 18px; }
    .overview-quick-grid { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
    .planner-layout { grid-template-columns: 1fr 1fr; gap: 28px; }
    .calendar-section { padding: 24px; }
    .kb-grid { grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 20px; }
    .alert-card { max-width: 420px; }
    .client-detail-metrics { grid-template-columns: repeat(4, 1fr); gap: 18px; }
    .client-detail-charts { grid-template-columns: repeat(3, 1fr); gap: 18px; }
    .compare-table { font-size: 14px; }
    .compare-table th, .compare-table td { padding: 14px 20px; }
    .task-prompt-modal { max-width: 720px; }
}
/* Large desktop (1920px–2559px) — bigger spacing, wider grids */
@media (min-width: 1920px) and (max-width: 2559px) {
    .main-content { max-width: 1900px; padding: 24px 36px 60px; }
    .kpi-row { grid-template-columns: repeat(6, 1fr); gap: 14px; }
    .charts-section { grid-template-columns: 1fr 1fr; gap: 18px; }
    .email-cards { grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); }
    .clients-large-grid { grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); }
    .targets-grid { grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); }
    .planner-layout { grid-template-columns: 1fr 1fr; gap: 24px; }
    .client-detail-metrics { grid-template-columns: repeat(4, 1fr); }
    .client-detail-charts { grid-template-columns: repeat(3, 1fr); }
    .alert-card { max-width: 400px; }
}
/* Desktop sidebar push (1025px+) */
@media (min-width: 1025px) {
    .sidebar.open ~ .dashboard { margin-left: 260px; transition: margin-left var(--transition-smooth); }
    .sidebar-overlay { display: none !important; }
}
/* Medium screens (1200px and below) */
@media (max-width: 1200px) {
    .kpi-row { grid-template-columns: repeat(3, 1fr); }
    .charts-section { grid-template-columns: 1fr; }
    .clients-grid { grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); }
    .clients-large-grid { grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); }
    .targets-grid { grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); }
}
/* Tablet / small laptop (1024px and below — sidebar overlay) */
@media (max-width: 1024px) {
    .sidebar.open ~ .dashboard { margin-left: 0; }
    .planner-layout { gap: 16px; }
}
/* Tablet portrait & large phones (768px and below) */
@media (max-width: 768px) {
    .kpi-row { grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .navbar { padding: 10px 16px; }
    .nav-brand .brand-text { display: none; }
    .nav-brand .brand-user { display: none; }
    .search-box { width: 120px; }
    .clients-grid { grid-template-columns: 1fr; }
    .clients-large-grid { grid-template-columns: 1fr; }
    .detail-panel { width: 100%; }
    .main-content { padding: 16px; }
    .detail-field-row { grid-template-columns: 1fr; }
    .alerts-grid { flex-direction: column; }
    .kb-grid { grid-template-columns: 1fr; }
    .alert-card { max-width: none; }
    .share-modal { width: 98%; max-height: 92vh; }
    .share-modal-actions { flex-wrap: wrap; gap: 6px; }
    .snap-kpi-row { grid-template-columns: repeat(2, 1fr); }
    .snap-client-metrics { grid-template-columns: 1fr; }
    .email-cards { grid-template-columns: 1fr; }
    .overview-quick-grid { grid-template-columns: 1fr; }
    .client-detail-metrics { grid-template-columns: repeat(2, 1fr); }
    .client-detail-charts { grid-template-columns: 1fr; }
    .compare-table { font-size: 12px; }
    .planner-layout { grid-template-columns: 1fr; }
    .calendar-event-card { flex-direction: column; gap: 8px; }
    .cal-time-block { min-width: auto; display: flex; gap: 8px; align-items: center; }
    .cal-actions { align-self: flex-end; }
    .task-prompt-modal { width: 96%; padding: 20px; }
    .change-popover { width: 92vw; max-width: 340px; }
    .todo-filters { flex-wrap: wrap; }
    .week-day-card { padding: 12px 14px; }
    .setup-overlay { padding: 20px 0; }
    .setup-modal { padding: 32px 24px; width: 95%; }
    .target-client-item { padding: 8px 10px; gap: 4px 8px; }
    .target-detail-stats { gap: 8px; }
    .target-detail-stat { padding: 8px 12px; min-width: 60px; }
    .target-detail-stat .tds-value { font-size: 16px; }
    .targets-grid { grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); }
}
/* Small phones (480px and below) */
@media (max-width: 480px) {
    .kpi-row { grid-template-columns: 1fr; gap: 8px; }
    .main-content { padding: 12px 10px 60px; }
    .navbar { padding: 8px 12px; gap: 6px; }
    .burger-btn { width: 36px; height: 36px; font-size: 16px; }
    .nav-brand .pod-tag { display: none; }
    .nav-actions { gap: 4px; }
    .nav-actions button { padding: 6px 8px; font-size: 11px; }
    .targets-grid { grid-template-columns: 1fr; }
    .target-card { padding: 14px; }
    .email-cards { grid-template-columns: 1fr; }
    .client-detail-metrics { grid-template-columns: 1fr; }
    .compare-table th, .compare-table td { padding: 8px 10px; font-size: 11px; }
    .planner-section-title { font-size: 14px; }
    .todo-filters { gap: 4px; }
    .todo-filter-btn { padding: 4px 8px; font-size: 10px; }
    .week-day-card { padding: 10px 12px; }
    .week-event-item { flex-wrap: wrap; gap: 4px; }
    .calendar-section { padding: 14px; }
    .task-prompt-modal { padding: 16px; }
    .task-prompt-textarea { min-height: 110px; font-size: 14px; }
    .task-prompt-actions { flex-direction: column; }
    .task-prompt-actions button { width: 100%; text-align: center; }
    .sidebar { width: 100%; }
    .kb-header { flex-direction: column; align-items: flex-start; }
    .kb-btn-add { width: 100%; justify-content: center; }
    .kb-modal { padding: 20px; }
    .kb-modal-actions { flex-direction: column; }
    .kb-modal-btn { width: 100%; text-align: center; }
    .kb-viewer-toolbar { flex-wrap: wrap; padding: 8px 12px; gap: 8px; }
    .kb-viewer-title { font-size: 13px; order: 3; width: 100%; }
    .btn-open-prompt { width: 100%; justify-content: center; }
    .share-modal-header { padding: 16px; }
    .share-modal-actions { padding: 10px 16px; }
    .share-modal-body { padding: 16px; }
    .share-action-btn { flex: 1; justify-content: center; font-size: 11px; padding: 8px 10px; }
    .snap-kpi-row { grid-template-columns: repeat(2, 1fr); gap: 8px; }
    .setup-overlay { padding: 12px 0; }
    .setup-modal { padding: 24px 16px; border-radius: var(--radius-lg); }
    .setup-close-btn { top: 8px; right: 8px; width: 28px; height: 28px; font-size: 14px; }
    .mode-toggle-btn { font-size: 12px; padding: 10px 12px; }
    .btn-secondary { font-size: 12px; padding: 8px; }
    .setup-modal .logo { font-size: 22px; }
    .setup-modal h2 { font-size: 17px; }
    .setup-modal .subtitle { font-size: 12px; margin-bottom: 20px; }
    .setup-hint { font-size: 11px; }
    .target-client-item { font-size: 11px; padding: 8px; gap: 4px 6px; }
    .target-client-item > span:first-child { min-width: 60px; }
    .target-client-item-actions { gap: 3px; }
    .target-exclude-btn, .target-include-btn, .target-override-btn { width: 24px; height: 24px; font-size: 11px; }
    .tcl-status { font-size: 10px !important; padding: 2px 6px !important; }
    .target-detail-stat { padding: 6px 10px; min-width: 50px; }
    .target-detail-stat .tds-value { font-size: 14px; }
    .target-detail-stat .tds-label { font-size: 9px; }
}
    </style>
    <script>
    // Apply theme immediately to prevent flash
    (function(){
        const saved = localStorage.getItem('iai_theme') || 'dark';
        let resolved = saved;
        if (saved === 'system') {
            resolved = window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
        }
        document.documentElement.setAttribute('data-theme', resolved);
    })();
    </script>
</head>
<body>

<!-- ======== SETUP MODAL ======== -->
<div class="setup-overlay" id="setupOverlay">
    <div class="setup-modal">
        <button class="setup-close-btn" id="setupCloseBtn" onclick="closeSetup()" title="Close" style="display:none;">&#10005;</button>
        <div class="logo">ImplementAI</div>
        <div class="subtitle" id="setupSubtitle">Client Productivity Dashboard</div>
        <h2>Connect to monday.com</h2>
        <p style="color:var(--text-muted);font-size:13px;margin-bottom:24px;">Enter your API token to sync live client data</p>
        <div class="setup-input-group">
            <label>API Token</label>
            <input type="password" id="tokenInput" placeholder="eyJhbGciOiJIUzI1NiJ9...">
            <button class="toggle-vis" onclick="toggleTokenVis()" title="Show/Hide">&#128065;</button>
        </div>
        <div class="setup-error" id="setupError"></div>
        <div class="setup-success" id="setupSuccess"></div>
        <button class="btn-primary" id="btnTestConnect" onclick="testConnection()">Test Connection &amp; Launch</button>
        <button class="btn-secondary" onclick="launchOffline()">Launch Offline (Standalone)</button>
        <div class="setup-hint">
            Get your token: monday.com &#8594; Profile Picture &#8594; Developers &#8594; My Access Tokens<br>
            Your token is stored locally in your browser only.
        </div>

        <div style="border-top:1px solid var(--border-default);margin:24px 0 16px;padding-top:16px;">
            <h3 style="font-size:14px;color:var(--text-secondary);margin-bottom:4px;">&#128236; Connect Outlook <span style="font-size:11px;color:var(--text-muted);font-weight:400;">(Optional)</span></h3>
            <p style="color:var(--text-muted);font-size:12px;margin-bottom:12px;">Paste an MS Graph access token to sync live email data. Without this, snapshot data is used.</p>
            <div class="setup-input-group">
                <label>Outlook Token</label>
                <input type="password" id="outlookTokenInput" placeholder="EwB4A8l6BAAURSN...">
                <button class="toggle-vis" onclick="const i=document.getElementById('outlookTokenInput');i.type=i.type==='password'?'text':'password'" title="Show/Hide">&#128065;</button>
            </div>
            <div class="setup-hint" style="margin-top:8px;">
                Get your token: <a href="https://developer.microsoft.com/en-us/graph/graph-explorer" target="_blank" style="color:var(--accent-purple-light);">Graph Explorer</a> &#8594; Sign in &#8594; Access token tab &#8594; Copy<br>
                Requires <strong>Mail.Read</strong> and <strong>Calendars.Read</strong> scopes. Token expires after ~1 hour — dashboard falls back to cached data.
            </div>
        </div>

        <div style="border-top:1px solid var(--border-default);margin:24px 0 16px;padding-top:16px;">
            <h3 style="font-size:14px;color:var(--text-secondary);margin-bottom:4px;">&#128225; Connection Mode</h3>
            <p style="color:var(--text-muted);font-size:12px;margin-bottom:8px;">Choose how the dashboard connects to data sources.</p>
            <div class="mode-toggle-group" id="modeToggleGroup">
                <button class="mode-toggle-btn active" data-mode="online" onclick="setConnectionMode('online')">&#9989; Online — Live sync with monday.com &amp; Outlook</button>
                <button class="mode-toggle-btn" data-mode="offline" onclick="setConnectionMode('offline')">&#128268; Offline / Standalone — Use local &amp; snapshot data only</button>
            </div>
            <p class="setup-hint" id="modeHint" style="margin-top:4px;"></p>
        </div>

        <div style="border-top:1px solid var(--border-default);margin:24px 0 16px;padding-top:16px;">
            <h3 style="font-size:14px;color:var(--text-secondary);margin-bottom:4px;">&#127760; Switch Pod</h3>
            <p style="color:var(--text-muted);font-size:12px;margin-bottom:12px;" id="currentPodInfo">No pod selected yet</p>
            <button class="btn-primary" style="background:var(--bg-elevated);color:var(--text-primary);border:1px solid var(--border-default);font-size:13px;padding:8px 16px;" onclick="switchPod()">Change Pod</button>
        </div>
    </div>
</div>

<!-- ======== POD SELECTION OVERLAY ======== -->
<div class="setup-overlay hidden" id="podSelectOverlay">
    <div class="setup-modal" style="max-width:460px;">
        <div class="logo">ImplementAI</div>
        <div class="subtitle" id="podSelectGreeting">Welcome!</div>
        <h2 style="margin-bottom:6px;">Select Your Pod</h2>
        <p style="color:var(--text-muted);font-size:13px;margin-bottom:24px;">Choose the pod you manage. This filters the dashboard to show only your clients.</p>
        <div id="podSelectButtons" style="display:flex;flex-direction:column;gap:10px;">
            <!-- Dynamically populated -->
        </div>
        <div class="setup-hint" style="margin-top:20px;">You can switch pods anytime via the Settings panel (&#9881;).</div>
    </div>
</div>

<!-- ======== FIRST LOGIN SPLASH ======== -->
<div class="setup-overlay hidden" id="splashOverlay">
    <div class="setup-modal" style="max-width:540px;">
        <div class="logo">ImplementAI</div>
        <h2 style="margin-bottom:8px;">Welcome to Your Pod Dashboard</h2>
        <p style="color:var(--text-muted);font-size:13px;margin-bottom:24px;" id="splashPodText"></p>

        <div style="text-align:left;margin-bottom:24px;">
            <div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:18px;">
                <span style="font-size:28px;flex-shrink:0;">&#128236;</span>
                <div>
                    <strong style="color:var(--text-primary);font-size:14px;">Live Email Activity</strong>
                    <p style="color:var(--text-muted);font-size:12px;margin-top:4px;line-height:1.5;">
                        Connect your <strong>Outlook</strong> via Settings to see live email sync with your clients.
                        This requires an MS Graph access token with <strong>Mail.Read</strong> scope.
                        Tokens expire after ~1 hour — the dashboard caches data and falls back gracefully.
                    </p>
                </div>
            </div>
            <div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:18px;">
                <span style="font-size:28px;flex-shrink:0;">&#128247;</span>
                <div>
                    <strong style="color:var(--text-primary);font-size:14px;">Snapshot Fallback</strong>
                    <p style="color:var(--text-muted);font-size:12px;margin-top:4px;line-height:1.5;">
                        Without Outlook connected, Email Activity shows a static snapshot (if available for your pod).
                        You can still use all other dashboard features — Outlook is fully optional.
                    </p>
                </div>
            </div>
            <div style="display:flex;align-items:flex-start;gap:12px;">
                <span style="font-size:28px;flex-shrink:0;">&#128274;</span>
                <div>
                    <strong style="color:var(--text-primary);font-size:14px;">Your Data is Private &amp; Local</strong>
                    <p style="color:var(--text-muted);font-size:12px;margin-top:4px;line-height:1.5;">
                        Targets, To-Do items, Knowledge Base docs, and local edits are stored in your browser
                        and namespaced to your pod. They persist across sessions but are not shared with other users.
                    </p>
                </div>
            </div>
        </div>

        <button class="btn-primary" onclick="dismissSplash()" style="width:100%;padding:14px;">
            Got It &mdash; Open Dashboard
        </button>
    </div>
</div>

<!-- ======== LOADING OVERLAY ======== -->
<!-- ======== SHARE SNAPSHOT MODAL ======== -->
<div class="share-overlay" id="shareOverlay" onclick="if(event.target===this)ShareSnapshot.close()">
    <div class="share-modal">
        <div class="share-modal-header">
            <h3>&#128228; Dashboard Snapshot</h3>
            <button class="share-modal-close" onclick="ShareSnapshot.close()" title="Close">&times;</button>
        </div>
        <div class="share-modal-actions">
            <button class="share-action-btn primary" onclick="ShareSnapshot.copyText()" id="btnCopyText">&#128203; Copy as Text</button>
            <button class="share-action-btn" onclick="ShareSnapshot.copyHTML()" id="btnCopyHTML">&#128196; Copy Rich Format</button>
            <button class="share-action-btn" onclick="ShareSnapshot.exportHTML()" id="btnExportHTML">&#128190; Export as HTML</button>
            <button class="share-action-btn" onclick="ShareSnapshot.exportPDF()" id="btnExportPDF">&#128462; Export as PDF</button>
        </div>
        <div class="share-modal-body" id="shareSnapshotBody">
            <!-- Snapshot content rendered here by JS -->
        </div>
    </div>
</div>

<div class="loading-overlay hidden" id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">Loading client data...</div>
</div>

<!-- ======== TOAST CONTAINER ======== -->
<div class="toast-container" id="toastContainer"></div>

<!-- ======== DETAIL BACKDROP ======== -->
<div class="detail-backdrop" id="detailBackdrop" onclick="closeDetail()"></div>

<!-- ======== DETAIL PANEL ======== -->
<div class="detail-panel" id="detailPanel">
    <div class="detail-header">
        <div>
            <h2 id="detailName">Client Name</h2>
            <div class="detail-subtitle" id="detailSubtitle">Loading...</div>
        </div>
        <button class="btn-close-detail" onclick="closeDetail()">&#10005;</button>
    </div>
    <div class="detail-body" id="detailBody"></div>
    <div class="detail-footer">
        <button class="btn-save" id="btnSaveAll" onclick="saveAllChanges()">Save All Changes</button>
        <button class="btn-secondary" id="btnOpenMonday" onclick="openInMonday()">Open in monday.com</button>
    </div>
</div>

<!-- ======== KEYBOARD SHORTCUTS PANEL ======== -->
<div class="shortcuts-panel" id="shortcutsPanel">
    <h4>Keyboard Shortcuts</h4>
    <div class="shortcut-row"><span>Refresh data</span><span class="shortcut-key">R</span></div>
    <div class="shortcut-row"><span>Search clients</span><span class="shortcut-key">/</span></div>
    <div class="shortcut-row"><span>Show all clients</span><span class="shortcut-key">A</span></div>
    <div class="shortcut-row"><span>Filter Green</span><span class="shortcut-key">1</span></div>
    <div class="shortcut-row"><span>Filter Amber</span><span class="shortcut-key">2</span></div>
    <div class="shortcut-row"><span>Filter Red</span><span class="shortcut-key">3</span></div>
    <div class="shortcut-row"><span>Close panel / ESC</span><span class="shortcut-key">Esc</span></div>
    <div class="shortcut-row"><span>Toggle this panel</span><span class="shortcut-key">?</span></div>
</div>

<!-- ======== SIDEBAR OVERLAY ======== -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="Router.toggleSidebar()"></div>

<!-- ======== SIDEBAR NAVIGATION ======== -->
<nav class="sidebar" id="sidebar">
    <div class="sidebar-header">IAI — Pod B Dashboard</div>
    <button class="sidebar-close" onclick="Router.closeSidebar()" title="Close menu">&#10005;</button>
    <a class="sidebar-nav-item active" data-route="overview" onclick="Router.navigate('overview')">
        <span class="nav-icon">&#128202;</span> Overview
    </a>
    <a class="sidebar-nav-item" data-route="charts" onclick="Router.navigate('charts')">
        <span class="nav-icon">&#128200;</span> Charts
    </a>
    <a class="sidebar-nav-item" data-route="targets" onclick="Router.navigate('targets')">
        <span class="nav-icon">&#127919;</span> Targets &amp; Goals
    </a>
    <a class="sidebar-nav-item" data-route="planner" onclick="Router.navigate('planner')">
        <span class="nav-icon">&#128467;</span> Planner &amp; To-Do
    </a>
    <a class="sidebar-nav-item" data-route="emails" onclick="Router.navigate('emails')">
        <span class="nav-icon">&#128236;</span> Email Activity
    </a>
    <a class="sidebar-nav-item" data-route="clients" onclick="Router.navigate('clients')">
        <span class="nav-icon">&#128101;</span> Client Portfolio
    </a>
    <a class="sidebar-nav-item" data-route="clients/compare" onclick="Router.navigate('clients/compare')">
        <span class="nav-icon">&#128203;</span> Compare Clients
    </a>
    <div style="border-top:1px solid var(--border-subtle);margin:10px 16px;"></div>
    <a class="sidebar-nav-item" data-route="knowledgebase" onclick="Router.navigate('knowledgebase')">
        <span class="nav-icon">&#128218;</span> Knowledge Base
    </a>
</nav>

<!-- ======== DASHBOARD WRAPPER ======== -->
<div class="dashboard" id="dashboard">

<!-- ======== NAVBAR ======== -->
<nav class="navbar" id="navbar">
    <div class="nav-brand">
        <button class="burger-btn" onclick="Router.toggleSidebar()" title="Menu">&#9776;</button>
        <a class="brand-home-link" onclick="Router.navigate('overview')" title="Go to Overview">
            <div class="brand-icon">IAI</div>
            <span class="brand-text">Pod B Dashboard</span>
            <span class="pod-tag">POD B</span>
        </a>
        <span class="brand-user">Mishai</span>
    </div>
    <div class="nav-actions">
        <input class="search-box" type="text" placeholder="Search clients... ( / )" id="searchBox" oninput="setSearch(this.value)">
        <button class="btn-icon" id="btnAlerts" onclick="toggleAlerts()" title="Smart Alerts">&#128276;<span class="alert-badge hidden" id="alertBadge">0</span></button>
        <button class="btn-icon" id="btnRefresh" onclick="refreshData()" title="Refresh (R)">&#8635;</button>
        <button class="btn-icon" onclick="ShareSnapshot.open()" title="Share Snapshot">&#128228;</button>
        <span class="last-refresh" id="lastRefresh">
            <span id="lastRefreshTime">--</span>
            <span class="refresh-countdown" id="refreshCountdown"></span>
        </span>
        <div class="theme-toggle" id="themeToggle" title="Toggle theme">
            <button data-theme-btn="light" onclick="setTheme('light')" title="Light mode">&#9788;</button>
            <button data-theme-btn="dark" onclick="setTheme('dark')" title="Dark mode">&#9790;</button>
            <button data-theme-btn="system" onclick="setTheme('system')" title="Match system">&#128187;</button>
        </div>
        <span class="nav-connection-status" id="navConnectionStatus" data-status="online" style="display:none;"><span class="conn-dot"></span><span id="connStatusText">Online</span></span>
        <button class="btn-icon" onclick="showSetup()" title="Settings">&#9881;</button>
    </div>
</nav>

<!-- ======== MAIN APP ======== -->
<div class="main-content" id="mainContent">

    <!-- ====== PAGE: OVERVIEW ====== -->
    <div class="page-container page-active" id="page-overview">
        <!-- SMART ALERTS -->
        <div class="alerts-section hidden" id="alertsSection">
            <div class="alerts-header">
                <h3>&#9888;&#65039; Smart Alerts <span id="alertsTotalCount"></span></h3>
                <div class="alerts-actions">
                    <button class="alerts-clear" onclick="clearAllAlerts()" title="Clear all alerts for this session">Clear All</button>
                    <button class="alerts-toggle" onclick="toggleAlerts()">Dismiss</button>
                </div>
            </div>
            <div class="alerts-grid" id="alertsGrid"></div>
        </div>
        <!-- KPI ROW -->
        <div class="kpi-row" id="kpiRow"></div>
        <!-- OVERVIEW CONTENT (rendered by JS) -->
        <div id="overviewContent"></div>
    </div>

    <!-- ====== PAGE: CHARTS ====== -->
    <div class="page-container" id="page-charts">
        <div class="charts-section" id="chartsSection">
            <div class="chart-card">
                <h3>RAG Status Distribution</h3>
                <div class="chart-wrapper"><canvas id="ragChart"></canvas></div>
            </div>
            <div class="chart-card">
                <h3>AIOS Plan Breakdown</h3>
                <div class="chart-wrapper"><canvas id="planChart"></canvas></div>
            </div>
            <div class="chart-card">
                <h3>Agents by Client</h3>
                <div class="chart-wrapper"><canvas id="agentsChart"></canvas></div>
            </div>
            <div class="chart-card">
                <h3>AIOS Days (Time in Programme)</h3>
                <div class="chart-wrapper"><canvas id="daysChart"></canvas></div>
            </div>
        </div>
    </div>

    <!-- ====== PAGE: TARGETS ====== -->
    <div class="page-container" id="page-targets">
        <div class="targets-section" id="targetsSection">
            <div class="targets-header">
                <h2>&#127919; Targets &amp; Goals</h2>
                <button class="btn-add-target" onclick="TargetsManager.openAddModal()">+ Add Target</button>
            </div>
            <div class="targets-grid" id="targetsGrid"></div>
        </div>
    </div>

    <!-- TARGET ADD/EDIT MODAL (global, not in a page) -->
    <div class="target-modal-overlay" id="targetModalOverlay">
        <div class="target-modal">
            <h3 id="targetModalTitle">Add New Target</h3>
            <div class="field">
                <label>Target Title</label>
                <input type="text" id="targetTitleInput" placeholder="e.g. Complete all client onboarding">
            </div>
            <div class="field">
                <label>Goal (target number)</label>
                <input type="number" id="targetGoalInput" placeholder="e.g. 7" min="1">
            </div>
            <div class="field">
                <label>Current Progress</label>
                <input type="number" id="targetCurrentInput" placeholder="e.g. 3" min="0">
            </div>
            <div class="field">
                <label>Deadline (optional)</label>
                <input type="date" id="targetDeadlineInput">
            </div>
            <input type="hidden" id="targetEditId" value="">
            <div class="target-modal-actions">
                <button class="btn-cancel" onclick="TargetsManager.closeModal()">Cancel</button>
                <button class="btn-primary" onclick="TargetsManager.saveFromModal()">Save Target</button>
            </div>
        </div>
    </div>

    <!-- ====== TASK PROMPT MODAL ====== -->
    <div class="task-prompt-overlay" id="taskPromptOverlay" onclick="if(event.target===this)closeTaskPrompt();">
        <div class="task-prompt-modal">
            <h3>&#128221; Add Tasks</h3>
            <div class="prompt-subtitle">
                Paste your tasks below — one per line. You can include priority and dates:<br>
                <span style="color:var(--text-primary);">Format: </span>
                <code style="background:var(--bg-elevated);padding:2px 6px;border-radius:4px;font-size:11px;">Task text [!high/!medium/!low] [@date]</code><br>
                <span style="color:var(--text-muted);font-size:11px;">e.g. "Follow up with Townhouse !high @2026-02-24" or just "Update client notes"</span>
            </div>
            <textarea class="task-prompt-textarea" id="taskPromptText" placeholder="Follow up with Townhouse on booking agent !high @2026-02-24&#10;Send QDP recall campaign update&#10;Review Orbital email notification system !medium&#10;Prepare weekly pod report !low @2026-02-28&#10;Update GANESHA project board"></textarea>
            <div class="task-prompt-options">
                <label>Default priority:</label>
                <select id="taskPromptDefaultPriority">
                    <option value="high">High</option>
                    <option value="medium" selected>Medium</option>
                    <option value="low">Low</option>
                </select>
                <label>Default date:</label>
                <select id="taskPromptDateMode">
                    <option value="today" selected>Today</option>
                    <option value="spread">Spread across week</option>
                    <option value="custom">Custom date</option>
                </select>
                <input type="date" id="taskPromptCustomDate" style="display:none;" value="">
            </div>
            <div class="task-prompt-preview" id="taskPromptPreview">
                <div class="task-prompt-preview-title">Preview (<span id="taskPromptPreviewCount">0</span> tasks)</div>
                <div id="taskPromptPreviewList"></div>
            </div>
            <div class="task-prompt-actions">
                <button class="btn-cancel" onclick="closeTaskPrompt()">Cancel</button>
                <button class="btn-add-tasks" id="taskPromptSubmit" onclick="submitTaskPrompt()">Add Tasks</button>
            </div>
        </div>
    </div>

    <!-- ====== PAGE: PLANNER & TO-DO ====== -->
    <div class="page-container" id="page-planner">
        <div id="plannerContent"></div>
    </div>

    <!-- ====== PAGE: KNOWLEDGE BASE ====== -->
    <div class="page-container" id="page-knowledgebase">
        <div id="kbContent"></div>
        <!-- KB Viewer (hidden until a doc is opened) -->
        <div class="kb-viewer-wrap" id="kbViewerWrap" style="display:none;">
            <div class="kb-viewer-toolbar">
                <button class="kb-viewer-back" onclick="KnowledgeBase.closeViewer()">&#8592; Back to Documents</button>
                <span class="kb-viewer-title" id="kbViewerTitle"></span>
                <a class="kb-viewer-external" id="kbViewerExternal" href="#" target="_blank" title="Open in new tab">&#8599; Open Externally</a>
            </div>
            <iframe id="kbViewerFrame" class="kb-viewer-frame" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
        </div>
    </div>

    <!-- KB Add Document Modal -->
    <div class="kb-modal-overlay" id="kbAddModal" onclick="if(event.target===this)KnowledgeBase.closeAddModal();">
        <div class="kb-modal">
            <h3 class="kb-modal-title">&#10010; Add Document</h3>
            <div class="kb-modal-field">
                <label>Title *</label>
                <input type="text" id="kbDocTitle" placeholder="e.g. Kickoff Checklist, Onboarding Guide...">
            </div>
            <div class="kb-modal-field">
                <label>Description</label>
                <input type="text" id="kbDocDesc" placeholder="Brief description of the document">
            </div>
            <div class="kb-modal-field">
                <label>File Path or URL *</label>
                <input type="text" id="kbDocPath" placeholder="file:///C:/Users/.../doc.html or https://...">
                <span class="kb-modal-hint">Paste the full file path or web URL to the HTML document</span>
            </div>
            <div class="kb-modal-field">
                <label>Category</label>
                <select id="kbDocCategory">
                    <option value="checklist">Checklist</option>
                    <option value="guide">Guide / Playbook</option>
                    <option value="reference">Reference</option>
                    <option value="template">Template</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="kb-modal-field">
                <label>Icon</label>
                <select id="kbDocIcon">
                    <option value="📋">📋 Checklist</option>
                    <option value="📖">📖 Guide</option>
                    <option value="📄">📄 Document</option>
                    <option value="🛠">🛠 Toolkit</option>
                    <option value="🎯">🎯 Strategy</option>
                    <option value="📊">📊 Report</option>
                    <option value="⚡">⚡ Quick Ref</option>
                    <option value="🔐">🔐 Security</option>
                </select>
            </div>
            <div class="kb-modal-actions">
                <button class="kb-modal-btn cancel" onclick="KnowledgeBase.closeAddModal()">Cancel</button>
                <button class="kb-modal-btn add" onclick="KnowledgeBase.addFromModal()">Add Document</button>
            </div>
        </div>
    </div>

    <!-- ====== PAGE: EMAILS ====== -->
    <div class="page-container" id="page-emails">
        <div class="email-section" id="emailSection">
            <div class="email-section-header">
                <h2>&#128236; Email Activity</h2>
                <div class="email-sync-status">
                    <span class="email-sync-text" id="emailSyncText">Loading...</span>
                    <button class="email-sync-btn" id="btnEmailSync" onclick="OutlookSync.sync(true)" title="Sync now">&#128260; Sync</button>
                </div>
            </div>
            <div class="email-cards" id="emailCards"></div>
        </div>
    </div>

    <!-- ====== PAGE: CLIENTS ====== -->
    <div class="page-container" id="page-clients">
        <div id="clientsPageContent"></div>
    </div>

    <!-- ====== PAGE: COMPARE ====== -->
    <div class="page-container" id="page-compare">
        <div id="compareContent"></div>
    </div>

    <!-- ====== PAGE: CLIENT DETAIL ====== -->
    <div class="page-container" id="page-client-detail">
        <div id="clientDetailContent"></div>
    </div>

</div>
</div><!-- end .dashboard -->

<script>
/* ================================================================
   THEME MANAGER
   ================================================================ */
const ThemeManager = {
    _preference: localStorage.getItem('iai_theme') || 'dark',
    _mediaQuery: window.matchMedia('(prefers-color-scheme: light)'),

    init() {
        this.apply();
        this.updateToggleUI();
        // Listen for OS-level changes when in 'system' mode
        this._mediaQuery.addEventListener('change', () => {
            if (this._preference === 'system') this.apply();
        });
    },

    apply() {
        let resolved = this._preference;
        if (resolved === 'system') {
            resolved = this._mediaQuery.matches ? 'light' : 'dark';
        }
        document.documentElement.setAttribute('data-theme', resolved);
        // Update Chart.js defaults for the active theme
        if (typeof Chart !== 'undefined') {
            const isDark = resolved === 'dark';
            Chart.defaults.color = isDark ? '#999' : '#5e6c84';
            Chart.defaults.borderColor = isDark ? '#333' : '#dfe1e6';
        }
    },

    set(mode) {
        this._preference = mode;
        localStorage.setItem('iai_theme', mode);
        this.apply();
        this.updateToggleUI();
        // Re-render charts with correct colours
        if (typeof State !== 'undefined' && State.dataLoaded) {
            Charts.renderAll(State.clients);
        }
    },

    updateToggleUI() {
        document.querySelectorAll('#themeToggle button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.themeBtn === this._preference);
        });
    },

    isDark() {
        const resolved = this._preference === 'system'
            ? (this._mediaQuery.matches ? 'light' : 'dark')
            : this._preference;
        return resolved === 'dark';
    },
};

function setTheme(mode) { ThemeManager.set(mode); }

/* ================================================================
   ROUTER (HASH-BASED SPA NAVIGATION)
   ================================================================ */
const Router = {
    sidebarOpen: false,
    current: 'overview',
    currentParams: null,
    _chartInstances: {},  // track detail-page chart instances for cleanup

    pages: ['overview', 'charts', 'targets', 'emails', 'clients', 'clients/compare', 'client-detail'],

    toggleSidebar() {
        this.sidebarOpen = !this.sidebarOpen;
        document.getElementById('sidebar').classList.toggle('open', this.sidebarOpen);
        document.getElementById('sidebarOverlay').classList.toggle('visible', this.sidebarOpen);
    },

    closeSidebar() {
        this.sidebarOpen = false;
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('sidebarOverlay').classList.remove('visible');
    },

    navigate(route) {
        window.location.hash = '#/' + route;
    },

    parseRoute(hash) {
        const h = (hash || '').replace(/^#\/?/, '');
        if (h.startsWith('client/') && h !== 'clients/compare') {
            return { route: 'client-detail', params: { id: h.replace('client/', '') } };
        }
        if (h === 'clients/compare') return { route: 'clients/compare', params: null };
        const valid = ['overview', 'charts', 'targets', 'planner', 'emails', 'clients', 'knowledgebase'];
        return { route: valid.includes(h) ? h : 'overview', params: null };
    },

    showPage(route, params) {
        this.current = route;
        this.currentParams = params;

        // Hide all page containers
        document.querySelectorAll('.page-container').forEach(p => p.classList.remove('page-active'));

        // Determine which container to show
        let pageId;
        if (route === 'client-detail') pageId = 'page-client-detail';
        else if (route === 'clients/compare') pageId = 'page-compare';
        else pageId = 'page-' + route;

        const pageEl = document.getElementById(pageId);
        if (pageEl) pageEl.classList.add('page-active');

        // Update sidebar active state
        document.querySelectorAll('.sidebar-nav-item').forEach(item => {
            const itemRoute = item.getAttribute('data-route');
            item.classList.toggle('active', itemRoute === route || (route === 'client-detail' && itemRoute === 'clients'));
        });

        // Close sidebar on mobile after navigating
        if (window.innerWidth <= 1024) this.closeSidebar();

        // Close KB viewer if navigating away
        if (typeof KnowledgeBase !== 'undefined' && KnowledgeBase._viewerOpen) {
            KnowledgeBase.closeViewer();
        }

        // Destroy any old detail-page charts
        Object.values(this._chartInstances).forEach(c => { try { c.destroy(); } catch(e){} });
        this._chartInstances = {};

        // Render page-specific content
        // Planner page works without API data (uses localStorage + static calendar data)
        const dataIndependentPages = ['planner', 'targets', 'knowledgebase'];
        if ((typeof State !== 'undefined' && State.dataLoaded) || dataIndependentPages.includes(route)) {
            this._renderPage(route, params);
        }
    },

    _renderPage(route, params) {
        switch (route) {
            case 'overview':
                renderKPIs(State.clients);
                if (typeof renderOverviewPage === 'function') renderOverviewPage();
                break;
            case 'charts':
                setTimeout(() => Charts.renderAll(State.clients), 60);
                break;
            case 'targets':
                TargetsManager.render();
                break;
            case 'planner':
                if (typeof renderPlannerPage === 'function') renderPlannerPage();
                break;
            case 'knowledgebase':
                if (typeof KnowledgeBase !== 'undefined') KnowledgeBase.render();
                break;
            case 'emails':
                renderEmailActivity();
                break;
            case 'clients':
                renderClients();
                break;
            case 'clients/compare':
                if (typeof renderComparisonTable === 'function') renderComparisonTable();
                break;
            case 'client-detail':
                if (params && params.id && typeof renderClientFullPage === 'function') {
                    renderClientFullPage(params.id);
                }
                break;
        }
    },

    init() {
        window.addEventListener('hashchange', () => {
            const { route, params } = this.parseRoute(window.location.hash);
            this.showPage(route, params);
        });

        // Escape closes sidebar
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && this.sidebarOpen) this.closeSidebar();
        });

        // Parse initial hash
        const { route, params } = this.parseRoute(window.location.hash);
        this.showPage(route, params);
    }
};

/* ================================================================
   TARGETS & GOALS MANAGER
   ================================================================ */
const TargetsManager = {
    _key: 'iai_targets',
    _exKey: 'iai_target_exclusions',
    _sk() { return UserSession.podKey(this._key); },
    _exSk() { return UserSession.podKey(this._exKey); },
    _manualTargets: [],
    _exclusions: {}, // { targetId: ['ClientName1', 'ClientName2'] }
    _overrides: {}, // { targetId: ['ClientName1', 'ClientName2'] } — force-met
    _ovKey: 'iai_target_overrides',
    _ovSk() { return UserSession.podKey(this._ovKey); },

    autoTargets: [
        { id: 'auto_billing', title: 'All Clients Billing Active', field: 'billing', matchValue: 'Yes', icon: '&#128179;' },
        { id: 'auto_rag_green', title: 'All Clients Green RAG', field: 'rag', matchValue: 'Green', icon: '&#9679;' },
        { id: 'auto_updates', title: 'All Updates Confirmed', field: 'updateStatus', matchValue: 'Yes', icon: '&#9989;' },
    ],

    load() {
        try {
            const raw = localStorage.getItem(this._sk());
            this._manualTargets = raw ? JSON.parse(raw) : [];
        } catch { this._manualTargets = []; }
        try {
            const exRaw = localStorage.getItem(this._exSk());
            this._exclusions = exRaw ? JSON.parse(exRaw) : {};
        } catch { this._exclusions = {}; }
        try {
            const ovRaw = localStorage.getItem(this._ovSk());
            this._overrides = ovRaw ? JSON.parse(ovRaw) : {};
        } catch { this._overrides = {}; }
    },

    save() {
        localStorage.setItem(this._sk(), JSON.stringify(this._manualTargets));
    },

    _saveExclusions() {
        localStorage.setItem(this._exSk(), JSON.stringify(this._exclusions));
    },

    _saveOverrides() {
        localStorage.setItem(this._ovSk(), JSON.stringify(this._overrides));
    },

    isOverridden(targetId, clientName) {
        return (this._overrides[targetId] || []).includes(clientName);
    },

    toggleOverride(targetId, clientName) {
        if (!this._overrides[targetId]) this._overrides[targetId] = [];
        const idx = this._overrides[targetId].indexOf(clientName);
        if (idx >= 0) {
            this._overrides[targetId].splice(idx, 1);
            showToast(`${clientName} override removed`, 'info');
        } else {
            this._overrides[targetId].push(clientName);
            showToast(`${clientName} manually marked as met`, 'success');
        }
        this._saveOverrides();
        this.render();
    },

    isExcluded(targetId, clientName) {
        return (this._exclusions[targetId] || []).includes(clientName);
    },

    toggleExclusion(targetId, clientName) {
        if (!this._exclusions[targetId]) this._exclusions[targetId] = [];
        const idx = this._exclusions[targetId].indexOf(clientName);
        if (idx >= 0) {
            this._exclusions[targetId].splice(idx, 1);
            showToast(`${clientName} included in target`, 'info');
        } else {
            this._exclusions[targetId].push(clientName);
            showToast(`${clientName} excluded from target`, 'info');
        }
        this._saveExclusions();
        this.render();
    },

    _getActiveClients(targetId) {
        const clients = typeof State !== 'undefined' && State.clients ? State.clients : [];
        const excluded = this._exclusions[targetId] || [];
        return clients.filter(c => !excluded.includes(c.name));
    },

    getAll() {
        const clients = typeof State !== 'undefined' && State.clients ? State.clients : [];
        const targets = [];

        // Auto targets
        this.autoTargets.forEach(at => {
            const active = this._getActiveClients(at.id);
            const excluded = (this._exclusions[at.id] || []).length;
            const overrideNames = this._overrides[at.id] || [];
            const current = active.filter(c =>
                c[at.field] === at.matchValue || overrideNames.includes(c.name)
            ).length;
            const overridden = overrideNames.filter(name => active.some(c => c.name === name && c[at.field] !== at.matchValue)).length;
            targets.push({
                id: at.id, title: at.title, current, goal: active.length,
                type: 'auto', icon: at.icon, deadline: null,
                excludedCount: excluded, overriddenCount: overridden,
            });
        });

        // Manual targets
        this._manualTargets.forEach(mt => {
            targets.push({ ...mt, type: 'manual', icon: '&#9998;' });
        });

        return targets;
    },

    _expandedTargets: new Set(),

    toggleExpand(id) {
        const isExpanding = !this._expandedTargets.has(id);
        if (isExpanding) {
            this._expandedTargets.add(id);
        } else {
            this._expandedTargets.delete(id);
        }
        // Toggle directly on the DOM — avoids full re-render which causes animation glitches
        const card = document.querySelector(`.target-card[data-target-id="${id}"]`);
        if (card) {
            card.classList.toggle('expanded', isExpanding);
        } else {
            // Fallback: full re-render if card not found
            this.render();
        }
    },

    _buildAutoDetailPanel(target) {
        const allClients = typeof State !== 'undefined' && State.clients ? State.clients : [];
        const autoTarget = this.autoTargets.find(a => a.id === target.id);
        if (!autoTarget || allClients.length === 0) return '<p class="target-detail-description">No client data available.</p>';

        const excludedNames = this._exclusions[target.id] || [];
        const overriddenNames = this._overrides[target.id] || [];
        const activeClients = allClients.filter(c => !excludedNames.includes(c.name));
        const excludedClients = allClients.filter(c => excludedNames.includes(c.name));
        const met = activeClients.filter(c => c[autoTarget.field] === autoTarget.matchValue || overriddenNames.includes(c.name));
        const unmet = activeClients.filter(c => c[autoTarget.field] !== autoTarget.matchValue && !overriddenNames.includes(c.name));

        let fieldLabel = autoTarget.field === 'billing' ? 'Billing' : autoTarget.field === 'rag' ? 'RAG Status' : 'Update Status';
        let description = '';
        if (autoTarget.field === 'billing') {
            description = `This target tracks whether all clients have <strong>active billing</strong>. A client meets this target when their billing status is "Yes", meaning they are financially set up and payments are flowing correctly.`;
        } else if (autoTarget.field === 'rag') {
            description = `This target tracks whether all clients are at <strong>Green RAG status</strong>. Green means the client is healthy — no blockers, on track, and progressing well through their journey.`;
        } else if (autoTarget.field === 'updateStatus') {
            description = `This target tracks whether all client <strong>updates are confirmed</strong>. A confirmed update means the latest status has been reviewed, communicated, and logged properly.`;
        }

        const statsHtml = `
            <div class="target-detail-stats">
                <div class="target-detail-stat">
                    <span class="tds-value" style="color:var(--rag-green)">${met.length}</span>
                    <span class="tds-label">Meeting</span>
                </div>
                <div class="target-detail-stat">
                    <span class="tds-value" style="color:var(--rag-red)">${unmet.length}</span>
                    <span class="tds-label">Not Met</span>
                </div>
                <div class="target-detail-stat">
                    <span class="tds-value">${activeClients.length}</span>
                    <span class="tds-label">Active</span>
                </div>
                ${excludedClients.length > 0 ? `<div class="target-detail-stat">
                    <span class="tds-value" style="color:var(--text-muted)">${excludedClients.length}</span>
                    <span class="tds-label">Excluded</span>
                </div>` : ''}
                ${overriddenNames.filter(n => activeClients.some(c => c.name === n && c[autoTarget.field] !== autoTarget.matchValue)).length > 0 ? `<div class="target-detail-stat">
                    <span class="tds-value" style="color:var(--rag-amber)">${overriddenNames.filter(n => activeClients.some(c => c.name === n && c[autoTarget.field] !== autoTarget.matchValue)).length}</span>
                    <span class="tds-label">Overridden</span>
                </div>` : ''}
            </div>`;

        const clientListHtml = activeClients.map(c => {
            const esc = c.name.replace(/'/g, "\\'");
            const isNaturallyMet = c[autoTarget.field] === autoTarget.matchValue;
            const isManuallyMet = overriddenNames.includes(c.name);
            const isMet = isNaturallyMet || isManuallyMet;
            const currentVal = c[autoTarget.field] || '--';

            let statusHtml;
            if (isManuallyMet && !isNaturallyMet) {
                statusHtml = `<span class="tcl-status met manual">✓ Met (Manual)</span>`;
            } else if (isMet) {
                statusHtml = `<span class="tcl-status met">✓ Met</span>`;
            } else {
                statusHtml = `<span class="tcl-status unmet">✗ Action Needed</span>`;
            }

            let overrideBtn = '';
            if (isManuallyMet && !isNaturallyMet) {
                overrideBtn = `<button class="target-override-btn revert" onclick="event.stopPropagation();TargetsManager.toggleOverride('${target.id}','${esc}')" title="Remove manual override">↩</button>`;
            } else if (!isMet) {
                overrideBtn = `<button class="target-override-btn" onclick="event.stopPropagation();TargetsManager.toggleOverride('${target.id}','${esc}')" title="Manually mark as met">✓</button>`;
            }

            return `<div class="target-client-item${isManuallyMet && !isNaturallyMet ? ' manually-overridden' : ''}">
                <span>${c.name}</span>
                <span style="color:var(--text-muted);font-size:11px;">${fieldLabel}: ${currentVal}</span>
                <div class="target-client-item-actions">
                    ${statusHtml}
                    ${overrideBtn}
                    <button class="target-exclude-btn" onclick="event.stopPropagation();TargetsManager.toggleExclusion('${target.id}','${esc}')" title="Exclude from target">✕</button>
                </div>
            </div>`;
        }).join('');

        const excludedListHtml = excludedClients.length > 0 ? `
            <div style="margin-top:12px;">
                <div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Excluded Clients</div>
                <div class="target-client-list">${excludedClients.map(c => {
                    const currentVal = c[autoTarget.field] || '--';
                    return `<div class="target-client-item target-client-excluded">
                        <span style="text-decoration:line-through;opacity:0.6;">${c.name}</span>
                        <span style="color:var(--text-muted);font-size:11px;">${fieldLabel}: ${currentVal}</span>
                        <div class="target-client-item-actions">
                            <span class="tcl-status" style="background:rgba(255,255,255,0.05);color:var(--text-muted);">Excluded</span>
                            <button class="target-include-btn" onclick="event.stopPropagation();TargetsManager.toggleExclusion('${target.id}','${c.name.replace(/'/g,"\\'")}')" title="Include in target">&#8634;</button>
                        </div>
                    </div>`;
                }).join('')}</div>
            </div>` : '';

        const actionHint = unmet.length > 0 ?
            `<p class="target-detail-hint">💡 Action: Focus on ${unmet.map(c => c.name).join(', ')} to achieve this target.</p>` :
            `<p class="target-detail-hint">🎉 All active clients meet this target — great work!</p>`;

        return `
            <p class="target-detail-description">${description}</p>
            ${statsHtml}
            <div class="target-client-list">${clientListHtml}</div>
            ${excludedListHtml}
            ${actionHint}`;
    },

    _buildManualDetailPanel(target) {
        const pct = target.goal > 0 ? Math.round((target.current / target.goal) * 100) : 0;
        const remaining = Math.max(0, target.goal - target.current);

        let deadlineHtml = '';
        if (target.deadline) {
            const deadlineDate = new Date(target.deadline);
            const now = new Date();
            const diffDays = Math.ceil((deadlineDate - now) / (1000 * 60 * 60 * 24));
            const urgency = diffDays < 0 ? '🔴 Overdue!' : diffDays <= 7 ? '🟠 Due soon' : '🟢 On track';
            deadlineHtml = `
                <div class="target-deadline-info">
                    📅 Deadline: <strong>${deadlineDate.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' })}</strong>
                    &nbsp;—&nbsp;${diffDays < 0 ? Math.abs(diffDays) + ' days overdue' : diffDays + ' days remaining'}
                    &nbsp;(${urgency})
                </div>`;
        }

        const statsHtml = `
            <div class="target-detail-stats">
                <div class="target-detail-stat">
                    <span class="tds-value" style="color:var(--rag-green)">${target.current}</span>
                    <span class="tds-label">Completed</span>
                </div>
                <div class="target-detail-stat">
                    <span class="tds-value" style="color:var(--rag-red)">${remaining}</span>
                    <span class="tds-label">Remaining</span>
                </div>
                <div class="target-detail-stat">
                    <span class="tds-value">${target.goal}</span>
                    <span class="tds-label">Goal</span>
                </div>
                <div class="target-detail-stat">
                    <span class="tds-value">${pct}%</span>
                    <span class="tds-label">Progress</span>
                </div>
            </div>`;

        const actionHint = pct >= 100 ?
            `<p class="target-detail-hint">🎉 This target is complete! Well done.</p>` :
            `<p class="target-detail-hint">💡 ${remaining} more to go. Keep pushing to reach the goal of ${target.goal}.</p>`;

        return `
            <p class="target-detail-description">This is a <strong>manually tracked target</strong>. Update progress by clicking the edit (✏️) button.</p>
            ${deadlineHtml}
            ${statsHtml}
            ${actionHint}`;
    },

    render() {
        const grid = document.getElementById('targetsGrid');
        if (!grid) return;
        const targets = this.getAll();

        grid.innerHTML = targets.map(t => {
            const pct = t.goal > 0 ? Math.round((t.current / t.goal) * 100) : 0;
            const clampPct = Math.min(100, Math.max(0, pct));
            const barColor = clampPct >= 100 ? 'var(--rag-green)' :
                             clampPct >= 66 ? 'var(--rag-green)' :
                             clampPct >= 33 ? 'var(--rag-amber)' : 'var(--rag-red)';
            const isComplete = clampPct >= 100;
            const deadlineStr = t.deadline ? new Date(t.deadline).toLocaleDateString() : '';
            const isExpanded = this._expandedTargets.has(t.id);

            const detailPanel = t.type === 'auto'
                ? this._buildAutoDetailPanel(t)
                : this._buildManualDetailPanel(t);

            return `
            <div class="target-card ${isExpanded ? 'expanded' : ''}" data-target-id="${t.id}" onclick="TargetsManager.toggleExpand('${t.id}')">
                <div class="target-card-header">
                    <span class="target-title">${t.icon} ${t.title} <span class="target-expand-indicator">&#9660;</span></span>
                    <span class="target-type-badge ${t.type}">${t.type === 'auto' ? '&#9889; Auto' : '&#9998; Manual'}</span>
                </div>
                <div class="target-progress-row">
                    <div class="target-progress-bar">
                        <div class="target-progress-fill" style="width:${clampPct}%;background:${barColor}"></div>
                    </div>
                    <span class="target-fraction ${isComplete ? 'target-complete' : ''}">${t.current}/${t.goal}</span>
                </div>
                <div class="target-meta">
                    <span>${isComplete ? '&#10004; Complete!' : clampPct + '% progress'}${deadlineStr ? ' &bull; <span class="target-deadline">Due: ' + deadlineStr + '</span>' : ''}</span>
                    ${t.type === 'manual' ? `
                        <span class="target-actions">
                            <button onclick="event.stopPropagation();TargetsManager.openEditModal('${t.id}')" title="Edit">&#9998;</button>
                            <button class="delete" onclick="event.stopPropagation();TargetsManager.deleteTarget('${t.id}')" title="Delete">&#128465;</button>
                        </span>` : ''}
                </div>
                <div class="target-detail-panel">
                    <div class="target-detail-panel-inner">
                        ${detailPanel}
                    </div>
                </div>
            </div>`;
        }).join('');
    },

    openAddModal() {
        document.getElementById('targetModalTitle').textContent = 'Add New Target';
        document.getElementById('targetTitleInput').value = '';
        document.getElementById('targetGoalInput').value = '';
        document.getElementById('targetCurrentInput').value = '0';
        document.getElementById('targetDeadlineInput').value = '';
        document.getElementById('targetEditId').value = '';
        document.getElementById('targetModalOverlay').classList.add('open');
        setTimeout(() => document.getElementById('targetTitleInput').focus(), 100);
    },

    openEditModal(id) {
        const t = this._manualTargets.find(m => m.id === id);
        if (!t) return;
        document.getElementById('targetModalTitle').textContent = 'Edit Target';
        document.getElementById('targetTitleInput').value = t.title;
        document.getElementById('targetGoalInput').value = t.goal;
        document.getElementById('targetCurrentInput').value = t.current;
        document.getElementById('targetDeadlineInput').value = t.deadline || '';
        document.getElementById('targetEditId').value = id;
        document.getElementById('targetModalOverlay').classList.add('open');
        setTimeout(() => document.getElementById('targetTitleInput').focus(), 100);
    },

    closeModal() {
        document.getElementById('targetModalOverlay').classList.remove('open');
    },

    saveFromModal() {
        const title = document.getElementById('targetTitleInput').value.trim();
        const goal = parseInt(document.getElementById('targetGoalInput').value) || 0;
        const current = parseInt(document.getElementById('targetCurrentInput').value) || 0;
        const deadline = document.getElementById('targetDeadlineInput').value || null;
        const editId = document.getElementById('targetEditId').value;

        if (!title) { showToast('Please enter a target title', 'error'); return; }
        if (goal < 1) { showToast('Goal must be at least 1', 'error'); return; }

        if (editId) {
            const idx = this._manualTargets.findIndex(m => m.id === editId);
            if (idx >= 0) {
                this._manualTargets[idx] = { ...this._manualTargets[idx], title, goal, current, deadline };
            }
        } else {
            this._manualTargets.push({
                id: 'target_' + Date.now(),
                title, goal, current, deadline,
                createdAt: new Date().toISOString(),
            });
        }

        this.save();
        this.render();
        this.closeModal();
        showToast(editId ? 'Target updated' : 'Target added', 'success');
    },

    deleteTarget(id) {
        this._manualTargets = this._manualTargets.filter(m => m.id !== id);
        this.save();
        this.render();
        showToast('Target removed', 'info');
    },
};

/* ================================================================
   PLANNER / TO-DO MANAGER
   ================================================================ */
const DashTodo = {
    _key: 'iai_todos',
    _sk() { return UserSession.podKey(this._key); },
    _items: [],
    _filter: 'all', // all | today | week | completed

    load() {
        try {
            const raw = localStorage.getItem(this._sk());
            this._items = raw ? JSON.parse(raw) : [];
        } catch { this._items = []; }
    },

    save() {
        localStorage.setItem(this._sk(), JSON.stringify(this._items));
    },

    add(text, priority = 'medium', dueDate = null) {
        if (!text.trim()) return;
        const n = new Date();
        const localToday = n.getFullYear() + '-' + String(n.getMonth()+1).padStart(2,'0') + '-' + String(n.getDate()).padStart(2,'0');
        this._items.push({
            id: 'todo_' + Date.now(),
            text: text.trim(),
            priority, // high, medium, low
            dueDate: dueDate || localToday, // default today
            completed: false,
            createdAt: new Date().toISOString(),
            completedAt: null,
        });
        this.save();
    },

    toggle(id) {
        const item = this._items.find(t => t.id === id);
        if (item) {
            item.completed = !item.completed;
            item.completedAt = item.completed ? new Date().toISOString() : null;
            this.save();
        }
    },

    remove(id) {
        this._items = this._items.filter(t => t.id !== id);
        this.save();
    },

    getToday() {
        const n = new Date();
        const today = n.getFullYear() + '-' + String(n.getMonth()+1).padStart(2,'0') + '-' + String(n.getDate()).padStart(2,'0');
        return this._items.filter(t => t.dueDate === today);
    },

    getThisWeek() {
        const now = new Date();
        const startOfWeek = new Date(now);
        startOfWeek.setDate(now.getDate() - now.getDay() + 1); // Monday
        startOfWeek.setHours(0, 0, 0, 0);
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6); // Sunday
        endOfWeek.setHours(23, 59, 59, 999);

        return this._items.filter(t => {
            const d = new Date(t.dueDate);
            return d >= startOfWeek && d <= endOfWeek;
        });
    },

    getFiltered() {
        switch (this._filter) {
            case 'today': return this.getToday();
            case 'week': return this.getThisWeek();
            case 'completed': return this._items.filter(t => t.completed);
            default: return this._items.filter(t => !t.completed);
        }
    },

    setFilter(f) {
        this._filter = f;
        renderPlannerPage();
    },

    getTodosForDate(dateStr) {
        return this._items.filter(t => t.dueDate === dateStr);
    },
};

/* ================================================================
   EMAIL ACTION OVERRIDES — Manual status overrides for email actions
   Stores manual overrides (done, awaiting, needs-action, auto) per client.
   'auto' means revert to automatic detection.
   ================================================================ */
const EmailActionOverrides = {
    _key: 'iai_email_overrides',
    _sk() { return UserSession.podKey(this._key); },
    _overrides: {}, // { clientName: { status: 'done'|'awaiting'|'needs-action'|'auto', setAt: ISO } }

    load() {
        try {
            const raw = localStorage.getItem(this._sk());
            this._overrides = raw ? JSON.parse(raw) : {};
        } catch { this._overrides = {}; }
    },

    save() {
        try {
            localStorage.setItem(this._sk(), JSON.stringify(this._overrides));
        } catch { /* storage full */ }
    },

    /** Set manual override for a client's email action status */
    setOverride(clientName, status) {
        if (status === 'auto') {
            delete this._overrides[clientName];
        } else {
            this._overrides[clientName] = {
                status,
                setAt: new Date().toISOString()
            };
        }
        this.save();
        // Log override to activity feed
        ActivityFeed.log({
            type: 'override',
            title: `Manual override: ${clientName}`,
            desc: status === 'auto' ? 'Reverted to automatic detection' : `Status set to "${status}"`,
            source: 'user-action'
        });
    },

    /** Get the effective status — manual override takes priority, else fallback to auto */
    getStatus(clientName) {
        const override = this._overrides[clientName];
        if (override && override.status !== 'auto') {
            return override.status;
        }
        return null; // null = use automatic detection
    },

    /** Check if client has manual override */
    hasOverride(clientName) {
        return !!this._overrides[clientName] && this._overrides[clientName].status !== 'auto';
    },

    /** Get override info */
    getOverrideInfo(clientName) {
        return this._overrides[clientName] || null;
    },

    /** Clear all overrides */
    clearAll() {
        this._overrides = {};
        this.save();
    },
};

/* ================================================================
   EMAIL HIDDEN CARDS — Hide/dismiss email cards from the grid.
   Stores hidden state per client with the lastEmailDate at hide-time.
   Auto-unhides when a newer email is detected on next render/sync.
   ================================================================ */
const EmailHiddenCards = {
    _key: 'iai_email_hidden',
    _sk() { return UserSession.podKey(this._key); },
    _hidden: {},
    _showHidden: false,

    load() {
        try {
            const raw = localStorage.getItem(this._sk());
            this._hidden = raw ? JSON.parse(raw) : {};
        } catch { this._hidden = {}; }
    },

    save() {
        try { localStorage.setItem(this._sk(), JSON.stringify(this._hidden)); } catch { /* quota */ }
    },

    hide(clientName) {
        const ed = EMAIL_DATA.clients[clientName];
        this._hidden[clientName] = {
            hiddenAt: new Date().toISOString(),
            lastEmailDate: ed?.lastEmailDate || ed?.emails?.[0]?.date || null
        };
        this.save();
        ActivityFeed.log({ type: 'email-hide', title: `Hidden: ${clientName}`, desc: 'Card dismissed from email activity view', source: 'user-action' });
        showToast(`${clientName} hidden from email view`, 'info');
    },

    unhide(clientName) {
        delete this._hidden[clientName];
        this.save();
        ActivityFeed.log({ type: 'email-unhide', title: `Restored: ${clientName}`, desc: 'Card restored to email activity view', source: 'user-action' });
        showToast(`${clientName} restored`, 'success');
    },

    isHidden(clientName) { return !!this._hidden[clientName]; },

    hiddenCount() { return Object.keys(this._hidden).length; },

    /** Compare stored lastEmailDate with current — auto-unhide if new email arrived */
    autoUnhideCheck() {
        const unhidden = [];
        for (const [name, entry] of Object.entries(this._hidden)) {
            const ed = EMAIL_DATA.clients[name];
            if (!ed) continue;
            const currentLast = ed.lastEmailDate || ed.emails?.[0]?.date || null;
            if (currentLast && entry.lastEmailDate && currentLast > entry.lastEmailDate) {
                unhidden.push(name);
                delete this._hidden[name];
            }
        }
        if (unhidden.length > 0) {
            this.save();
            unhidden.forEach(name => {
                ActivityFeed.log({ type: 'email-auto-unhide', title: `Auto-restored: ${name}`, desc: 'New email detected — card automatically restored', source: 'auto-sync' });
            });
            showToast(`${unhidden.length === 1 ? unhidden[0] + ' auto-restored' : unhidden.length + ' cards auto-restored'} — new email detected`, 'info');
        }
        return unhidden;
    },

    toggleShowHidden() {
        this._showHidden = !this._showHidden;
        renderEmailActivity();
    },

    clearAll() {
        this._hidden = {};
        this._showHidden = false;
        this.save();
    },
};

/* ================================================================
   OUTLOOK SYNC — Live email sync via Microsoft Graph API
   Auto-syncs every 10 minutes, with manual sync option.
   Falls back to hardcoded EMAIL_DATA snapshot when no token or on error.
   ================================================================ */
const OutlookSync = {
    _tokenKey: 'iai_outlook_token',
    _cacheKey: 'iai_outlook_cache',
    _csk() { return UserSession.podKey(this._cacheKey); },
    _token: null,
    _syncInterval: null,
    _lastSync: null,
    _syncing: false,
    _error: null,
    SYNC_INTERVAL_MS: 600000, // 10 minutes

    // Common email domains to exclude from domain-based matching
    _commonDomains: new Set(['gmail.com','outlook.com','hotmail.com','yahoo.com','live.com','icloud.com','aol.com','protonmail.com','mail.com','zoho.com','fireflies.ai']),

    // ── Token Management ──
    getToken() {
        if (this._token) return this._token;
        return localStorage.getItem(this._tokenKey) || null;
    },
    setToken(token) {
        this._token = token;
        if (token) localStorage.setItem(this._tokenKey, token);
        else localStorage.removeItem(this._tokenKey);
    },
    hasToken() { return !!this.getToken(); },
    clearToken() { this._token = null; localStorage.removeItem(this._tokenKey); },

    // ── Microsoft Graph API ──
    _buildGraphUrl(endpoint, params) {
        const base = 'https://graph.microsoft.com/v1.0' + endpoint;
        if (!params || Object.keys(params).length === 0) return base;
        const qs = Object.entries(params).map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');
        return base + '?' + qs;
    },

    async _graphFetch(endpoint, params) {
        const token = this.getToken();
        if (!token) { this._error = 'no-token'; return null; }
        try {
            const url = this._buildGraphUrl(endpoint, params);
            const resp = await fetch(url, {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (resp.status === 401) {
                this._error = 'token-expired';
                console.warn('[OutlookSync] Token expired (401)');
                return null;
            }
            if (resp.status === 403) {
                this._error = 'forbidden';
                console.warn('[OutlookSync] Insufficient permissions (403). Ensure Mail.Read scope is granted.');
                return null;
            }
            if (!resp.ok) {
                this._error = 'api-error';
                console.error('[OutlookSync] Graph API error:', resp.status, await resp.text().catch(() => ''));
                return null;
            }
            this._error = null;
            return await resp.json();
        } catch (err) {
            this._error = 'network';
            console.error('[OutlookSync] Network error:', err.message);
            return null;
        }
    },

    async fetchEmails() {
        const daysBack = 14;
        const since = new Date(Date.now() - daysBack * 86400000).toISOString().split('.')[0] + 'Z';
        const selectFields = 'subject,from,receivedDateTime,webLink,toRecipients,ccRecipients';

        const [inbox, sent] = await Promise.all([
            this._graphFetch('/me/messages', {
                '$filter': `receivedDateTime ge ${since}`,
                '$top': '200',
                '$select': selectFields,
                '$orderby': 'receivedDateTime desc'
            }),
            this._graphFetch('/me/mailFolders/SentItems/messages', {
                '$filter': `sentDateTime ge ${since}`,
                '$top': '200',
                '$select': 'subject,toRecipients,ccRecipients,sentDateTime',
                '$orderby': 'sentDateTime desc'
            })
        ]);

        if (!inbox && !sent) return null;
        return { inbox: inbox?.value || [], sent: sent?.value || [] };
    },

    // ── Email-to-Client Matching ──
    _getClientEmails(client) {
        return [client.sponsorEmail, client.pocEmail, client.otherEmail, client.itContact]
            .filter(Boolean).map(e => e.toLowerCase().trim());
    },

    _getClientDomain(client) {
        if (!client.domain) return null;
        const d = client.domain.replace(/^https?:\/\//, '').replace(/^www\./, '').split('/')[0].toLowerCase();
        return this._commonDomains.has(d) ? null : d;
    },

    _emailMatchesClient(emailAddr, clientEmails, clientDomain) {
        if (!emailAddr) return false;
        const addr = emailAddr.toLowerCase();
        if (clientEmails.includes(addr)) return true;
        if (clientDomain) {
            const fromDomain = addr.split('@')[1];
            if (fromDomain === clientDomain) return true;
        }
        return false;
    },

    buildEmailData(inbox, sent) {
        const clients = State.clients.length > 0 ? State.clients : [];
        const newClients = {};
        const myEmail = (RUNTIME.userEmail || CONFIG.USER_EMAIL).toLowerCase();

        clients.forEach(client => {
            const clientEmails = this._getClientEmails(client);
            const clientDomain = this._getClientDomain(client);
            const matched = [];

            // Match inbox emails
            inbox.forEach(msg => {
                const fromAddr = msg.from?.emailAddress?.address;
                const allRecipients = [...(msg.toRecipients || []), ...(msg.ccRecipients || [])].map(r => r.emailAddress?.address?.toLowerCase()).filter(Boolean);

                const fromMatchesClient = this._emailMatchesClient(fromAddr, clientEmails, clientDomain);
                const sentToClient = allRecipients.some(r => clientEmails.includes(r) || (clientDomain && r.split('@')[1] === clientDomain));

                if (fromMatchesClient || sentToClient) {
                    const isFromMe = fromAddr?.toLowerCase() === myEmail;
                    matched.push({
                        subject: msg.subject || '(No subject)',
                        from: fromAddr || 'unknown',
                        date: msg.receivedDateTime,
                        isFromClient: fromMatchesClient && !isFromMe,
                        isFromMe,
                        webLink: msg.webLink || null
                    });
                }
            });

            // Match sent emails
            sent.forEach(msg => {
                const allRecipients = [...(msg.toRecipients || []), ...(msg.ccRecipients || [])].map(r => r.emailAddress?.address?.toLowerCase()).filter(Boolean);
                const sentToClient = allRecipients.some(r => clientEmails.includes(r) || (clientDomain && r.split('@')[1] === clientDomain));

                if (sentToClient) {
                    // Avoid duplicates (inbox may already have this via received copy)
                    const dup = matched.find(m => m.isFromMe && m.subject === msg.subject && Math.abs(new Date(m.date) - new Date(msg.sentDateTime)) < 120000);
                    if (!dup) {
                        matched.push({
                            subject: msg.subject || '(No subject)',
                            from: myEmail,
                            date: msg.sentDateTime,
                            isFromClient: false,
                            isFromMe: true,
                            webLink: null
                        });
                    }
                }
            });

            // Sort newest first
            matched.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Compute status fields
            const lastClientEmail = matched.find(m => m.isFromClient);
            const lastFromMe = matched.find(m => m.isFromMe);
            const existingData = EMAIL_DATA.clients[client.name];

            let status = 'no-recent';
            if (matched.length === 0) {
                status = existingData?.status === 'discontinued' ? 'discontinued' : 'no-recent';
            } else if (lastClientEmail && lastFromMe) {
                status = new Date(lastClientEmail.date) > new Date(lastFromMe.date) ? 'needs-response' : 'awaiting';
            } else if (lastClientEmail) {
                status = 'needs-response';
            } else if (lastFromMe) {
                status = 'awaiting';
            }

            newClients[client.name] = {
                emails: matched,
                lastClientEmail: lastClientEmail?.date || null,
                lastEmailDate: matched[0]?.date || null,
                status
            };
        });

        return { snapshotDate: new Date().toISOString(), clients: newClients };
    },

    // ── Sync Orchestration ──
    async sync(manual = false) {
        if (this._syncing) return;
        if (!this.hasToken()) {
            this._updateSyncStatusUI();
            return;
        }

        this._syncing = true;
        this._updateSyncStatusUI();

        const result = await this.fetchEmails();

        if (result) {
            const newData = this.buildEmailData(result.inbox, result.sent);
            EMAIL_DATA = newData;
            this._saveCache(newData);
            this._lastSync = new Date();
            this._error = null;
            ConnectionStatus.setOutlook('ok');

            const clientCount = Object.keys(newData.clients).length;
            const emailCount = Object.values(newData.clients).reduce((sum, c) => sum + c.emails.length, 0);
            ActivityFeed.log({
                type: 'sync',
                title: 'Outlook sync complete',
                desc: `${emailCount} emails fetched, ${clientCount} clients matched`,
                source: manual ? 'user-action' : 'auto-sync'
            });
            if (manual) showToast(`Outlook synced — ${emailCount} emails, ${clientCount} clients`, 'success');
        } else {
            // Error occurred — try cached data
            ConnectionStatus.setOutlook(this._error === 'token-expired' ? 'token-expired' : 'error');
            const cached = this._loadCache();
            if (cached) {
                EMAIL_DATA = cached;
                if (manual) showToast('Sync failed — using cached data', 'warning');
            } else {
                if (manual) showToast('Sync failed — using snapshot data', 'error');
            }
        }

        this._syncing = false;
        renderEmailActivity();
        this._updateSyncStatusUI();
    },

    // ── Cache (localStorage persistence) ──
    _saveCache(emailData) {
        try { localStorage.setItem(this._csk(), JSON.stringify(emailData)); } catch (e) { /* quota */ }
    },
    _loadCache() {
        try {
            const raw = localStorage.getItem(this._csk());
            return raw ? JSON.parse(raw) : null;
        } catch (e) { return null; }
    },

    // ── Auto-Sync Timer ──
    startAutoSync() {
        this.stopAutoSync();
        if (this.hasToken()) {
            this._syncInterval = setInterval(() => this.sync(false), this.SYNC_INTERVAL_MS);
        }
    },
    stopAutoSync() {
        if (this._syncInterval) { clearInterval(this._syncInterval); this._syncInterval = null; }
    },

    // ── UI Updates ──
    _updateSyncStatusUI() {
        const textEl = document.getElementById('emailSyncText');
        const btn = document.getElementById('btnEmailSync');
        if (!textEl) return;

        // Offline mode — show snapshot/local data status, hide sync button
        if (typeof getConnectionMode === 'function' && getConnectionMode() === 'offline') {
            if (btn) btn.style.display = 'none';
            const snapshotDate = EMAIL_DATA?.snapshotDate ? new Date(EMAIL_DATA.snapshotDate) : null;
            textEl.textContent = snapshotDate
                ? `Offline — snapshot: ${snapshotDate.toLocaleDateString()} ${snapshotDate.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`
                : 'Offline — using local data';
            textEl.className = 'email-sync-text';
            return;
        }

        if (this._syncing) {
            textEl.textContent = 'Syncing...';
            textEl.className = 'email-sync-text';
            if (btn) btn.disabled = true;
            return;
        }
        if (btn) btn.disabled = false;

        if (!this.hasToken()) {
            textEl.textContent = `Snapshot data — connect Outlook in Settings`;
            textEl.className = 'email-sync-text';
            if (btn) btn.style.display = 'none';
            return;
        }
        if (btn) btn.style.display = '';

        if (this._error === 'token-expired') {
            textEl.innerHTML = `&#9888; Token expired — <a href="#" onclick="showSetup();return false" style="color:var(--accent-purple-light)">update token</a>`;
            textEl.className = 'email-sync-text error';
            return;
        }
        if (this._error === 'forbidden') {
            textEl.innerHTML = `&#9888; Insufficient permissions — ensure Mail.Read scope is granted`;
            textEl.className = 'email-sync-text error';
            return;
        }
        if (this._error === 'network' || this._error === 'api-error') {
            const cacheTime = this._lastSync || (this._loadCache() ? new Date(this._loadCache().snapshotDate) : null);
            textEl.textContent = `Offline — using ${cacheTime ? 'cached data from ' + cacheTime.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : 'snapshot data'}`;
            textEl.className = 'email-sync-text error';
            return;
        }

        if (this._lastSync) {
            const ago = Math.round((Date.now() - this._lastSync.getTime()) / 60000);
            const agoStr = ago < 1 ? 'just now' : ago === 1 ? '1 min ago' : `${ago} min ago`;
            const emailCount = Object.values(EMAIL_DATA.clients).reduce((sum, c) => sum + c.emails.length, 0);
            textEl.textContent = `Live sync: ${agoStr} · ${emailCount} emails tracked`;
            textEl.className = 'email-sync-text live';
        } else {
            const snapshotDate = new Date(EMAIL_DATA.snapshotDate);
            textEl.textContent = `Snapshot: ${snapshotDate.toLocaleDateString()} ${snapshotDate.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`;
            textEl.className = 'email-sync-text';
        }
    },

    // ── Init ──
    init() {
        this._token = localStorage.getItem(this._tokenKey) || null;
        const cached = this._loadCache();
        if (cached && this.hasToken()) {
            EMAIL_DATA = cached;
            this._lastSync = new Date(cached.snapshotDate);
        }
        this.startAutoSync();
    }
};

/* ================================================================
   CALENDAR SYNC — Live calendar sync via Microsoft Graph API
   Uses the same Outlook token (needs Calendars.Read scope).
   Auto-syncs every 10 minutes, falls back to cached → snapshot data.
   ================================================================ */
const CalendarSync = {
    _cacheKey: 'iai_calendar_cache',
    _csk() { return UserSession.podKey(this._cacheKey); },
    _syncInterval: null,
    _lastSync: null,
    _syncing: false,
    _error: null,
    SYNC_INTERVAL_MS: 600000, // 10 minutes

    // ── Token Management (delegates to OutlookSync) ──
    getToken() { return OutlookSync.getToken(); },
    hasToken() { return OutlookSync.hasToken(); },

    // ── Microsoft Graph API ──
    async _graphFetch(endpoint, params, headers = {}) {
        const token = this.getToken();
        if (!token) { this._error = 'no-token'; return null; }
        try {
            const base = 'https://graph.microsoft.com/v1.0' + endpoint;
            const qs = params && Object.keys(params).length > 0
                ? '?' + Object.entries(params).map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&')
                : '';
            const resp = await fetch(base + qs, {
                headers: { 'Authorization': 'Bearer ' + token, ...headers }
            });
            if (resp.status === 401) { this._error = 'token-expired'; console.warn('[CalendarSync] Token expired (401)'); return null; }
            if (resp.status === 403) { this._error = 'forbidden'; console.warn('[CalendarSync] Insufficient permissions (403). Ensure Calendars.Read scope is granted.'); return null; }
            if (!resp.ok) { this._error = 'api-error'; console.error('[CalendarSync] Graph API error:', resp.status); return null; }
            this._error = null;
            return await resp.json();
        } catch (err) {
            this._error = 'network';
            console.error('[CalendarSync] Network error:', err.message);
            return null;
        }
    },

    // ── Fetch Events for Current Week (Mon-Sun) ──
    async fetchEvents() {
        const now = new Date();
        const dayOfWeek = now.getDay();
        const monday = new Date(now);
        monday.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
        monday.setHours(0, 0, 0, 0);

        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 7);
        sunday.setHours(0, 0, 0, 0);

        const startDateTime = monday.toISOString();
        const endDateTime = sunday.toISOString();

        const data = await this._graphFetch('/me/calendarview', {
            startDateTime,
            endDateTime,
            '$top': '100',
            '$select': 'id,subject,start,end,organizer,location,webLink,isOrganizer,recurrence',
            '$orderby': 'start/dateTime asc'
        }, { 'Prefer': 'outlook.timezone="UTC"' });

        return data?.value || null;
    },

    // ── Transform Graph events → dashboard format ──
    _transformEvents(graphEvents) {
        return graphEvents.map(ev => ({
            id: ev.id || `cal_live_${Math.random().toString(36).slice(2, 8)}`,
            subject: ev.subject || '(No subject)',
            start: ev.start?.dateTime ? ev.start.dateTime + (ev.start.dateTime.endsWith('Z') ? '' : 'Z') : null,
            end: ev.end?.dateTime ? ev.end.dateTime + (ev.end.dateTime.endsWith('Z') ? '' : 'Z') : null,
            organizer: ev.organizer?.emailAddress?.address || 'unknown',
            location: ev.location?.displayName || '',
            webLink: ev.webLink || null,
            isOrganizer: ev.isOrganizer || false,
            recurring: !!ev.recurrence
        })).filter(e => e.start && e.end);
    },

    // ── Sync Orchestration ──
    async sync(manual = false) {
        if (this._syncing) return;
        if (!this.hasToken()) {
            this._updateSyncStatusUI();
            return;
        }

        this._syncing = true;
        this._updateSyncStatusUI();

        const graphEvents = await this.fetchEvents();

        if (graphEvents) {
            const transformed = this._transformEvents(graphEvents);
            CALENDAR_DATA = {
                snapshotDate: new Date().toISOString(),
                events: transformed,
                _live: true
            };
            this._saveCache(CALENDAR_DATA);
            this._lastSync = new Date();
            this._error = null;
            ConnectionStatus.setCalendar('ok');

            ActivityFeed.log({
                type: 'sync',
                title: 'Calendar sync complete',
                desc: `${transformed.length} events fetched for this week`,
                source: manual ? 'user-action' : 'auto-sync'
            });
            if (manual) showToast(`Calendar synced — ${transformed.length} events`, 'success');
        } else {
            ConnectionStatus.setCalendar(this._error === 'token-expired' ? 'token-expired' : 'error');
            const cached = this._loadCache();
            if (cached) {
                CALENDAR_DATA = cached;
                if (manual) showToast('Calendar sync failed — using cached data', 'warning');
            } else {
                if (manual) showToast('Calendar sync failed — using snapshot data', 'error');
            }
        }

        this._syncing = false;
        // Re-render planner if it's currently visible
        if (document.getElementById('plannerContent')?.innerHTML) {
            renderPlannerPage();
        }
        this._updateSyncStatusUI();
    },

    // ── Cache (localStorage persistence) ──
    _saveCache(calData) {
        try { localStorage.setItem(this._csk(), JSON.stringify(calData)); } catch (e) { /* quota */ }
    },
    _loadCache() {
        try {
            const raw = localStorage.getItem(this._csk());
            return raw ? JSON.parse(raw) : null;
        } catch (e) { return null; }
    },

    // ── Auto-Sync Timer ──
    startAutoSync() {
        this.stopAutoSync();
        if (this.hasToken()) {
            this._syncInterval = setInterval(() => this.sync(false), this.SYNC_INTERVAL_MS);
        }
    },
    stopAutoSync() {
        if (this._syncInterval) { clearInterval(this._syncInterval); this._syncInterval = null; }
    },

    // ── UI Updates ──
    _updateSyncStatusUI() {
        const textEl = document.getElementById('calSyncText');
        const btn = document.getElementById('btnCalSync');
        if (!textEl) return;

        // Offline mode — show snapshot/local data status, hide sync button
        if (typeof getConnectionMode === 'function' && getConnectionMode() === 'offline') {
            if (btn) btn.style.display = 'none';
            const snapshotDate = CALENDAR_DATA?.snapshotDate ? new Date(CALENDAR_DATA.snapshotDate) : null;
            textEl.textContent = snapshotDate
                ? `Offline — snapshot: ${snapshotDate.toLocaleDateString()} ${snapshotDate.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`
                : 'Offline — using local data';
            textEl.className = 'email-sync-text';
            return;
        }

        if (this._syncing) {
            textEl.textContent = 'Syncing...';
            textEl.className = 'email-sync-text';
            if (btn) btn.disabled = true;
            return;
        }
        if (btn) btn.disabled = false;

        if (!this.hasToken()) {
            textEl.textContent = 'Snapshot data — connect Outlook in Settings';
            textEl.className = 'email-sync-text';
            if (btn) btn.style.display = 'none';
            return;
        }
        if (btn) btn.style.display = '';

        if (this._error === 'token-expired') {
            textEl.innerHTML = `&#9888; Token expired — <a href="#" onclick="showSetup();return false" style="color:var(--accent-purple-light)">update token</a>`;
            textEl.className = 'email-sync-text error';
            return;
        }
        if (this._error === 'forbidden') {
            textEl.innerHTML = '&#9888; Missing Calendars.Read scope — update token with calendar permission';
            textEl.className = 'email-sync-text error';
            return;
        }
        if (this._error === 'network' || this._error === 'api-error') {
            const cacheTime = this._lastSync || (this._loadCache() ? new Date(this._loadCache().snapshotDate) : null);
            textEl.textContent = `Offline — using ${cacheTime ? 'cached data from ' + cacheTime.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : 'snapshot data'}`;
            textEl.className = 'email-sync-text error';
            return;
        }

        if (this._lastSync) {
            const ago = Math.round((Date.now() - this._lastSync.getTime()) / 60000);
            const agoStr = ago < 1 ? 'just now' : ago === 1 ? '1 min ago' : `${ago} min ago`;
            const eventCount = CALENDAR_DATA.events?.length || 0;
            textEl.textContent = `Live sync: ${agoStr} · ${eventCount} events`;
            textEl.className = 'email-sync-text live';
        } else {
            const snapshotDate = CALENDAR_DATA.snapshotDate ? new Date(CALENDAR_DATA.snapshotDate) : null;
            textEl.textContent = snapshotDate
                ? `Snapshot: ${snapshotDate.toLocaleDateString()} ${snapshotDate.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`
                : 'Snapshot data';
            textEl.className = 'email-sync-text';
        }
    },

    // ── Init ──
    init() {
        const cached = this._loadCache();
        if (cached && this.hasToken()) {
            CALENDAR_DATA = cached;
            this._lastSync = new Date(cached.snapshotDate);
        }
        this.startAutoSync();
    }
};

/* ================================================================
   ACTIVITY FEED — Comprehensive change log of ALL dashboard data
   Persists in localStorage for cross-session visibility.
   ================================================================ */
const ActivityFeed = {
    _key: 'iai_activity_feed',
    _sk() { return UserSession.podKey(this._key); },
    _events: [],
    _maxEvents: 200,  // Keep last 200 events
    _filter: 'all',   // all | email | calendar | data | system

    load() {
        try {
            const raw = localStorage.getItem(this._sk());
            this._events = raw ? JSON.parse(raw) : [];
        } catch { this._events = []; }
    },

    save() {
        try {
            // Trim to max before saving
            if (this._events.length > this._maxEvents) {
                this._events = this._events.slice(0, this._maxEvents);
            }
            localStorage.setItem(this._sk(), JSON.stringify(this._events));
        } catch { /* storage full — trim harder */
            this._events = this._events.slice(0, 50);
            try { localStorage.setItem(this._sk(), JSON.stringify(this._events)); } catch {}
        }
    },

    /** Log a new event to the feed */
    log(evt) {
        this._events.unshift({
            id: 'af_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
            date: new Date().toISOString(),
            type: evt.type || 'system',         // email-in, email-out, calendar, data-change, alert, target, note, override, system
            dotClass: evt.dotClass || evt.type || 'system',
            title: evt.title || '',
            desc: evt.desc || '',
            source: evt.source || 'system',     // outlook, monday, user-action, auto
            clientName: evt.clientName || null,
        });
        this.save();
    },

    /** Build the full comprehensive feed, merging persisted + live data */
    getAll(filter) {
        const f = filter || this._filter;
        if (f === 'all') return this._events;
        const typeMap = {
            'email': ['email-in', 'email-out'],
            'calendar': ['calendar'],
            'data': ['data-change', 'status-change'],
            'system': ['system', 'target', 'note', 'override'],
        };
        const types = typeMap[f] || [f];
        return this._events.filter(e => types.includes(e.type));
    },

    /** Seed feed from current data (on first load or refresh) */
    seed() {
        const existingIds = new Set(this._events.map(e => e.id));
        const newEvents = [];

        // 1. ALL email events from EMAIL_DATA
        Object.entries(EMAIL_DATA.clients).forEach(([clientName, ed]) => {
            if (ed.discontinued) return;
            ed.emails.forEach(e => {
                const seedId = 'seed_email_' + clientName + '_' + e.date;
                if (existingIds.has(seedId)) return; // already seeded
                const sender = classifyEmailSender(e);
                const senderLabel = sender === 'me' ? 'You' : sender === 'client' ? e.from.split('@')[0].replace(/\./g, ' ') : e.from.split('@')[0];
                const type = sender === 'me' ? 'email-out' : sender === 'client' ? 'email-in' : 'system';
                const icon = sender === 'me' ? '📤' : sender === 'client' ? '📩' : '🔄';
                newEvents.push({
                    id: seedId,
                    date: e.date,
                    type,
                    dotClass: type,
                    title: `${icon} ${clientName}`,
                    desc: `${senderLabel}: ${e.subject.length > 80 ? e.subject.substring(0,80) + '...' : e.subject}`,
                    source: 'outlook',
                    clientName,
                });
            });
        });

        // 2. Calendar events
        if (typeof CALENDAR_DATA !== 'undefined') {
            CALENDAR_DATA.events.forEach(e => {
                const seedId = 'seed_cal_' + e.id;
                if (existingIds.has(seedId)) return;
                const state = typeof CalendarState !== 'undefined' ? CalendarState.getState(e.id) : 'active';
                const label = state === 'completed' ? '✓ Completed' : state === 'cancelled' ? '✗ Cancelled' : 'Scheduled';
                newEvents.push({
                    id: seedId,
                    date: e.start,
                    type: 'calendar',
                    dotClass: 'calendar',
                    title: `📅 ${e.subject}`,
                    desc: `Meeting ${label} — ${new Date(e.start).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`,
                    source: 'outlook',
                    clientName: null,
                });
            });
        }

        // 3. monday.com data — client status snapshots
        if (State.dataLoaded && State.clients.length > 0) {
            State.clients.forEach(c => {
                const seedId = 'seed_client_' + c.id;
                if (existingIds.has(seedId)) return;
                newEvents.push({
                    id: seedId,
                    date: c.updatedAt || new Date().toISOString(),
                    type: 'data-change',
                    dotClass: 'data-change',
                    title: `📊 ${c.name} — Data synced`,
                    desc: `RAG: ${c.rag} | Billing: ${c.billing} | Stage: ${c.agentStage} | AIOS: ${c.aiosDays}d`,
                    source: 'monday',
                    clientName: c.name,
                });
            });

            // 4. ChangeTracker — detected changes
            if (typeof ChangeTracker !== 'undefined') {
                Object.entries(ChangeTracker._changes).forEach(([clientId, changes]) => {
                    const client = State.clients.find(cl => cl.id === clientId);
                    if (!client) return;
                    changes.forEach(ch => {
                        const seedId = 'seed_change_' + clientId + '_' + ch.field;
                        if (existingIds.has(seedId)) return;
                        newEvents.push({
                            id: seedId,
                            date: new Date().toISOString(),
                            type: ch.direction === 'declined' ? 'alert' : ch.direction === 'improved' ? 'status-change' : 'data-change',
                            dotClass: ch.direction === 'declined' ? 'alert' : ch.direction === 'improved' ? 'email-in' : 'data-change',
                            title: `🔄 ${client.name} — ${ch.field}`,
                            desc: `${ch.oldVal} → ${ch.newVal}`,
                            source: 'monday',
                            clientName: client.name,
                        });
                    });
                });
            }

            // monday sync timestamp
            const syncId = 'seed_sync_' + new Date().toISOString().split('T')[0];
            if (!existingIds.has(syncId)) {
                newEvents.push({
                    id: syncId,
                    date: new Date().toISOString(),
                    type: 'system',
                    dotClass: 'system',
                    title: '🔃 monday.com data synced',
                    desc: `${State.clients.length} clients loaded`,
                    source: 'monday',
                    clientName: null,
                });
            }
        }

        // 5. Email action overrides
        Object.entries(EmailActionOverrides._overrides).forEach(([clientName, ov]) => {
            const seedId = 'seed_override_' + clientName + '_' + ov.setAt;
            if (existingIds.has(seedId)) return;
            newEvents.push({
                id: seedId,
                date: ov.setAt,
                type: 'override',
                dotClass: 'override',
                title: `🎯 ${clientName} — Manual override`,
                desc: `Email status set to "${ov.status}"`,
                source: 'user-action',
                clientName,
            });
        });

        // Merge new events and sort
        if (newEvents.length > 0) {
            this._events = [...newEvents, ...this._events];
            this._events.sort((a, b) => new Date(b.date) - new Date(a.date));
            // Deduplicate by id
            const seen = new Set();
            this._events = this._events.filter(e => {
                if (seen.has(e.id)) return false;
                seen.add(e.id);
                return true;
            });
            this.save();
        }
    },

    setFilter(f) {
        this._filter = f;
        // Re-render overview if on that page
        if (typeof Router !== 'undefined' && Router.current === 'overview') {
            renderOverviewPage();
        }
    },
};

/* ================================================================
   CALENDAR STATE MANAGER
   ================================================================ */
const CalendarState = {
    _key: 'iai_cal_states',
    _sk() { return UserSession.podKey(this._key); },
    _states: {},   // { cal_1: 'completed', cal_3: 'cancelled', ... }

    load() {
        try {
            const raw = localStorage.getItem(this._sk());
            this._states = raw ? JSON.parse(raw) : {};
        } catch { this._states = {}; }
    },

    save() {
        try { localStorage.setItem(this._sk(), JSON.stringify(this._states)); } catch {}
    },

    getState(eventId) {
        // Manual state takes priority
        if (this._states[eventId]) return this._states[eventId];
        // Auto-complete: if meeting end time has passed
        const event = CALENDAR_DATA.events.find(e => e.id === eventId);
        if (event && new Date(event.end) < new Date()) return 'completed';
        return 'active';
    },

    markComplete(eventId) {
        this._states[eventId] = 'completed';
        this.save();
        renderPlannerPage();
    },

    markCancelled(eventId) {
        this._states[eventId] = 'cancelled';
        this.save();
        renderPlannerPage();
    },

    resetState(eventId) {
        delete this._states[eventId];
        this.save();
        renderPlannerPage();
    }
};

/* ================================================================
   NOTES MANAGER
   ================================================================ */
const NotesManager = {
    get(clientId) {
        if (!State || !State.localData) return [];
        const ld = State.localData[clientId];
        return (ld && ld.notes) ? ld.notes : [];
    },

    add(clientId, text) {
        if (!text.trim()) return;
        if (!State.localData[clientId]) State.localData[clientId] = {};
        if (!State.localData[clientId].notes) State.localData[clientId].notes = [];
        State.localData[clientId].notes.unshift({
            id: 'n_' + Date.now(),
            text: text.trim(),
            createdAt: new Date().toISOString(),
        });
        State.saveLocal();
        showToast('Note added', 'success');
    },

    delete(clientId, noteId) {
        if (!State.localData[clientId] || !State.localData[clientId].notes) return;
        State.localData[clientId].notes = State.localData[clientId].notes.filter(n => n.id !== noteId);
        State.saveLocal();
        showToast('Note removed', 'info');
    },

    renderInDetail(clientId) {
        const notes = this.get(clientId);
        return `
            <div class="detail-notes-section">
                <div class="note-input-row">
                    <input type="text" id="noteInput_${clientId}" placeholder="Add a note..." onkeydown="if(event.key==='Enter'){NotesManager.addFromInput('${clientId}');}">
                    <button onclick="NotesManager.addFromInput('${clientId}')">Add Note</button>
                </div>
                ${notes.length > 0 ? `<div class="notes-list">
                    ${notes.map(n => {
                        const d = new Date(n.createdAt);
                        const ts = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
                        return `<div class="note-item">
                            <div class="note-content">
                                <div class="note-text">${n.text.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
                                <div class="note-time">${ts}</div>
                            </div>
                            <button class="note-delete" onclick="NotesManager.deleteAndRefresh('${clientId}','${n.id}')" title="Delete note">&#128465;</button>
                        </div>`;
                    }).join('')}
                </div>` : '<div style="color:var(--text-muted);font-size:12px;font-style:italic;">No notes yet</div>'}
            </div>`;
    },

    addFromInput(clientId) {
        const input = document.getElementById('noteInput_' + clientId);
        if (!input || !input.value.trim()) return;
        this.add(clientId, input.value);
        // Re-render the notes section in detail panel
        if (State.selectedId === clientId) {
            openDetail(clientId);
        }
        // Update client cards to show notes badge
        renderClients(State.filtered);
    },

    deleteAndRefresh(clientId, noteId) {
        this.delete(clientId, noteId);
        if (State.selectedId === clientId) {
            openDetail(clientId);
        }
        renderClients(State.filtered);
    },

    countBadge(clientId) {
        const notes = this.get(clientId);
        if (notes.length === 0) return '';
        return `<span class="notes-badge" onclick="event.stopPropagation();openDetail('${clientId}')">&#128221; ${notes.length} note${notes.length !== 1 ? 's' : ''}</span>`;
    },
};

/* ================================================================
   EDIT MANAGER (Inline Editable Sections)
   ================================================================ */
const EditManager = {
    _emailNotesKey: 'iai_email_notes',
    _enk() { return UserSession.podKey(this._emailNotesKey); },
    _activeEdit: null,

    editSummary(clientId, el) {
        if (el.classList.contains('editing')) return;
        const currentText = el.textContent.trim();
        this._activeEdit = { clientId, originalText: currentText, el };

        el.classList.add('editing');
        el.innerHTML = `
            <textarea>${currentText}</textarea>
            <div class="edit-save-hint">Click outside to save &bull; Esc to cancel</div>
        `;
        const ta = el.querySelector('textarea');
        ta.focus();
        ta.setSelectionRange(ta.value.length, ta.value.length);

        ta.addEventListener('blur', () => {
            setTimeout(() => this._saveSummary(clientId, ta.value, el), 100);
        });
        ta.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                e.preventDefault();
                this._cancelEdit(el);
            }
        });
    },

    async _saveSummary(clientId, newText, el) {
        if (!this._activeEdit || this._activeEdit.clientId !== clientId) return;
        const original = this._activeEdit.originalText;
        this._activeEdit = null;

        if (newText.trim() === original) {
            el.classList.remove('editing');
            el.innerHTML = original || '<span style="color:var(--text-muted);font-style:italic">No summary available</span>';
            return;
        }

        el.classList.remove('editing');
        el.innerHTML = newText.trim() || '<span style="color:var(--text-muted);font-style:italic">No summary available</span>';

        try {
            await MondayAPI.updateColumn(clientId, CONFIG.COLUMNS.SUMMARY, JSON.stringify(newText.trim()));
            // Update local state
            const client = State.clients.find(c => c.id === clientId);
            if (client) client.summary = newText.trim();
            showToast('Summary updated', 'success');
        } catch (err) {
            el.innerHTML = original;
            showToast('Failed to save summary: ' + err.message, 'error');
        }
    },

    _cancelEdit(el) {
        if (!this._activeEdit) return;
        const original = this._activeEdit.originalText;
        this._activeEdit = null;
        el.classList.remove('editing');
        el.innerHTML = original || '<span style="color:var(--text-muted);font-style:italic">No summary available</span>';
    },

    // Email notes (localStorage only)
    _loadEmailNotes() {
        try {
            const raw = localStorage.getItem(this._enk());
            return raw ? JSON.parse(raw) : {};
        } catch { return {}; }
    },

    _saveEmailNotes(notes) {
        localStorage.setItem(this._enk(), JSON.stringify(notes));
    },

    getEmailNote(clientName) {
        const notes = this._loadEmailNotes();
        return notes[clientName] || '';
    },

    saveEmailNote(clientName, text) {
        const notes = this._loadEmailNotes();
        if (text.trim()) {
            notes[clientName] = text.trim();
        } else {
            delete notes[clientName];
        }
        this._saveEmailNotes(notes);
    },

    startEmailNoteEdit(clientName, el) {
        const currentText = this.getEmailNote(clientName);
        el.innerHTML = `<input class="email-note-input" type="text" value="${currentText.replace(/"/g,'&quot;')}" placeholder="Add a note..."
            onblur="EditManager.finishEmailNoteEdit('${clientName.replace(/'/g,"\\'")}', this)"
            onkeydown="if(event.key==='Enter')this.blur();if(event.key==='Escape'){this.value='${currentText.replace(/'/g,"\\'")}';this.blur();}">`;
        el.querySelector('input').focus();
    },

    finishEmailNoteEdit(clientName, input) {
        const text = input.value.trim();
        this.saveEmailNote(clientName, text);
        const parent = input.closest('.email-note');
        if (parent) {
            const displayText = text || '+ Add note';
            parent.innerHTML = `<span class="email-note-text ${text ? '' : 'placeholder'}" onclick="EditManager.startEmailNoteEdit('${clientName.replace(/'/g,"\\'")}', this.closest('.email-note'))">${displayText}</span>`;
        }
    },

    emailNoteHTML(clientName) {
        const note = this.getEmailNote(clientName);
        const displayText = note || '+ Add note';
        const safeName = clientName.replace(/'/g, "\\'");
        return `<div class="email-note">
            <span class="email-note-text ${note ? '' : 'placeholder'}" onclick="event.stopPropagation();EditManager.startEmailNoteEdit('${safeName}', this.closest('.email-note'))">${displayText}</span>
        </div>`;
    },
};

/* ================================================================
   LOCAL EDIT MANAGER — Local-first data persistence
   Edits save to localStorage immediately. monday.com sync is optional.
   ================================================================ */
const LocalEditManager = {
    _key: 'iai_local_edits',
    _sk() { return UserSession.podKey(this._key); },
    _edits: {},  // { clientId: { field: value, ... } }

    load() {
        try {
            this._edits = JSON.parse(localStorage.getItem(this._sk()) || '{}');
        } catch { this._edits = {}; }
    },

    save() {
        localStorage.setItem(this._sk(), JSON.stringify(this._edits));
    },

    set(clientId, field, value) {
        if (!this._edits[clientId]) this._edits[clientId] = {};
        this._edits[clientId][field] = value;
        this.save();

        // Update State.clients in-memory immediately
        const client = State.clients.find(c => c.id === clientId);
        if (client) {
            client[field] = value;
            State.applyFilters();
        }

        // Log to activity feed
        ActivityFeed.log({
            type: 'data',
            dotClass: 'status-change',
            title: `Local edit: ${client ? client.name : clientId}`,
            desc: `${field} updated locally`,
            source: 'local-edit',
            clientName: client ? client.name : '',
        });
    },

    get(clientId, field) {
        return this._edits[clientId]?.[field] ?? null;
    },

    getAll(clientId) {
        return this._edits[clientId] || {};
    },

    hasEdits(clientId) {
        return !!this._edits[clientId] && Object.keys(this._edits[clientId]).length > 0;
    },

    hasAnyEdits() {
        return Object.keys(this._edits).length > 0;
    },

    applyToClient(client) {
        const edits = this._edits[client.id];
        if (!edits) return;
        Object.keys(edits).forEach(field => {
            client[field] = edits[field];
        });
    },

    applyToAll(clients) {
        clients.forEach(c => this.applyToClient(c));
    },

    async syncToMonday(clientId) {
        const edits = this._edits[clientId];
        if (!edits || Object.keys(edits).length === 0) return;

        const client = State.clients.find(c => c.id === clientId);
        const clientName = client ? client.name : clientId;

        // Map field names to monday.com column IDs and format values
        const columnMap = {
            rag: { col: CONFIG.COLUMNS.RAG, fmt: v => { const opt = CONFIG.RAG_OPTIONS.find(o => o.label === v); return opt ? JSON.stringify({ index: opt.index }) : null; } },
            plan: { col: CONFIG.COLUMNS.PLAN, fmt: v => { const opt = CONFIG.PLAN_OPTIONS.find(o => o.label === v); return opt ? JSON.stringify({ index: opt.index }) : null; } },
            updateStatus: { col: CONFIG.COLUMNS.UPDATE, fmt: v => { const opt = CONFIG.UPDATE_OPTIONS.find(o => o.label === v); return opt ? JSON.stringify({ index: opt.index }) : null; } },
            billing: { col: CONFIG.COLUMNS.BILLING, fmt: v => { const opt = CONFIG.BILLING_OPTIONS.find(o => o.label === v); return opt ? JSON.stringify({ index: opt.index }) : null; } },
            summary: { col: CONFIG.COLUMNS.SUMMARY, fmt: v => JSON.stringify(v) },
            agentCount: { col: CONFIG.COLUMNS.AGENTS, fmt: v => JSON.stringify(v.toString()) },
            commencement: { col: CONFIG.COLUMNS.COMMENCEMENT, fmt: v => JSON.stringify({ date: v }) },
            goLive: { col: CONFIG.COLUMNS.GO_LIVE, fmt: v => JSON.stringify({ date: v }) },
            deadline: { col: CONFIG.COLUMNS.DEADLINE, fmt: v => JSON.stringify({ date: v }) },
            pilotKickoff: { col: CONFIG.COLUMNS.PILOT_KICKOFF, fmt: v => JSON.stringify({ date: v }) },
            lastContact: { col: CONFIG.COLUMNS.LAST_CONTACT, fmt: v => JSON.stringify({ date: v }) },
            sponsorEmail: { col: CONFIG.COLUMNS.SPONSOR_EMAIL, fmt: v => JSON.stringify({ email: v, text: v }) },
            pocEmail: { col: CONFIG.COLUMNS.POC_EMAIL, fmt: v => JSON.stringify({ email: v, text: v }) },
            otherEmail: { col: CONFIG.COLUMNS.OTHER_EMAIL, fmt: v => JSON.stringify({ email: v, text: v }) },
            itContact: { col: CONFIG.COLUMNS.IT_CONTACT, fmt: v => JSON.stringify(v) },
        };

        let successCount = 0;
        let failCount = 0;
        for (const [field, value] of Object.entries(edits)) {
            const mapping = columnMap[field];
            if (!mapping) continue;
            const formatted = mapping.fmt(value);
            if (!formatted) continue;
            try {
                await MondayAPI.updateColumn(clientId, mapping.col, formatted);
                successCount++;
            } catch (err) {
                failCount++;
                console.warn(`Sync failed for ${field}:`, err);
            }
        }

        if (successCount > 0 && failCount === 0) {
            delete this._edits[clientId];
            this.save();
            showToast(`${clientName}: ${successCount} field${successCount !== 1 ? 's' : ''} synced to monday.com`, 'success');
        } else if (successCount > 0) {
            showToast(`${clientName}: ${successCount} synced, ${failCount} failed`, 'warning');
        } else {
            showToast(`Sync failed for ${clientName}`, 'error');
        }
    },

    async syncAll() {
        const ids = Object.keys(this._edits);
        if (ids.length === 0) { showToast('No local edits to sync', 'info'); return; }
        for (const id of ids) { await this.syncToMonday(id); }
    },

    clearEdits(clientId) {
        delete this._edits[clientId];
        this.save();
    },

    clearAll() {
        this._edits = {};
        this.save();
    },
};

/* ================================================================
   CONFIGURATION
   ================================================================ */
const CONFIG = Object.freeze({
    BOARD_ID: 5085368097,
    API_URL: 'https://api.monday.com/v2',
    COLUMNS: {
        POD: 'color_mm0pt4z',
        RAG: 'color_mkyfvmsk',
        PLAN: 'color_mm0afhmp',
        UPDATE: 'color_mm0a96w5',
        BILLING: 'color_mkzc3vtd',
        AGENTS: 'numeric_mkymy8x1',
        SUMMARY: 'text_mm08zyp5',
        GO_LIVE: 'date_mm0p9m3a',
        DEADLINE: 'date_mm0p60n8',
        COMMENCEMENT: 'date_mm0pcrhw',
        PILOT_KICKOFF: 'date_mm0ppz6k',
        LAST_CONTACT: 'date_mkyjryvw',
        AIOS_DAYS: 'formula_mkyjp2ar',
        PILOT_DAYS: 'formula_mm0pwhey',
        SPONSOR_EMAIL: 'email_mkymxft1',
        POC_EMAIL: 'email_mkym2khq',
        OTHER_EMAIL: 'email_mkymg882',
        IT_CONTACT: 'text_mkymv9ky',
        DOMAIN: 'company_domain',
        INDUSTRY: 'dropdown_mky0gacd',
        OFFER_SENT: 'color_mkya3rrx',
    },
    RAG_OPTIONS: [
        { label: 'Green', index: 1, color: '#00c875' },
        { label: 'Amber', index: 0, color: '#fdab3d' },
        { label: 'Red',   index: 2, color: '#df2f4a' },
    ],
    PLAN_OPTIONS: [
        { label: 'Activate',    index: 7, color: '#579bfc' },
        { label: 'Scale',       index: 2, color: '#df2f4a' },
        { label: 'AIOS Pilot',  index: 0, color: '#fdab3d' },
        { label: 'Orchestrate', index: 3, color: '#007eb5' },
        { label: 'Custom Plan', index: 1, color: '#00c875' },
        { label: 'Partnership', index: 4, color: '#9d50dd' },
        { label: 'Free Demo',   index: 6, color: '#037f4c' },
    ],
    UPDATE_OPTIONS: [
        { label: 'Yes',              index: 1, color: '#00c875' },
        { label: 'Working on it',    index: 0, color: '#fdab3d' },
        { label: 'Need Contact',     index: 2, color: '#df2f4a' },
        { label: 'Steps to Confirm', index: 5, color: '#c4c4c4' },
    ],
    BILLING_OPTIONS: [
        { label: 'Yes',  index: 1, color: '#00c875' },
        { label: 'No',   index: 2, color: '#df2f4a' },
        { label: 'N/A',  index: 3, color: '#579bfc' },
    ],
    AUTO_REFRESH_MS: 300000, // 5 minutes
    STALE_WARNING_DAYS: 7,
    STALE_CRITICAL_DAYS: 14,
    RESPONSE_GRACE_HOURS: 48, // hours before a client email becomes "needs response"
    USER_EMAIL: 'mishai@implementai.io', // Fallback Pod Lead email — overridden by RUNTIME.userEmail after login
});

/* ================================================================
   RUNTIME — mutable session config (populated after login)
   ================================================================ */
const RUNTIME = {
    podName: null,       // e.g. 'Pod B'
    podIndex: null,      // e.g. 4 (compare_value for API filter)
    podSlug: null,       // e.g. 'pod-b' (for localStorage namespacing)
    userName: null,      // e.g. 'Mishai'
    userEmail: null,     // e.g. 'mishai@implementai.io'
    allPods: [],         // discovered: [{ name, index, slug }]
};

/* ================================================================
   USER SESSION — pod selection, identity, localStorage namespacing
   ================================================================ */
const UserSession = {
    _key: 'iai_user_session',
    _splashKey: 'iai_first_login_done',

    load() {
        try {
            const raw = localStorage.getItem(this._key);
            if (raw) {
                const data = JSON.parse(raw);
                RUNTIME.podName = data.podName || null;
                RUNTIME.podIndex = data.podIndex ?? null;
                RUNTIME.podSlug = data.podSlug || null;
                RUNTIME.userName = data.userName || null;
                RUNTIME.userEmail = data.userEmail || null;
                return true;
            }
        } catch {}
        return false;
    },

    save() {
        localStorage.setItem(this._key, JSON.stringify({
            podName: RUNTIME.podName,
            podIndex: RUNTIME.podIndex,
            podSlug: RUNTIME.podSlug,
            userName: RUNTIME.userName,
            userEmail: RUNTIME.userEmail,
        }));
    },

    clear() {
        localStorage.removeItem(this._key);
        RUNTIME.podName = RUNTIME.podIndex = RUNTIME.podSlug = null;
        RUNTIME.userName = RUNTIME.userEmail = null;
    },

    hasSession() {
        return RUNTIME.podName !== null && RUNTIME.podIndex !== null;
    },

    isFirstLogin() {
        return !localStorage.getItem(this._splashKey);
    },

    markSplashSeen() {
        localStorage.setItem(this._splashKey, '1');
    },

    /** Returns a pod-namespaced localStorage key */
    podKey(baseKey) {
        return RUNTIME.podSlug ? `${baseKey}_${RUNTIME.podSlug}` : baseKey;
    },

    /** One-time migration: copy un-namespaced keys to pod-namespaced keys */
    migrateStorage(podSlug) {
        const keys = [
            'iai_targets', 'iai_todos', 'iai_email_overrides', 'iai_email_hidden',
            'iai_outlook_cache', 'iai_calendar_cache', 'iai_activity_feed', 'iai_cal_states',
            'iai_email_notes', 'iai_local_edits', 'iai_local_data',
            'iai_kb_docs', 'iai_snapshot', 'iai_target_exclusions', 'iai_target_overrides', 'iai_connection_mode'
        ];
        keys.forEach(key => {
            const oldData = localStorage.getItem(key);
            const newKey = `${key}_${podSlug}`;
            if (oldData && !localStorage.getItem(newKey)) {
                localStorage.setItem(newKey, oldData);
            }
        });
    },
};

/* ================================================================
   OUTLOOK EMAIL DATA (snapshot from MCP integration)
   Updated: 2026-02-23
   ================================================================
   OUTLOOK FULL INTEGRATION — live sync via MS Graph API
   Plan: .claude/plans/wobbly-nibbling-shannon.md
   ================================================================ */
let EMAIL_DATA = {
    snapshotDate: '2026-02-23T10:30:00Z',
    clients: {
        'Kitchen Makeovers': {
            emails: [
                { subject: 'IAI x Kitchen Makeovers - Feedback Session Follow-Up', from: 'mishai@implementai.io', date: '2026-02-18T09:15:00Z', isFromClient: false, isFromMe: true, webLink: null },
                { subject: 'IAI x Kitchen Makeovers - Feedback Session', from: 'fred@fireflies.ai', date: '2026-02-17T15:28:49Z', isFromClient: false, isFromMe: false, webLink: null },
            ],
            lastClientEmail: null,
            lastEmailDate: '2026-02-18',
            status: 'awaiting', // Mishai sent follow-up, awaiting client reply
        },
        'Townhouse': {
            emails: [
                { subject: 'Re: IAI x ClassPass Booking Agent - Requirements for Engineering Handoff', from: 'Luke.phillips@townhouse.co.uk', date: '2026-02-23T10:00:57Z', isFromClient: true, isFromMe: false, webLink: 'https://outlook.office365.com/owa/?ItemID=AAMkADdkMGU4MjNkLWFlYjMtNGZmZS04N2I1LWU0ZmU5NjM1NGFlMgBGAAAAAABHe5kNIbzrToESJ8CLAkibBwDyezS52hfdQZb98D2A0hOYAAAAAAEMAADyezS52hfdQZb98D2A0hOYAABEjrfXAAA%3D&exvsurl=1&viewmodel=ReadMessageItem' },
                { subject: 'Re: IAI x ClassPass Booking Agent - Requirements for Engineering Handoff', from: 'mishai@implementai.io', date: '2026-02-23T09:58:15Z', isFromClient: false, isFromMe: true, webLink: null },
            ],
            lastClientEmail: 'Luke.phillips@townhouse.co.uk',
            lastEmailDate: '2026-02-23',
            status: 'needs-response',
        },
        'Progressive Property': {
            emails: [
                { subject: 'IAI x Progressive Property - Warm Transfer Enhancement Update', from: 'mishai@implementai.io', date: '2026-02-20T08:18:25Z', isFromClient: false, isFromMe: true, webLink: null },
                { subject: 'Re: IAI x Warm Transfer Enhancement - Progressive Property', from: 'conornicholls@progressiveproperty.co.uk', date: '2026-02-17T11:08:22Z', isFromClient: true, isFromMe: false, webLink: null },
            ],
            lastClientEmail: 'conornicholls@progressiveproperty.co.uk',
            lastEmailDate: '2026-02-20',
            status: 'awaiting', // Mishai sent last, awaiting client
        },
        'Quality Dental Group': {
            emails: [
                { subject: 'Recall Campaign', from: 'shane@qualitydentalgroup.co.uk', date: '2026-02-19T20:39:06Z', isFromClient: true, isFromMe: false, webLink: 'https://outlook.office365.com/owa/?ItemID=AAMkADdkMGU4MjNkLWFlYjMtNGZmZS04N2I1LWU0ZmU5NjM1NGFlMgBGAAAAAABHe5kNIbzrToESJ8CLAkibBwDyezS52hfdQZb98D2A0hOYAAAAAAEMAADyezS52hfdQZb98D2A0hOYAABC128dAAA%3D&exvsurl=1&viewmodel=ReadMessageItem' },
                { subject: 'Re: IAI x QDP - Agent Updates & Outstanding Items', from: 'shane@qualitydentalgroup.co.uk', date: '2026-02-19T15:09:23Z', isFromClient: true, isFromMe: false, webLink: null },
            ],
            lastClientEmail: 'shane@qualitydentalgroup.co.uk',
            lastEmailDate: '2026-02-19',
            status: 'needs-response',
        },
        'Orbital': {
            emails: [
                { subject: 'Re: IAI x Orbital - Email Notification System Update', from: 'craig.cleave@vfast.com', date: '2026-02-20T15:38:03Z', isFromClient: true, isFromMe: false, webLink: 'https://outlook.office365.com/owa/?ItemID=AAMkADdkMGU4MjNkLWFlYjMtNGZmZS04N2I1LWU0ZmU5NjM1NGFlMgBGAAAAAABHe5kNIbzrToESJ8CLAkibBwDyezS52hfdQZb98D2A0hOYAAAAAAEMAADyezS52hfdQZb98D2A0hOYAABC1280AAA%3D&exvsurl=1&viewmodel=ReadMessageItem' },
                { subject: 'Re: IAI x Orbital - Email Notification System Update', from: 'mishai@implementai.io', date: '2026-02-20T14:33:23Z', isFromClient: false, isFromMe: true, webLink: null },
            ],
            lastClientEmail: 'craig.cleave@vfast.com',
            lastEmailDate: '2026-02-20',
            status: 'needs-response',
        },
        'Hales Group': {
            emails: [
                { subject: 'Re: IAI x Hales Group Campaign Results & Next Steps', from: 'Mason.Barendrecht@halesgroup.co.uk', date: '2026-02-23T10:07:52Z', isFromClient: true, isFromMe: false, webLink: 'https://outlook.office365.com/owa/?ItemID=AAMkADdkMGU4MjNkLWFlYjMtNGZmZS04N2I1LWU0ZmU5NjM1NGFlMgBGAAAAAABHe5kNIbzrToESJ8CLAkibBwDyezS52hfdQZb98D2A0hOYAAAAAAEMAADyezS52hfdQZb98D2A0hOYAABEjrfZAAA%3D&exvsurl=1&viewmodel=ReadMessageItem' },
                { subject: 'Re: IAI x Hales Group Campaign Results & Next Steps', from: 'mishai@implementai.io', date: '2026-02-23T09:03:23Z', isFromClient: false, isFromMe: true, webLink: null },
            ],
            lastClientEmail: 'Mason.Barendrecht@halesgroup.co.uk',
            lastEmailDate: '2026-02-23',
            status: 'needs-response',
        },
        'NetMonkeys': {
            emails: [
                { subject: 'Re: NetMonkeys x IAI: Alignment on the Email Agent Plan and Next Steps', from: 'mdixon@netmonkeys.co.uk', date: '2025-12-11T18:08:03Z', isFromClient: true, isFromMe: false, webLink: 'https://outlook.office365.com/owa/?ItemID=AAMkADdkMGU4MjNkLWFlYjMtNGZmZS04N2I1LWU0ZmU5NjM1NGFlMgBGAAAAAABHe5kNIbzrToESJ8CLAkibBwDyezS52hfdQZb98D2A0hOYAAAAAAEMAADyezS52hfdQZb98D2A0hOYAAAUVx1vAAA%3D&exvsurl=1&viewmodel=ReadMessageItem' },
            ],
            lastClientEmail: 'mdixon@netmonkeys.co.uk',
            lastEmailDate: '2025-12-11',
            status: 'discontinued', // Client no longer continuing with agent building
            discontinued: true,
        },
    }
};

/* ================================================================
   TEAMS CALENDAR DATA (snapshot from MCP integration)
   Updated: 2026-02-23
   ================================================================ */
let CALENDAR_DATA = {
    snapshotDate: '2026-02-23T12:00:00Z',
    events: [
        {
            id: 'cal_1',
            subject: 'Advantos CUA x Saad progress update',
            start: '2026-02-23T11:30:00.000Z',
            end: '2026-02-23T12:00:00.000Z',
            organizer: 'kamil@implementai.io',
            location: 'Microsoft Teams Meeting',
            isOrganizer: false,
            webLink: 'https://outlook.office365.com/owa/?itemid=AAMkADdkMGU4MjNkLWFlYjMtNGZmZS04N2I1LWU0ZmU5NjM1NGFlMgBGAAAAAABHe5kNIbzrToESJ8CLAkibBwDyezS52hfdQZb98D2A0hOYAAAAAAENAADyezS52hfdQZb98D2A0hOYAABEjv%2F3AAA%3D&exvsurl=1&path=/calendar/item',
        },
        {
            id: 'cal_2',
            subject: 'AIOS Advantos Progress Review',
            start: '2026-02-23T15:30:00.000Z',
            end: '2026-02-23T16:15:00.000Z',
            organizer: 'kamil@implementai.io',
            location: 'Microsoft Teams Meeting',
            isOrganizer: false,
            webLink: 'https://outlook.office365.com/owa/?itemid=AAMkADdkMGU4MjNkLWFlYjMtNGZmZS04N2I1LWU0ZmU5NjM1NGFlMgBGAAAAAABHe5kNIbzrToESJ8CLAkibBwDyezS52hfdQZb98D2A0hOYAAAAAAENAADyezS52hfdQZb98D2A0hOYAABC12sgAAA%3D&exvsurl=1&path=/calendar/item',
        },
        {
            id: 'cal_3',
            subject: 'POD A - Daily Huddle',
            start: '2026-02-24T09:45:00.000Z',
            end: '2026-02-24T10:10:00.000Z',
            organizer: 'kamil@implementai.io',
            location: 'Microsoft Teams Meeting',
            isOrganizer: false,
            recurring: true,
            webLink: null,
        },
        {
            id: 'cal_4',
            subject: 'IAI x Townhouse: US Booking Agent',
            start: '2026-02-24T15:30:00.000Z',
            end: '2026-02-24T16:00:00.000Z',
            organizer: 'mishai@implementai.io',
            location: 'Microsoft Teams Meeting',
            isOrganizer: true,
            webLink: 'https://outlook.office365.com/owa/?itemid=AAMkADdkMGU4MjNkLWFlYjMtNGZmZS04N2I1LWU0ZmU5NjM1NGFlMgBGAAAAAABHe5kNIbzrToESJ8CLAkibBwDyezS52hfdQZb98D2A0hOYAAAAAAENAADyezS52hfdQZb98D2A0hOYAABASsGGAAA%3D&exvsurl=1&path=/calendar/item',
        },
        {
            id: 'cal_5',
            subject: 'POD A - Daily Huddle',
            start: '2026-02-25T09:45:00.000Z',
            end: '2026-02-25T10:10:00.000Z',
            organizer: 'kamil@implementai.io',
            location: 'Microsoft Teams Meeting',
            isOrganizer: false,
            recurring: true,
            webLink: null,
        },
        {
            id: 'cal_6',
            subject: 'POD - Weekly Client Review',
            start: '2026-02-25T10:00:00.000Z',
            end: '2026-02-25T10:40:00.000Z',
            organizer: 'alex@implementai.io',
            location: 'Microsoft Teams Meeting',
            isOrganizer: false,
            webLink: null,
        },
        {
            id: 'cal_7',
            subject: 'POD A - Daily Huddle',
            start: '2026-02-26T09:45:00.000Z',
            end: '2026-02-26T10:10:00.000Z',
            organizer: 'kamil@implementai.io',
            location: 'Microsoft Teams Meeting',
            isOrganizer: false,
            recurring: true,
            webLink: null,
        },
        {
            id: 'cal_8',
            subject: 'Pharmacy Store <> IAI',
            start: '2026-02-26T14:30:00.000Z',
            end: '2026-02-26T15:00:00.000Z',
            organizer: 'brunno@implementai.io',
            location: 'Microsoft Teams Meeting',
            isOrganizer: false,
            webLink: 'https://outlook.office365.com/owa/?itemid=AAMkADdkMGU4MjNkLWFlYjMtNGZmZS04N2I1LWU0ZmU5NjM1NGFlMgBGAAAAAABHe5kNIbzrToESJ8CLAkibBwDyezS52hfdQZb98D2A0hOYAAAAAAENAADyezS52hfdQZb98D2A0hOYAABASsGEAAA%3D&exvsurl=1&path=/calendar/item',
        },
        {
            id: 'cal_9',
            subject: 'POD A - Daily Huddle',
            start: '2026-02-27T09:45:00.000Z',
            end: '2026-02-27T10:10:00.000Z',
            organizer: 'kamil@implementai.io',
            location: 'Microsoft Teams Meeting',
            isOrganizer: false,
            recurring: true,
            webLink: null,
        },
        {
            id: 'cal_10',
            subject: 'POD A - Daily Huddle',
            start: '2026-02-28T09:45:00.000Z',
            end: '2026-02-28T10:10:00.000Z',
            organizer: 'kamil@implementai.io',
            location: 'Microsoft Teams Meeting',
            isOrganizer: false,
            recurring: true,
            webLink: null,
        },
    ]
};

/* ================================================================
   MONDAY.COM API MODULE
   ================================================================ */
const MondayAPI = {
    _token: null,

    init() {
        this._token = localStorage.getItem('iai_monday_token');
        return !!this._token;
    },

    setToken(t) {
        this._token = t;
        localStorage.setItem('iai_monday_token', t);
    },

    async query(q, vars = {}) {
        const res = await fetch(CONFIG.API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': this._token,
                'API-Version': '2024-10',
            },
            body: JSON.stringify({ query: q, variables: vars }),
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        const data = await res.json();
        if (data.errors) throw new Error(data.errors.map(e => e.message).join('; '));
        if (data.error_message) throw new Error(data.error_message);
        return data.data;
    },

    async testConnection() {
        const data = await this.query('{ me { name email } }');
        return { name: data.me.name, email: data.me.email };
    },

    /** Fetch all items' POD column to discover available pods */
    async discoverPods() {
        const q = `query {
            boards(ids: ${CONFIG.BOARD_ID}) {
                items_page(limit: 200) {
                    items {
                        column_values(ids: ["${CONFIG.COLUMNS.POD}"]) { text value }
                    }
                }
            }
        }`;
        const data = await this.query(q);
        const items = data.boards[0].items_page.items;
        const podMap = new Map();
        items.forEach(item => {
            const col = item.column_values[0];
            if (!col || !col.text) return;
            let index = null;
            try { index = JSON.parse(col.value)?.index; } catch {}
            if (index !== null && index !== undefined && !podMap.has(col.text)) {
                podMap.set(col.text, index);
            }
        });
        return Array.from(podMap.entries()).map(([name, index]) => ({
            name,
            index,
            slug: name.toLowerCase().replace(/\s+/g, '-'),
        })).sort((a, b) => a.name.localeCompare(b.name));
    },

    async fetchPodClients(podIndex) {
        const q = `query {
            boards(ids: ${CONFIG.BOARD_ID}) {
                items_page(limit: 50, query_params: {
                    rules: [{ column_id: "${CONFIG.COLUMNS.POD}", compare_value: [${podIndex}], operator: any_of }]
                }) {
                    items {
                        id name updated_at
                        column_values { id type text value }
                        subitems { id name column_values { id type text value } }
                    }
                }
            }
        }`;
        const data = await this.query(q);
        return data.boards[0].items_page.items;
    },

    async updateColumn(itemId, columnId, value) {
        const q = `mutation ($boardId: ID!, $itemId: ID!, $columnId: String!, $value: JSON!) {
            change_column_value(board_id: $boardId, item_id: $itemId, column_id: $columnId, value: $value) {
                id name
            }
        }`;
        return await this.query(q, {
            boardId: String(CONFIG.BOARD_ID),
            itemId: String(itemId),
            columnId: columnId,
            value: value,
        });
    },

    async updateMultipleColumns(itemId, columnValues) {
        const q = `mutation ($boardId: ID!, $itemId: ID!, $columnValues: JSON!) {
            change_multiple_column_values(board_id: $boardId, item_id: $itemId, column_values: $columnValues) {
                id name
            }
        }`;
        return await this.query(q, {
            boardId: String(CONFIG.BOARD_ID),
            itemId: String(itemId),
            columnValues: JSON.stringify(columnValues),
        });
    },
};

/* ================================================================
   STATE MANAGER
   ================================================================ */
const State = {
    clients: [],
    filtered: [],
    filters: { rag: 'all', plan: 'all', billing: 'all', search: '' },
    sort: 'health-desc',
    selectedId: null,
    pendingChanges: {},
    localData: {},
    alerts: [],
    alertsVisible: false,
    alertsExpanded: false,
    alertsDismissedIds: new Set(),
    dataLoaded: false,

    loadLocal() {
        try {
            this.localData = JSON.parse(localStorage.getItem(UserSession.podKey('iai_local_data')) || '{}');
        } catch (e) { this.localData = {}; }
    },

    saveLocal() {
        localStorage.setItem(UserSession.podKey('iai_local_data'), JSON.stringify(this.localData));
    },

    getLocal(id, key, def) {
        return this.localData[id]?.[key] ?? def;
    },

    setLocal(id, key, val) {
        if (!this.localData[id]) this.localData[id] = {};
        this.localData[id][key] = val;
        this.saveLocal();
    },

    transform(rawItems) {
        // Helper: calculate absolute days between today and a date string
        const calcDaysSince = (dateStr) => {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) return '';
            return Math.abs(Math.round((Date.now() - d.getTime()) / 86400000)).toString();
        };

        // Helper: sanitize formula column text ('null', '', undefined → '')
        const sanitizeNum = (text) => {
            if (!text || text === 'null' || text === 'undefined') return '';
            const n = parseFloat(text);
            return isNaN(n) ? '' : n.toString();
        };

        return rawItems.map(item => {
            const cv = {};
            item.column_values.forEach(c => { cv[c.id] = c; });
            const getText = id => cv[id]?.text || '';
            const getVal = id => { try { return JSON.parse(cv[id]?.value || 'null'); } catch { return null; } };

            const commencement = getVal(CONFIG.COLUMNS.COMMENCEMENT)?.date || '';
            const pilotKickoff = getVal(CONFIG.COLUMNS.PILOT_KICKOFF)?.date || '';

            // Prefer local calculation from dates; fall back to API formula value
            const apiAiosDays = sanitizeNum(getText(CONFIG.COLUMNS.AIOS_DAYS));
            const apiPilotDays = sanitizeNum(getText(CONFIG.COLUMNS.PILOT_DAYS));
            const aiosDays = calcDaysSince(commencement) || apiAiosDays;
            const pilotDays = calcDaysSince(pilotKickoff) || apiPilotDays;

            return {
                id: item.id,
                name: item.name,
                updatedAt: item.updated_at,
                rag: getText(CONFIG.COLUMNS.RAG) || 'Unknown',
                plan: getText(CONFIG.COLUMNS.PLAN) || 'Unknown',
                updateStatus: getText(CONFIG.COLUMNS.UPDATE) || 'Unknown',
                billing: getText(CONFIG.COLUMNS.BILLING) || 'Unknown',
                agentCount: parseInt(getText(CONFIG.COLUMNS.AGENTS)) || 0,
                summary: getText(CONFIG.COLUMNS.SUMMARY),
                goLive: getVal(CONFIG.COLUMNS.GO_LIVE)?.date || '',
                deadline: getVal(CONFIG.COLUMNS.DEADLINE)?.date || '',
                commencement,
                pilotKickoff,
                lastContact: getVal(CONFIG.COLUMNS.LAST_CONTACT)?.date || getText(CONFIG.COLUMNS.LAST_CONTACT).split(' ')[0] || '',
                aiosDays,
                pilotDays,
                sponsorEmail: getVal(CONFIG.COLUMNS.SPONSOR_EMAIL)?.email || getText(CONFIG.COLUMNS.SPONSOR_EMAIL),
                pocEmail: getVal(CONFIG.COLUMNS.POC_EMAIL)?.email || getText(CONFIG.COLUMNS.POC_EMAIL),
                otherEmail: getVal(CONFIG.COLUMNS.OTHER_EMAIL)?.email || getText(CONFIG.COLUMNS.OTHER_EMAIL),
                itContact: getText(CONFIG.COLUMNS.IT_CONTACT),
                domain: getVal(CONFIG.COLUMNS.DOMAIN)?.url || getText(CONFIG.COLUMNS.DOMAIN),
                industry: getText(CONFIG.COLUMNS.INDUSTRY),
                offerSent: getText(CONFIG.COLUMNS.OFFER_SENT),
                agents: (item.subitems || []).map(s => {
                    const scv = {};
                    s.column_values.forEach(c => { scv[c.id] = c; });
                    const stageCol = scv['color_mkynkxhs'] || scv['status'] || {};
                    return { id: s.id, name: s.name, stage: stageCol.text || 'Unknown' };
                }),
            };
        });
    },

    // Calculate health score (0-100) from multiple factors
    calcHealth(client) {
        let score = 50; // base

        // RAG weight (30 points)
        if (client.rag === 'Green') score += 30;
        else if (client.rag === 'Amber') score += 15;
        else if (client.rag === 'Red') score -= 10;

        // Last contact recency (20 points)
        const daysSince = getDaysSinceContact(client.lastContact);
        if (daysSince !== null) {
            if (daysSince <= 3) score += 20;
            else if (daysSince <= 7) score += 12;
            else if (daysSince <= 14) score += 5;
            else score -= 10;
        }

        // Update status (10 points)
        if (client.updateStatus === 'Yes') score += 10;
        else if (client.updateStatus === 'Working on it') score += 5;
        else if (client.updateStatus === 'Need Contact') score -= 5;

        // Billing (10 points)
        if (client.billing === 'Yes') score += 10;

        // Agent count (relative)
        if (client.agentCount >= 3) score += 5;
        else if (client.agentCount >= 1) score += 2;

        // Confidence from local slider
        const conf = this.getLocal(client.id, 'confidence', 50);
        score += Math.round((conf - 50) * 0.1); // -5 to +5

        return Math.max(0, Math.min(100, score));
    },

    // Detailed health breakdown for KPI insight popover
    calcHealthBreakdown(client) {
        const factors = [];
        let score = 50;

        // RAG weight (30 points)
        let ragPts = 0;
        if (client.rag === 'Green') ragPts = 30;
        else if (client.rag === 'Amber') ragPts = 15;
        else if (client.rag === 'Red') ragPts = -10;
        score += ragPts;
        factors.push({ name: 'RAG Status', points: ragPts, detail: client.rag || 'Unknown', max: 30 });

        // Last contact recency (20 points)
        const daysSince = getDaysSinceContact(client.lastContact);
        let contactPts = 0;
        let contactDetail = 'No data';
        if (daysSince !== null) {
            if (daysSince <= 3) { contactPts = 20; contactDetail = `${daysSince}d ago`; }
            else if (daysSince <= 7) { contactPts = 12; contactDetail = `${daysSince}d ago`; }
            else if (daysSince <= 14) { contactPts = 5; contactDetail = `${daysSince}d ago`; }
            else { contactPts = -10; contactDetail = `${daysSince}d ago (stale)`; }
        }
        score += contactPts;
        factors.push({ name: 'Last Contact', points: contactPts, detail: contactDetail, max: 20 });

        // Update status (10 points)
        let updatePts = 0;
        if (client.updateStatus === 'Yes') updatePts = 10;
        else if (client.updateStatus === 'Working on it') updatePts = 5;
        else if (client.updateStatus === 'Need Contact') updatePts = -5;
        score += updatePts;
        factors.push({ name: 'Update Status', points: updatePts, detail: client.updateStatus || 'Unknown', max: 10 });

        // Billing (10 points)
        let billingPts = client.billing === 'Yes' ? 10 : 0;
        score += billingPts;
        factors.push({ name: 'Billing', points: billingPts, detail: client.billing || 'Unknown', max: 10 });

        // Agent count
        let agentPts = 0;
        if (client.agentCount >= 3) agentPts = 5;
        else if (client.agentCount >= 1) agentPts = 2;
        score += agentPts;
        factors.push({ name: 'Agents', points: agentPts, detail: `${client.agentCount} agent${client.agentCount !== 1 ? 's' : ''}`, max: 5 });

        // Confidence
        const conf = this.getLocal(client.id, 'confidence', 50);
        const confPts = Math.round((conf - 50) * 0.1);
        score += confPts;
        factors.push({ name: 'Confidence', points: confPts, detail: `${conf}%`, max: 5 });

        return { total: Math.max(0, Math.min(100, score)), base: 50, factors };
    },

    // Auto-calculate progress from dates
    calcAutoProgress(client) {
        if (!client.commencement) return null;
        const start = new Date(client.commencement);
        const end = client.deadline ? new Date(client.deadline) : client.goLive ? new Date(client.goLive) : null;
        if (!end) return null;
        const now = new Date();
        const total = end - start;
        if (total <= 0) return 100;
        const elapsed = now - start;
        return Math.max(0, Math.min(100, Math.round((elapsed / total) * 100)));
    },

    // Generate smart alerts
    generateAlerts() {
        this.alerts = [];

        // Check if a client is discontinued (no longer active for agent building)
        const isDiscontinued = (clientName) => {
            const ed = EMAIL_DATA.clients[clientName];
            return ed && ed.discontinued === true;
        };

        this.clients.forEach(c => {
            // Skip all operational alerts for discontinued clients
            if (isDiscontinued(c.name)) return;

            const daysSince = getDaysSinceContact(c.lastContact);

            // Critical: No contact in 14+ days
            if (daysSince !== null && daysSince >= CONFIG.STALE_CRITICAL_DAYS) {
                this.alerts.push({
                    type: 'critical',
                    icon: '&#128680;',
                    title: `${c.name} - No contact in ${daysSince} days`,
                    desc: 'Critical: Client needs immediate outreach',
                    clientId: c.id,
                    timestamp: c.lastContact,
                });
            }
            // Warning: No contact in 7+ days
            else if (daysSince !== null && daysSince >= CONFIG.STALE_WARNING_DAYS) {
                this.alerts.push({
                    type: 'warning',
                    icon: '&#9888;&#65039;',
                    title: `${c.name} - Last contact ${daysSince} days ago`,
                    desc: 'Consider scheduling a check-in',
                    clientId: c.id,
                    timestamp: c.lastContact,
                });
            }

            // Red RAG alert
            if (c.rag === 'Red') {
                this.alerts.push({
                    type: 'critical',
                    icon: '&#128308;',
                    title: `${c.name} - Red RAG Status`,
                    desc: 'Requires immediate attention and action plan',
                    clientId: c.id,
                    timestamp: c.updatedAt,
                });
            }

            // Missing billing for non-pilot clients
            if (c.billing === 'No' && c.plan !== 'AIOS Pilot' && c.plan !== 'Free Demo') {
                this.alerts.push({
                    type: 'info',
                    icon: '&#128179;',
                    title: `${c.name} - Billing not active`,
                    desc: `${c.plan} plan but billing is set to No`,
                    clientId: c.id,
                    timestamp: c.updatedAt,
                });
            }

            // Zero agents deployed
            if (c.agentCount === 0) {
                this.alerts.push({
                    type: 'warning',
                    icon: '&#129302;',
                    title: `${c.name} - No agents deployed`,
                    desc: 'Client has zero agents configured',
                    clientId: c.id,
                    timestamp: c.updatedAt,
                });
            }

            // Update status: Need Contact
            if (c.updateStatus === 'Need Contact') {
                this.alerts.push({
                    type: 'warning',
                    icon: '&#128222;',
                    title: `${c.name} - Needs contact`,
                    desc: 'Update status is set to "Need Contact"',
                    clientId: c.id,
                    timestamp: c.updatedAt,
                });
            }

            // Deadline approaching (within 7 days)
            if (c.deadline) {
                const daysToDeadline = Math.ceil((new Date(c.deadline) - new Date()) / 86400000);
                if (daysToDeadline >= 0 && daysToDeadline <= 7) {
                    this.alerts.push({
                        type: 'warning',
                        icon: '&#9200;',
                        title: `${c.name} - Deadline in ${daysToDeadline} day${daysToDeadline !== 1 ? 's' : ''}`,
                        desc: `Go-live deadline: ${c.deadline}`,
                        clientId: c.id,
                        timestamp: c.deadline,
                    });
                } else if (daysToDeadline < 0) {
                    this.alerts.push({
                        type: 'critical',
                        icon: '&#128165;',
                        title: `${c.name} - Deadline OVERDUE`,
                        desc: `Deadline was ${c.deadline} (${Math.abs(daysToDeadline)} days overdue)`,
                        clientId: c.id,
                        timestamp: c.deadline,
                    });
                }
            }
        });

        // Email-based alerts (skip discontinued clients, respect 48h grace period)
        this.clients.forEach(c => {
            if (isDiscontinued(c.name)) return;
            const ed = EMAIL_DATA.clients[c.name];
            if (ed) {
                const effectiveStatus = getEffectiveEmailStatus(c.name);

                // Only alert if 48h grace period has passed
                if (effectiveStatus === 'needs-response') {
                    const latestEmail = ed.emails[0];
                    const fromName = latestEmail?.from?.split('@')[0]?.replace(/\./g, ' ') || 'Client';
                    const hoursSince = getHoursSinceLastClientEmail(ed);
                    const daysWaiting = hoursSince !== null ? Math.floor(hoursSince / 24) : 0;
                    this.alerts.push({
                        type: daysWaiting >= 4 ? 'critical' : 'warning',
                        icon: daysWaiting >= 4 ? '&#128680;' : '&#128236;',
                        title: `${c.name} - Email needs response (${daysWaiting}d waiting)`,
                        desc: `${fromName} is waiting for a reply — past 48h window`,
                        clientId: c.id,
                        timestamp: latestEmail?.date || ed.lastEmailDate,
                    });
                }
                // within-grace: no alert — client just emailed, still within 48h window
                if (ed.status === 'stale') {
                    this.alerts.push({
                        type: 'critical',
                        icon: '&#128232;',
                        title: `${c.name} - Email thread stale`,
                        desc: `Last email exchange was ${ed.lastEmailDate} - re-engage client`,
                        clientId: c.id,
                        timestamp: ed.lastEmailDate,
                    });
                }
            }
        });

        // Sort: critical first, then warning, then info; within same type, oldest first (most urgent)
        const order = { critical: 0, warning: 1, info: 2 };
        this.alerts.sort((a, b) => {
            const typeDiff = order[a.type] - order[b.type];
            if (typeDiff !== 0) return typeDiff;
            // Within same type: oldest timestamp first (needs attention longest)
            const tA = a.timestamp ? new Date(a.timestamp).getTime() : Infinity;
            const tB = b.timestamp ? new Date(b.timestamp).getTime() : Infinity;
            return tA - tB;
        });

        // Filter out previously dismissed alerts (session only)
        if (this.alertsDismissedIds.size > 0) {
            this.alerts = this.alerts.filter(a => {
                const alertKey = `${a.clientId}-${a.title}`;
                return !this.alertsDismissedIds.has(alertKey);
            });
        }
    },

    applyFilters() {
        let f = [...this.clients];
        if (this.filters.rag !== 'all') f = f.filter(c => c.rag === this.filters.rag);
        if (this.filters.plan !== 'all') f = f.filter(c => c.plan === this.filters.plan);
        if (this.filters.billing !== 'all') f = f.filter(c => c.billing === this.filters.billing);
        if (this.filters.search) {
            const q = this.filters.search.toLowerCase();
            f = f.filter(c =>
                c.name.toLowerCase().includes(q) ||
                (c.summary || '').toLowerCase().includes(q) ||
                (c.industry || '').toLowerCase().includes(q)
            );
        }
        // Apply sorting
        f = this.applySorting(f);
        this.filtered = f;
    },

    applySorting(arr) {
        const s = this.sort;
        return arr.sort((a, b) => {
            switch(s) {
                case 'health-desc': return this.calcHealth(b) - this.calcHealth(a);
                case 'health-asc': return this.calcHealth(a) - this.calcHealth(b);
                case 'name-asc': return a.name.localeCompare(b.name);
                case 'name-desc': return b.name.localeCompare(a.name);
                case 'rag': {
                    const ragOrder = { Red: 0, Amber: 1, Green: 2, Unknown: 3 };
                    return (ragOrder[a.rag] ?? 3) - (ragOrder[b.rag] ?? 3);
                }
                case 'contact-asc': {
                    const da = a.lastContact ? new Date(a.lastContact).getTime() : 0;
                    const db = b.lastContact ? new Date(b.lastContact).getTime() : 0;
                    return da - db;
                }
                case 'contact-desc': {
                    const da = a.lastContact ? new Date(a.lastContact).getTime() : 0;
                    const db = b.lastContact ? new Date(b.lastContact).getTime() : 0;
                    return db - da;
                }
                case 'agents-desc': return b.agentCount - a.agentCount;
                default: return 0;
            }
        });
    },

    getSelected() {
        return this.clients.find(c => c.id === this.selectedId);
    },
};

/* ================================================================
   CHART MANAGER
   ================================================================ */
const Charts = {
    _instances: {},

    destroy(id) {
        if (this._instances[id]) { this._instances[id].destroy(); delete this._instances[id]; }
    },

    themeDefaults() {
        const isDark = ThemeManager.isDark();
        Chart.defaults.color = isDark ? '#999' : '#5e6c84';
        Chart.defaults.borderColor = isDark ? '#333' : '#dfe1e6';
        Chart.defaults.font.family = 'Inter';
    },

    renderAll(clients) {
        this.themeDefaults();
        this.renderRAG(clients);
        this.renderPlans(clients);
        this.renderAgents(clients);
        this.renderDays(clients);
    },

    renderRAG(clients) {
        this.destroy('rag');
        const counts = { Green: 0, Amber: 0, Red: 0 };
        clients.forEach(c => { if (counts[c.rag] !== undefined) counts[c.rag]++; });
        const ctx = document.getElementById('ragChart');
        if (!ctx) return;
        this._instances['rag'] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(counts),
                datasets: [{
                    data: Object.values(counts),
                    backgroundColor: ['#00c875', '#fdab3d', '#df2f4a'],
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-card').trim(), borderWidth: 3,
                    hoverBorderColor: '#fff',
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: { position: 'bottom', labels: { padding: 12, usePointStyle: true, pointStyle: 'circle' } },
                },
            }
        });
    },

    renderPlans(clients) {
        this.destroy('plans');
        const counts = {};
        clients.forEach(c => { counts[c.plan] = (counts[c.plan] || 0) + 1; });
        const labels = Object.keys(counts);
        const colors = labels.map(l => {
            const opt = CONFIG.PLAN_OPTIONS.find(o => o.label === l);
            return opt ? opt.color : '#666';
        });
        const ctx = document.getElementById('planChart');
        if (!ctx) return;
        this._instances['plans'] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [{ data: Object.values(counts), backgroundColor: colors, borderRadius: 4, barThickness: 28 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { color: ThemeManager.isDark() ? '#222' : '#e4e6ea' }, ticks: { stepSize: 1 } },
                    y: { grid: { display: false }, ticks: { font: { size: 11 } } },
                }
            }
        });
    },

    renderAgents(clients) {
        this.destroy('agents');
        const sorted = [...clients].sort((a, b) => b.agentCount - a.agentCount);
        const ctx = document.getElementById('agentsChart');
        if (!ctx) return;
        this._instances['agents'] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sorted.map(c => c.name),
                datasets: [{
                    data: sorted.map(c => c.agentCount),
                    backgroundColor: '#6B30FF', borderRadius: 4, barThickness: 28,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false }, ticks: { font: { size: 10 }, maxRotation: 45 } },
                    y: { grid: { color: ThemeManager.isDark() ? '#222' : '#e4e6ea' }, ticks: { stepSize: 1 }, beginAtZero: true },
                }
            }
        });
    },

    renderDays(clients) {
        this.destroy('days');
        // Get the days value for each client (prefer aiosDays, then pilotDays)
        const getDays = (c) => {
            const a = parseFloat(c.aiosDays);
            if (!isNaN(a) && a > 0) return a;
            const p = parseFloat(c.pilotDays);
            if (!isNaN(p) && p > 0) return p;
            return 0;
        };
        const withDays = [...clients].filter(c => getDays(c) > 0)
            .sort((a, b) => getDays(b) - getDays(a));
        if (withDays.length === 0) return;
        const ragColors = withDays.map(c => {
            if (c.rag === 'Green') return '#00c875';
            if (c.rag === 'Amber') return '#fdab3d';
            return '#df2f4a';
        });
        const labels = withDays.map(c => {
            const isPilot = !c.aiosDays && c.pilotDays;
            return isPilot ? `${c.name} (Pilot)` : c.name;
        });
        const ctx = document.getElementById('daysChart');
        if (!ctx) return;
        this._instances['days'] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    data: withDays.map(c => Math.round(getDays(c))),
                    backgroundColor: ragColors, borderRadius: 4, barThickness: 28,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `${ctx.parsed.x} days in programme`
                        }
                    }
                },
                scales: {
                    x: { grid: { color: ThemeManager.isDark() ? '#222' : '#e4e6ea' }, ticks: {}, title: { display: true, text: 'Days' } },
                    y: { grid: { display: false }, ticks: { font: { size: 11 } } },
                }
            }
        });
    },
};

/* ================================================================
   UI HELPERS
   ================================================================ */
function ragBadgeClass(rag) {
    if (rag === 'Green') return 'badge-green';
    if (rag === 'Amber') return 'badge-amber';
    if (rag === 'Red') return 'badge-red';
    return 'badge-gray';
}

function planBadgeClass(plan) {
    if (plan === 'Activate') return 'badge-blue';
    if (plan === 'Scale') return 'badge-red';
    if (plan === 'AIOS Pilot') return 'badge-amber';
    if (plan === 'Orchestrate') return 'badge-teal';
    if (plan === 'Custom Plan') return 'badge-green';
    if (plan === 'Partnership') return 'badge-purple';
    return 'badge-gray';
}

function billingBadgeClass(b) {
    if (b === 'Yes') return 'badge-green';
    if (b === 'No') return 'badge-red';
    return 'badge-blue';
}

function updateBadgeClass(u) {
    if (u === 'Yes') return 'badge-green';
    if (u === 'Working on it') return 'badge-amber';
    if (u === 'Need Contact') return 'badge-red';
    return 'badge-gray';
}

function getDaysSinceContact(dateStr) {
    if (!dateStr) return null;
    try {
        const d = new Date(dateStr);
        if (isNaN(d.getTime())) return null;
        return Math.floor((new Date() - d) / 86400000);
    } catch { return null; }
}

function daysAgo(dateStr) {
    const d = getDaysSinceContact(dateStr);
    if (d === null) return 'N/A';
    if (d === 0) return 'Today';
    if (d === 1) return '1 day ago';
    return `${d} days ago`;
}

function daysAgoClass(dateStr) {
    const diff = getDaysSinceContact(dateStr);
    if (diff === null) return '';
    if (diff >= CONFIG.STALE_CRITICAL_DAYS) return 'danger';
    if (diff >= CONFIG.STALE_WARNING_DAYS) return 'warning';
    return '';
}

function confidenceColor(v) {
    if (v < 33) return '#df2f4a';
    if (v < 66) return '#fdab3d';
    return '#00c875';
}

function healthColor(v) {
    if (v >= 75) return '#00c875';
    if (v >= 50) return '#fdab3d';
    return '#df2f4a';
}

function safeDomain(url) {
    if (!url) return '';
    try {
        const u = new URL(url.startsWith('http') ? url : 'https://' + url);
        return u.hostname;
    } catch { return url; }
}

function showToast(msg, type = 'success') {
    const container = document.getElementById('toastContainer');
    const icons = { success: '&#10003;', error: '&#10007;', info: '&#8505;', warning: '&#9888;' };
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    el.innerHTML = `<span>${icons[type] || icons.info}</span> ${msg}`;
    container.appendChild(el);
    setTimeout(() => {
        el.style.opacity = '0';
        el.style.transform = 'translateX(40px)';
        el.style.transition = 'all 0.3s ease';
        setTimeout(() => el.remove(), 300);
    }, 3500);
}

function formatAlertTimestamp(ts) {
    if (!ts) return null;
    const d = new Date(ts);
    if (isNaN(d.getTime())) return null;
    const now = new Date();
    const diffMs = now - d;
    const diffDays = Math.floor(diffMs / 86400000);
    const diffHours = Math.floor(diffMs / 3600000);

    // Freshness category: fresh (<2d), recent (2-7d), aged (>7d)
    let freshness = 'aged';
    if (diffDays < 2) freshness = 'fresh';
    else if (diffDays <= 7) freshness = 'recent';

    // Friendly relative label
    let label;
    if (diffDays < 0) {
        // Future date (deadline)
        const absDays = Math.abs(diffDays);
        label = absDays === 0 ? 'Today' : absDays === 1 ? 'Tomorrow' : `In ${absDays}d`;
        freshness = 'fresh';
    } else if (diffHours < 1) {
        label = 'Just now';
    } else if (diffHours < 24) {
        label = `${diffHours}h ago`;
    } else if (diffDays === 1) {
        label = 'Yesterday';
    } else if (diffDays < 30) {
        label = `${diffDays}d ago`;
    } else {
        const diffWeeks = Math.floor(diffDays / 7);
        if (diffWeeks < 8) {
            label = `${diffWeeks}w ago`;
        } else {
            label = d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
        }
    }

    // Absolute date for title tooltip
    const abs = d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });

    return { label, freshness, absolute: abs };
}

/* ================================================================
   RENDER SMART ALERTS
   ================================================================ */
function renderAlerts() {
    State.generateAlerts();
    const count = State.alerts.length;
    const badge = document.getElementById('alertBadge');
    badge.textContent = count;
    badge.classList.toggle('hidden', count === 0);

    const section = document.getElementById('alertsSection');
    const grid = document.getElementById('alertsGrid');
    document.getElementById('alertsTotalCount').textContent = count > 0 ? `(${count})` : '';

    if (count === 0) {
        section.classList.add('hidden');
        grid.innerHTML = '';
        return;
    }

    if (State.alertsVisible) {
        section.classList.remove('hidden');
    }

    const INITIAL_SHOW = 8;
    const expanded = State.alertsExpanded;
    const alertsToShow = expanded ? State.alerts : State.alerts.slice(0, INITIAL_SHOW);
    const hasMore = count > INITIAL_SHOW;

    grid.innerHTML = alertsToShow.map((a, i) => {
        const alertKey = `${a.clientId}-${a.title}`;
        const safeKey = alertKey.replace(/'/g, "\\'");
        const ts = formatAlertTimestamp(a.timestamp);
        const tsHTML = ts ? `<div class="alert-timestamp" title="${ts.absolute}"><span class="ts-dot ${ts.freshness}"></span>${ts.label}</div>` : '';
        return `
        <div class="alert-card ${a.type}" onclick="openDetail('${a.clientId}')">
            <button class="alert-dismiss" onclick="event.stopPropagation();dismissAlert('${safeKey}')" title="Dismiss this alert">&#10005;</button>
            <span class="alert-icon">${a.icon}</span>
            <div class="alert-content">
                <div class="alert-title">${a.title}</div>
                <div class="alert-desc">${a.desc}</div>
                ${tsHTML}
            </div>
        </div>`;
    }).join('') + (hasMore ? `
        <button class="alerts-show-more" onclick="toggleAlertExpand()">
            ${expanded ? '&#9650; Show Less' : `&#9660; Show All ${count} Alerts (+${count - INITIAL_SHOW} more)`}
        </button>
    ` : '');
}

function toggleAlertExpand() {
    State.alertsExpanded = !State.alertsExpanded;
    renderAlerts();
}

function toggleAlerts() {
    State.alertsVisible = !State.alertsVisible;
    const section = document.getElementById('alertsSection');
    if (State.alertsVisible && State.alerts.length > 0) {
        // Navigate to overview page where alerts live
        if (Router.current !== 'overview') Router.navigate('overview');
        section.classList.remove('hidden');
    } else {
        section.classList.add('hidden');
        State.alertsVisible = false;
        State.alertsExpanded = false; // Reset expand state when hiding
    }
}

function dismissAlert(alertKey) {
    State.alertsDismissedIds.add(alertKey);
    // Find the alert to show a nice toast
    const alert = State.alerts.find(a => `${a.clientId}-${a.title}` === alertKey);
    const clientName = alert ? alert.title.split(' - ')[0] : '';
    renderAlerts();
    if (State.alerts.length === 0) {
        State.alertsVisible = false;
        document.getElementById('alertsSection').classList.add('hidden');
    }
    showToast(clientName ? `Dismissed: ${clientName}` : 'Alert dismissed', 'info');
}

function clearAllAlerts() {
    // Dismiss all current alerts for this session
    State.alerts.forEach(a => {
        const alertKey = `${a.clientId}-${a.title}`;
        State.alertsDismissedIds.add(alertKey);
    });
    State.alerts = [];
    State.alertsVisible = false;
    State.alertsExpanded = false;
    const section = document.getElementById('alertsSection');
    section.classList.add('hidden');
    document.getElementById('alertsGrid').innerHTML = '';
    document.getElementById('alertBadge').textContent = '0';
    document.getElementById('alertBadge').classList.add('hidden');
    document.getElementById('alertsTotalCount').textContent = '';
    showToast('All alerts cleared for this session', 'info');
}

/* ================================================================
   UPDATE FILTER PILL COUNTS
   ================================================================ */
function updateFilterCounts() {
    const all = State.clients;
    // Filter counts are now inside dynamically rendered clients page
    const countAll = document.getElementById('countAll');
    const countGreen = document.getElementById('countGreen');
    const countAmber = document.getElementById('countAmber');
    const countRed = document.getElementById('countRed');
    if (countAll) countAll.textContent = all.length;
    if (countGreen) countGreen.textContent = all.filter(c => c.rag === 'Green').length;
    if (countAmber) countAmber.textContent = all.filter(c => c.rag === 'Amber').length;
    if (countRed) countRed.textContent = all.filter(c => c.rag === 'Red').length;
}

/* ================================================================
   RENDER KPI CARDS
   ================================================================ */
function renderKPIs(clients) {
    const all = State.clients; // always show totals from all clients
    const filtered = State.filtered;
    const isFiltered = State.filters.rag !== 'all' || State.filters.plan !== 'all' || State.filters.billing !== 'all' || State.filters.search;

    const totalClients = all.length;
    const totalAgents = all.reduce((s, c) => s + c.agentCount, 0);
    const greenCount = all.filter(c => c.rag === 'Green').length;
    const amberCount = all.filter(c => c.rag === 'Amber').length;
    const redCount = all.filter(c => c.rag === 'Red').length;
    const billingActive = all.filter(c => c.billing === 'Yes').length;

    // Avg health score
    const avgHealth = all.length > 0 ? Math.round(all.reduce((s, c) => s + State.calcHealth(c), 0) / all.length) : 0;

    const filterSuffix = isFiltered ? `<div class="kpi-sub">Showing: ${filtered.length} of ${all.length}</div>` : '';

    // Change detection indicators for KPI tiles
    const totalChanges = ChangeTracker.totalCount();
    const changeBadge = totalChanges > 0 ? `<div class="kpi-sub" style="color:var(--rag-amber)">&#9889; ${totalChanges} client${totalChanges !== 1 ? 's' : ''} changed</div>` : '';

    document.getElementById('kpiRow').innerHTML = `
        <div class="kpi-card" onclick="KPIInsight.totalClients(event)">
            <div class="kpi-accent" style="background:var(--accent-purple)"></div>
            <span class="kpi-icon">&#128101;</span>
            <div class="kpi-value">${totalClients}</div>
            <div class="kpi-label">Total Clients</div>
            ${filterSuffix}${changeBadge}
        </div>
        <div class="kpi-card" onclick="KPIInsight.totalAgents(event)">
            <div class="kpi-accent" style="background:var(--accent-orange)"></div>
            <span class="kpi-icon">&#129302;</span>
            <div class="kpi-value">${totalAgents}</div>
            <div class="kpi-label">Total Agents</div>
            <div class="kpi-sub">Avg ${all.length > 0 ? (totalAgents / all.length).toFixed(1) : 0} per client</div>
        </div>
        <div class="kpi-card ${State.filters.rag === 'Green' ? 'active-filter' : ''}" onclick="KPIInsight.ragBreakdown('Green',event);setRagFilter('Green',document.querySelector('[data-rag=Green]'))">
            <div class="kpi-accent" style="background:var(--rag-green)"></div>
            <span class="kpi-icon">&#9989;</span>
            <div class="kpi-value" style="color:var(--rag-green)">${greenCount}</div>
            <div class="kpi-label">Green RAG</div>
        </div>
        <div class="kpi-card ${State.filters.rag === 'Amber' ? 'active-filter' : ''}" onclick="KPIInsight.ragBreakdown('Amber',event);setRagFilter('Amber',document.querySelector('[data-rag=Amber]'))">
            <div class="kpi-accent" style="background:var(--rag-amber)"></div>
            <span class="kpi-icon">&#9888;&#65039;</span>
            <div class="kpi-value" style="color:var(--rag-amber)">${amberCount}</div>
            <div class="kpi-label">Amber RAG</div>
        </div>
        <div class="kpi-card ${State.filters.rag === 'Red' ? 'active-filter' : ''}" onclick="KPIInsight.ragBreakdown('Red',event);setRagFilter('Red',document.querySelector('[data-rag=Red]'))">
            <div class="kpi-accent" style="background:var(--rag-red)"></div>
            <span class="kpi-icon">&#10060;</span>
            <div class="kpi-value" style="color:var(--rag-red)">${redCount}</div>
            <div class="kpi-label">Red RAG</div>
        </div>
        <div class="kpi-card" onclick="KPIInsight.healthBreakdown(event)">
            <div class="kpi-accent" style="background:${healthColor(avgHealth)}"></div>
            <span class="kpi-icon">&#128170;</span>
            <div class="kpi-value" style="color:${healthColor(avgHealth)}">${avgHealth}</div>
            <div class="kpi-label">Avg Health Score</div>
            <div class="kpi-sub">${billingActive}/${totalClients} billing active</div>
        </div>
    `;
}

/* ================================================================
   RENDER CLIENT CARDS
   ================================================================ */
function renderClients(clientsArg) {
    const clients = clientsArg || State.filtered || [];
    const container = document.getElementById('clientsPageContent');
    if (!container) return;

    if (!State.dataLoaded) {
        container.innerHTML = `<div class="empty-state" style="text-align:center;padding:60px 20px;">
            <div class="empty-icon">&#128274;</div>
            <h3>No data loaded</h3>
            <p>Connect your monday.com API token to see client data</p>
        </div>`;
        return;
    }

    // Build filter pills + header
    const filtersHTML = `
    <div class="clients-page-header">
        <h2>&#128101; Client Portfolio <span style="font-size:14px;font-weight:400;color:var(--text-muted);">(${clients.length} client${clients.length !== 1 ? 's' : ''})</span></h2>
        <div class="clients-page-actions">
            <button class="btn-compare" onclick="Router.navigate('clients/compare')">&#128203; Compare All</button>
        </div>
    </div>
    <div class="clients-filters-row" id="clientsFiltersRow">
        <button class="filter-pill ${State.filters.rag === 'all' ? 'active' : ''}" data-rag="all" onclick="setRagFilter('all',this)">All <span class="pill-count" id="countAll">0</span></button>
        <button class="filter-pill rag-green ${State.filters.rag === 'Green' ? 'active' : ''}" data-rag="Green" onclick="setRagFilter('Green',this)">&#9679; Green <span class="pill-count" id="countGreen">0</span></button>
        <button class="filter-pill rag-amber ${State.filters.rag === 'Amber' ? 'active' : ''}" data-rag="Amber" onclick="setRagFilter('Amber',this)">&#9679; Amber <span class="pill-count" id="countAmber">0</span></button>
        <button class="filter-pill rag-red ${State.filters.rag === 'Red' ? 'active' : ''}" data-rag="Red" onclick="setRagFilter('Red',this)">&#9679; Red <span class="pill-count" id="countRed">0</span></button>
        <select class="filter-select" id="planFilter" onchange="setPlanFilter(this.value)">
            <option value="all" ${State.filters.plan === 'all' ? 'selected' : ''}>All Plans</option>
            <option value="Activate" ${State.filters.plan === 'Activate' ? 'selected' : ''}>Activate</option>
            <option value="Scale" ${State.filters.plan === 'Scale' ? 'selected' : ''}>Scale</option>
            <option value="AIOS Pilot" ${State.filters.plan === 'AIOS Pilot' ? 'selected' : ''}>AIOS Pilot</option>
            <option value="Orchestrate" ${State.filters.plan === 'Orchestrate' ? 'selected' : ''}>Orchestrate</option>
            <option value="Custom Plan" ${State.filters.plan === 'Custom Plan' ? 'selected' : ''}>Custom Plan</option>
        </select>
        <select class="filter-select" id="billingFilter" onchange="setBillingFilter(this.value)">
            <option value="all" ${State.filters.billing === 'all' ? 'selected' : ''}>All Billing</option>
            <option value="Yes" ${State.filters.billing === 'Yes' ? 'selected' : ''}>Billing Active</option>
            <option value="No" ${State.filters.billing === 'No' ? 'selected' : ''}>No Billing</option>
            <option value="N/A" ${State.filters.billing === 'N/A' ? 'selected' : ''}>N/A</option>
        </select>
        <select class="sort-select" id="sortSelect" onchange="setSort(this.value)">
            <option value="health-desc">Sort: Health &#8595;</option>
            <option value="health-asc">Sort: Health &#8593;</option>
            <option value="name-asc">Sort: Name A-Z</option>
            <option value="name-desc">Sort: Name Z-A</option>
            <option value="rag">Sort: RAG Status</option>
            <option value="contact-asc">Sort: Last Contact (oldest)</option>
            <option value="contact-desc">Sort: Last Contact (newest)</option>
            <option value="agents-desc">Sort: Most Agents</option>
        </select>
        <input class="search-box" type="text" placeholder="Search clients..." value="${State.filters.search || ''}" oninput="setSearch(this.value)" style="width:180px;">
    </div>`;

    if (clients.length === 0) {
        container.innerHTML = filtersHTML + `<div class="empty-state" style="text-align:center;padding:40px 20px;">
            <div class="empty-icon">&#128269;</div>
            <h3>No clients match your filters</h3>
            <p>Try adjusting your filter criteria or <a href="#" onclick="resetFilters();return false;" style="color:var(--accent-purple-light)">reset all filters</a></p>
        </div>`;
        updateFilterCounts();
        return;
    }

    const cardsHTML = clients.map(c => {
        const health = State.calcHealth(c);
        const hColor = healthColor(health);
        const ragColor = c.rag === 'Green' ? 'var(--rag-green)' : c.rag === 'Amber' ? 'var(--rag-amber)' : 'var(--rag-red)';
        const summaryText = c.summary ? (c.summary.length > 200 ? c.summary.substring(0, 200) + '...' : c.summary) : 'No summary available';
        const changed = ChangeTracker.hasChanges(c.id);
        const hasLocalEdits = LocalEditManager.hasEdits(c.id);
        const localBadge = hasLocalEdits ? '<span class="local-edit-badge" title="Has local edits">&#9998; local</span>' : '';

        // Inline change indicators
        const ragChg = ChangeTracker.inlineBadge(c.id, 'RAG Status');
        const healthChg = ChangeTracker.inlineBadge(c.id, 'Health Score');
        const billingChg = ChangeTracker.inlineBadge(c.id, 'Billing');
        const updateChg = ChangeTracker.inlineBadge(c.id, 'Update Status');
        const agentChg = ChangeTracker.inlineBadge(c.id, 'Agent Count');

        return `
        <div class="client-card-large ${changed ? 'has-changes' : ''}" onclick="Router.navigate('client/${c.id}')">
            ${ChangeTracker.badgeHTML(c.id)}
            <div class="client-header">
                <span class="rag-badge" style="background:${ragColor};cursor:pointer;" title="${c.rag} RAG — click to change" onclick="event.stopPropagation();toggleDropdown(event,'rag','${c.id}')"></span>
                <span class="client-name">${c.name} ${ragChg}</span>
                <span style="margin-left:auto;font-size:14px;font-weight:700;color:${hColor}">${health}${healthChg}</span>
                ${localBadge}
            </div>
            <div class="client-meta-row">
                <span class="meta-tag badge" style="cursor:pointer;" onclick="event.stopPropagation();toggleDropdown(event,'plan','${c.id}')">${c.plan}</span>
                <span class="meta-tag badge ${c.billing === 'Yes' ? 'billing-yes' : c.billing === 'No' ? 'billing-no' : ''}" style="cursor:pointer;" onclick="event.stopPropagation();toggleDropdown(event,'billing','${c.id}')">&#128179; ${c.billing}${billingChg}</span>
                <span class="meta-tag badge ${c.updateStatus === 'Yes' ? 'update-yes' : 'update-no'}" style="cursor:pointer;" onclick="event.stopPropagation();toggleDropdown(event,'update','${c.id}')">Update: ${c.updateStatus}${updateChg}</span>
                <span class="meta-tag">&#129302; ${c.agentCount} agent${c.agentCount !== 1 ? 's' : ''}${agentChg}</span>
            </div>
            <div class="client-summary-text" data-editable onclick="event.stopPropagation();EditManager.editSummary('${c.id}', this)">${summaryText}</div>
            <div class="client-stats-row">
                <div class="stat-item">
                    <span class="stat-label">AIOS Days</span>
                    <span class="stat-value">${c.aiosDays ? Math.round(parseFloat(c.aiosDays)) : '--'}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Stage</span>
                    <span class="stat-value">${c.agentStage || '--'}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Last Contact</span>
                    <span class="stat-value" style="color:${daysAgoClass(c.lastContact) === 'danger' ? 'var(--rag-red)' : daysAgoClass(c.lastContact) === 'warning' ? 'var(--rag-amber)' : 'inherit'}">${daysAgo(c.lastContact)}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Platform</span>
                    <span class="stat-value">${c.platform || '--'}</span>
                </div>
            </div>
            <div class="card-footer">
                ${NotesManager.countBadge(c.id)}
            </div>
            ${ChangeTracker.summaryStrip(c.id)}
        </div>`;
    }).join('');

    container.innerHTML = filtersHTML + `<div class="clients-large-grid">${cardsHTML}</div>`;
    updateFilterCounts();
}

/* ================================================================
   INLINE EDITING DROPDOWNS
   ================================================================ */
let activeDropdown = null;

function closeDropdowns() {
    document.querySelectorAll('.inline-dropdown').forEach(d => d.remove());
    activeDropdown = null;
}

document.addEventListener('click', (e) => {
    if (activeDropdown && !e.target.closest('.inline-dropdown') && !e.target.closest('.badge')) {
        closeDropdowns();
    }
});

function toggleDropdown(e, type, clientId) {
    e.stopPropagation();
    closeDropdowns();

    const badge = e.currentTarget;
    let options;
    let columnId;
    if (type === 'rag') { options = CONFIG.RAG_OPTIONS; columnId = CONFIG.COLUMNS.RAG; }
    else if (type === 'plan') { options = CONFIG.PLAN_OPTIONS; columnId = CONFIG.COLUMNS.PLAN; }
    else if (type === 'update') { options = CONFIG.UPDATE_OPTIONS; columnId = CONFIG.COLUMNS.UPDATE; }
    else if (type === 'billing') { options = CONFIG.BILLING_OPTIONS; columnId = CONFIG.COLUMNS.BILLING; }

    const dd = document.createElement('div');
    dd.className = 'inline-dropdown';
    dd.innerHTML = options.map(o => `
        <div class="dd-option" onclick="inlineEdit(event,'${clientId}','${columnId}',${o.index},'${o.label}','${type}')">
            <span class="dd-dot" style="background:${o.color}"></span>
            ${o.label}
        </div>
    `).join('');
    badge.style.position = 'relative';
    badge.appendChild(dd);
    activeDropdown = dd;
}

async function inlineEdit(e, clientId, columnId, index, label, type) {
    e.stopPropagation();
    closeDropdowns();

    const client = State.clients.find(c => c.id === clientId);
    if (!client) return;

    const fieldMap = { rag: 'rag', plan: 'plan', update: 'updateStatus', billing: 'billing' };
    const field = fieldMap[type] || type;
    const oldValue = client[field];

    if (oldValue === label) return; // no change

    // Save locally first (always persists)
    LocalEditManager.set(clientId, field, label);

    State.applyFilters();
    renderAll();

    // Attempt to sync to monday.com (non-blocking)
    try {
        await MondayAPI.updateColumn(clientId, columnId, JSON.stringify({ index }));
        // If API sync succeeds, remove from local edits
        const localEdits = LocalEditManager.getAll(clientId);
        if (localEdits[field] === label) {
            delete localEdits[field];
            if (Object.keys(localEdits).length === 0) delete LocalEditManager._edits[clientId];
            LocalEditManager.save();
        }
        showToast(`${client.name}: ${type} &#8594; ${label}`, 'success');
    } catch (err) {
        // Keep local edit — don't rollback since it's persisted locally
        showToast(`${client.name}: ${type} &#8594; ${label} (saved locally, sync failed)`, 'warning');
    }
}

/* ================================================================
   INLINE FIELD EDITOR — Generic editor for any field type
   ================================================================ */
let activeInlineEdit = null;

function closeInlineEdits() {
    if (activeInlineEdit) {
        activeInlineEdit.remove();
        activeInlineEdit = null;
    }
}

document.addEventListener('click', (e) => {
    if (activeInlineEdit && !e.target.closest('.inline-edit-overlay') && !e.target.closest('.editable-field')) {
        closeInlineEdits();
    }
});

function inlineFieldEdit(clientId, field, currentValue, type, configKey, event) {
    if (event) event.stopPropagation();
    closeInlineEdits();
    closeDropdowns();

    const overlay = document.createElement('div');
    overlay.className = 'inline-edit-overlay';

    if (type === 'dropdown') {
        // Use CONFIG options
        const options = CONFIG[configKey] || [];
        overlay.innerHTML = options.map(o => `
            <div class="dd-option" onclick="applyFieldEdit('${clientId}','${field}','${o.label}');closeInlineEdits();">
                <span class="dd-dot" style="background:${o.color}"></span>
                ${o.label}
            </div>
        `).join('');
    } else if (type === 'date') {
        overlay.innerHTML = `
            <input class="inline-edit-input" type="date" value="${currentValue || ''}" autofocus>
            <div class="inline-edit-actions">
                <button onclick="closeInlineEdits()">Cancel</button>
                <button class="save" onclick="applyFieldEdit('${clientId}','${field}',this.closest('.inline-edit-overlay').querySelector('input').value);closeInlineEdits();">Save</button>
            </div>`;
    } else if (type === 'number') {
        overlay.innerHTML = `
            <input class="inline-edit-input" type="number" value="${currentValue || 0}" min="0" autofocus>
            <div class="inline-edit-actions">
                <button onclick="closeInlineEdits()">Cancel</button>
                <button class="save" onclick="applyFieldEdit('${clientId}','${field}',parseInt(this.closest('.inline-edit-overlay').querySelector('input').value)||0);closeInlineEdits();">Save</button>
            </div>`;
    } else {
        // text or email
        const inputType = type === 'email' ? 'email' : 'text';
        overlay.innerHTML = `
            <input class="inline-edit-input" type="${inputType}" value="${(currentValue || '').replace(/"/g, '&quot;')}" placeholder="Enter value..." autofocus>
            <div class="inline-edit-actions">
                <button onclick="closeInlineEdits()">Cancel</button>
                <button class="save" onclick="applyFieldEdit('${clientId}','${field}',this.closest('.inline-edit-overlay').querySelector('input').value.trim());closeInlineEdits();">Save</button>
            </div>`;
    }

    document.body.appendChild(overlay);
    activeInlineEdit = overlay;

    // Position near the click
    requestAnimationFrame(() => {
        const target = event ? event.target.getBoundingClientRect() : { left: window.innerWidth / 2 - 100, top: window.innerHeight / 2, right: window.innerWidth / 2 + 100, bottom: window.innerHeight / 2 + 20 };
        let left = target.left;
        let top = target.bottom + 4;
        if (left + overlay.offsetWidth > window.innerWidth - 12) left = window.innerWidth - overlay.offsetWidth - 12;
        if (left < 12) left = 12;
        if (top + overlay.offsetHeight > window.innerHeight - 12) top = target.top - overlay.offsetHeight - 4;
        if (top < 12) top = 12;
        overlay.style.left = left + 'px';
        overlay.style.top = top + 'px';
    });

    // Auto-focus input
    const input = overlay.querySelector('input');
    if (input) {
        setTimeout(() => input.focus(), 50);
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                applyFieldEdit(clientId, field, input.value.trim());
                closeInlineEdits();
            } else if (e.key === 'Escape') {
                closeInlineEdits();
            }
        });
    }
}

function applyFieldEdit(clientId, field, value) {
    const client = State.clients.find(c => c.id === clientId);
    if (!client) return;
    const oldValue = client[field];
    if (String(oldValue) === String(value)) return;

    LocalEditManager.set(clientId, field, value);
    State.applyFilters();

    // Re-render current page
    const route = Router.current;
    if (route === 'client-detail' || (route && route.startsWith('clients/'))) {
        renderClientFullPage(clientId);
    } else {
        renderAll();
    }
    showToast(`${client.name}: ${field} updated`, 'success');
}

/* ================================================================
   SLIDER HANDLERS
   ================================================================ */
function updateSlider(clientId, key, value, el) {
    value = parseInt(value);
    State.setLocal(clientId, key, value);
    const labelEl = document.getElementById(`${key === 'confidence' ? 'conf' : 'prog'}-${clientId}`);
    if (labelEl) {
        labelEl.textContent = `${value}%`;
        if (key === 'confidence') labelEl.style.color = confidenceColor(value);
    }
}

/* ================================================================
   DETAIL PANEL
   ================================================================ */
function openDetail(clientId) {
    // Redirect to full-page client detail view
    Router.navigate('client/' + clientId);
    return;
    // Legacy detail panel code below (kept for reference)
    State.selectedId = clientId;
    State.pendingChanges = {};
    const c = State.getSelected();
    if (!c) return;

    const health = State.calcHealth(c);
    const hColor = healthColor(health);

    document.getElementById('detailName').textContent = c.name;
    document.getElementById('detailSubtitle').innerHTML = `${c.plan} &bull; <span style="color:${hColor}">Health: ${health}</span> &bull; ${c.agentCount} agents`;

    const body = document.getElementById('detailBody');
    body.innerHTML = `
        <div class="detail-section">
            <h3>&#128200; Health &amp; Status</h3>
            <div style="display:flex;gap:12px;margin-bottom:12px;flex-wrap:wrap;">
                <span class="badge ${ragBadgeClass(c.rag)}" style="font-size:13px;padding:6px 14px;">&#9679; ${c.rag} RAG</span>
                <span class="badge ${planBadgeClass(c.plan)}" style="font-size:13px;padding:6px 14px;">${c.plan}</span>
                <span class="badge ${updateBadgeClass(c.updateStatus)}" style="font-size:13px;padding:6px 14px;">${c.updateStatus}</span>
                <span class="badge ${billingBadgeClass(c.billing)}" style="font-size:13px;padding:6px 14px;">&#128179; ${c.billing}</span>
            </div>
            <div style="background:var(--bg-secondary);border-radius:var(--radius-sm);padding:12px;margin-bottom:8px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                    <span style="font-size:11px;font-weight:600;color:var(--text-muted);">HEALTH SCORE</span>
                    <span style="font-size:18px;font-weight:700;color:${hColor}">${health}/100</span>
                </div>
                <div style="height:6px;background:var(--bg-elevated);border-radius:3px;overflow:hidden;">
                    <div style="height:100%;width:${health}%;background:${hColor};border-radius:3px;transition:width 0.5s ease;"></div>
                </div>
            </div>
        </div>

        <div class="detail-section">
            <h3>&#128197; Key Dates</h3>
            <div class="detail-field-row">
                <div class="detail-field">
                    <label>Commencement Date</label>
                    <input type="date" value="${c.commencement}" onchange="trackChange('${CONFIG.COLUMNS.COMMENCEMENT}',JSON.stringify({date:this.value}))">
                </div>
                <div class="detail-field">
                    <label>Go-Live Deadline</label>
                    <input type="date" value="${c.deadline}" onchange="trackChange('${CONFIG.COLUMNS.DEADLINE}',JSON.stringify({date:this.value}))">
                </div>
            </div>
            <div class="detail-field-row">
                <div class="detail-field">
                    <label>Go-Live Date</label>
                    <input type="date" value="${c.goLive}" onchange="trackChange('${CONFIG.COLUMNS.GO_LIVE}',JSON.stringify({date:this.value}))">
                </div>
                <div class="detail-field">
                    <label>Pilot Kick Off</label>
                    <input type="date" value="${c.pilotKickoff}" onchange="trackChange('${CONFIG.COLUMNS.PILOT_KICKOFF}',JSON.stringify({date:this.value}))">
                </div>
            </div>
            <div class="detail-field-row">
                <div class="detail-field">
                    <label>Last Contact</label>
                    <input type="date" value="${c.lastContact}" onchange="trackChange('${CONFIG.COLUMNS.LAST_CONTACT}',JSON.stringify({date:this.value}))">
                </div>
                <div class="detail-field">
                    <label>Days Since Contact</label>
                    <div class="read-only" style="color:${daysAgoClass(c.lastContact) === 'danger' ? 'var(--rag-red)' : daysAgoClass(c.lastContact) === 'warning' ? 'var(--rag-amber)' : 'var(--text-secondary)'}">${daysAgo(c.lastContact)}</div>
                </div>
            </div>
            <div class="detail-field-row">
                <div class="detail-field">
                    <label>AIOS Total Days</label>
                    <div class="read-only">${c.aiosDays ? Math.round(parseFloat(c.aiosDays)) + ' days' : 'N/A'}</div>
                </div>
                <div class="detail-field">
                    <label>Pilot Days</label>
                    <div class="read-only">${c.pilotDays ? Math.round(parseFloat(c.pilotDays)) + ' days' : 'N/A'}</div>
                </div>
            </div>
        </div>

        <div class="detail-section">
            <h3>&#128236; Contacts</h3>
            <div class="detail-field">
                <label>Sponsor Email</label>
                <input type="email" value="${c.sponsorEmail || ''}" onchange="trackChange('${CONFIG.COLUMNS.SPONSOR_EMAIL}',JSON.stringify({email:this.value,text:this.value}))">
            </div>
            <div class="detail-field">
                <label>POC Email</label>
                <input type="email" value="${c.pocEmail || ''}" onchange="trackChange('${CONFIG.COLUMNS.POC_EMAIL}',JSON.stringify({email:this.value,text:this.value}))">
            </div>
            <div class="detail-field">
                <label>Other Contact Email</label>
                <input type="email" value="${c.otherEmail || ''}" onchange="trackChange('${CONFIG.COLUMNS.OTHER_EMAIL}',JSON.stringify({email:this.value,text:this.value}))">
            </div>
            <div class="detail-field">
                <label>IT Contact</label>
                <input type="text" value="${c.itContact || ''}" onchange="trackChange('${CONFIG.COLUMNS.IT_CONTACT}',this.value)">
            </div>
        </div>

        <div class="detail-section">
            <h3>&#128221; Summary</h3>
            <div class="detail-field">
                <label>Project Summary</label>
                <textarea rows="6" onchange="trackChange('${CONFIG.COLUMNS.SUMMARY}',this.value)">${c.summary || ''}</textarea>
            </div>
        </div>

        <div class="detail-section">
            <h3>&#128221; Notes (${NotesManager.get(c.id).length})</h3>
            ${NotesManager.renderInDetail(c.id)}
        </div>

        <div class="detail-section">
            <h3>&#129302; Deployed Agents (${c.agents.length})</h3>
            ${c.agents.length > 0 ? `<div class="agents-list">
                ${c.agents.map(a => {
                    let stageClass = 'badge-gray';
                    if (a.stage === 'Live') stageClass = 'badge-green';
                    else if (a.stage === 'Production') stageClass = 'badge-purple';
                    else if (a.stage === 'Stuck') stageClass = 'badge-red';
                    else if (a.stage === 'Onboarding') stageClass = 'badge-teal';
                    else if (a.stage === 'Ready') stageClass = 'badge-amber';
                    return `<div class="agent-item">
                        <span class="agent-name">${a.name}</span>
                        <span class="badge ${stageClass} agent-stage">${a.stage}</span>
                    </div>`;
                }).join('')}
            </div>` : '<div style="color:var(--text-muted);font-size:13px;font-style:italic">No agents configured</div>'}
        </div>

        <div class="detail-section">
            <h3>&#128236; Recent Emails</h3>
            ${getEmailDetailHTML(c.name)}
        </div>

        <div class="detail-section">
            <h3>&#128736; Additional Info</h3>
            <div class="detail-field-row">
                <div class="detail-field">
                    <label>Industry</label>
                    <div class="read-only">${c.industry || 'Not set'}</div>
                </div>
                <div class="detail-field">
                    <label>AIOS Offer Sent</label>
                    <div class="read-only">${c.offerSent || 'Unknown'}</div>
                </div>
            </div>
            <div class="detail-field">
                <label>Domain</label>
                <div class="read-only">${c.domain ? `<a href="${c.domain.startsWith('http') ? c.domain : 'https://' + c.domain}" target="_blank" style="color:var(--accent-purple-light)">${c.domain}</a>` : 'Not set'}</div>
            </div>
        </div>
    `;

    document.getElementById('detailBackdrop').classList.add('open');
    document.getElementById('detailPanel').classList.add('open');
    document.getElementById('btnSaveAll').disabled = true;
    document.getElementById('btnSaveAll').textContent = 'Save All Changes';
}

function closeDetail() {
    document.getElementById('detailBackdrop').classList.remove('open');
    document.getElementById('detailPanel').classList.remove('open');
    State.selectedId = null;
    State.pendingChanges = {};
}

function trackChange(columnId, value) {
    try {
        State.pendingChanges[columnId] = JSON.parse(value);
    } catch {
        State.pendingChanges[columnId] = value;
    }
    document.getElementById('btnSaveAll').disabled = false;
    document.getElementById('btnSaveAll').textContent = `Save Changes (${Object.keys(State.pendingChanges).length})`;
}

async function saveAllChanges() {
    if (!State.selectedId || Object.keys(State.pendingChanges).length === 0) return;
    const btn = document.getElementById('btnSaveAll');
    btn.disabled = true;
    btn.textContent = 'Saving...';

    try {
        await MondayAPI.updateMultipleColumns(State.selectedId, State.pendingChanges);
        const client = State.getSelected();
        showToast(`${client?.name || 'Client'}: All changes saved`, 'success');
        State.pendingChanges = {};
        btn.textContent = 'Save All Changes';
        // Refresh to get updated data
        await loadData(false);
        // Re-open detail panel if it was open
        if (State.selectedId) {
            openDetail(State.selectedId);
        }
    } catch (err) {
        showToast(`Save failed: ${err.message}`, 'error');
        btn.disabled = false;
        btn.textContent = `Retry Save (${Object.keys(State.pendingChanges).length})`;
    }
}

function openInMonday() {
    if (State.selectedId) {
        window.open(`https://implementai-company.monday.com/boards/${CONFIG.BOARD_ID}/pulses/${State.selectedId}`, '_blank');
    }
}

/* ================================================================
   FILTER & SORT HANDLERS
   ================================================================ */
function setRagFilter(value, el) {
    // Update pill active states
    document.querySelectorAll('.filter-pill[data-rag]').forEach(p => p.classList.remove('active'));
    if (el) el.classList.add('active');
    else {
        const pill = document.querySelector(`.filter-pill[data-rag="${value}"]`);
        if (pill) pill.classList.add('active');
    }

    State.filters.rag = value;
    State.applyFilters();
    renderClients(State.filtered);
    updateFilterCounts();
}

function setPlanFilter(value) {
    State.filters.plan = value;
    State.applyFilters();
    renderClients(State.filtered);
}

function setBillingFilter(value) {
    State.filters.billing = value;
    State.applyFilters();
    renderClients(State.filtered);
}

function setSearch(value) {
    State.filters.search = value;
    State.applyFilters();
    renderClients(State.filtered);
}

function setSort(value) {
    State.sort = value;
    State.applyFilters();
    renderClients(State.filtered);
}

function resetFilters() {
    State.filters = { rag: 'all', plan: 'all', billing: 'all', search: '' };
    State.sort = 'health-desc';
    // Update filter elements if they exist (they're now inside the clients page)
    const planFilter = document.getElementById('planFilter');
    const billingFilter = document.getElementById('billingFilter');
    const sortSelect = document.getElementById('sortSelect');
    const searchBox = document.getElementById('searchBox');
    if (planFilter) planFilter.value = 'all';
    if (billingFilter) billingFilter.value = 'all';
    if (sortSelect) sortSelect.value = 'health-desc';
    if (searchBox) searchBox.value = '';
    document.querySelectorAll('.filter-pill[data-rag]').forEach(p => p.classList.remove('active'));
    const allPill = document.querySelector('.filter-pill[data-rag="all"]');
    if (allPill) allPill.classList.add('active');
    State.applyFilters();
    renderClients(State.filtered);
}

/* ================================================================
   RENDER EMAIL ACTIVITY
   ================================================================ */
function getEmailDataForClient(clientName) {
    return EMAIL_DATA.clients[clientName] || null;
}

/**
 * Classifies an email sender as 'me', 'client', or 'third-party'.
 * Uses RUNTIME.userEmail (or CONFIG.USER_EMAIL fallback) to identify the dashboard user.
 */
function classifyEmailSender(email) {
    if (!email || !email.from) return 'unknown';
    const from = email.from.toLowerCase();
    if (from === (RUNTIME.userEmail || CONFIG.USER_EMAIL).toLowerCase()) return 'me';
    if (email.isFromClient) return 'client';
    return 'third-party';
}

/**
 * Returns the most recent email from the user (mishai@implementai.io).
 */
function getLastEmailFromMe(emailEntry) {
    if (!emailEntry || !emailEntry.emails) return null;
    return emailEntry.emails.find(e => classifyEmailSender(e) === 'me') || null;
}

/**
 * Returns the most recent email from the client (isFromClient === true).
 */
function getLastEmailFromClient(emailEntry) {
    if (!emailEntry || !emailEntry.emails) return null;
    return emailEntry.emails.find(e => e.isFromClient === true) || null;
}

/**
 * Returns hours since the last client email for a given EMAIL_DATA entry.
 * Only counts emails where isFromClient === true.
 * Returns null if no client email found.
 */
function getHoursSinceLastClientEmail(emailEntry) {
    const clientEmail = getLastEmailFromClient(emailEntry);
    if (!clientEmail || !clientEmail.date) return null;
    try {
        const emailDate = new Date(clientEmail.date);
        if (isNaN(emailDate.getTime())) return null;
        return (Date.now() - emailDate.getTime()) / (1000 * 60 * 60);
    } catch { return null; }
}

/**
 * Returns hours since the last email sent by me (mishai@implementai.io).
 */
function getHoursSinceMyLastEmail(emailEntry) {
    const myEmail = getLastEmailFromMe(emailEntry);
    if (!myEmail || !myEmail.date) return null;
    try {
        const emailDate = new Date(myEmail.date);
        if (isNaN(emailDate.getTime())) return null;
        return (Date.now() - emailDate.getTime()) / (1000 * 60 * 60);
    } catch { return null; }
}

/**
 * Computes the effective email status dynamically from email data.
 * Now properly distinguishes me vs client vs third-party.
 *
 * Logic:
 *  - If discontinued → 'discontinued'
 *  - Find the latest email from me and the latest from client
 *  - If client sent more recently than me → 'needs-response' (or 'within-grace' if < 48h)
 *  - If I sent more recently than client → 'awaiting'
 *  - If no emails from either → 'no-recent'
 *  - If only third-party emails → 'no-recent'
 *  - If only I sent, never client → 'awaiting'
 *  - If only client sent, never me → 'needs-response' (with grace check)
 *  - If last exchange is very old (>14d) → 'stale'
 */
function getEffectiveEmailStatus(clientName) {
    const ed = EMAIL_DATA.clients[clientName];
    if (!ed) return null;
    if (ed.discontinued) return 'discontinued';

    const lastFromMe = getLastEmailFromMe(ed);
    const lastFromClient = getLastEmailFromClient(ed);

    const myDate = lastFromMe ? new Date(lastFromMe.date) : null;
    const clientDate = lastFromClient ? new Date(lastFromClient.date) : null;

    // No meaningful emails from either party
    if (!myDate && !clientDate) return 'no-recent';

    // Only I have sent — waiting on client
    if (myDate && !clientDate) {
        const hoursSinceMe = getHoursSinceMyLastEmail(ed);
        if (hoursSinceMe !== null && hoursSinceMe > CONFIG.STALE_CRITICAL_DAYS * 24) return 'stale';
        return 'awaiting';
    }

    // Only client has sent — I need to respond
    if (!myDate && clientDate) {
        const hoursSinceClient = getHoursSinceLastClientEmail(ed);
        if (hoursSinceClient !== null && hoursSinceClient < CONFIG.RESPONSE_GRACE_HOURS) return 'within-grace';
        return 'needs-response';
    }

    // Both have sent — compare dates
    if (clientDate > myDate) {
        // Client sent more recently — I need to respond
        const hoursSinceClient = getHoursSinceLastClientEmail(ed);
        if (hoursSinceClient !== null && hoursSinceClient < CONFIG.RESPONSE_GRACE_HOURS) return 'within-grace';
        return 'needs-response';
    } else {
        // I sent more recently — awaiting client
        const hoursSinceMe = getHoursSinceMyLastEmail(ed);
        if (hoursSinceMe !== null && hoursSinceMe > CONFIG.STALE_CRITICAL_DAYS * 24) return 'stale';
        return 'awaiting';
    }
}

function emailStatusLabel(status) {
    switch(status) {
        case 'needs-response': return { text: 'Needs Response', class: 'needs-response' };
        case 'within-grace': return { text: 'Received — Within 48h', class: 'within-grace' };
        case 'awaiting': return { text: 'Awaiting Reply', class: 'awaiting' };
        case 'stale': return { text: 'Stale - Outreach Needed', class: 'stale-email' };
        case 'no-recent': return { text: 'No Recent Email', class: 'stale-email' };
        case 'discontinued': return { text: 'Discontinued', class: 'discontinued' };
        default: return { text: 'Up to Date', class: 'up-to-date' };
    }
}

function renderEmailActivity() {
    const grid = document.getElementById('emailCards');
    if (!grid) return;

    // Update sync status in header
    OutlookSync._updateSyncStatusUI();

    // Empty state: no email data and no Outlook token
    if (Object.keys(EMAIL_DATA.clients).length === 0 && !OutlookSync.hasToken()) {
        grid.innerHTML = `
            <div style="grid-column:1/-1;text-align:center;padding:48px 20px;">
                <div style="font-size:48px;margin-bottom:16px;">&#128236;</div>
                <h3 style="margin-bottom:8px;color:var(--text-primary);">Connect Outlook for Email Activity</h3>
                <p style="color:var(--text-muted);font-size:13px;max-width:420px;margin:0 auto 20px;line-height:1.6;">
                    Connect your Outlook account via Settings to see live email
                    activity for your ${RUNTIME.podName || ''} clients. An MS Graph token with
                    <strong>Mail.Read</strong> scope is required.
                </p>
                <button class="btn-primary" onclick="showSetup()" style="padding:10px 24px;">
                    &#9881; Open Settings
                </button>
            </div>`;
        return;
    }

    // Auto-unhide cards if new emails have arrived
    EmailHiddenCards.autoUnhideCheck();

    // Match email data to loaded clients, using effective status (48h grace period)
    const statusOrder = { 'needs-response': 0, 'stale': 1, 'no-recent': 2, 'within-grace': 3, 'awaiting': 4, 'discontinued': 5 };
    const clientEmails = [];

    // If clients are loaded, use them; otherwise use EMAIL_DATA keys
    const clientNames = State.dataLoaded && State.clients.length > 0
        ? State.clients.map(c => c.name)
        : Object.keys(EMAIL_DATA.clients);

    clientNames.forEach(name => {
        const ed = EMAIL_DATA.clients[name];
        if (ed) {
            const client = State.clients.find(c => c.name === name);
            const effectiveStatus = getEffectiveEmailStatus(name);
            clientEmails.push({ name, clientId: client?.id, ...ed, effectiveStatus });
        }
    });

    clientEmails.sort((a, b) => (statusOrder[a.effectiveStatus] ?? 99) - (statusOrder[b.effectiveStatus] ?? 99));

    // Separate visible and hidden cards
    const visibleEmails = clientEmails.filter(ce => !EmailHiddenCards.isHidden(ce.name));
    const hiddenEmails = clientEmails.filter(ce => EmailHiddenCards.isHidden(ce.name));
    const hiddenCount = hiddenEmails.length;

    function buildEmailCardHTML(ce, isHiddenCard) {
        const st = emailStatusLabel(ce.effectiveStatus);
        const latestEmail = ce.emails[0];
        const emailDate = latestEmail ? new Date(latestEmail.date) : null;
        const dateStr = emailDate ? emailDate.toLocaleDateString() + ' ' + emailDate.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : 'N/A';
        const cardClass = ce.effectiveStatus === 'needs-response' ? 'needs-response' :
                          ce.effectiveStatus === 'within-grace' ? 'within-grace' :
                          ce.effectiveStatus === 'stale' || ce.effectiveStatus === 'no-recent' ? 'stale-email' :
                          ce.effectiveStatus === 'awaiting' ? 'awaiting' :
                          ce.effectiveStatus === 'discontinued' ? 'discontinued' : '';

        let graceNote = '';
        if (ce.effectiveStatus === 'within-grace') {
            const hoursSince = getHoursSinceLastClientEmail(ce);
            if (hoursSince !== null) {
                const hoursLeft = Math.max(0, Math.ceil(CONFIG.RESPONSE_GRACE_HOURS - hoursSince));
                graceNote = `<div style="font-size:10px;color:#579bfc;margin-top:4px;">&#9201; ${hoursLeft}h remaining before response needed</div>`;
            }
        }

        const fullFrom = latestEmail?.from || '';
        const totalEmails = ce.emails.length;
        const senderType = latestEmail ? classifyEmailSender(latestEmail) : 'unknown';
        const directionLabel = senderType === 'me' ? 'Sent by you' : senderType === 'client' ? 'Received from' : 'Via';
        const directionIcon = senderType === 'me' ? '&#128228; You sent' : senderType === 'client' ? '&#128229; Inbound' : '&#128260; Third-party';

        const myLastEmail = getLastEmailFromMe(ce);
        const myLastDate = myLastEmail ? new Date(myLastEmail.date) : null;
        const lastSentNote = myLastDate ? `<div style="font-size:10px;color:var(--text-muted);margin-top:2px;">&#128228; You last sent: ${myLastDate.toLocaleDateString('en-GB',{day:'numeric',month:'short'})} ${myLastDate.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>` : '<div style="font-size:10px;color:var(--rag-amber);margin-top:2px;">&#9888; No outbound email tracked yet</div>';

        const safeName = ce.name.replace(/'/g, "\\'");
        const hiddenClass = isHiddenCard ? ' email-card-hidden' : '';

        const actionBtn = isHiddenCard
            ? `<button class="email-restore-btn" onclick="event.stopPropagation();EmailHiddenCards.unhide('${safeName}');renderEmailActivity();">&#128065; Restore</button>`
            : `<button class="email-hide-btn" onclick="event.stopPropagation();EmailHiddenCards.hide('${safeName}');renderEmailActivity();" title="Hide this card">&#10005;</button>`;

        return `
        <div class="email-card ${cardClass}${hiddenClass}" ${ce.clientId ? `onclick="openDetail('${ce.clientId}')"` : ''}>
            ${actionBtn}
            <div class="email-card-header">
                <span class="email-client-name">${ce.name}</span>
                <span class="email-status-tag ${st.class}">${st.text}</span>
            </div>
            <div class="email-subject">${latestEmail?.subject || 'No emails found'}</div>
            <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px;">
                ${directionLabel}: <span style="color:var(--text-secondary)">${fullFrom}</span>
            </div>
            <div class="email-meta-row">
                <span class="email-from">${directionIcon}</span>
                <span>&#128197; ${dateStr}</span>
                <span style="opacity:0.7">${totalEmails} email${totalEmails !== 1 ? 's' : ''} tracked</span>
                ${!isHiddenCard && latestEmail?.webLink ? `<a class="email-open-link" href="${latestEmail.webLink}" target="_blank" onclick="event.stopPropagation()">Open in Outlook &#8599;</a>` : ''}
            </div>
            ${graceNote}
            ${lastSentNote}
            ${EditManager.emailNoteHTML(ce.name)}
        </div>`;
    }

    // Build visible cards
    let html = visibleEmails.map(ce => buildEmailCardHTML(ce, false)).join('');

    // Add "Show N hidden" toggle if there are hidden cards
    if (hiddenCount > 0) {
        const showingHidden = EmailHiddenCards._showHidden;
        html += `<button class="email-hidden-toggle" onclick="EmailHiddenCards.toggleShowHidden()">
            ${showingHidden ? '&#9650; Hide dismissed cards' : `&#128065; Show ${hiddenCount} dismissed card${hiddenCount !== 1 ? 's' : ''}`}
        </button>`;
        if (showingHidden) {
            html += hiddenEmails.map(ce => buildEmailCardHTML(ce, true)).join('');
        }
    }

    grid.innerHTML = html;
}

function getEmailDetailHTML(clientName) {
    const ed = EMAIL_DATA.clients[clientName];
    if (!ed || !ed.emails.length) {
        return '<div style="color:var(--text-muted);font-size:12px;font-style:italic">No email data available for this client</div>';
    }

    const effectiveStatus = getEffectiveEmailStatus(clientName);
    const st = emailStatusLabel(effectiveStatus);
    return `
        <div style="margin-bottom:8px;">
            <span class="email-status-tag ${st.class}" style="font-size:11px;">${st.text}</span>
            ${ed.lastClientEmail ? `<span style="font-size:11px;color:var(--text-muted);margin-left:8px;">Last from: ${ed.lastClientEmail}</span>` : ''}
        </div>
        <div class="detail-emails-list">
            ${ed.emails.map(e => {
                const d = new Date(e.date);
                const sender = classifyEmailSender(e);
                const icon = sender === 'me' ? '&#128228;' : sender === 'client' ? '&#128229;' : '&#128260;';
                const senderLabel = sender === 'me' ? '<span style="color:var(--accent-purple-light);font-size:10px;margin-left:4px;">YOU</span>' : sender === 'third-party' ? '<span style="color:var(--text-muted);font-size:10px;margin-left:4px;">3RD PARTY</span>' : '';
                return `<div class="detail-email-item" ${e.webLink ? `onclick="window.open('${e.webLink}','_blank')"` : ''}>
                    <div class="detail-email-subject">${icon} ${e.subject} ${senderLabel}</div>
                    <div class="detail-email-meta">
                        <span>${e.from}</span>
                        <span>${d.toLocaleDateString()} ${d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>
                    </div>
                </div>`;
            }).join('')}
        </div>
    `;
}

/* ================================================================
   ACTIVITY LOG — aggregates recent updates from all data sources
   ================================================================ */
/**
 * Renders the comprehensive Activity Feed — a complete change log of ALL data.
 * Uses ActivityFeed (persisted in localStorage) for full history.
 * @param {number} maxItems — max items to show initially (default 30)
 */
function renderActivityLog(maxItems = 30) {
    // Ensure feed is seeded with latest data
    ActivityFeed.load();
    ActivityFeed.seed();

    const allEvents = ActivityFeed.getAll();
    const events = allEvents.slice(0, maxItems);
    const hasMore = allEvents.length > maxItems;

    if (events.length === 0) return '<div class="activity-log-empty">No activity to display yet — data will appear here as it comes in</div>';

    // Filter controls
    const filters = [
        { key: 'all', label: 'All', count: ActivityFeed.getAll('all').length },
        { key: 'email', label: '📧 Email', count: ActivityFeed.getAll('email').length },
        { key: 'calendar', label: '📅 Calendar', count: ActivityFeed.getAll('calendar').length },
        { key: 'data', label: '📊 Data', count: ActivityFeed.getAll('data').length },
        { key: 'system', label: '⚙️ System', count: ActivityFeed.getAll('system').length },
    ];

    const filterHTML = `<div class="activity-log-controls">
        ${filters.map(f => `<button class="activity-log-filter-btn ${ActivityFeed._filter === f.key ? 'active' : ''}" onclick="ActivityFeed.setFilter('${f.key}')">${f.label} (${f.count})</button>`).join('')}
        <span class="activity-log-count">${allEvents.length} total events</span>
    </div>`;

    const eventsHTML = events.map(ev => {
        const evDate = new Date(ev.date);
        const timeLabel = formatAlertTimestamp(evDate);
        const timeHTML = timeLabel ? `<div class="activity-log-time" title="${timeLabel.absolute}">${timeLabel.label}</div>` : '';
        const sourceLabel = ev.source === 'outlook' ? 'Outlook' : ev.source === 'monday' ? 'monday.com' : ev.source === 'user-action' ? 'Manual' : 'System';
        return `
        <div class="activity-log-item">
            <div class="activity-log-dot ${ev.dotClass || ev.type}"></div>
            <div class="activity-log-body">
                <div class="activity-log-title">${ev.title}</div>
                <div class="activity-log-desc">${ev.desc}</div>
                <div class="activity-log-source">via ${sourceLabel}</div>
            </div>
            ${timeHTML}
        </div>`;
    }).join('');

    const showMoreHTML = hasMore
        ? `<div class="activity-log-show-more" onclick="document.getElementById('activityLogList').innerHTML=renderActivityLogExpanded()">Show all ${allEvents.length} events ▾</div>`
        : '';

    return filterHTML + `<div class="activity-log-list" id="activityLogList">${eventsHTML}${showMoreHTML}</div>`;
}

/** Renders ALL activity events (no limit) — used by "Show more" */
function renderActivityLogExpanded() {
    const events = ActivityFeed.getAll();
    return events.map(ev => {
        const evDate = new Date(ev.date);
        const timeLabel = formatAlertTimestamp(evDate);
        const timeHTML = timeLabel ? `<div class="activity-log-time" title="${timeLabel.absolute}">${timeLabel.label}</div>` : '';
        const sourceLabel = ev.source === 'outlook' ? 'Outlook' : ev.source === 'monday' ? 'monday.com' : ev.source === 'user-action' ? 'Manual' : 'System';
        return `
        <div class="activity-log-item">
            <div class="activity-log-dot ${ev.dotClass || ev.type}"></div>
            <div class="activity-log-body">
                <div class="activity-log-title">${ev.title}</div>
                <div class="activity-log-desc">${ev.desc}</div>
                <div class="activity-log-source">via ${sourceLabel}</div>
            </div>
            ${timeHTML}
        </div>`;
    }).join('');
}

/* ================================================================
   OVERVIEW PAGE
   ================================================================ */
function renderOverviewPage() {
    renderKPIs(State.clients);
    const container = document.getElementById('overviewContent');
    if (!container || !State.dataLoaded) return;

    const clients = State.clients;

    // Quick client grid
    const clientCards = clients.map(c => {
        const ragColor = c.rag === 'Green' ? 'var(--rag-green)' : c.rag === 'Amber' ? 'var(--rag-amber)' : 'var(--rag-red)';
        const health = State.calcHealth(c);
        const hColor = healthColor(health);
        const changed = ChangeTracker.hasChanges(c.id);
        return `
        <div class="overview-client-card ${changed ? 'has-changes' : ''}" onclick="Router.navigate('client/${c.id}')" style="position:relative;">
            ${ChangeTracker.badgeHTML(c.id)}
            <div class="overview-client-name">
                <span style="width:10px;height:10px;border-radius:50%;background:${ragColor};flex-shrink:0;"></span>
                ${c.name}
                <span style="margin-left:auto;font-size:12px;font-weight:700;color:${hColor}">${health}</span>
            </div>
            <div class="overview-client-meta">
                <span class="tag" style="background:var(--bg-elevated);color:var(--text-secondary);border:1px solid var(--border-default);">${c.plan}</span>
                <span class="tag" style="background:${c.billing === 'Yes' ? 'rgba(0,200,117,0.1)' : 'rgba(223,47,74,0.1)'};color:${c.billing === 'Yes' ? 'var(--billing-yes)' : 'var(--billing-no)'};">&#128179; ${c.billing}</span>
                <span class="tag" style="background:var(--bg-elevated);color:var(--text-secondary);border:1px solid var(--border-default);">&#129302; ${c.agentCount}</span>
            </div>
        </div>`;
    }).join('');

    // RAG distribution for mini chart
    const greenCount = clients.filter(c => c.rag === 'Green').length;
    const amberCount = clients.filter(c => c.rag === 'Amber').length;
    const redCount = clients.filter(c => c.rag === 'Red').length;

    const changeCount = ChangeTracker.totalCount();
    const changeBanner = changeCount > 0 ? `<button onclick="ChangeTracker.dismissAll()" style="font-size:11px;padding:5px 12px;border-radius:var(--radius-md);background:rgba(107,48,255,0.12);color:var(--accent-purple-light);border:1px solid rgba(107,48,255,0.25);cursor:pointer;font-weight:600;transition:all var(--transition-fast);" onmouseover="this.style.background='rgba(107,48,255,0.22)'" onmouseout="this.style.background='rgba(107,48,255,0.12)'">&#10003; Clear ${changeCount} Change${changeCount !== 1 ? 's' : ''}</button>` : '';

    container.innerHTML = `
        <div class="overview-clients-header">
            <h3>&#128101; Quick Client View ${changeCount > 0 ? `<span style="font-size:12px;font-weight:600;color:var(--accent-purple-light);margin-left:8px;">&#9889; ${changeCount} updated</span>` : ''}</h3>
            <div style="display:flex;gap:8px;align-items:center;">
                ${changeBanner}
                <button class="btn-compare" onclick="Router.navigate('clients')" style="font-size:12px;padding:6px 12px;">View All &#8594;</button>
            </div>
        </div>
        <div class="overview-quick-grid">${clientCards}</div>
        <div class="overview-rag-chart-wrap">
            <h3>&#128200; RAG Distribution</h3>
            <div class="overview-chart-container">
                <canvas id="overviewRagChart"></canvas>
            </div>
        </div>

        <div class="activity-log-section">
            <h3>📰 Activity Feed — Complete Change Log</h3>
            ${renderActivityLog(30)}
        </div>
    `;

    // Render mini RAG doughnut
    setTimeout(() => {
        const ctx = document.getElementById('overviewRagChart');
        if (!ctx) return;
        const cs = getComputedStyle(document.documentElement);
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Green', 'Amber', 'Red'],
                datasets: [{
                    data: [greenCount, amberCount, redCount],
                    backgroundColor: [cs.getPropertyValue('--rag-green').trim(), cs.getPropertyValue('--rag-amber').trim(), cs.getPropertyValue('--rag-red').trim()],
                    borderWidth: 0,
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom', labels: { color: cs.getPropertyValue('--text-secondary').trim(), font: { size: 12 } } }
                },
                cutout: '60%',
            }
        });
    }, 60);
}

/* ================================================================
   CLIENT FULL PAGE (INDIVIDUAL CLIENT DETAIL)
   ================================================================ */
function renderClientFullPage(clientId) {
    State.selectedId = clientId;
    State.pendingChanges = {};
    const c = State.clients.find(cl => cl.id === clientId);
    if (!c) {
        document.getElementById('clientDetailContent').innerHTML = `
            <button class="client-detail-back" onclick="Router.navigate('clients')">&#8592; Back to Portfolio</button>
            <div class="empty-state" style="text-align:center;padding:40px;">
                <h3>Client not found</h3>
            </div>`;
        return;
    }

    const health = State.calcHealth(c);
    const hColor = healthColor(health);
    const ragColor = c.rag === 'Green' ? 'var(--rag-green)' : c.rag === 'Amber' ? 'var(--rag-amber)' : 'var(--rag-red)';
    const ragBg = c.rag === 'Green' ? 'var(--rag-green-bg)' : c.rag === 'Amber' ? 'var(--rag-amber-bg)' : 'var(--rag-red-bg)';

    // Agent stage distribution
    const stageCounts = {};
    c.agents.forEach(a => { stageCounts[a.stage] = (stageCounts[a.stage] || 0) + 1; });

    // Email data for this client
    const emailData = EMAIL_DATA.clients[c.name];
    let emailHTML = '<p style="color:var(--text-muted);font-style:italic;">No email data available for this client.</p>';
    if (emailData) {
        emailHTML = getEmailDetailHTML(c.name);
    }

    const container = document.getElementById('clientDetailContent');
    const hasLocalEdits = LocalEditManager.hasEdits(c.id);
    const localEditBar = hasLocalEdits ? `<div class="local-edit-indicator">
        <span>&#9998; This client has local edits not yet synced to monday.com</span>
        <button class="sync-btn" onclick="LocalEditManager.syncToMonday('${c.id}').then(()=>{renderClientFullPage('${c.id}')})">&#8635; Sync to monday.com</button>
        <button onclick="LocalEditManager.clearEdits('${c.id}');renderClientFullPage('${c.id}')">Discard</button>
    </div>` : '';

    // Editable field helper
    const ef = (field, val, type, configKey) => {
        const display = val || '--';
        const chg = ChangeTracker.inlineBadge(c.id, ChangeTracker._fields.find(f => f.key === field)?.label || '');
        return `<span class="editable-field" onclick="event.stopPropagation();inlineFieldEdit('${c.id}','${field}','${(val||'').toString().replace(/'/g,"\\'")}','${type}','${configKey||''}',event)">${display}${chg}<span class="ef-pencil">&#9998;</span></span>`;
    };

    container.innerHTML = `
        <button class="client-detail-back" onclick="Router.navigate('clients')">&#8592; Back to Portfolio</button>

        ${localEditBar}
        ${ChangeTracker.recentChangesCard(c.id)}

        <div class="client-detail-header">
            <span class="detail-name">${c.name}</span>
            <div class="detail-badges">
                <span class="detail-badge" style="background:${ragBg};color:${ragColor};border:1px solid ${ragColor};cursor:pointer;" onclick="inlineFieldEdit('${c.id}','rag','${c.rag}','dropdown','RAG_OPTIONS',event)">&#9679; ${c.rag} ${ChangeTracker.inlineBadge(c.id, 'RAG Status')}</span>
                <span class="detail-badge" style="background:rgba(107,48,255,0.1);color:var(--accent-purple);border:1px solid rgba(107,48,255,0.3);cursor:pointer;" onclick="inlineFieldEdit('${c.id}','plan','${c.plan}','dropdown','PLAN_OPTIONS',event)">${c.plan}</span>
                <span class="detail-badge" style="background:${c.billing === 'Yes' ? 'rgba(0,200,117,0.1)' : 'rgba(223,47,74,0.1)'};color:${c.billing === 'Yes' ? 'var(--billing-yes)' : 'var(--billing-no)'};border:1px solid ${c.billing === 'Yes' ? 'rgba(0,200,117,0.3)' : 'rgba(223,47,74,0.3)'};cursor:pointer;" onclick="inlineFieldEdit('${c.id}','billing','${c.billing}','dropdown','BILLING_OPTIONS',event)">&#128179; Billing: ${c.billing} ${ChangeTracker.inlineBadge(c.id, 'Billing')}</span>
                <span class="detail-badge" style="background:${c.updateStatus === 'Yes' ? 'rgba(0,200,117,0.1)' : 'rgba(253,171,61,0.1)'};color:${c.updateStatus === 'Yes' ? 'var(--rag-green)' : 'var(--rag-amber)'};border:1px solid ${c.updateStatus === 'Yes' ? 'rgba(0,200,117,0.3)' : 'rgba(253,171,61,0.3)'};cursor:pointer;" onclick="inlineFieldEdit('${c.id}','updateStatus','${c.updateStatus}','dropdown','UPDATE_OPTIONS',event)">Update: ${c.updateStatus} ${ChangeTracker.inlineBadge(c.id, 'Update Status')}</span>
            </div>
        </div>

        <div class="client-detail-summary">
            <h3>&#128221; Summary <span class="edit-icon" onclick="EditManager.editSummary('${c.id}', this.closest('.client-detail-summary').querySelector('.summary-text'))" title="Edit summary">&#9998;</span></h3>
            <div class="summary-text" data-editable onclick="event.stopPropagation();EditManager.editSummary('${c.id}', this)">${c.summary || '<span style="color:var(--text-muted);font-style:italic">No summary — click to add</span>'}</div>
        </div>

        <div class="client-detail-metrics">
            <div class="detail-metric-card">
                <div class="metric-label">Health Score ${ChangeTracker.inlineBadge(c.id, 'Health Score')}</div>
                <div class="metric-value" style="color:${hColor}">${health}</div>
                <div class="metric-sub">out of 100</div>
            </div>
            <div class="detail-metric-card">
                <div class="metric-label">AIOS Days</div>
                <div class="metric-value">${c.aiosDays ? Math.round(parseFloat(c.aiosDays)) : '--'}</div>
                <div class="metric-sub">${c.pilotDays ? 'Pilot: ' + Math.round(parseFloat(c.pilotDays)) + 'd' : ''}</div>
            </div>
            <div class="detail-metric-card" style="cursor:pointer;" onclick="inlineFieldEdit('${c.id}','agentCount','${c.agentCount}','number','',event)">
                <div class="metric-label">Agents ${ChangeTracker.inlineBadge(c.id, 'Agent Count')} <span class="ef-pencil" style="font-size:10px;opacity:0.5;">&#9998;</span></div>
                <div class="metric-value">${c.agentCount}</div>
                <div class="metric-sub">${c.agentStage || 'N/A'}</div>
            </div>
            <div class="detail-metric-card" style="cursor:pointer;" onclick="inlineFieldEdit('${c.id}','lastContact','${c.lastContact||''}','date','',event)">
                <div class="metric-label">Last Contact ${ChangeTracker.inlineBadge(c.id, 'Last Contact')} <span class="ef-pencil" style="font-size:10px;opacity:0.5;">&#9998;</span></div>
                <div class="metric-value" style="font-size:16px;color:${daysAgoClass(c.lastContact) === 'danger' ? 'var(--rag-red)' : daysAgoClass(c.lastContact) === 'warning' ? 'var(--rag-amber)' : 'inherit'}">${daysAgo(c.lastContact)}</div>
                <div class="metric-sub">${c.lastContact || 'click to set'}</div>
            </div>
            <div class="detail-metric-card" style="cursor:pointer;" onclick="inlineFieldEdit('${c.id}','industry','${(c.industry||'').replace(/'/g,"\\'")}','text','',event)">
                <div class="metric-label">Industry <span class="ef-pencil" style="font-size:10px;opacity:0.5;">&#9998;</span></div>
                <div class="metric-value" style="font-size:14px;">${c.industry || '--'}</div>
            </div>
            <div class="detail-metric-card" style="cursor:pointer;" onclick="inlineFieldEdit('${c.id}','commencement','${c.commencement||''}','date','',event)">
                <div class="metric-label">Commencement <span class="ef-pencil" style="font-size:10px;opacity:0.5;">&#9998;</span></div>
                <div class="metric-value" style="font-size:14px;">${c.commencement || '--'}</div>
            </div>
            <div class="detail-metric-card" style="cursor:pointer;" onclick="inlineFieldEdit('${c.id}','goLive','${c.goLive||''}','date','',event)">
                <div class="metric-label">Go-Live <span class="ef-pencil" style="font-size:10px;opacity:0.5;">&#9998;</span></div>
                <div class="metric-value" style="font-size:14px;">${c.goLive || '--'}</div>
            </div>
            <div class="detail-metric-card" style="cursor:pointer;" onclick="inlineFieldEdit('${c.id}','deadline','${c.deadline||''}','date','',event)">
                <div class="metric-label">Deadline <span class="ef-pencil" style="font-size:10px;opacity:0.5;">&#9998;</span></div>
                <div class="metric-value" style="font-size:14px;">${c.deadline || '--'}</div>
            </div>
        </div>

        <div class="client-detail-charts">
            <div class="detail-chart-card">
                <h4>&#129302; Agent Stage Distribution</h4>
                <div class="chart-container"><canvas id="detailAgentChart"></canvas></div>
            </div>
            <div class="detail-chart-card">
                <h4>&#128200; Health Gauge</h4>
                <div class="chart-container"><canvas id="detailHealthChart"></canvas></div>
            </div>
            <div class="detail-chart-card">
                <h4>&#128197; Timeline</h4>
                <div class="chart-container" style="display:flex;flex-direction:column;gap:10px;justify-content:center;padding:10px 0;" id="detailTimeline"></div>
            </div>
        </div>

        <div class="client-detail-notes">
            <h3>&#128221; Notes (${NotesManager.get(c.id).length})</h3>
            ${NotesManager.renderInDetail(c.id)}
        </div>

        <div class="client-detail-emails">
            <h3>&#128236; Email Activity</h3>
            ${emailHTML}
        </div>

        <div style="background:var(--card-bg);border:1px solid var(--border-default);border-radius:var(--radius-lg);padding:20px;margin-bottom:24px;">
            <h3 style="font-size:14px;font-weight:600;color:var(--text-primary);margin-bottom:12px;">&#128736; Contacts &amp; Links <span style="font-size:11px;color:var(--text-muted);font-weight:400;">(click to edit)</span></h3>
            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;">
                <div>
                    <span style="font-size:11px;color:var(--text-muted);display:block;">Sponsor Email</span>
                    ${ef('sponsorEmail', c.sponsorEmail, 'email')}
                </div>
                <div>
                    <span style="font-size:11px;color:var(--text-muted);display:block;">POC Email</span>
                    ${ef('pocEmail', c.pocEmail, 'email')}
                </div>
                <div>
                    <span style="font-size:11px;color:var(--text-muted);display:block;">Other Contact</span>
                    ${ef('otherEmail', c.otherEmail, 'email')}
                </div>
                <div>
                    <span style="font-size:11px;color:var(--text-muted);display:block;">IT Contact</span>
                    ${ef('itContact', c.itContact, 'text')}
                </div>
                <div>
                    <span style="font-size:11px;color:var(--text-muted);display:block;">Domain</span>
                    ${ef('domain', c.domain, 'text')}
                </div>
                <div><span style="font-size:11px;color:var(--text-muted);display:block;">monday.com</span><a href="https://implementai-company.monday.com/boards/${CONFIG.BOARD_ID}/pulses/${c.id}" target="_blank" style="color:var(--accent-purple-light);font-size:13px;">Open in monday.com &#8599;</a></div>
            </div>
        </div>
    `;

    // Render mini charts after DOM is ready
    setTimeout(() => {
        const cs = getComputedStyle(document.documentElement);

        // 1. Agent stage doughnut
        const agentCtx = document.getElementById('detailAgentChart');
        if (agentCtx && Object.keys(stageCounts).length > 0) {
            const stageColors = { Live: '#00c875', Production: '#9d50dd', Onboarding: '#579bfc', Ready: '#fdab3d', Stuck: '#df2f4a', Building: '#007eb5' };
            const labels = Object.keys(stageCounts);
            const data = Object.values(stageCounts);
            const colors = labels.map(l => stageColors[l] || '#666');
            Router._chartInstances.agentChart = new Chart(agentCtx, {
                type: 'doughnut',
                data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: cs.getPropertyValue('--text-secondary').trim(), font: { size: 11 } } } }, cutout: '55%' }
            });
        } else if (agentCtx) {
            agentCtx.parentElement.innerHTML = '<p style="color:var(--text-muted);font-size:13px;text-align:center;padding:40px 0;">No agents deployed</p>';
        }

        // 2. Health gauge (doughnut with fixed segments)
        const healthCtx = document.getElementById('detailHealthChart');
        if (healthCtx) {
            Router._chartInstances.healthChart = new Chart(healthCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Health', 'Remaining'],
                    datasets: [{ data: [health, 100 - health], backgroundColor: [hColor, cs.getPropertyValue('--bg-elevated').trim() || '#333'], borderWidth: 0 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, rotation: -90, circumference: 180,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false },
                    },
                    cutout: '70%',
                }
            });
        }

        // 3. Timeline (milestone markers)
        const timelineEl = document.getElementById('detailTimeline');
        if (timelineEl) {
            const milestones = [
                { label: 'Commencement', date: c.commencement, color: 'var(--accent-purple)' },
                { label: 'Pilot Kickoff', date: c.pilotKickoff, color: 'var(--plan-activate)' },
                { label: 'Go-Live Deadline', date: c.deadline, color: 'var(--rag-amber)' },
                { label: 'Go-Live', date: c.goLive, color: 'var(--rag-green)' },
                { label: 'Last Contact', date: c.lastContact, color: 'var(--accent-purple-light)' },
            ].filter(m => m.date);
            milestones.sort((a, b) => new Date(a.date) - new Date(b.date));
            timelineEl.innerHTML = milestones.length > 0 ? milestones.map(m => `
                <div style="display:flex;align-items:center;gap:10px;">
                    <span style="width:10px;height:10px;border-radius:50%;background:${m.color};flex-shrink:0;"></span>
                    <span style="font-size:12px;color:var(--text-muted);min-width:60px;">${m.date}</span>
                    <span style="font-size:13px;color:var(--text-primary);font-weight:500;">${m.label}</span>
                </div>
            `).join('') : '<p style="color:var(--text-muted);font-size:13px;text-align:center;">No dates available</p>';
        }
    }, 80);
}

/* ================================================================
   COMPARISON TABLE
   ================================================================ */
// Comparison table sort state
const CompareSort = {
    column: 'name',
    direction: 'asc',

    columns: [
        { key: 'name', label: 'Client', type: 'text' },
        { key: 'rag', label: 'RAG', type: 'rag' },
        { key: 'health', label: 'Health', type: 'number' },
        { key: 'billing', label: 'Billing', type: 'text' },
        { key: 'updateStatus', label: 'Update', type: 'text' },
        { key: 'plan', label: 'Plan', type: 'text' },
        { key: 'agentStage', label: 'Stage', type: 'text' },
        { key: 'agentCount', label: 'Agents', type: 'number' },
        { key: 'aiosDays', label: 'AIOS Days', type: 'number' },
        { key: 'platform', label: 'Platform', type: 'text' },
        { key: 'lastContact', label: 'Last Contact', type: 'date' },
        { key: 'commencement', label: 'Commencement', type: 'date' },
    ],

    toggle(colKey) {
        if (this.column === colKey) {
            this.direction = this.direction === 'asc' ? 'desc' : 'asc';
        } else {
            this.column = colKey;
            this.direction = 'asc';
        }
        renderComparisonTable();
    },

    sort(clients) {
        const col = this.columns.find(c => c.key === this.column);
        if (!col) return clients;
        const dir = this.direction === 'asc' ? 1 : -1;

        return [...clients].sort((a, b) => {
            let valA, valB;

            if (col.key === 'health') {
                valA = State.calcHealth(a);
                valB = State.calcHealth(b);
                return (valA - valB) * dir;
            }

            if (col.type === 'number') {
                valA = parseFloat(a[col.key]) || 0;
                valB = parseFloat(b[col.key]) || 0;
                return (valA - valB) * dir;
            }

            if (col.type === 'date') {
                valA = a[col.key] ? new Date(a[col.key]).getTime() : 0;
                valB = b[col.key] ? new Date(b[col.key]).getTime() : 0;
                return (valA - valB) * dir;
            }

            if (col.type === 'rag') {
                const ragOrder = { 'Green': 3, 'Amber': 2, 'Red': 1 };
                valA = ragOrder[a.rag] || 0;
                valB = ragOrder[b.rag] || 0;
                return (valA - valB) * dir;
            }

            // text
            valA = (a[col.key] || '').toString().toLowerCase();
            valB = (b[col.key] || '').toString().toLowerCase();
            return valA.localeCompare(valB) * dir;
        });
    }
};

function renderComparisonTable() {
    const container = document.getElementById('compareContent');
    if (!container) return;

    const clients = State.filtered && State.filtered.length > 0 ? State.filtered : State.clients;

    if (!State.dataLoaded || clients.length === 0) {
        container.innerHTML = `
            <button class="client-detail-back" onclick="Router.navigate('clients')">&#8592; Back to Portfolio</button>
            <div class="empty-state" style="text-align:center;padding:40px;">
                <h3>No client data available</h3>
            </div>`;
        return;
    }

    const sorted = CompareSort.sort(clients);

    const headerCells = CompareSort.columns.map(col => {
        const isActive = CompareSort.column === col.key;
        const arrow = isActive ? (CompareSort.direction === 'asc' ? '▲' : '▼') : '⇅';
        return `<th class="${isActive ? 'sort-active' : ''}" onclick="CompareSort.toggle('${col.key}')">${col.label} <span class="sort-indicator">${arrow}</span></th>`;
    }).join('');

    const rows = sorted.map(c => {
        const ragColor = c.rag === 'Green' ? 'var(--rag-green)' : c.rag === 'Amber' ? 'var(--rag-amber)' : 'var(--rag-red)';
        const health = State.calcHealth(c);
        const hColor = healthColor(health);
        const changed = ChangeTracker.hasChanges(c.id);
        const changeBadge = changed ? `<span class="change-badge change-badge-inline" onclick="event.stopPropagation();ChangeTracker.showPopover('${c.id}', event)" title="Changes detected">!</span>` : '';
        return `<tr class="${changed ? 'compare-row-changed' : ''}">
            <td><a class="client-name-link" onclick="Router.navigate('client/${c.id}')">${c.name} ${changeBadge}</a></td>
            <td><div class="rag-cell"><span class="rag-dot" style="background:${ragColor}"></span>${c.rag}</div></td>
            <td style="color:${hColor};font-weight:600;">${health}</td>
            <td>${c.billing}</td>
            <td>${c.updateStatus}</td>
            <td>${c.plan}</td>
            <td>${c.agentStage || '--'}</td>
            <td>${c.agentCount}</td>
            <td>${c.aiosDays ? Math.round(parseFloat(c.aiosDays)) : '--'}</td>
            <td>${c.platform || '--'}</td>
            <td>${daysAgo(c.lastContact)}</td>
            <td>${c.commencement || '--'}</td>
        </tr>`;
    }).join('');

    const changeCount = ChangeTracker.totalCount();
    const changeInfo = changeCount > 0 ? `<span style="font-size:12px;color:var(--accent-purple);font-weight:600;margin-left:10px;">&#9889; ${changeCount} updated</span>` : '';

    container.innerHTML = `
        <div class="compare-page-header">
            <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                <button class="client-detail-back" onclick="Router.navigate('clients')" style="margin-bottom:0;">&#8592; Back</button>
                <h2>&#128203; Client Comparison (${sorted.length})${changeInfo}</h2>
            </div>
            <p style="font-size:12px;color:var(--text-muted);margin-top:4px;">Click any column header to sort ▲▼ &nbsp;|&nbsp; <span style="color:var(--accent-purple);">!</span> = changes detected since last refresh</p>
        </div>
        <div class="compare-table-wrap">
            <table class="compare-table">
                <thead>
                    <tr>${headerCells}</tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
        </div>
    `;
}

/* ================================================================
   EMAIL OVERRIDE MENU HELPERS
   ================================================================ */
function toggleEmailOverrideMenu(clientName) {
    const menuId = 'emailOverride_' + clientName.replace(/[^a-zA-Z0-9]/g, '_');
    const menu = document.getElementById(menuId);
    if (!menu) return;
    const isOpen = menu.classList.contains('open');
    closeAllOverrideMenus();
    if (!isOpen) menu.classList.add('open');
}

function closeAllOverrideMenus() {
    document.querySelectorAll('.email-action-override-menu.open').forEach(m => m.classList.remove('open'));
}

// Close override menus on any click outside
document.addEventListener('click', (e) => {
    if (!e.target.closest('.email-action-override')) {
        closeAllOverrideMenus();
    }
});

/* ================================================================
   RENDER PLANNER & TO-DO PAGE
   ================================================================ */
function renderPlannerPage() {
    const container = document.getElementById('plannerContent');
    if (!container) return;

    DashTodo.load();

    const today = new Date();
    const todayStr = today.getFullYear() + '-' + String(today.getMonth()+1).padStart(2,'0') + '-' + String(today.getDate()).padStart(2,'0');

    // Local date string helper (avoids UTC shift from toISOString)
    function toLocalDateStr(d) {
        const dt = new Date(d);
        return dt.getFullYear() + '-' + String(dt.getMonth()+1).padStart(2,'0') + '-' + String(dt.getDate()).padStart(2,'0');
    }

    // Build week days (Mon–Sun of current week)
    const weekStart = new Date(today);
    const dayOfWeek = today.getDay();
    weekStart.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1)); // Monday
    weekStart.setHours(0, 0, 0, 0);

    const weekDays = [];
    for (let i = 0; i < 7; i++) {
        const d = new Date(weekStart);
        d.setDate(weekStart.getDate() + i);
        weekDays.push(d);
    }

    // Calendar events helper — uses local dates to avoid UTC timezone shift
    function getEventsForDate(dateStr) {
        return CALENDAR_DATA.events.filter(e => {
            return toLocalDateStr(e.start) === dateStr;
        });
    }

    function formatTime(isoStr) {
        const d = new Date(isoStr);
        return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
    }

    function calcDuration(start, end) {
        const mins = Math.round((new Date(end) - new Date(start)) / 60000);
        return mins >= 60 ? `${Math.floor(mins/60)}h ${mins%60 ? mins%60 + 'm' : ''}` : `${mins}m`;
    }

    // ---- TODAY'S CALENDAR ----
    const todayEvents = getEventsForDate(todayStr);

    function buildEventCard(e) {
        const state = CalendarState.getState(e.id);
        const stateClass = state === 'completed' ? 'cal-completed' : state === 'cancelled' ? 'cal-cancelled' : '';
        const isManualState = CalendarState._states[e.id]; // explicitly set by user
        const isAutoCompleted = !isManualState && state === 'completed'; // auto-detected past meeting

        let statusBadge = '';
        if (state === 'completed') statusBadge = '<span class="cal-status-badge" style="background:rgba(0,200,117,0.15);color:var(--rag-green);">&#10003; Done</span>';
        else if (state === 'cancelled') statusBadge = '<span class="cal-status-badge" style="background:rgba(232,73,73,0.15);color:var(--rag-red);">&#10007; Cancelled</span>';

        let actionButtons = '';
        if (state === 'active') {
            actionButtons = `
                <div class="cal-actions">
                    <button class="cal-action-btn complete" onclick="event.stopPropagation();CalendarState.markComplete('${e.id}')" title="Mark as complete">&#10003;</button>
                    <button class="cal-action-btn cancel-btn" onclick="event.stopPropagation();CalendarState.markCancelled('${e.id}')" title="Mark as cancelled">&#10007;</button>
                </div>`;
        } else {
            actionButtons = `
                <div class="cal-actions">
                    <button class="cal-action-btn undo" onclick="event.stopPropagation();CalendarState.resetState('${e.id}')" title="Reset to active">&#8634;</button>
                </div>`;
        }

        return `
        <div class="calendar-event-card ${stateClass}">
            <div class="cal-time-block">
                <div class="cal-time">${formatTime(e.start)}</div>
                <div class="cal-duration">${calcDuration(e.start, e.end)}</div>
            </div>
            <div class="cal-event-info">
                <div class="cal-event-subject">${e.subject} ${statusBadge}</div>
                <div class="cal-event-meta">
                    <span>&#128100; ${e.organizer.split('@')[0]}</span>
                    <span>&#128205; ${e.location || 'No location'}</span>
                    ${e.isOrganizer ? '<span style="color:var(--accent-purple);">&#9733; You\'re organizing</span>' : ''}
                    ${isAutoCompleted ? '<span style="color:var(--text-muted);font-style:italic;">auto-completed</span>' : ''}
                </div>
                ${e.webLink ? `<a class="cal-event-link" href="${e.webLink}" target="_blank" onclick="event.stopPropagation()">Open in Outlook &#8599;</a>` : ''}
            </div>
            ${actionButtons}
        </div>`;
    }

    const todayCalendarHTML = todayEvents.length > 0
        ? todayEvents.map(e => buildEventCard(e)).join('')
        : '<div class="week-no-events">No meetings scheduled for today</div>';

    // ---- TO-DO LIST + EMAIL ACTIONS ----
    // Client names list (shared between email actions and email follow-ups)
    const clientNames = State.dataLoaded && State.clients.length > 0
        ? State.clients.map(c => c.name)
        : Object.keys(EMAIL_DATA.clients);

    // Build email action items with effective status (respects manual overrides)
    const emailActions = [];
    clientNames.forEach(name => {
        const ed = EMAIL_DATA.clients[name];
        if (!ed || ed.discontinued) return;
        if (EmailHiddenCards.isHidden(name)) return;
        const client = State.clients.find(c => c.name === name);
        // Check for manual override first
        const manualStatus = EmailActionOverrides.getStatus(name);
        const autoStatus = getEffectiveEmailStatus(name);
        const effectiveStatus = manualStatus || autoStatus;
        const isOverridden = EmailActionOverrides.hasOverride(name);
        const latestEmail = ed.emails[0];
        const lastFromMe = getLastEmailFromMe(ed);
        const lastFromClient = getLastEmailFromClient(ed);

        let actionLabel = '', statusClass = '', icon = '', detail = '', isDone = false;
        if (effectiveStatus === 'done') {
            actionLabel = 'Done'; statusClass = 'done'; icon = '✅'; isDone = true;
            detail = isOverridden ? 'Manually marked as done' : 'Completed';
        } else if (effectiveStatus === 'awaiting') {
            actionLabel = 'Awaiting Reply'; statusClass = 'awaiting'; icon = '📤';
            const myLast = lastFromMe ? new Date(lastFromMe.date) : null;
            detail = myLast ? `You sent on ${myLast.toLocaleDateString('en-GB', {day:'numeric',month:'short'})}` : 'Awaiting client response';
        } else if (effectiveStatus === 'needs-response') {
            actionLabel = 'Needs Response'; statusClass = 'needs-action'; icon = '⚠️';
            const hrs = getHoursSinceLastClientEmail(ed);
            detail = hrs !== null ? `Client emailed ${hrs < 24 ? Math.round(hrs) + 'h' : Math.round(hrs/24) + 'd'} ago — reply needed` : 'Client awaiting reply';
        } else if (effectiveStatus === 'within-grace') {
            actionLabel = 'Within Grace'; statusClass = 'grace'; icon = '⏰';
            const hrs = getHoursSinceLastClientEmail(ed);
            const remaining = hrs !== null ? Math.max(0, Math.round(CONFIG.RESPONSE_GRACE_HOURS - hrs)) : null;
            detail = remaining !== null ? `${remaining}h left in 48h grace window` : 'Within response window';
        } else if (effectiveStatus === 'stale' || effectiveStatus === 'no-recent') {
            actionLabel = effectiveStatus === 'stale' ? 'Stale' : 'No Recent'; statusClass = 'needs-action'; icon = '📭';
            detail = latestEmail ? `Last email: ${new Date(latestEmail.date).toLocaleDateString('en-GB', {day:'numeric',month:'short'})}` : 'No email history';
        } else {
            return; // discontinued or unknown
        }

        emailActions.push({
            type: 'email',
            clientName: name,
            clientId: client?.id,
            effectiveStatus,
            autoStatus,
            isOverridden,
            isDone,
            actionLabel,
            statusClass,
            icon,
            detail,
            latestEmail,
            webLink: latestEmail?.webLink || null,
        });
    });

    // Compute combined counts for filter tabs
    const emailActionsToday = emailActions.filter(ea => !ea.isDone);
    const emailActionsDone = emailActions.filter(ea => ea.isDone);
    const emailActionsAwaiting = emailActions.filter(ea => ea.effectiveStatus === 'awaiting');

    const filtered = DashTodo.getFiltered();
    const priorityOrder = { high: 0, medium: 1, low: 2 };
    const sortedTodos = [...filtered].sort((a, b) => {
        if (a.completed !== b.completed) return a.completed ? 1 : -1;
        return (priorityOrder[a.priority] ?? 1) - (priorityOrder[b.priority] ?? 1);
    });

    const todayTodoCount = DashTodo.getToday().filter(t => !t.completed).length;
    const weekTodoCount = DashTodo.getThisWeek().filter(t => !t.completed).length;
    const completedTodoCount = DashTodo._items.filter(t => t.completed).length;

    // Combined counts: tasks + email actions
    const todayCount = todayTodoCount + emailActionsToday.length;
    const weekCount = weekTodoCount + emailActionsToday.length; // email actions are always "this week" level
    const completedCount = completedTodoCount + emailActionsDone.length;

    // Build email action items HTML
    function buildEmailActionHTML(ea) {
        const overrideInfo = EmailActionOverrides.getOverrideInfo(ea.clientName);
        const overrideLabel = ea.isOverridden ? `<span style="font-size:9px;color:var(--text-muted);margin-left:4px;">(manual)</span>` : '';
        return `
        <div class="email-action-item ${ea.isDone ? 'is-done' : ''}" data-client="${ea.clientName}">
            <div class="email-action-checkbox ${ea.isDone ? 'checked' : ''}" onclick="event.stopPropagation();EmailActionOverrides.setOverride('${ea.clientName.replace(/'/g,"\\'")}', '${ea.isDone ? 'auto' : 'done'}');renderPlannerPage();">${ea.isDone ? '✓' : ''}</div>
            <span class="email-action-icon">${ea.icon}</span>
            <div class="email-action-body">
                <div class="email-action-text">📧 ${ea.clientName}</div>
                <div class="email-action-detail">${ea.detail}</div>
            </div>
            <div class="email-action-override">
                <button class="email-action-status-btn ${ea.statusClass}" onclick="event.stopPropagation();toggleEmailOverrideMenu('${ea.clientName.replace(/'/g,"\\'")}')">${ea.actionLabel}${overrideLabel}</button>
                <div class="email-action-override-menu" id="emailOverride_${ea.clientName.replace(/[^a-zA-Z0-9]/g,'_')}">
                    <div class="email-action-override-option" onclick="event.stopPropagation();EmailActionOverrides.setOverride('${ea.clientName.replace(/'/g,"\\'")}','done');closeAllOverrideMenus();renderPlannerPage();">
                        <span class="ov-dot done"></span> Mark as Done
                    </div>
                    <div class="email-action-override-option" onclick="event.stopPropagation();EmailActionOverrides.setOverride('${ea.clientName.replace(/'/g,"\\'")}','awaiting');closeAllOverrideMenus();renderPlannerPage();">
                        <span class="ov-dot awaiting"></span> Awaiting Reply
                    </div>
                    <div class="email-action-override-option" onclick="event.stopPropagation();EmailActionOverrides.setOverride('${ea.clientName.replace(/'/g,"\\'")}','needs-response');closeAllOverrideMenus();renderPlannerPage();">
                        <span class="ov-dot needs-action"></span> Needs Response
                    </div>
                    <div class="email-action-override-option" onclick="event.stopPropagation();EmailActionOverrides.setOverride('${ea.clientName.replace(/'/g,"\\'")}','auto');closeAllOverrideMenus();renderPlannerPage();">
                        <span class="ov-dot auto"></span> Auto-detect
                    </div>
                </div>
            </div>
            ${ea.clientId ? `<a class="email-followup-action" onclick="Router.navigate('client/${ea.clientId}')" style="font-size:10px;">View</a>` : ''}
        </div>`;
    }

    // Filter email actions based on active tab
    let filteredEmailActions = [];
    if (DashTodo._filter === 'today' || DashTodo._filter === 'all') {
        filteredEmailActions = emailActions.filter(ea => !ea.isDone);
    } else if (DashTodo._filter === 'week') {
        filteredEmailActions = emailActions.filter(ea => !ea.isDone);
    } else if (DashTodo._filter === 'completed') {
        filteredEmailActions = emailActions.filter(ea => ea.isDone);
    }
    // Sort: urgent first
    const statusOrder = { 'needs-response': 0, 'within-grace': 1, 'stale': 2, 'no-recent': 3, 'awaiting': 4, 'done': 5 };
    filteredEmailActions.sort((a, b) => (statusOrder[a.effectiveStatus] ?? 9) - (statusOrder[b.effectiveStatus] ?? 9));

    const emailActionsHTML = filteredEmailActions.length > 0
        ? `<div style="margin-bottom:8px;font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;padding:8px 0 4px;">📧 Email Actions</div>` + filteredEmailActions.map(ea => buildEmailActionHTML(ea)).join('')
        : '';

    const todoListHTML = sortedTodos.length > 0 ? sortedTodos.map(t => `
        <div class="todo-item priority-${t.priority} ${t.completed ? 'completed' : ''}" data-id="${t.id}">
            <div class="todo-checkbox" onclick="event.stopPropagation();DashTodo.toggle('${t.id}');renderPlannerPage();">${t.completed ? '&#10003;' : ''}</div>
            <span class="todo-text">${t.text}</span>
            <div class="todo-meta">
                <span class="todo-priority-badge ${t.priority}">${t.priority}</span>
                ${t.dueDate !== todayStr ? `<span>${new Date(t.dueDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })}</span>` : ''}
            </div>
            <span class="todo-delete" onclick="event.stopPropagation();DashTodo.remove('${t.id}');renderPlannerPage();">&#128465;</span>
        </div>
    `).join('') : '';

    const emptyMessage = (sortedTodos.length === 0 && filteredEmailActions.length === 0)
        ? `<div class="todo-empty">${DashTodo._filter === 'completed' ? 'No completed items yet' : 'All clear! Add a task to get started.'}</div>`
        : '';

    // ---- EMAIL FOLLOW-UPS ----
    // Compute email follow-up items for all clients (clientNames already defined above)
    const emailFollowUps = [];
    clientNames.forEach(name => {
        const ed = EMAIL_DATA.clients[name];
        if (!ed || ed.discontinued) return;
        if (EmailHiddenCards.isHidden(name)) return;
        const client = State.clients.find(c => c.name === name);
        const effectiveStatus = getEffectiveEmailStatus(name);
        const latestEmail = ed.emails[0];
        const lastEmailDate = latestEmail ? new Date(latestEmail.date) : null;
        const hoursSince = getHoursSinceLastClientEmail(ed);

        // Grace period: compute when grace expires (48h from last client email)
        let graceExpiresDate = null;
        if (effectiveStatus === 'within-grace' && hoursSince !== null) {
            const clientEmail = ed.emails.find(e => e.isFromClient === true);
            if (clientEmail) {
                graceExpiresDate = new Date(new Date(clientEmail.date).getTime() + CONFIG.RESPONSE_GRACE_HOURS * 3600000);
            }
        }

        let urgency = 99; // lower = more urgent
        let tag = '', tagClass = '', icon = '', iconClass = '', detail = '';

        if (effectiveStatus === 'needs-response') {
            urgency = 0;
            tag = 'Needs Response'; tagClass = 'urgent'; icon = '&#9888;'; iconClass = 'urgent';
            const hrs = hoursSince !== null ? Math.round(hoursSince) : null;
            detail = hrs !== null ? `Client emailed ${hrs < 24 ? hrs + 'h' : Math.round(hrs/24) + 'd'} ago` : 'Client awaiting reply';
        } else if (effectiveStatus === 'within-grace') {
            urgency = 1;
            tag = 'Within 48h Grace'; tagClass = 'grace'; icon = '&#9200;'; iconClass = 'grace';
            if (graceExpiresDate) {
                const hoursLeft = Math.max(0, Math.round((graceExpiresDate - today) / 3600000));
                detail = `Grace expires in ${hoursLeft}h — respond by ${graceExpiresDate.toLocaleDateString('en-GB', {day:'numeric',month:'short'})} ${graceExpiresDate.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}`;
            } else {
                detail = 'Within 48h response window';
            }
        } else if (effectiveStatus === 'stale' || effectiveStatus === 'no-recent') {
            urgency = 2;
            tag = effectiveStatus === 'stale' ? 'Stale' : 'No Recent Email'; tagClass = 'stale'; icon = '&#128249;'; iconClass = 'stale';
            detail = lastEmailDate ? `Last email: ${lastEmailDate.toLocaleDateString('en-GB', {day:'numeric',month:'short'})}` : 'No email history';
        } else if (effectiveStatus === 'awaiting') {
            urgency = 3;
            tag = 'Awaiting Reply'; tagClass = 'awaiting'; icon = '&#128228;'; iconClass = 'awaiting';
            detail = lastEmailDate ? `You sent last on ${lastEmailDate.toLocaleDateString('en-GB', {day:'numeric',month:'short'})}` : 'Awaiting client response';
        } else {
            return; // up-to-date or other — skip
        }

        emailFollowUps.push({
            name, clientId: client?.id, effectiveStatus, urgency,
            tag, tagClass, icon, iconClass, detail,
            lastEmailDate, graceExpiresDate, latestEmail,
            webLink: latestEmail?.webLink || null
        });
    });

    emailFollowUps.sort((a, b) => a.urgency - b.urgency);

    // Today's follow-ups: needs-response + within-grace expiring today + stale
    // Excludes items manually overridden as "done"
    const todayFollowUps = emailFollowUps.filter(f => {
        const manual = EmailActionOverrides.getStatus(f.name);
        if (manual === 'done') return false;
        return f.effectiveStatus === 'needs-response' ||
            f.effectiveStatus === 'within-grace' ||
            f.effectiveStatus === 'stale' ||
            f.effectiveStatus === 'no-recent';
    });

    const todayEmailHTML = todayFollowUps.length > 0 ? todayFollowUps.map(f => `
        <div class="email-followup-item">
            <div class="email-followup-icon ${f.iconClass}">${f.icon}</div>
            <div class="email-followup-body">
                <div class="email-followup-client">${f.name}</div>
                <div class="email-followup-detail">
                    <span>${f.detail}</span>
                    ${f.latestEmail ? `<span>Re: ${f.latestEmail.subject.length > 50 ? f.latestEmail.subject.substring(0,50) + '...' : f.latestEmail.subject}</span>` : ''}
                </div>
            </div>
            <span class="email-followup-tag ${f.tagClass}">${f.tag}</span>
            ${f.clientId ? `<a class="email-followup-action" onclick="Router.navigate('client/${f.clientId}')">View &#8599;</a>` : ''}
            ${f.webLink ? `<a class="email-followup-action" href="${f.webLink}" target="_blank" onclick="event.stopPropagation()">Open &#128231;</a>` : ''}
        </div>
    `).join('') : '<div class="week-no-events">No email follow-ups due today</div>';

    // Helper: compute which email follow-ups fall on which day of the week
    // Logic: needs-response → show on today; within-grace → show on expiry day; stale → show on today;
    //        awaiting → spread across future days as reminders to check in
    // Excludes items manually marked as "done"
    function getEmailFollowUpsForDate(dateStr) {
        const items = [];
        emailFollowUps.filter(f => {
            // Exclude items overridden as done
            const manual = EmailActionOverrides.getStatus(f.name);
            return manual !== 'done';
        }).forEach(f => {
            if (f.effectiveStatus === 'needs-response' || f.effectiveStatus === 'stale' || f.effectiveStatus === 'no-recent') {
                // Show urgent/stale items on today only
                if (dateStr === todayStr) {
                    items.push(f);
                }
            } else if (f.effectiveStatus === 'within-grace' && f.graceExpiresDate) {
                // Show on the day grace expires — use local date
                const expiryDateStr = toLocalDateStr(f.graceExpiresDate);
                if (dateStr === expiryDateStr) {
                    items.push(f);
                }
                // Also show on today as a heads-up if expiry is later in the week
                if (dateStr === todayStr && expiryDateStr !== todayStr) {
                    items.push({ ...f, tag: 'Grace — respond soon', tagClass: 'grace' });
                }
            } else if (f.effectiveStatus === 'awaiting') {
                // Show awaiting items on today as a "check-in" reminder
                if (dateStr === todayStr) {
                    items.push(f);
                }
                // Also show a follow-up reminder 3 days from last email if it falls in this week
                if (f.lastEmailDate) {
                    const followUpDate = new Date(f.lastEmailDate.getTime() + 3 * 86400000);
                    const followUpStr = toLocalDateStr(followUpDate);
                    if (dateStr === followUpStr && dateStr !== todayStr) {
                        items.push({ ...f, tag: 'Follow up?', tagClass: 'awaiting' });
                    }
                }
            }
        });
        return items;
    }

    // ---- WEEK PROJECTION ----
    const weekProjectionHTML = weekDays.map(day => {
        const dateStr = toLocalDateStr(day);
        const isToday = dateStr === todayStr;
        const dayName = day.toLocaleDateString('en-GB', { weekday: 'long' });
        const dateLabel = day.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
        const dayEvents = getEventsForDate(dateStr);
        const dayTodos = DashTodo.getTodosForDate(dateStr).filter(t => !t.completed);
        const dayEmails = getEmailFollowUpsForDate(dateStr);
        const totalItems = dayEvents.length + dayTodos.length + dayEmails.length;

        const eventsHTML = dayEvents.map(e => {
            const state = CalendarState.getState(e.id);
            const weekClass = state === 'completed' ? 'we-completed' : state === 'cancelled' ? 'we-cancelled' : '';
            const label = state === 'completed' ? 'Done' : state === 'cancelled' ? 'Cancelled' : 'Meeting';
            return `
            <div class="week-event-item ${weekClass}">
                <span class="week-event-time">${formatTime(e.start)}</span>
                <span class="week-event-title">${e.subject}</span>
                <span class="week-event-type meeting">${label}</span>
            </div>`;
        }).join('');

        const todosHTML = dayTodos.map(t => `
            <div class="week-event-item">
                <span class="week-event-time">To-Do</span>
                <span class="week-event-title">${t.text}</span>
                <span class="week-event-type todo">${t.priority}</span>
            </div>
        `).join('');

        const emailsHTML = dayEmails.map(f => `
            <div class="week-event-item">
                <span class="week-event-time">&#128231;</span>
                <span class="week-event-title">${f.name}</span>
                <span class="week-event-type email-${f.tagClass}">${f.tag}</span>
            </div>
        `).join('');

        const contentHTML = (eventsHTML + todosHTML + emailsHTML) || '<div class="week-no-events">Nothing scheduled</div>';

        return `
            <div class="week-day-card ${isToday ? 'today' : ''}">
                <div class="week-day-header">
                    <span class="week-day-name">${isToday ? '&#128313; ' : ''}${dayName}</span>
                    <span class="week-day-date">${dateLabel}</span>
                    ${totalItems > 0 ? `<span class="week-day-badge">${totalItems} item${totalItems !== 1 ? 's' : ''}</span>` : ''}
                </div>
                ${contentHTML}
            </div>
        `;
    }).join('');

    // ---- RENDER FULL PAGE ----
    container.innerHTML = `
        <h2 style="font-size:22px;font-weight:700;color:var(--text-white);margin-bottom:20px;">&#128467; Planner & To-Do</h2>

        <!-- Today's Calendar -->
        <div class="calendar-section">
            <div class="planner-section-title" style="flex-wrap:wrap;gap:8px;">
                <span>&#128197; Today's Schedule — ${today.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</span>
                <span class="section-count">${todayEvents.length} meeting${todayEvents.length !== 1 ? 's' : ''}</span>
                <div class="email-sync-status" style="margin-left:auto;">
                    <span class="email-sync-text" id="calSyncText">Loading...</span>
                    <button class="email-sync-btn" id="btnCalSync" onclick="CalendarSync.sync(true)" title="Sync calendar now">&#128260; Sync</button>
                </div>
            </div>
            ${todayCalendarHTML}
        </div>

        <!-- Email Follow-Ups Due -->
        <div class="email-followup-section">
            <div class="planner-section-title">
                &#128231; Email Follow-Ups
                <span class="section-count">${todayFollowUps.length} action${todayFollowUps.length !== 1 ? 's' : ''} needed</span>
            </div>
            ${todayEmailHTML}
        </div>

        <div class="planner-layout">
            <!-- LEFT: To-Do List -->
            <div class="planner-column">
                <div class="planner-section-title">
                    ✅ Action Items
                    <span class="section-count">${todayCount} today (${emailActionsToday.length} email${emailActionsToday.length !== 1 ? 's' : ''} + ${todayTodoCount} task${todayTodoCount !== 1 ? 's' : ''})</span>
                </div>

                <div class="todo-filters">
                    <button class="todo-filter-btn ${DashTodo._filter === 'all' ? 'active' : ''}" onclick="DashTodo.setFilter('all')">Active (${todayCount})</button>
                    <button class="todo-filter-btn ${DashTodo._filter === 'today' ? 'active' : ''}" onclick="DashTodo.setFilter('today')">Today (${todayCount})</button>
                    <button class="todo-filter-btn ${DashTodo._filter === 'week' ? 'active' : ''}" onclick="DashTodo.setFilter('week')">This Week (${weekCount})</button>
                    <button class="todo-filter-btn ${DashTodo._filter === 'completed' ? 'active' : ''}" onclick="DashTodo.setFilter('completed')">Done (${completedCount})</button>
                </div>

                <button class="btn-open-prompt" onclick="openTaskPrompt()">&#10010; Add Tasks</button>

                <div class="todo-list">
                    ${emailActionsHTML}
                    ${sortedTodos.length > 0 && filteredEmailActions.length > 0 ? '<div style="margin-bottom:8px;margin-top:12px;font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;padding:4px 0;">📋 Tasks</div>' : ''}
                    ${todoListHTML}
                    ${emptyMessage}
                </div>
            </div>

            <!-- RIGHT: Week Projection -->
            <div class="planner-column">
                <div class="planner-section-title">
                    &#128197; Week at a Glance
                    <span class="section-count">${weekDays[0].toLocaleDateString('en-GB', {day:'numeric',month:'short'})} — ${weekDays[6].toLocaleDateString('en-GB', {day:'numeric',month:'short'})}</span>
                </div>
                ${weekProjectionHTML}
            </div>
        </div>
    `;

    // Update calendar sync status after rendering (so #calSyncText exists)
    CalendarSync._updateSyncStatusUI();
}

/* ================================================================
   KNOWLEDGE BASE MANAGER
   ================================================================ */
/* BACKLOG: Cloud-sync KB via Azure AD app registration.
   One-time setup unlocks auto-refreshing tokens for Outlook + SharePoint/OneDrive/Teams.
   Would replace localStorage with a shared SharePoint document library per pod.
   Also fixes the current Outlook token ~1hr expiry (Graph Explorer limitation). */
const KnowledgeBase = {
    _key: 'iai_kb_docs',
    _sk() { return UserSession.podKey(this._key); },
    _docs: [],
    _viewerOpen: false,

    _defaults: [
        {
            id: 'kb_default_kickoff',
            title: 'IAI Universal Kickoff Checklist',
            description: 'Complete agent specification discovery checklist for client kickoff meetings. 49 items across 10 sections with progress tracking.',
            path: 'file:///C:/Users/mishi/Downloads/IAI_Universal_Kickoff_Checklist.html',
            category: 'checklist',
            icon: '⚡',
            addedDate: '2026-02-23',
            isDefault: true
        }
    ],

    load() {
        try {
            const saved = localStorage.getItem(this._sk());
            if (saved) {
                this._docs = JSON.parse(saved);
            } else {
                this._docs = [...this._defaults];
                this.save();
            }
            // Ensure defaults always exist
            this._defaults.forEach(def => {
                if (!this._docs.find(d => d.id === def.id)) {
                    this._docs.unshift(def);
                }
            });
        } catch (e) {
            this._docs = [...this._defaults];
            this.save();
        }
    },

    save() {
        try {
            localStorage.setItem(this._sk(), JSON.stringify(this._docs));
        } catch (e) { /* storage full — silent */ }
    },

    add(doc) {
        const newDoc = {
            id: 'kb_' + Date.now(),
            title: doc.title || 'Untitled Document',
            description: doc.description || '',
            path: doc.path || '',
            category: doc.category || 'other',
            icon: doc.icon || '📄',
            addedDate: new Date().toISOString().split('T')[0],
            isDefault: false
        };
        this._docs.push(newDoc);
        this.save();
        this.render();
        showToast('Document added: ' + newDoc.title, 'success');
    },

    remove(id) {
        const doc = this._docs.find(d => d.id === id);
        if (!doc) return;
        if (doc.isDefault) {
            showToast('Cannot remove default documents', 'info');
            return;
        }
        this._docs = this._docs.filter(d => d.id !== id);
        this.save();
        this.render();
        showToast('Removed: ' + doc.title, 'info');
    },

    openViewer(id) {
        const doc = this._docs.find(d => d.id === id);
        if (!doc) return;
        const wrap = document.getElementById('kbViewerWrap');
        const frame = document.getElementById('kbViewerFrame');
        const title = document.getElementById('kbViewerTitle');
        const ext = document.getElementById('kbViewerExternal');

        title.textContent = doc.title;
        ext.href = doc.path;
        frame.src = doc.path;
        wrap.style.display = 'flex';
        this._viewerOpen = true;
    },

    closeViewer() {
        const wrap = document.getElementById('kbViewerWrap');
        const frame = document.getElementById('kbViewerFrame');
        frame.src = 'about:blank';
        wrap.style.display = 'none';
        this._viewerOpen = false;
    },

    openAddModal() {
        document.getElementById('kbAddModal').classList.add('open');
        document.getElementById('kbDocTitle').value = '';
        document.getElementById('kbDocDesc').value = '';
        document.getElementById('kbDocPath').value = '';
        document.getElementById('kbDocCategory').value = 'checklist';
        document.getElementById('kbDocIcon').value = '📋';
        setTimeout(() => document.getElementById('kbDocTitle').focus(), 100);
    },

    closeAddModal() {
        document.getElementById('kbAddModal').classList.remove('open');
    },

    addFromModal() {
        const title = document.getElementById('kbDocTitle').value.trim();
        const path = document.getElementById('kbDocPath').value.trim();
        if (!title) { showToast('Please enter a document title', 'info'); return; }
        if (!path) { showToast('Please enter a file path or URL', 'info'); return; }

        this.add({
            title: title,
            description: document.getElementById('kbDocDesc').value.trim(),
            path: path,
            category: document.getElementById('kbDocCategory').value,
            icon: document.getElementById('kbDocIcon').value
        });
        this.closeAddModal();
    },

    _categoryLabel(cat) {
        const map = { checklist: 'Checklist', guide: 'Guide', reference: 'Reference', template: 'Template', other: 'Other' };
        return map[cat] || cat;
    },

    render() {
        const container = document.getElementById('kbContent');
        if (!container) return;

        const cardsHTML = this._docs.length
            ? `<div class="kb-grid">${this._docs.map(doc => `
                <div class="kb-card" onclick="KnowledgeBase.openViewer('${doc.id}')">
                    ${!doc.isDefault ? `<button class="kb-card-remove" onclick="event.stopPropagation();KnowledgeBase.remove('${doc.id}')" title="Remove document">&#10005;</button>` : ''}
                    <div class="kb-card-icon">${doc.icon}</div>
                    <div class="kb-card-title">${doc.title}</div>
                    ${doc.description ? `<div class="kb-card-desc">${doc.description}</div>` : ''}
                    <div class="kb-card-meta">
                        <span class="kb-card-cat ${doc.category}">${this._categoryLabel(doc.category)}</span>
                        <span class="kb-card-date">Added ${doc.addedDate}</span>
                    </div>
                </div>
            `).join('')}</div>`
            : `<div class="kb-empty">
                <div class="kb-empty-icon">&#128218;</div>
                <div class="kb-empty-text">No documents yet. Add your first one!</div>
                <button class="kb-btn-add" onclick="KnowledgeBase.openAddModal()">&#10010; Add Document</button>
            </div>`;

        container.innerHTML = `
            <div class="kb-header">
                <h2>&#128218; Knowledge Base <span class="kb-header-count">${this._docs.length} document${this._docs.length !== 1 ? 's' : ''}</span></h2>
                <button class="kb-btn-add" onclick="KnowledgeBase.openAddModal()">&#10010; Add Document</button>
            </div>
            ${cardsHTML}
        `;
    }
};

/* ================================================================
   TASK PROMPT MODAL — Open / Parse / Preview / Submit
   ================================================================ */
function openTaskPrompt() {
    const overlay = document.getElementById('taskPromptOverlay');
    overlay.classList.add('open');
    document.getElementById('taskPromptText').value = '';
    document.getElementById('taskPromptPreview').classList.remove('visible');
    document.getElementById('taskPromptCustomDate').style.display = 'none';

    // Set default custom date to today
    document.getElementById('taskPromptCustomDate').value = new Date().toISOString().split('T')[0];

    // Listen for typing to live-preview
    const textarea = document.getElementById('taskPromptText');
    textarea.focus();
    textarea.oninput = () => updateTaskPreview();

    // Date mode toggle
    document.getElementById('taskPromptDateMode').onchange = function() {
        document.getElementById('taskPromptCustomDate').style.display = this.value === 'custom' ? 'inline-block' : 'none';
        updateTaskPreview();
    };
    document.getElementById('taskPromptDefaultPriority').onchange = () => updateTaskPreview();
    document.getElementById('taskPromptCustomDate').onchange = () => updateTaskPreview();
}

function closeTaskPrompt() {
    document.getElementById('taskPromptOverlay').classList.remove('open');
}

/**
 * Parse bulk text into task objects.
 * Supports:   "Task text !high @2026-02-25"
 *             "Task text !low"
 *             "Task text @tomorrow"
 *             "Task text" (uses defaults)
 */
function parseTaskLines(text, defaultPriority, dateMode, customDate) {
    const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    const tasks = [];

    lines.forEach((line, idx) => {
        let priority = defaultPriority;
        let dueDate = todayStr;
        let taskText = line;

        // Extract priority: !high, !medium, !low, !urgent (→high), !important (→high)
        const prioMatch = taskText.match(/\s*!(high|medium|low|urgent|important)\s*/i);
        if (prioMatch) {
            const p = prioMatch[1].toLowerCase();
            priority = (p === 'urgent' || p === 'important') ? 'high' : p;
            taskText = taskText.replace(prioMatch[0], ' ').trim();
        }

        // Extract date: @2026-02-25 or @tomorrow or @monday etc
        const dateMatch = taskText.match(/\s*@(\S+)\s*/i);
        if (dateMatch) {
            const raw = dateMatch[1].toLowerCase();
            taskText = taskText.replace(dateMatch[0], ' ').trim();

            // Try ISO date first
            if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) {
                dueDate = raw;
            } else if (raw === 'today') {
                dueDate = todayStr;
            } else if (raw === 'tomorrow') {
                const tmrw = new Date(today);
                tmrw.setDate(today.getDate() + 1);
                dueDate = tmrw.toISOString().split('T')[0];
            } else {
                // Try day name (monday, tuesday, etc)
                const dayNames = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
                const targetDay = dayNames.indexOf(raw);
                if (targetDay >= 0) {
                    const d = new Date(today);
                    let diff = targetDay - d.getDay();
                    if (diff <= 0) diff += 7;
                    d.setDate(d.getDate() + diff);
                    dueDate = d.toISOString().split('T')[0];
                }
            }
        } else {
            // No explicit date — use the mode
            if (dateMode === 'today') {
                dueDate = todayStr;
            } else if (dateMode === 'custom' && customDate) {
                dueDate = customDate;
            } else if (dateMode === 'spread') {
                // Spread tasks across the work week (Mon-Fri from today)
                const spreadDate = new Date(today);
                spreadDate.setDate(today.getDate() + (idx % 5));
                // Skip weekends
                while (spreadDate.getDay() === 0 || spreadDate.getDay() === 6) {
                    spreadDate.setDate(spreadDate.getDate() + 1);
                }
                dueDate = spreadDate.toISOString().split('T')[0];
            }
        }

        if (taskText.length > 0) {
            tasks.push({ text: taskText, priority, dueDate });
        }
    });

    return tasks;
}

function updateTaskPreview() {
    const text = document.getElementById('taskPromptText').value;
    const defaultPriority = document.getElementById('taskPromptDefaultPriority').value;
    const dateMode = document.getElementById('taskPromptDateMode').value;
    const customDate = document.getElementById('taskPromptCustomDate').value;

    const tasks = parseTaskLines(text, defaultPriority, dateMode, customDate);
    const preview = document.getElementById('taskPromptPreview');
    const list = document.getElementById('taskPromptPreviewList');
    const countEl = document.getElementById('taskPromptPreviewCount');

    if (tasks.length === 0) {
        preview.classList.remove('visible');
        return;
    }

    preview.classList.add('visible');
    countEl.textContent = tasks.length;

    list.innerHTML = tasks.map(t => {
        const dateLabel = new Date(t.dueDate).toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
        return `<div class="task-preview-item">
            <span class="tpi-priority ${t.priority}">${t.priority}</span>
            <span>${t.text}</span>
            <span class="tpi-date">${dateLabel}</span>
        </div>`;
    }).join('');
}

function submitTaskPrompt() {
    const text = document.getElementById('taskPromptText').value;
    const defaultPriority = document.getElementById('taskPromptDefaultPriority').value;
    const dateMode = document.getElementById('taskPromptDateMode').value;
    const customDate = document.getElementById('taskPromptCustomDate').value;

    const tasks = parseTaskLines(text, defaultPriority, dateMode, customDate);
    if (tasks.length === 0) {
        showToast('No tasks found — enter one task per line', 'error');
        return;
    }

    tasks.forEach(t => DashTodo.add(t.text, t.priority, t.dueDate));
    closeTaskPrompt();
    showToast(`${tasks.length} task${tasks.length !== 1 ? 's' : ''} added`, 'success');
    renderPlannerPage();
}

/* ================================================================
   CHANGE TRACKER
   ================================================================ */
const ChangeTracker = {
    _key: 'iai_snapshot',
    _sk() { return UserSession.podKey(this._key); },
    _changes: {},       // { clientId: [ { field, oldVal, newVal, direction } ] }
    _popoverEl: null,

    // Fields to track with display labels and value formatters
    _fields: [
        { key: 'rag',          label: 'RAG Status',    format: v => v || 'Unknown',
          direction: (o, n) => { const ord = {Green:3,Amber:2,Red:1}; return (ord[n]||0) > (ord[o]||0) ? 'improved' : (ord[n]||0) < (ord[o]||0) ? 'declined' : 'neutral'; } },
        { key: 'health',       label: 'Health Score',  computed: true,
          format: v => v.toString(),
          direction: (o, n) => n > o ? 'improved' : n < o ? 'declined' : 'neutral' },
        { key: 'billing',      label: 'Billing',       format: v => v || 'Unknown',
          direction: (o, n) => n === 'Yes' && o !== 'Yes' ? 'improved' : n !== 'Yes' && o === 'Yes' ? 'declined' : 'neutral' },
        { key: 'updateStatus', label: 'Update Status', format: v => v || 'Unknown',
          direction: (o, n) => n === 'Yes' && o !== 'Yes' ? 'improved' : n !== 'Yes' && o === 'Yes' ? 'declined' : 'neutral' },
        { key: 'plan',         label: 'Plan',          format: v => v || 'Unknown', direction: () => 'neutral' },
        { key: 'agentCount',   label: 'Agent Count',   format: v => v.toString(),
          direction: (o, n) => n > o ? 'improved' : n < o ? 'declined' : 'neutral' },
        { key: 'lastContact',  label: 'Last Contact',  format: v => v || 'N/A', direction: () => 'neutral' },
        { key: 'summary',      label: 'Summary',       format: v => v ? (v.length > 80 ? v.substring(0,80) + '...' : v) : 'None',
          direction: () => 'neutral' },
    ],

    // Take a snapshot of current client data
    _snapshot(clients) {
        const snap = {};
        clients.forEach(c => {
            snap[c.id] = {
                name: c.name,
                rag: c.rag,
                health: State.calcHealth(c),
                billing: c.billing,
                updateStatus: c.updateStatus,
                plan: c.plan,
                agentCount: c.agentCount,
                lastContact: c.lastContact,
                summary: c.summary || '',
            };
        });
        return snap;
    },

    // Load previous snapshot from localStorage
    _loadPrevious() {
        try {
            return JSON.parse(localStorage.getItem(this._sk()) || 'null');
        } catch { return null; }
    },

    // Save current snapshot
    _saveCurrent(snap) {
        localStorage.setItem(this._sk(), JSON.stringify(snap));
    },

    // Compare new data against previous snapshot, populate _changes
    detect(clients) {
        const prev = this._loadPrevious();
        const current = this._snapshot(clients);

        // Save current as the new baseline
        this._saveCurrent(current);

        // If no previous snapshot (first load), no changes to show
        if (!prev) {
            this._changes = {};
            return;
        }

        const changes = {};

        // Check each current client against previous
        Object.keys(current).forEach(id => {
            const cur = current[id];
            const old = prev[id];
            if (!old) {
                // Brand new client appeared
                changes[id] = [{ field: 'New Client', oldVal: '', newVal: cur.name, direction: 'neutral', icon: '🆕' }];
                return;
            }

            const diffs = [];
            this._fields.forEach(f => {
                const oldVal = f.computed ? (old[f.key] ?? '') : (old[f.key] ?? '');
                const newVal = f.computed ? (cur[f.key] ?? '') : (cur[f.key] ?? '');
                // Compare as strings for consistency
                if (String(oldVal) !== String(newVal)) {
                    diffs.push({
                        field: f.label,
                        oldVal: f.format(oldVal),
                        newVal: f.format(newVal),
                        direction: f.direction(oldVal, newVal),
                    });
                }
            });

            if (diffs.length > 0) {
                changes[id] = diffs;
            }
        });

        // Check for removed clients
        Object.keys(prev).forEach(id => {
            if (!current[id]) {
                changes[id] = [{ field: 'Client Removed', oldVal: prev[id].name, newVal: '', direction: 'declined', icon: '🗑️' }];
            }
        });

        this._changes = changes;

        // If there are changes, show a toast summary
        const changedCount = Object.keys(changes).length;
        if (changedCount > 0) {
            const totalDiffs = Object.values(changes).reduce((s, arr) => s + arr.length, 0);
            showToast(`${totalDiffs} change${totalDiffs !== 1 ? 's' : ''} detected across ${changedCount} client${changedCount !== 1 ? 's' : ''}`, 'info');
        }
    },

    // Check if a client has changes
    hasChanges(clientId) {
        return !!this._changes[clientId] && this._changes[clientId].length > 0;
    },

    // Get changes for a client
    getChanges(clientId) {
        return this._changes[clientId] || [];
    },

    // Get total change count
    totalCount() {
        return Object.keys(this._changes).length;
    },

    // Dismiss changes for a client
    dismiss(clientId) {
        delete this._changes[clientId];
        this.closePopover();
        renderAll();
    },

    // Dismiss all changes
    dismissAll() {
        this._changes = {};
        this.closePopover();
        renderAll();
        showToast('All change indicators cleared', 'info');
    },

    // Show popover with change details
    showPopover(clientId, event) {
        event.stopPropagation();
        this.closePopover();

        const changes = this.getChanges(clientId);
        if (!changes.length) return;

        const client = State.clients.find(c => c.id === clientId);
        const clientName = client ? client.name : 'Unknown Client';

        const el = document.createElement('div');
        el.className = 'change-popover';
        el.id = 'changePopover';

        const directionIcon = (dir) => {
            if (dir === 'improved') return '<span style="color:var(--rag-green)">&#9650;</span>';
            if (dir === 'declined') return '<span style="color:var(--rag-red)">&#9660;</span>';
            return '<span style="color:var(--accent-purple-light)">&#9670;</span>';
        };

        const itemsHTML = changes.map(ch => {
            const icon = ch.icon || directionIcon(ch.direction);
            const iconClass = ch.direction || 'neutral';
            if (ch.field === 'New Client' || ch.field === 'Client Removed') {
                return `<div class="change-item">
                    <div class="change-item-icon ${iconClass}">${icon}</div>
                    <div class="change-item-detail">
                        <div class="change-item-field">${ch.field}</div>
                        <div class="change-item-values">
                            <span class="change-val-new ${iconClass}">${ch.newVal || ch.oldVal}</span>
                        </div>
                    </div>
                </div>`;
            }
            return `<div class="change-item">
                <div class="change-item-icon ${iconClass}">${directionIcon(ch.direction)}</div>
                <div class="change-item-detail">
                    <div class="change-item-field">${ch.field}</div>
                    <div class="change-item-values">
                        <span class="change-val-old">${ch.oldVal}</span>
                        <span class="change-val-arrow">&#10142;</span>
                        <span class="change-val-new ${ch.direction}">${ch.newVal}</span>
                    </div>
                </div>
            </div>`;
        }).join('');

        el.innerHTML = `
            <div class="change-popover-header">
                <h4>&#9889; Changes — ${clientName}</h4>
                <button class="change-popover-close" onclick="ChangeTracker.closePopover()">&times;</button>
            </div>
            <div class="change-popover-body">${itemsHTML}</div>
            <div class="change-popover-footer">
                <button class="change-popover-btn dismiss" onclick="ChangeTracker.dismiss('${clientId}')">Dismiss</button>
                <button class="change-popover-btn view" onclick="ChangeTracker.closePopover();Router.navigate('client/${clientId}')">View Client &#8594;</button>
            </div>
        `;

        document.body.appendChild(el);
        this._popoverEl = el;

        // Position near the clicked badge
        requestAnimationFrame(() => {
            const rect = event.target.getBoundingClientRect();
            const popW = el.offsetWidth;
            const popH = el.offsetHeight;
            let left = rect.right + 8;
            let top = rect.top - 10;

            // Keep within viewport
            if (left + popW > window.innerWidth - 12) {
                left = rect.left - popW - 8;
            }
            if (left < 12) left = 12;
            if (top + popH > window.innerHeight - 12) {
                top = window.innerHeight - popH - 12;
            }
            if (top < 12) top = 12;

            el.style.left = left + 'px';
            el.style.top = top + 'px';
        });
    },

    closePopover() {
        if (this._popoverEl) {
            this._popoverEl.remove();
            this._popoverEl = null;
        }
    },

    // Generate badge HTML for a client card
    badgeHTML(clientId) {
        if (!this.hasChanges(clientId)) return '';
        const count = this.getChanges(clientId).length;
        return `<div class="change-badge" onclick="ChangeTracker.showPopover('${clientId}', event)" title="${count} change${count !== 1 ? 's' : ''} detected">!</div>`;
    },

    // Inline indicator for a specific field change (small arrow next to value)
    inlineBadge(clientId, fieldLabel) {
        const changes = this.getChanges(clientId);
        const ch = changes.find(c => c.field === fieldLabel);
        if (!ch) return '';
        const icon = ch.direction === 'improved' ? '&#9650;' : ch.direction === 'declined' ? '&#9660;' : '&#9670;';
        return `<span class="change-inline ${ch.direction}" title="${ch.oldVal} → ${ch.newVal}">${icon}</span>`;
    },

    // One-line summary strip of all changes for a client card footer
    summaryStrip(clientId) {
        const changes = this.getChanges(clientId);
        if (!changes.length) return '';
        const items = changes.slice(0, 4).map(ch => {
            const icon = ch.direction === 'improved' ? '<span class="change-inline improved">&#9650;</span>' :
                         ch.direction === 'declined' ? '<span class="change-inline declined">&#9660;</span>' :
                         '<span class="change-inline neutral">&#9670;</span>';
            if (ch.field === 'New Client' || ch.field === 'Client Removed') {
                return `<span class="cs-item">${ch.field} ${icon}</span>`;
            }
            return `<span class="cs-item">${ch.field}: ${ch.oldVal} <span class="cs-arrow">&#8594;</span> ${ch.newVal} ${icon}</span>`;
        }).join('');
        const extra = changes.length > 4 ? `<span class="cs-item">+${changes.length - 4} more</span>` : '';
        return `<div class="change-summary-strip">${items}${extra}</div>`;
    },

    // HTML for recent changes card in client detail page
    recentChangesCard(clientId) {
        const changes = this.getChanges(clientId);
        if (!changes.length) return '';
        const items = changes.map(ch => {
            const dirClass = ch.direction || 'neutral';
            if (ch.field === 'New Client' || ch.field === 'Client Removed') {
                return `<div class="rc-item"><span class="rc-field">${ch.field}</span><span class="rc-new ${dirClass}">${ch.newVal || ch.oldVal}</span></div>`;
            }
            return `<div class="rc-item">
                <span class="rc-field">${ch.field}</span>
                <span class="rc-old">${ch.oldVal}</span>
                <span class="rc-arrow">&#8594;</span>
                <span class="rc-new ${dirClass}">${ch.newVal}</span>
            </div>`;
        }).join('');
        return `<div class="recent-changes-card">
            <h4>&#9889; Recent Changes Detected</h4>
            ${items}
            <div style="margin-top:8px;text-align:right;">
                <button onclick="ChangeTracker.dismiss('${clientId}')" style="background:none;border:1px solid var(--border-default);color:var(--text-muted);padding:4px 10px;border-radius:4px;font-size:11px;cursor:pointer;">Dismiss</button>
            </div>
        </div>`;
    },

    // Get all changes aggregated for KPI insight (by field)
    getChangesByField(fieldLabel) {
        const result = [];
        Object.keys(this._changes).forEach(id => {
            const changes = this._changes[id];
            const match = changes.find(c => c.field === fieldLabel);
            if (match) {
                const client = State.clients.find(c => c.id === id);
                result.push({ ...match, clientId: id, clientName: client ? client.name : 'Unknown' });
            }
        });
        return result;
    },

    // Get all changes aggregated
    getAllChangesFlat() {
        const result = [];
        Object.keys(this._changes).forEach(id => {
            const client = State.clients.find(c => c.id === id);
            this._changes[id].forEach(ch => {
                result.push({ ...ch, clientId: id, clientName: client ? client.name : 'Unknown' });
            });
        });
        return result;
    },
};

// Close popover on click outside
document.addEventListener('click', (e) => {
    if (ChangeTracker._popoverEl && !e.target.closest('.change-popover') && !e.target.closest('.change-badge')) {
        ChangeTracker.closePopover();
    }
});

/* ================================================================
   KPI INSIGHT — Interactive popover for KPI tiles
   ================================================================ */
const KPIInsight = {
    _popoverEl: null,

    close() {
        if (this._popoverEl) {
            this._popoverEl.remove();
            this._popoverEl = null;
        }
    },

    _showPopover(html, event) {
        this.close();
        const el = document.createElement('div');
        el.className = 'kpi-insight-popover';
        el.innerHTML = html;
        document.body.appendChild(el);
        this._popoverEl = el;

        requestAnimationFrame(() => {
            const rect = event.currentTarget ? event.currentTarget.getBoundingClientRect() : event.target.getBoundingClientRect();
            let left = rect.left;
            let top = rect.bottom + 8;
            if (left + el.offsetWidth > window.innerWidth - 12) left = window.innerWidth - el.offsetWidth - 12;
            if (left < 12) left = 12;
            if (top + el.offsetHeight > window.innerHeight - 12) top = rect.top - el.offsetHeight - 8;
            if (top < 12) top = 12;
            el.style.left = left + 'px';
            el.style.top = top + 'px';
        });
    },

    totalClients(event) {
        event.stopPropagation();
        const all = State.clients;
        const ragColor = (r) => r === 'Green' ? 'var(--rag-green)' : r === 'Amber' ? 'var(--rag-amber)' : 'var(--rag-red)';
        const rows = all.map(c => {
            const ch = ChangeTracker.hasChanges(c.id) ? ChangeTracker.inlineBadge(c.id, 'New Client') : '';
            return `<div class="kpi-insight-row">
                <span class="kpi-insight-client" onclick="KPIInsight.close();Router.navigate('client/${c.id}')">
                    <span class="kpi-insight-rag-dot" style="background:${ragColor(c.rag)}"></span>${c.name}
                </span>
                <span style="font-size:12px;color:var(--text-muted)">${c.plan} ${ch}</span>
            </div>`;
        }).join('');
        const newClients = ChangeTracker.getChangesByField('New Client');
        const removedClients = ChangeTracker.getChangesByField('Client Removed');
        let changesHTML = '';
        if (newClients.length || removedClients.length) {
            changesHTML = `<div class="kpi-insight-section-title">Changes Detected</div>`;
            newClients.forEach(ch => { changesHTML += `<div class="kpi-insight-change"><span class="ci-icon">&#x1f195;</span> <b>${ch.clientName}</b> — New client added</div>`; });
            removedClients.forEach(ch => { changesHTML += `<div class="kpi-insight-change"><span class="ci-icon">&#128465;</span> <b>${ch.clientName}</b> — Client removed</div>`; });
        }
        this._showPopover(`
            <div class="kpi-insight-header"><h4>&#128101; Total Clients: ${all.length}</h4><button class="kpi-insight-close" onclick="KPIInsight.close()">&times;</button></div>
            <div class="kpi-insight-body">${rows}${changesHTML}</div>
        `, event);
    },

    totalAgents(event) {
        event.stopPropagation();
        const all = State.clients;
        const total = all.reduce((s, c) => s + c.agentCount, 0);
        const agentChanges = ChangeTracker.getChangesByField('Agent Count');
        const rows = all.map(c => {
            const ch = agentChanges.find(a => a.clientId === c.id);
            const delta = ch ? `<span class="kpi-insight-delta ${ch.direction === 'improved' ? 'up' : 'down'}">${ch.oldVal} &#8594; ${ch.newVal}</span>` : '';
            return `<div class="kpi-insight-row">
                <span class="kpi-insight-client" onclick="KPIInsight.close();Router.navigate('client/${c.id}')">${c.name}</span>
                <span style="font-size:13px;font-weight:600;color:var(--text-primary)">${c.agentCount} agent${c.agentCount !== 1 ? 's' : ''} ${delta}</span>
            </div>`;
        }).join('');
        this._showPopover(`
            <div class="kpi-insight-header"><h4>&#129302; Total Agents: ${total}</h4><button class="kpi-insight-close" onclick="KPIInsight.close()">&times;</button></div>
            <div class="kpi-insight-body">${rows}</div>
        `, event);
    },

    ragBreakdown(ragFilter, event) {
        event.stopPropagation();
        const all = State.clients;
        const ragColor = ragFilter === 'Green' ? 'var(--rag-green)' : ragFilter === 'Amber' ? 'var(--rag-amber)' : 'var(--rag-red)';
        const matching = all.filter(c => c.rag === ragFilter);
        const ragChanges = ChangeTracker.getChangesByField('RAG Status');

        const rows = matching.map(c => {
            const health = State.calcHealth(c);
            return `<div class="kpi-insight-row">
                <span class="kpi-insight-client" onclick="KPIInsight.close();Router.navigate('client/${c.id}')">${c.name}</span>
                <span style="font-size:12px;color:var(--text-muted)">Health: <b style="color:${healthColor(health)}">${health}</b></span>
            </div>`;
        }).join('');

        let changesHTML = '';
        const movedTo = ragChanges.filter(ch => ch.newVal === ragFilter);
        const movedFrom = ragChanges.filter(ch => ch.oldVal === ragFilter);
        if (movedTo.length || movedFrom.length) {
            changesHTML = `<div class="kpi-insight-section-title">RAG Changes</div>`;
            movedTo.forEach(ch => { changesHTML += `<div class="kpi-insight-change"><span class="ci-icon" style="color:var(--rag-green)">&#9650;</span> <b>${ch.clientName}</b>: ${ch.oldVal} &#8594; ${ch.newVal}</div>`; });
            movedFrom.forEach(ch => { changesHTML += `<div class="kpi-insight-change"><span class="ci-icon" style="color:var(--rag-red)">&#9660;</span> <b>${ch.clientName}</b>: ${ch.oldVal} &#8594; ${ch.newVal}</div>`; });
        }

        this._showPopover(`
            <div class="kpi-insight-header"><h4><span style="color:${ragColor}">&#9679;</span> ${ragFilter} RAG: ${matching.length} client${matching.length !== 1 ? 's' : ''}</h4><button class="kpi-insight-close" onclick="KPIInsight.close()">&times;</button></div>
            <div class="kpi-insight-body">${rows}${changesHTML}</div>
        `, event);
    },

    healthBreakdown(event) {
        event.stopPropagation();
        const all = State.clients;
        if (!all.length) { this.close(); return; }

        const avgHealth = Math.round(all.reduce((s, c) => s + State.calcHealth(c), 0) / all.length);

        // Get previous avg from snapshot
        let prevAvg = null;
        try {
            const prev = JSON.parse(localStorage.getItem('iai_snapshot') || 'null');
            if (prev) {
                const ids = Object.keys(prev);
                if (ids.length > 0) {
                    prevAvg = Math.round(ids.reduce((s, id) => s + (prev[id].health || 0), 0) / ids.length);
                }
            }
        } catch {}

        const delta = prevAvg !== null ? avgHealth - prevAvg : null;
        const deltaHTML = delta !== null ? `<span class="kpi-insight-delta ${delta > 0 ? 'up' : delta < 0 ? 'down' : ''}">${delta > 0 ? '&#9650;' : delta < 0 ? '&#9660;' : '&#9670;'}${delta > 0 ? '+' : ''}${delta}</span>` : '';
        const prevHTML = prevAvg !== null ? `<span style="font-size:12px;color:var(--text-muted);margin-left:8px;">Previous: ${prevAvg}</span>` : '';

        // Per-client breakdown
        const clientBreakdowns = all.map(c => {
            const breakdown = State.calcHealthBreakdown(c);
            const healthChanges = ChangeTracker.getChanges(c.id);
            const healthChange = healthChanges.find(ch => ch.field === 'Health Score');
            const clientDelta = healthChange ? parseInt(healthChange.newVal) - parseInt(healthChange.oldVal) : null;
            return { client: c, breakdown, clientDelta, healthChange };
        }).sort((a, b) => (b.clientDelta || 0) - (a.clientDelta || 0));

        const clientsHTML = clientBreakdowns.map(({ client: c, breakdown, clientDelta, healthChange }) => {
            const hColor = healthColor(breakdown.total);
            const deltaStr = clientDelta !== null ? `<span class="kpi-insight-delta ${clientDelta > 0 ? 'up' : clientDelta < 0 ? 'down' : ''}">(${clientDelta > 0 ? '+' : ''}${clientDelta})</span>` : '';
            const factors = breakdown.factors.map(f => {
                const cls = f.points > 0 ? 'positive' : f.points < 0 ? 'negative' : '';
                return `<span class="hb-factor ${cls}">${f.name}: ${f.detail} (${f.points > 0 ? '+' : ''}${f.points})</span>`;
            }).join('');
            return `<div class="health-breakdown-item">
                <div class="hb-header">
                    <span class="hb-name" style="cursor:pointer;" onclick="KPIInsight.close();Router.navigate('client/${c.id}')">${c.name}</span>
                    <span class="hb-score" style="color:${hColor}">${breakdown.total} ${deltaStr}</span>
                </div>
                <div class="hb-factors">${factors}</div>
            </div>`;
        }).join('');

        // What drove the change section
        let driversHTML = '';
        const allChanges = ChangeTracker.getAllChangesFlat().filter(ch => ch.field !== 'Summary' && ch.field !== 'New Client' && ch.field !== 'Client Removed');
        if (allChanges.length > 0) {
            driversHTML = `<div class="kpi-insight-section-title">What Drove The Change</div>`;
            allChanges.forEach(ch => {
                const icon = ch.direction === 'improved' ? '&#9989;' : ch.direction === 'declined' ? '&#9888;&#65039;' : '&#128310;';
                const verb = ch.direction === 'improved' ? 'improved' : ch.direction === 'declined' ? 'declined' : 'changed';
                driversHTML += `<div class="kpi-insight-change"><span class="ci-icon">${icon}</span> <b>${ch.clientName}</b>: ${ch.field} ${verb} (${ch.oldVal} &#8594; ${ch.newVal})</div>`;
            });
        }

        this._showPopover(`
            <div class="kpi-insight-header">
                <h4>&#128170; Health Score: ${avgHealth} ${deltaHTML} ${prevHTML}</h4>
                <button class="kpi-insight-close" onclick="KPIInsight.close()">&times;</button>
            </div>
            <div class="kpi-insight-body">
                <div class="kpi-insight-section-title">Per-Client Breakdown (Base: 50)</div>
                ${clientsHTML}
                ${driversHTML}
            </div>
        `, event);
    },
};

// Close KPI insight on click outside
document.addEventListener('click', (e) => {
    if (KPIInsight._popoverEl && !e.target.closest('.kpi-insight-popover') && !e.target.closest('.kpi-card')) {
        KPIInsight.close();
    }
});

/* ================================================================
   SHARE SNAPSHOT
   ================================================================ */
const ShareSnapshot = {
    _open: false,

    open() {
        if (!State.dataLoaded || !State.clients.length) {
            showToast('No client data loaded — connect to monday.com first', 'warning');
            return;
        }
        this._open = true;
        this.render();
        document.getElementById('shareOverlay').classList.add('open');
    },

    close() {
        this._open = false;
        document.getElementById('shareOverlay').classList.remove('open');
    },

    _ragColor(rag) {
        if (rag === 'Green') return '#00c875';
        if (rag === 'Amber') return '#fdab3d';
        if (rag === 'Red') return '#df2f4a';
        return '#666';
    },

    _ragClass(rag) {
        if (rag === 'Green') return 'rag-green';
        if (rag === 'Amber') return 'rag-amber';
        if (rag === 'Red') return 'rag-red';
        return '';
    },

    _formatDate(d) {
        if (!d) return 'N/A';
        const dt = new Date(d);
        if (isNaN(dt.getTime())) return 'N/A';
        return dt.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
    },

    _summary() {
        const clients = State.clients;
        const total = clients.length;
        const green = clients.filter(c => c.rag === 'Green').length;
        const amber = clients.filter(c => c.rag === 'Amber').length;
        const red = clients.filter(c => c.rag === 'Red').length;
        const avgHealth = total > 0 ? Math.round(clients.reduce((s, c) => s + State.calcHealth(c), 0) / total) : 0;
        const billingActive = clients.filter(c => c.billing === 'Yes').length;
        const totalAgents = clients.reduce((s, c) => s + (c.agentCount || 0), 0);

        return { total, green, amber, red, avgHealth, billingActive, totalAgents };
    },

    render() {
        const body = document.getElementById('shareSnapshotBody');
        const s = this._summary();
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        const timeStr = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

        let html = `
            <div class="snap-header">
                <div class="snap-title">IAI ${RUNTIME.podName || 'Pod B'} — Client Progress Snapshot</div>
                <div class="snap-subtitle">Generated: ${dateStr} at ${timeStr} &middot; Pod Lead: ${RUNTIME.userName || 'Mishai'}</div>
            </div>

            <div class="snap-kpi-row">
                <div class="snap-kpi">
                    <div class="snap-kpi-value">${s.total}</div>
                    <div class="snap-kpi-label">Total Clients</div>
                </div>
                <div class="snap-kpi">
                    <div class="snap-kpi-value" style="color:${healthColor(s.avgHealth)}">${s.avgHealth}</div>
                    <div class="snap-kpi-label">Avg Health</div>
                </div>
                <div class="snap-kpi">
                    <div class="snap-kpi-value" style="color:#00c875">${s.green}</div>
                    <div class="snap-kpi-label">Green RAG</div>
                </div>
                <div class="snap-kpi">
                    <div class="snap-kpi-value">${s.totalAgents}</div>
                    <div class="snap-kpi-label">Total Agents</div>
                </div>
            </div>

            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;">
                <span style="font-size:11px;padding:4px 10px;border-radius:10px;background:rgba(0,200,117,0.12);color:#00c875;font-weight:600;">&#9679; ${s.green} Green</span>
                <span style="font-size:11px;padding:4px 10px;border-radius:10px;background:rgba(253,171,61,0.12);color:#fdab3d;font-weight:600;">&#9679; ${s.amber} Amber</span>
                <span style="font-size:11px;padding:4px 10px;border-radius:10px;background:rgba(223,47,74,0.12);color:#df2f4a;font-weight:600;">&#9679; ${s.red} Red</span>
                <span style="font-size:11px;padding:4px 10px;border-radius:10px;background:rgba(255,255,255,0.06);color:var(--text-secondary);font-weight:600;">&#128179; ${s.billingActive}/${s.total} Billing Active</span>
            </div>

            <div class="snap-section-title">Client Details</div>
            <div class="snap-clients-grid">`;

        // Sort by health descending for the snapshot
        const sorted = [...State.clients].sort((a, b) => State.calcHealth(b) - State.calcHealth(a));

        sorted.forEach(c => {
            const health = State.calcHealth(c);
            const hColor = healthColor(health);
            const ragC = this._ragColor(c.rag);
            const ragCls = this._ragClass(c.rag);
            const summaryText = c.summary ? (c.summary.length > 250 ? c.summary.substring(0, 250) + '...' : c.summary) : '';

            html += `
                <div class="snap-client-card ${ragCls}">
                    <div class="snap-client-header">
                        <div class="snap-rag-dot" style="background:${ragC};" title="${c.rag}"></div>
                        <div class="snap-client-name">${c.name}</div>
                        <div class="snap-health-badge" style="color:${hColor}">Health: ${health}</div>
                    </div>
                    <div class="snap-client-metrics">
                        <div class="snap-metric"><span class="snap-metric-label">RAG Status</span><span class="snap-metric-value" style="color:${ragC}">${c.rag}</span></div>
                        <div class="snap-metric"><span class="snap-metric-label">Plan</span><span class="snap-metric-value">${c.plan || 'N/A'}</span></div>
                        <div class="snap-metric"><span class="snap-metric-label">Billing</span><span class="snap-metric-value">${c.billing}</span></div>
                        <div class="snap-metric"><span class="snap-metric-label">Update Status</span><span class="snap-metric-value">${c.updateStatus}</span></div>
                        <div class="snap-metric"><span class="snap-metric-label">Agents</span><span class="snap-metric-value">${c.agentCount}</span></div>
                        <div class="snap-metric"><span class="snap-metric-label">AIOS Days</span><span class="snap-metric-value">${c.aiosDays ? Math.round(parseFloat(c.aiosDays)) : 'N/A'}</span></div>
                        <div class="snap-metric"><span class="snap-metric-label">Last Contact</span><span class="snap-metric-value">${daysAgo(c.lastContact)}</span></div>
                        <div class="snap-metric"><span class="snap-metric-label">Commencement</span><span class="snap-metric-value">${this._formatDate(c.commencement)}</span></div>
                    </div>`;

            if (c.agents && c.agents.length > 0) {
                html += `<div class="snap-agents-row">`;
                c.agents.forEach(a => {
                    html += `<span class="snap-agent-tag">&#129302; ${a.name} — ${a.stage}</span>`;
                });
                html += `</div>`;
            }

            if (summaryText) {
                html += `<div class="snap-client-summary">${summaryText}</div>`;
            }

            html += `</div>`;
        });

        html += `</div>
            <div class="snap-footer">
                IAI ${RUNTIME.podName || 'Pod B'} Dashboard &middot; ImplementAI &middot; Snapshot generated ${dateStr} at ${timeStr}
            </div>`;

        body.innerHTML = html;
    },

    // Generate plain text version for clipboard
    _toPlainText() {
        const s = this._summary();
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        const timeStr = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

        let txt = `IAI POD B — CLIENT PROGRESS SNAPSHOT\n`;
        txt += `Generated: ${dateStr} at ${timeStr} | Pod Lead: ${RUNTIME.userName || 'Mishai'}\n`;
        txt += `${'═'.repeat(50)}\n\n`;

        txt += `OVERVIEW\n`;
        txt += `  Total Clients: ${s.total}  |  Avg Health: ${s.avgHealth}\n`;
        txt += `  RAG: ${s.green} Green, ${s.amber} Amber, ${s.red} Red\n`;
        txt += `  Billing Active: ${s.billingActive}/${s.total}  |  Total Agents: ${s.totalAgents}\n`;
        txt += `${'─'.repeat(50)}\n\n`;

        const sorted = [...State.clients].sort((a, b) => State.calcHealth(b) - State.calcHealth(a));

        sorted.forEach(c => {
            const health = State.calcHealth(c);
            txt += `${c.rag.toUpperCase()} | ${c.name}  (Health: ${health})\n`;
            txt += `  Plan: ${c.plan || 'N/A'}  |  Billing: ${c.billing}  |  Update: ${c.updateStatus}\n`;
            txt += `  Agents: ${c.agentCount}  |  AIOS Days: ${c.aiosDays ? Math.round(parseFloat(c.aiosDays)) : 'N/A'}  |  Last Contact: ${daysAgo(c.lastContact)}\n`;
            txt += `  Commencement: ${this._formatDate(c.commencement)}\n`;

            if (c.agents && c.agents.length > 0) {
                txt += `  Agent Details: ${c.agents.map(a => `${a.name} (${a.stage})`).join(', ')}\n`;
            }

            if (c.summary) {
                const sum = c.summary.length > 200 ? c.summary.substring(0, 200) + '...' : c.summary;
                txt += `  Summary: ${sum}\n`;
            }
            txt += `\n`;
        });

        txt += `${'═'.repeat(50)}\n`;
        txt += `IAI ${RUNTIME.podName || 'Pod B'} Dashboard | ImplementAI | ${dateStr} at ${timeStr}\n`;
        return txt;
    },

    // Copy plain text to clipboard
    async copyText() {
        const btn = document.getElementById('btnCopyText');
        try {
            const text = this._toPlainText();
            await navigator.clipboard.writeText(text);
            btn.classList.add('copied');
            btn.innerHTML = '&#10003; Copied!';
            showToast('Snapshot copied as plain text', 'info');
            setTimeout(() => {
                btn.classList.remove('copied');
                btn.innerHTML = '&#128203; Copy as Text';
            }, 2000);
        } catch (err) {
            showToast('Copy failed — try Export instead', 'error');
        }
    },

    // Copy rich HTML to clipboard (for pasting into Teams/Outlook/etc)
    async copyHTML() {
        const btn = document.getElementById('btnCopyHTML');
        try {
            const htmlContent = this._toRichHTML();
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const textBlob = new Blob([this._toPlainText()], { type: 'text/plain' });
            await navigator.clipboard.write([
                new ClipboardItem({
                    'text/html': blob,
                    'text/plain': textBlob
                })
            ]);
            btn.classList.add('copied');
            btn.innerHTML = '&#10003; Copied!';
            showToast('Rich format copied — paste into Teams, Outlook, or Word', 'info');
            setTimeout(() => {
                btn.classList.remove('copied');
                btn.innerHTML = '&#128196; Copy Rich Format';
            }, 2000);
        } catch (err) {
            // Fallback: copy plain text
            try {
                await navigator.clipboard.writeText(this._toPlainText());
                showToast('Copied as plain text (rich format not supported in this browser)', 'info');
            } catch {
                showToast('Copy failed — try Export instead', 'error');
            }
        }
    },

    // Generate styled HTML for rich paste
    _toRichHTML() {
        const s = this._summary();
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        const timeStr = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        const sorted = [...State.clients].sort((a, b) => State.calcHealth(b) - State.calcHealth(a));

        let html = `<div style="font-family:Segoe UI,Arial,sans-serif;color:#222;max-width:700px;">`;
        html += `<h2 style="margin:0 0 4px;font-size:18px;color:#1a1a2e;">IAI ${RUNTIME.podName || 'Pod B'} — Client Progress Snapshot</h2>`;
        html += `<p style="margin:0 0 16px;font-size:12px;color:#888;">Generated: ${dateStr} at ${timeStr} &middot; Pod Lead: ${RUNTIME.userName || 'Mishai'}</p>`;

        html += `<table style="width:100%;border-collapse:collapse;margin-bottom:16px;">`;
        html += `<tr>`;
        html += `<td style="text-align:center;padding:10px;background:#f5f5f5;border:1px solid #ddd;border-radius:6px;"><strong style="font-size:20px;">${s.total}</strong><br><span style="font-size:10px;color:#888;">Clients</span></td>`;
        html += `<td style="text-align:center;padding:10px;background:#f5f5f5;border:1px solid #ddd;border-radius:6px;"><strong style="font-size:20px;color:${healthColor(s.avgHealth)};">${s.avgHealth}</strong><br><span style="font-size:10px;color:#888;">Avg Health</span></td>`;
        html += `<td style="text-align:center;padding:10px;background:#f5f5f5;border:1px solid #ddd;border-radius:6px;"><strong style="font-size:20px;color:#00c875;">${s.green}</strong><br><span style="font-size:10px;color:#888;">Green</span></td>`;
        html += `<td style="text-align:center;padding:10px;background:#f5f5f5;border:1px solid #ddd;border-radius:6px;"><strong style="font-size:20px;">${s.totalAgents}</strong><br><span style="font-size:10px;color:#888;">Agents</span></td>`;
        html += `</tr></table>`;

        html += `<p style="font-size:12px;margin:0 0 12px;">`;
        html += `<span style="color:#00c875;font-weight:600;">&#9679; ${s.green} Green</span> &nbsp; `;
        html += `<span style="color:#fdab3d;font-weight:600;">&#9679; ${s.amber} Amber</span> &nbsp; `;
        html += `<span style="color:#df2f4a;font-weight:600;">&#9679; ${s.red} Red</span> &nbsp; `;
        html += `<span style="color:#888;">Billing: ${s.billingActive}/${s.total} active</span></p>`;
        html += `<hr style="border:none;border-top:1px solid #ddd;margin:12px 0;">`;

        sorted.forEach(c => {
            const health = State.calcHealth(c);
            const hColor = healthColor(health);
            const ragC = this._ragColor(c.rag);

            html += `<div style="border-left:3px solid ${ragC};padding:10px 14px;margin-bottom:10px;background:#fafafa;border-radius:4px;">`;
            html += `<div style="display:flex;align-items:center;margin-bottom:6px;">`;
            html += `<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${ragC};margin-right:8px;"></span>`;
            html += `<strong style="font-size:14px;color:#1a1a2e;">${c.name}</strong>`;
            html += `<span style="margin-left:auto;font-size:12px;font-weight:700;color:${hColor};">Health: ${health}</span>`;
            html += `</div>`;

            html += `<table style="width:100%;font-size:11px;border-collapse:collapse;">`;
            html += `<tr><td style="color:#888;padding:2px 8px 2px 0;">Plan</td><td style="font-weight:600;">${c.plan || 'N/A'}</td>`;
            html += `<td style="color:#888;padding:2px 8px 2px 16px;">Billing</td><td style="font-weight:600;">${c.billing}</td></tr>`;
            html += `<tr><td style="color:#888;padding:2px 8px 2px 0;">Update</td><td style="font-weight:600;">${c.updateStatus}</td>`;
            html += `<td style="color:#888;padding:2px 8px 2px 16px;">Agents</td><td style="font-weight:600;">${c.agentCount}</td></tr>`;
            html += `<tr><td style="color:#888;padding:2px 8px 2px 0;">AIOS Days</td><td style="font-weight:600;">${c.aiosDays ? Math.round(parseFloat(c.aiosDays)) : 'N/A'}</td>`;
            html += `<td style="color:#888;padding:2px 8px 2px 16px;">Last Contact</td><td style="font-weight:600;">${daysAgo(c.lastContact)}</td></tr>`;
            html += `</table>`;

            if (c.agents && c.agents.length > 0) {
                html += `<div style="margin-top:6px;font-size:10px;">`;
                c.agents.forEach(a => {
                    html += `<span style="display:inline-block;padding:2px 8px;margin:2px 3px 2px 0;background:#f0ebff;color:#6B30FF;border-radius:10px;">&#129302; ${a.name} — ${a.stage}</span>`;
                });
                html += `</div>`;
            }

            if (c.summary) {
                const sum = c.summary.length > 200 ? c.summary.substring(0, 200) + '...' : c.summary;
                html += `<div style="margin-top:6px;font-size:11px;color:#555;padding:6px 8px;background:#f0f0f0;border-radius:4px;border-left:2px solid #ddd;">${sum}</div>`;
            }
            html += `</div>`;
        });

        html += `<p style="text-align:center;font-size:10px;color:#aaa;margin-top:16px;">IAI ${RUNTIME.podName || 'Pod B'} Dashboard &middot; ImplementAI &middot; ${dateStr}</p>`;
        html += `</div>`;
        return html;
    },

    // Export as standalone HTML file
    exportHTML() {
        const s = this._summary();
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        const timeStr = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        const sorted = [...State.clients].sort((a, b) => State.calcHealth(b) - State.calcHealth(a));

        let doc = `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">`;
        doc += `<title>IAI ${RUNTIME.podName || 'Pod B'} Snapshot — ${dateStr}</title>`;
        doc += `<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:#0d0d1a;color:#e0e0e0;padding:32px;max-width:800px;margin:0 auto;}
h1{font-size:22px;color:#fff;margin-bottom:4px;}
.subtitle{font-size:12px;color:#888;margin-bottom:24px;}
.kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px;}
.kpi{background:#1a1a2e;border:1px solid #2a2a4a;border-radius:10px;padding:16px;text-align:center;}
.kpi-value{font-size:26px;font-weight:800;color:#fff;}
.kpi-label{font-size:10px;color:#888;text-transform:uppercase;letter-spacing:0.5px;margin-top:4px;}
.tags{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:18px;}
.tag{font-size:11px;padding:4px 12px;border-radius:12px;font-weight:600;}
.section-title{font-size:14px;font-weight:700;color:#fff;margin:20px 0 12px;padding-bottom:6px;border-bottom:1px solid #2a2a4a;}
.client{background:#1a1a2e;border:1px solid #2a2a4a;border-radius:10px;padding:16px;margin-bottom:10px;border-left:3px solid #444;}
.client.green{border-left-color:#00c875;} .client.amber{border-left-color:#fdab3d;} .client.red{border-left-color:#df2f4a;}
.client-header{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
.rag-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.client-name{font-size:15px;font-weight:700;color:#fff;flex:1;}
.health-badge{font-size:12px;font-weight:700;padding:2px 10px;border-radius:10px;background:rgba(255,255,255,0.06);}
.metrics{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:4px 16px;margin-bottom:8px;}
.metric{display:flex;justify-content:space-between;font-size:11px;padding:3px 0;border-bottom:1px dashed #2a2a4a;}
.metric-label{color:#888;} .metric-value{color:#e0e0e0;font-weight:600;}
.agents-row{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px;}
.agent-tag{font-size:10px;padding:3px 10px;border-radius:12px;background:rgba(107,48,255,0.12);color:#a78bfa;border:1px solid rgba(107,48,255,0.2);}
.summary{font-size:11px;color:#999;line-height:1.6;margin-top:8px;padding:8px 12px;background:#0d0d1a;border-radius:6px;border-left:2px solid #2a2a4a;}
.footer{text-align:center;font-size:10px;color:#555;margin-top:24px;padding-top:16px;border-top:1px solid #2a2a4a;}
@media(max-width:600px){.kpi-row{grid-template-columns:repeat(2,1fr);}.metrics{grid-template-columns:1fr;}}
@media print{body{background:#fff;color:#222;padding:16px;} .kpi,.client{background:#f9f9f9;border-color:#ddd;} h1,.client-name,.section-title{color:#111;} .metric-value,.kpi-value{color:#222;}}
</style></head><body>`;

        doc += `<h1>IAI ${RUNTIME.podName || 'Pod B'} — Client Progress Snapshot</h1>`;
        doc += `<div class="subtitle">Generated: ${dateStr} at ${timeStr} &middot; Pod Lead: ${RUNTIME.userName || 'Mishai'}</div>`;

        doc += `<div class="kpi-row">`;
        doc += `<div class="kpi"><div class="kpi-value">${s.total}</div><div class="kpi-label">Total Clients</div></div>`;
        doc += `<div class="kpi"><div class="kpi-value" style="color:${healthColor(s.avgHealth)}">${s.avgHealth}</div><div class="kpi-label">Avg Health</div></div>`;
        doc += `<div class="kpi"><div class="kpi-value" style="color:#00c875">${s.green}</div><div class="kpi-label">Green RAG</div></div>`;
        doc += `<div class="kpi"><div class="kpi-value">${s.totalAgents}</div><div class="kpi-label">Total Agents</div></div>`;
        doc += `</div>`;

        doc += `<div class="tags">`;
        doc += `<span class="tag" style="background:rgba(0,200,117,0.12);color:#00c875;">&#9679; ${s.green} Green</span>`;
        doc += `<span class="tag" style="background:rgba(253,171,61,0.12);color:#fdab3d;">&#9679; ${s.amber} Amber</span>`;
        doc += `<span class="tag" style="background:rgba(223,47,74,0.12);color:#df2f4a;">&#9679; ${s.red} Red</span>`;
        doc += `<span class="tag" style="background:rgba(255,255,255,0.06);color:#888;">Billing: ${s.billingActive}/${s.total} active</span>`;
        doc += `</div>`;

        doc += `<div class="section-title">Client Details</div>`;

        sorted.forEach(c => {
            const health = State.calcHealth(c);
            const hColor = healthColor(health);
            const ragC = this._ragColor(c.rag);
            const ragCls = c.rag === 'Green' ? 'green' : c.rag === 'Amber' ? 'amber' : c.rag === 'Red' ? 'red' : '';

            doc += `<div class="client ${ragCls}">`;
            doc += `<div class="client-header">`;
            doc += `<div class="rag-dot" style="background:${ragC};"></div>`;
            doc += `<div class="client-name">${c.name}</div>`;
            doc += `<div class="health-badge" style="color:${hColor}">Health: ${health}</div>`;
            doc += `</div>`;

            doc += `<div class="metrics">`;
            doc += `<div class="metric"><span class="metric-label">RAG</span><span class="metric-value" style="color:${ragC}">${c.rag}</span></div>`;
            doc += `<div class="metric"><span class="metric-label">Plan</span><span class="metric-value">${c.plan || 'N/A'}</span></div>`;
            doc += `<div class="metric"><span class="metric-label">Billing</span><span class="metric-value">${c.billing}</span></div>`;
            doc += `<div class="metric"><span class="metric-label">Update</span><span class="metric-value">${c.updateStatus}</span></div>`;
            doc += `<div class="metric"><span class="metric-label">Agents</span><span class="metric-value">${c.agentCount}</span></div>`;
            doc += `<div class="metric"><span class="metric-label">AIOS Days</span><span class="metric-value">${c.aiosDays ? Math.round(parseFloat(c.aiosDays)) : 'N/A'}</span></div>`;
            doc += `<div class="metric"><span class="metric-label">Last Contact</span><span class="metric-value">${daysAgo(c.lastContact)}</span></div>`;
            doc += `<div class="metric"><span class="metric-label">Commencement</span><span class="metric-value">${this._formatDate(c.commencement)}</span></div>`;
            doc += `</div>`;

            if (c.agents && c.agents.length > 0) {
                doc += `<div class="agents-row">`;
                c.agents.forEach(a => {
                    doc += `<span class="agent-tag">&#129302; ${a.name} — ${a.stage}</span>`;
                });
                doc += `</div>`;
            }

            if (c.summary) {
                const sum = c.summary.length > 250 ? c.summary.substring(0, 250) + '...' : c.summary;
                doc += `<div class="summary">${sum}</div>`;
            }
            doc += `</div>`;
        });

        doc += `<div class="footer">IAI ${RUNTIME.podName || 'Pod B'} Dashboard &middot; ImplementAI &middot; ${dateStr} at ${timeStr}</div>`;
        doc += `</body></html>`;

        // Download the file
        const blob = new Blob([doc], { type: 'text/html;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `IAI_Pod_B_Snapshot_${now.toISOString().slice(0,10)}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('Snapshot exported as HTML file', 'info');
    },

    // Export as PDF via print dialog (print-optimised layout)
    exportPDF() {
        const s = this._summary();
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        const timeStr = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        const sorted = [...State.clients].sort((a, b) => State.calcHealth(b) - State.calcHealth(a));

        let doc = `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8">`;
        doc += `<title>IAI ${RUNTIME.podName || 'Pod B'} Snapshot — ${dateStr}</title>`;
        doc += `<style>
@page { margin: 18mm 14mm; size: A4; }
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;color:#222;padding:0;max-width:100%;line-height:1.4;}
h1{font-size:20px;color:#1a1a2e;margin-bottom:2px;}
.subtitle{font-size:11px;color:#777;margin-bottom:18px;}
.kpi-row{display:flex;gap:8px;margin-bottom:16px;}
.kpi{flex:1;background:#f7f7fa;border:1px solid #e0e0e0;border-radius:8px;padding:12px 8px;text-align:center;}
.kpi-value{font-size:22px;font-weight:800;color:#1a1a2e;}
.kpi-label{font-size:9px;color:#888;text-transform:uppercase;letter-spacing:0.5px;margin-top:2px;}
.tags{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px;}
.tag{font-size:10px;padding:3px 10px;border-radius:10px;font-weight:600;border:1px solid #ddd;}
.section-title{font-size:13px;font-weight:700;color:#1a1a2e;margin:16px 0 10px;padding-bottom:5px;border-bottom:1.5px solid #e0e0e0;}
.client{border:1px solid #e0e0e0;border-radius:8px;padding:12px 14px;margin-bottom:8px;border-left:3px solid #bbb;page-break-inside:avoid;}
.client.green{border-left-color:#00c875;} .client.amber{border-left-color:#e8a020;} .client.red{border-left-color:#df2f4a;}
.client-header{display:flex;align-items:center;gap:8px;margin-bottom:6px;}
.rag-dot{width:9px;height:9px;border-radius:50%;display:inline-block;}
.client-name{font-size:14px;font-weight:700;color:#1a1a2e;flex:1;}
.health-badge{font-size:11px;font-weight:700;padding:2px 8px;border-radius:8px;background:#f0f0f0;}
.metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:3px 12px;margin-bottom:6px;}
.metric{display:flex;justify-content:space-between;font-size:10px;padding:2px 0;border-bottom:1px dashed #e8e8e8;}
.metric-label{color:#888;} .metric-value{color:#222;font-weight:600;}
.agents-row{display:flex;flex-wrap:wrap;gap:3px;margin-top:4px;}
.agent-tag{font-size:9px;padding:2px 8px;border-radius:10px;background:#f0ebff;color:#6B30FF;border:1px solid #e0d6ff;}
.summary{font-size:10px;color:#555;line-height:1.5;margin-top:5px;padding:6px 10px;background:#f9f9fb;border-radius:4px;border-left:2px solid #ddd;}
.footer{text-align:center;font-size:9px;color:#aaa;margin-top:20px;padding-top:12px;border-top:1px solid #e0e0e0;}
</style></head><body>`;

        doc += `<h1>IAI ${RUNTIME.podName || 'Pod B'} — Client Progress Snapshot</h1>`;
        doc += `<div class="subtitle">Generated: ${dateStr} at ${timeStr} &middot; Pod Lead: ${RUNTIME.userName || 'Mishai'}</div>`;

        doc += `<div class="kpi-row">`;
        doc += `<div class="kpi"><div class="kpi-value">${s.total}</div><div class="kpi-label">Total Clients</div></div>`;
        doc += `<div class="kpi"><div class="kpi-value" style="color:${s.avgHealth >= 75 ? '#00875a' : s.avgHealth >= 50 ? '#c07800' : '#c9252d'}">${s.avgHealth}</div><div class="kpi-label">Avg Health</div></div>`;
        doc += `<div class="kpi"><div class="kpi-value" style="color:#00875a">${s.green}</div><div class="kpi-label">Green RAG</div></div>`;
        doc += `<div class="kpi"><div class="kpi-value">${s.totalAgents}</div><div class="kpi-label">Total Agents</div></div>`;
        doc += `</div>`;

        doc += `<div class="tags">`;
        doc += `<span class="tag" style="background:#e6f9f0;color:#00875a;">● ${s.green} Green</span>`;
        doc += `<span class="tag" style="background:#fff3e0;color:#c07800;">● ${s.amber} Amber</span>`;
        doc += `<span class="tag" style="background:#ffeaee;color:#c9252d;">● ${s.red} Red</span>`;
        doc += `<span class="tag" style="background:#f5f5f5;color:#777;">Billing: ${s.billingActive}/${s.total} active</span>`;
        doc += `</div>`;

        doc += `<div class="section-title">Client Details</div>`;

        sorted.forEach(c => {
            const health = State.calcHealth(c);
            const hColor = health >= 75 ? '#00875a' : health >= 50 ? '#c07800' : '#c9252d';
            const ragC = c.rag === 'Green' ? '#00875a' : c.rag === 'Amber' ? '#c07800' : c.rag === 'Red' ? '#c9252d' : '#888';
            const ragCls = c.rag === 'Green' ? 'green' : c.rag === 'Amber' ? 'amber' : c.rag === 'Red' ? 'red' : '';

            doc += `<div class="client ${ragCls}">`;
            doc += `<div class="client-header">`;
            doc += `<div class="rag-dot" style="background:${ragC};"></div>`;
            doc += `<div class="client-name">${c.name}</div>`;
            doc += `<div class="health-badge" style="color:${hColor}">Health: ${health}</div>`;
            doc += `</div>`;

            doc += `<div class="metrics">`;
            doc += `<div class="metric"><span class="metric-label">RAG</span><span class="metric-value" style="color:${ragC}">${c.rag}</span></div>`;
            doc += `<div class="metric"><span class="metric-label">Plan</span><span class="metric-value">${c.plan || 'N/A'}</span></div>`;
            doc += `<div class="metric"><span class="metric-label">Billing</span><span class="metric-value">${c.billing}</span></div>`;
            doc += `<div class="metric"><span class="metric-label">Update</span><span class="metric-value">${c.updateStatus}</span></div>`;
            doc += `<div class="metric"><span class="metric-label">Agents</span><span class="metric-value">${c.agentCount}</span></div>`;
            doc += `<div class="metric"><span class="metric-label">AIOS Days</span><span class="metric-value">${c.aiosDays ? Math.round(parseFloat(c.aiosDays)) : 'N/A'}</span></div>`;
            doc += `<div class="metric"><span class="metric-label">Last Contact</span><span class="metric-value">${daysAgo(c.lastContact)}</span></div>`;
            doc += `<div class="metric"><span class="metric-label">Commencement</span><span class="metric-value">${this._formatDate(c.commencement)}</span></div>`;
            doc += `</div>`;

            if (c.agents && c.agents.length > 0) {
                doc += `<div class="agents-row">`;
                c.agents.forEach(a => {
                    doc += `<span class="agent-tag">${a.name} — ${a.stage}</span>`;
                });
                doc += `</div>`;
            }

            if (c.summary) {
                const sum = c.summary.length > 250 ? c.summary.substring(0, 250) + '...' : c.summary;
                doc += `<div class="summary">${sum}</div>`;
            }
            doc += `</div>`;
        });

        doc += `<div class="footer">IAI ${RUNTIME.podName || 'Pod B'} Dashboard &middot; ImplementAI &middot; ${dateStr} at ${timeStr}</div>`;
        doc += `</body></html>`;

        // Open in hidden iframe and trigger print → Save as PDF
        const iframe = document.createElement('iframe');
        iframe.style.cssText = 'position:fixed;top:-9999px;left:-9999px;width:800px;height:600px;border:none;';
        document.body.appendChild(iframe);
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        iframeDoc.open();
        iframeDoc.write(doc);
        iframeDoc.close();

        // Wait for content to render, then print
        iframe.contentWindow.addEventListener('afterprint', () => {
            setTimeout(() => iframe.remove(), 500);
        });
        setTimeout(() => {
            iframe.contentWindow.focus();
            iframe.contentWindow.print();
            // Fallback cleanup if afterprint never fires
            setTimeout(() => { if (iframe.parentNode) iframe.remove(); }, 60000);
        }, 300);

        showToast('PDF print dialog opened — select "Save as PDF"', 'info');
    }
};

/* ================================================================
   RENDER ALL
   ================================================================ */
function renderAll() {
    updateFilterCounts();
    renderAlerts();
    // Re-render the current page via the Router
    if (Router.current) {
        Router._renderPage(Router.current, Router.currentParams);
    }
}

/* ================================================================
   DATA LOADING
   ================================================================ */
async function loadData(showOverlay = true) {
    // Skip API calls in offline mode
    if (getConnectionMode() === 'offline') {
        renderAll();
        document.getElementById('lastRefreshTime').textContent = 'Offline';
        document.getElementById('refreshCountdown').textContent = '';
        return;
    }
    if (showOverlay) {
        document.getElementById('loadingOverlay').classList.remove('hidden');
        document.getElementById('loadingText').textContent = 'Connecting to monday.com...';
    }
    try {
        if (showOverlay) document.getElementById('loadingText').textContent = `Fetching ${RUNTIME.podName || 'Pod'} clients...`;
        const raw = await MondayAPI.fetchPodClients(RUNTIME.podIndex);
        State.clients = State.transform(raw);
        // Apply local edits on top of API data — local overrides survive refreshes
        LocalEditManager.applyToAll(State.clients);
        State.dataLoaded = true;
        ConnectionStatus.setMonday('ok');
        ChangeTracker.detect(State.clients);
        State.applyFilters();
        renderAll();
        document.getElementById('lastRefreshTime').textContent = new Date().toLocaleTimeString();
        resetRefreshCountdown();

        // Auto-show alerts if there are critical ones on first load
        if (showOverlay) {
            const criticals = State.alerts.filter(a => a.type === 'critical');
            if (criticals.length > 0) {
                State.alertsVisible = true;
                document.getElementById('alertsSection').classList.remove('hidden');
                showToast(`${criticals.length} critical alert${criticals.length !== 1 ? 's' : ''} detected`, 'warning');
            }
        }

        // Trigger Outlook email sync now that we have client data for matching
        if (showOverlay && OutlookSync.hasToken() && !OutlookSync._lastSync) {
            OutlookSync.sync(false);
        }

        // Trigger Calendar sync on initial load
        if (showOverlay && CalendarSync.hasToken() && !CalendarSync._lastSync) {
            CalendarSync.sync(false);
        }

    } catch (err) {
        ConnectionStatus.setMonday('error');
        showToast(`Data load failed: ${err.message}`, 'error');
        console.error('Load error:', err);
    } finally {
        if (showOverlay) document.getElementById('loadingOverlay').classList.add('hidden');
    }
}

async function refreshData() {
    const btn = document.getElementById('btnRefresh');
    btn.classList.add('spinning');
    btn.disabled = true;
    await loadData(false);
    // Also trigger calendar sync on refresh
    if (CalendarSync.hasToken()) CalendarSync.sync(false);
    btn.classList.remove('spinning');
    btn.disabled = false;
    showToast('Data refreshed from monday.com', 'info');
}

/* ================================================================
   AUTO-REFRESH COUNTDOWN
   ================================================================ */
let refreshInterval = null;
let countdownInterval = null;
let nextRefreshTime = null;

function resetRefreshCountdown() {
    nextRefreshTime = Date.now() + CONFIG.AUTO_REFRESH_MS;
}

function updateCountdown() {
    if (!nextRefreshTime) return;
    const remaining = Math.max(0, Math.ceil((nextRefreshTime - Date.now()) / 1000));
    const mins = Math.floor(remaining / 60);
    const secs = remaining % 60;
    const el = document.getElementById('refreshCountdown');
    if (el) {
        el.textContent = `next: ${mins}:${secs.toString().padStart(2, '0')}`;
    }
}

/* ================================================================
   KEYBOARD SHORTCUTS
   ================================================================ */
document.addEventListener('keydown', (e) => {
    // Close modals/viewers on Escape from anywhere
    if (e.key === 'Escape') {
        // Change popover (small, closes first)
        if (typeof ChangeTracker !== 'undefined' && ChangeTracker._popoverEl) {
            ChangeTracker.closePopover();
            return;
        }
        // KB viewer takes priority (fullscreen)
        if (typeof KnowledgeBase !== 'undefined' && KnowledgeBase._viewerOpen) {
            KnowledgeBase.closeViewer();
            return;
        }
        // KB add modal
        const kbModal = document.getElementById('kbAddModal');
        if (kbModal && kbModal.classList.contains('open')) {
            KnowledgeBase.closeAddModal();
            return;
        }
        // Share snapshot modal
        if (typeof ShareSnapshot !== 'undefined' && ShareSnapshot._open) {
            ShareSnapshot.close();
            return;
        }
        // Task prompt modal
        const overlay = document.getElementById('taskPromptOverlay');
        if (overlay && overlay.classList.contains('open')) {
            closeTaskPrompt();
            return;
        }
    }

    // Don't trigger shortcuts when typing in inputs
    const tag = e.target.tagName.toLowerCase();
    if (tag === 'input' || tag === 'textarea' || tag === 'select') {
        if (e.key === 'Escape') {
            e.target.blur();
        }
        return;
    }

    switch(e.key) {
        case 'r':
        case 'R':
            e.preventDefault();
            refreshData();
            break;
        case '/':
            e.preventDefault();
            document.getElementById('searchBox').focus();
            break;
        case 'a':
        case 'A':
            e.preventDefault();
            if (Router.current !== 'clients') Router.navigate('clients');
            setTimeout(() => setRagFilter('all', document.querySelector('[data-rag="all"]')), 50);
            break;
        case '1':
            e.preventDefault();
            if (Router.current !== 'clients') Router.navigate('clients');
            setTimeout(() => setRagFilter('Green', document.querySelector('[data-rag="Green"]')), 50);
            break;
        case '2':
            e.preventDefault();
            if (Router.current !== 'clients') Router.navigate('clients');
            setTimeout(() => setRagFilter('Amber', document.querySelector('[data-rag="Amber"]')), 50);
            break;
        case '3':
            e.preventDefault();
            if (Router.current !== 'clients') Router.navigate('clients');
            setTimeout(() => setRagFilter('Red', document.querySelector('[data-rag="Red"]')), 50);
            break;
        case 'Escape':
            if (document.getElementById('detailPanel').classList.contains('open')) {
                closeDetail();
            } else if (!document.getElementById('setupOverlay').classList.contains('hidden')) {
                if (UserSession.hasSession()) closeSetup();
            } else {
                resetFilters();
            }
            break;
        case '?':
            e.preventDefault();
            document.getElementById('shortcutsPanel').classList.toggle('visible');
            break;
    }
});

/* ================================================================
   SETUP & INIT
   ================================================================ */
function toggleTokenVis() {
    const inp = document.getElementById('tokenInput');
    inp.type = inp.type === 'password' ? 'text' : 'password';
}

function showSetup() {
    document.getElementById('setupOverlay').classList.remove('hidden');
    document.getElementById('tokenInput').value = MondayAPI._token || '';
    const outlookInput = document.getElementById('outlookTokenInput');
    if (outlookInput) outlookInput.value = OutlookSync.getToken() || '';
    // Show current pod info
    const podInfo = document.getElementById('currentPodInfo');
    if (podInfo) {
        podInfo.textContent = RUNTIME.podName
            ? `Currently managing: ${RUNTIME.podName} (as ${RUNTIME.userName})`
            : 'No pod selected yet';
    }
    // Show close button only for returning users (has session)
    const closeBtn = document.getElementById('setupCloseBtn');
    if (closeBtn) closeBtn.style.display = UserSession.hasSession() ? 'flex' : 'none';
    // Update connection mode UI
    updateModeUI();
}

function closeSetup() {
    document.getElementById('setupOverlay').classList.add('hidden');
}

function getConnectionMode() {
    return localStorage.getItem('iai_connection_mode') || 'online';
}

function setConnectionMode(mode) {
    const prev = getConnectionMode();
    localStorage.setItem('iai_connection_mode', mode);
    updateModeUI();

    if (mode === 'offline') {
        // Stop auto-refresh
        if (refreshInterval) { clearInterval(refreshInterval); refreshInterval = null; }
        if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
        document.getElementById('refreshCountdown').textContent = '';
        document.getElementById('lastRefreshTime').textContent = 'Offline';
        // Refresh sync status UIs to show offline state
        OutlookSync._updateSyncStatusUI();
        CalendarSync._updateSyncStatusUI();
        showToast('Switched to Offline / Standalone mode', 'info');
    } else if (mode === 'online' && prev === 'offline') {
        // Restart auto-refresh
        refreshInterval = setInterval(() => { loadData(false); }, CONFIG.AUTO_REFRESH_MS);
        countdownInterval = setInterval(updateCountdown, 1000);
        resetRefreshCountdown();
        showToast('Switched to Online mode — syncing...', 'success');
        if (MondayAPI.init()) loadData(false);
    }
}

// ── Connection Status Tracker ──
const ConnectionStatus = {
    monday: 'unknown',   // 'ok' | 'error' | 'unknown'
    outlook: 'unknown',  // 'ok' | 'error' | 'no-token' | 'token-expired' | 'unknown'
    calendar: 'unknown', // 'ok' | 'error' | 'no-token' | 'token-expired' | 'unknown'

    setMonday(status) { this.monday = status; updateConnectionIndicator(); },
    setOutlook(status) { this.outlook = status; updateConnectionIndicator(); },
    setCalendar(status) { this.calendar = status; updateConnectionIndicator(); },

    // Overall health: green if monday OK, amber if any issues, red if monday down
    getOverall() {
        if (getConnectionMode() === 'offline') return 'offline';
        // Monday is the primary connection — if it's down, we're disconnected
        if (this.monday === 'error') return 'disconnected';
        if (this.monday === 'unknown') return 'online'; // haven't tried yet
        // Monday is OK — check secondary services
        const outlookIssue = this.outlook === 'error' || this.outlook === 'token-expired';
        const calendarIssue = this.calendar === 'error' || this.calendar === 'token-expired';
        // Only flag issues for services that have tokens configured
        if ((outlookIssue && OutlookSync.hasToken()) || (calendarIssue && CalendarSync.hasToken())) {
            return 'issues';
        }
        return 'online';
    },

    getTooltip() {
        const mode = getConnectionMode();
        if (mode === 'offline') return 'Offline / Standalone mode';
        const parts = [];
        parts.push(`monday.com: ${this.monday === 'ok' ? 'Connected' : this.monday === 'error' ? 'Failed' : 'Pending'}`);
        if (OutlookSync.hasToken()) {
            const oStatus = this.outlook === 'ok' ? 'Connected' : this.outlook === 'token-expired' ? 'Token expired' : this.outlook === 'error' ? 'Failed' : 'Pending';
            parts.push(`Outlook: ${oStatus}`);
        }
        if (CalendarSync.hasToken()) {
            const cStatus = this.calendar === 'ok' ? 'Connected' : this.calendar === 'token-expired' ? 'Token expired' : this.calendar === 'error' ? 'Failed' : 'Pending';
            parts.push(`Calendar: ${cStatus}`);
        }
        return parts.join('\n');
    }
};

function updateConnectionIndicator() {
    const el = document.getElementById('navConnectionStatus');
    const textEl = document.getElementById('connStatusText');
    if (!el || !textEl) return;

    const mode = getConnectionMode();
    const overall = ConnectionStatus.getOverall();

    if (mode === 'offline') {
        el.style.display = 'inline-flex';
        el.dataset.status = 'offline';
        textEl.textContent = 'Offline';
        el.title = 'Offline / Standalone mode';
    } else {
        el.style.display = 'inline-flex';
        el.dataset.status = overall;
        const labels = { online: 'Online', issues: 'Connection Issues', disconnected: 'Disconnected' };
        textEl.textContent = labels[overall] || 'Online';
        el.title = ConnectionStatus.getTooltip();
    }
}

function updateModeUI() {
    const mode = getConnectionMode();
    // Update toggle buttons
    document.querySelectorAll('.mode-toggle-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
    });
    // Update hint text
    const hint = document.getElementById('modeHint');
    if (hint) {
        hint.textContent = mode === 'offline'
            ? 'Offline: No API calls. Dashboard uses local edits, cached data, and snapshots.'
            : 'Online: Dashboard syncs live data from monday.com and Outlook.';
    }
    // Update connection indicator
    updateConnectionIndicator();
}

function launchOffline() {
    setConnectionMode('offline');
    if (UserSession.hasSession()) {
        // Returning user — just close overlay and render with existing data
        document.getElementById('setupOverlay').classList.add('hidden');
        renderEmailActivity();
        TargetsManager.render();
        renderAll();
    } else {
        // First-time user — need pod selection
        document.getElementById('setupOverlay').classList.add('hidden');
        showPodSelectionOffline();
    }
}

function showPodSelectionOffline() {
    const overlay = document.getElementById('podSelectOverlay');
    overlay.classList.remove('hidden');
    const greeting = document.getElementById('podSelectGreeting');
    if (greeting) greeting.textContent = 'Offline Mode';
    // Populate pod buttons with known pods (hardcoded for offline)
    const container = document.getElementById('podSelectButtons');
    const pods = [
        { name: 'Pod A', slug: 'pod-a', icon: 'A', index: 0 },
        { name: 'Pod B', slug: 'pod-b', icon: 'B', index: 1 },
        { name: 'Pod C', slug: 'pod-c', icon: 'C', index: 2 },
    ];
    container.innerHTML = pods.map(p => `
        <button class="pod-select-btn" onclick="selectPodOffline('${p.slug}','${p.name}',${p.index})">
            <span class="pod-icon">${p.icon}</span>
            <span>${p.name}</span>
        </button>
    `).join('');
}

function selectPodOffline(slug, name, index) {
    RUNTIME.podSlug = slug;
    RUNTIME.podName = name;
    RUNTIME.podIndex = index;
    RUNTIME.userName = 'Offline User';
    UserSession.save();
    document.getElementById('podSelectOverlay').classList.add('hidden');
    // Reload namespaced modules for the selected pod
    reloadNamespacedModules();
    updateDynamicUI();
    handleEmailDataForPod();
    handleCalendarDataForPod();
    renderEmailActivity();
    TargetsManager.render();
    renderAll();
    showToast(`Launched in Offline mode as ${name}`, 'success');
}

async function testConnection() {
    const btn = document.getElementById('btnTestConnect');
    const errEl = document.getElementById('setupError');
    const sucEl = document.getElementById('setupSuccess');
    const token = document.getElementById('tokenInput').value.trim();
    errEl.textContent = '';
    sucEl.textContent = '';

    if (!token) { errEl.textContent = 'Please enter your API token'; return; }

    btn.disabled = true;
    btn.textContent = 'Connecting...';
    MondayAPI.setToken(token);

    try {
        const { name, email } = await MondayAPI.testConnection();
        RUNTIME.userName = name;
        RUNTIME.userEmail = email;
        sucEl.textContent = `Connected as ${name}`;

        // Save Outlook token if provided
        const outlookToken = document.getElementById('outlookTokenInput')?.value?.trim();
        if (outlookToken) OutlookSync.setToken(outlookToken);

        setTimeout(async () => {
            document.getElementById('setupOverlay').classList.add('hidden');

            if (UserSession.hasSession()) {
                // Returning user with stored pod — update UI and load
                updateDynamicUI();
                reloadNamespacedModules();
                await loadData(true);
                if (outlookToken && OutlookSync.hasToken()) {
                    OutlookSync.sync(true);
                    CalendarSync.sync(true);
                }
            } else {
                // New user or no pod selected — discover pods
                await showPodSelection(name);
            }
        }, 800);
    } catch (err) {
        errEl.textContent = `Connection failed: ${err.message}`;
        btn.disabled = false;
        btn.textContent = 'Test Connection & Launch';
    }
}

/* ================================================================
   POD SELECTION + SPLASH SCREEN FLOW
   ================================================================ */
async function showPodSelection(userName) {
    const overlay = document.getElementById('podSelectOverlay');
    const container = document.getElementById('podSelectButtons');
    const greeting = document.getElementById('podSelectGreeting');

    greeting.textContent = `Hello, ${userName}!`;
    container.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:20px;">Discovering pods...</div>';
    overlay.classList.remove('hidden');

    try {
        const pods = await MondayAPI.discoverPods();
        RUNTIME.allPods = pods;

        if (pods.length === 0) {
            container.innerHTML = '<div style="color:var(--rag-red);padding:12px;">No pods found on the board. Check that items have a Pod column assigned.</div>';
            return;
        }

        container.innerHTML = pods.map(p => {
            const letter = p.name.replace(/pod\s*/i, '').charAt(0).toUpperCase();
            return `
                <button class="pod-select-btn" onclick="selectPod('${p.slug}', ${p.index}, '${p.name.replace(/'/g, "\\'")}')">
                    <div class="pod-icon">${letter}</div>
                    <div>
                        <div>${p.name}</div>
                        <div style="font-size:11px;font-weight:400;color:var(--text-muted);">Click to manage this pod</div>
                    </div>
                </button>`;
        }).join('');
    } catch (err) {
        container.innerHTML = `<div style="color:var(--rag-red);padding:12px;">Failed to discover pods: ${err.message}</div>`;
    }
}

async function selectPod(slug, index, name) {
    RUNTIME.podName = name;
    RUNTIME.podIndex = index;
    RUNTIME.podSlug = slug;

    // Migrate existing localStorage data (one-time for existing Pod B users)
    UserSession.migrateStorage(slug);
    UserSession.save();

    document.getElementById('podSelectOverlay').classList.add('hidden');

    // Reload modules with new namespaced keys
    reloadNamespacedModules();
    updateDynamicUI();
    handleEmailDataForPod();
    handleCalendarDataForPod();

    // Show splash for first-time users
    if (UserSession.isFirstLogin()) {
        showSplashScreen();
    } else {
        await loadData(true);
        if (OutlookSync.hasToken()) {
            OutlookSync.sync(false);
            CalendarSync.sync(false);
        }
    }
}

function showSplashScreen() {
    const podText = document.getElementById('splashPodText');
    podText.textContent = `You're now managing ${RUNTIME.podName} as ${RUNTIME.userName}.`;
    document.getElementById('splashOverlay').classList.remove('hidden');
}

async function dismissSplash() {
    UserSession.markSplashSeen();
    document.getElementById('splashOverlay').classList.add('hidden');
    await loadData(true);
    if (OutlookSync.hasToken()) {
        OutlookSync.sync(false);
        CalendarSync.sync(false);
    }
}

async function switchPod() {
    document.getElementById('setupOverlay').classList.add('hidden');
    const name = RUNTIME.userName;
    UserSession.clear();
    await showPodSelection(name || 'User');
}

/** Reload all pod-namespaced modules after pod selection changes */
function reloadNamespacedModules() {
    State.loadLocal();
    TargetsManager.load();
    DashTodo.load();
    CalendarState.load();
    KnowledgeBase.load();
    EmailActionOverrides.load();
    EmailHiddenCards.load();
    ActivityFeed.load();
    LocalEditManager.load();
    OutlookSync.init();
    CalendarSync.init();
}

/** Update all hardcoded Pod/User text in the DOM */
function updateDynamicUI() {
    const podName = RUNTIME.podName || 'Dashboard';
    const userName = RUNTIME.userName || '';

    document.title = `IAI ${podName} Dashboard — ${userName} | ImplementAI`;

    const sidebarHeader = document.querySelector('.sidebar-header');
    if (sidebarHeader) sidebarHeader.textContent = `IAI — ${podName} Dashboard`;

    const brandText = document.querySelector('.brand-text');
    if (brandText) brandText.textContent = `${podName} Dashboard`;

    const podTag = document.querySelector('.pod-tag');
    if (podTag) podTag.textContent = podName.toUpperCase();

    const brandUser = document.querySelector('.brand-user');
    if (brandUser) brandUser.textContent = userName;

    // Setup modal subtitle
    const setupSubtitle = document.getElementById('setupSubtitle');
    if (setupSubtitle) setupSubtitle.textContent = `${podName} Client Productivity Dashboard`;

    const podInfo = document.getElementById('currentPodInfo');
    if (podInfo && userName) podInfo.textContent = `Currently managing: ${podName} (as ${userName})`;
}

/** Clear EMAIL_DATA for non-Pod-B users if no Outlook cache exists */
function handleEmailDataForPod() {
    if (RUNTIME.podSlug !== 'pod-b') {
        // The hardcoded EMAIL_DATA is Pod B-specific
        const cached = OutlookSync._loadCache();
        if (!cached) {
            EMAIL_DATA = { snapshotDate: null, clients: {} };
        }
    }
}

/** Clear CALENDAR_DATA for non-Pod-B users if no calendar cache exists */
function handleCalendarDataForPod() {
    if (RUNTIME.podSlug !== 'pod-b') {
        const cached = CalendarSync._loadCache();
        if (!cached) {
            CALENDAR_DATA = { snapshotDate: null, events: [] };
        }
    }
}

async function init() {
    ThemeManager.init();

    // Load user session FIRST (determines pod namespace for all other modules)
    UserSession.load();

    // Load all pod-namespaced modules
    State.loadLocal();
    TargetsManager.load();
    DashTodo.load();
    CalendarState.load();
    KnowledgeBase.load();
    EmailActionOverrides.load();
    EmailHiddenCards.load();
    ActivityFeed.load();
    LocalEditManager.load();
    OutlookSync.init();
    CalendarSync.init();

    // Handle EMAIL_DATA and CALENDAR_DATA for non-Pod-B users
    handleEmailDataForPod();
    handleCalendarDataForPod();

    // Update dynamic UI if session exists
    if (UserSession.hasSession()) {
        updateDynamicUI();
    }

    // Initialise SPA router
    Router.init();

    // Update offline badge on init
    updateModeUI();

    if (getConnectionMode() === 'offline' && UserSession.hasSession()) {
        // Offline mode with existing session — skip API, render with local/snapshot data
        document.getElementById('setupOverlay').classList.add('hidden');
        document.getElementById('lastRefreshTime').textContent = 'Offline';
        renderEmailActivity();
        TargetsManager.render();
        renderAll();
    } else if (MondayAPI.init()) {
        if (UserSession.hasSession()) {
            // Returning user with stored pod — go straight to dashboard
            document.getElementById('setupOverlay').classList.add('hidden');
            await loadData(true);
        } else {
            // Token exists but no pod selected — discover pods
            document.getElementById('setupOverlay').classList.add('hidden');
            try {
                const { name, email } = await MondayAPI.testConnection();
                ConnectionStatus.setMonday('ok');
                RUNTIME.userName = name;
                RUNTIME.userEmail = email;
                await showPodSelection(name);
            } catch {
                // Token expired/invalid — show setup
                ConnectionStatus.setMonday('error');
                showSetup();
            }
        }
    } else {
        // No API token — show setup overlay, render static fallbacks
        ConnectionStatus.setMonday('error');
        renderEmailActivity();
        TargetsManager.render();
    }

    // Auto-refresh (skip in offline mode)
    if (getConnectionMode() !== 'offline') {
        refreshInterval = setInterval(() => {
            loadData(false);
        }, CONFIG.AUTO_REFRESH_MS);
        countdownInterval = setInterval(updateCountdown, 1000);
        resetRefreshCountdown();
    }
}

// Start
init();
</script>
<div class="watermark-credit">Created by Mishai</div>
</body>
</html>
